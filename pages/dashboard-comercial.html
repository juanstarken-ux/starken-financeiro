<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comercial - STARK Intelligence</title>
    <script src="../auth.js"></script>
    <script src="../theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Ocultar menu Gest√£o por padr√£o - ser√° mostrado apenas para CEO */
        #menu-gestao-financeira {
            display: none !important;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-green: #4A6B54;
            --secondary-green: #7A9B84;
            --light-green: #B8D4BE;
            --bg-gray: #f5f7fa;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #e1e8ed;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-gray);
            color: var(--text-dark);
            line-height: 1.6;
        }
        .dashboard-container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--primary-green);
            color: var(--white);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo-image { width: 140px; height: auto; display: block; margin: 0 auto 15px; cursor: pointer; }
        .company-info { text-align: center; font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 8px; }
        .sidebar-nav { padding: 20px 0; }
        .nav-item {
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.1); color: var(--white); border-left-color: var(--light-green); }
        .nav-item.active { background-color: rgba(255,255,255,0.15); color: var(--white); border-left-color: var(--white); font-weight: 600; }
        .nav-icon { margin-right: 12px; font-size: 18px; }

        /* Main Content */
        .main-content { flex: 1; margin-left: 260px; padding: 30px; }
        .page-header { margin-bottom: 30px; }
        .page-title { font-size: 28px; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
        .page-subtitle { color: var(--text-light); font-size: 14px; }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1400px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .kpi-grid { grid-template-columns: 1fr; } }

        .kpi-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }

        .kpi-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 5px;
        }

        .kpi-trend {
            font-size: 13px;
            color: var(--text-light);
        }

        .kpi-trend.up { color: var(--success); }
        .kpi-trend.down { color: var(--danger); }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) { .charts-grid { grid-template-columns: 1fr; } }

        .chart-card {
            background: var(--white);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .chart-card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.tall { height: 400px; }

        /* Pipeline Table */
        .pipeline-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pipeline-table th {
            background-color: var(--bg-gray);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border-color);
        }

        .pipeline-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .pipeline-table tr:hover {
            background-color: var(--bg-gray);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.prospeccao { background-color: #e3f2fd; color: #1976d2; }
        .status-badge.qualificacao { background-color: #fff3e0; color: #f57c00; }
        .status-badge.proposta { background-color: #f3e5f5; color: #7b1fa2; }
        .status-badge.negociacao { background-color: #fff9c4; color: #f57f17; }
        .status-badge.fechado { background-color: #e8f5e9; color: #2e7d32; }
        .status-badge.perdido { background-color: #ffebee; color: #c62828; }

        /* Logout */
        .logout-section {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background-color: rgba(255,255,255,0.1);
            color: var(--white);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../logo-starken.png" alt="STARK Intelligence" class="logo-image" onclick="window.location.href='../index.html'">
                <div class="company-info">
                    STARK Intelligence<br>
                    Starken Tecnologia Ltda
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="../index.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    Dashboard Financeiro
                </a>
                <a href="dashboard-comercial.html" class="nav-item active">
                    <span class="nav-icon">üíº</span>
                    Dashboard Comercial
                </a>

                <div class="nav-separator"></div>

                <div class="nav-item nav-item-expandable" data-menu="submenu-gestao" onclick="ThemeManager.toggleSubMenu('submenu-gestao')">
                    <span class="nav-icon">üí∞</span>
                    Gest√£o Financeira
                    <span class="menu-arrow">‚ñ∂</span>
                </div>
                <div id="submenu-gestao" class="submenu">
                    <a href="contas-pagar.html" class="nav-item">
                        <span class="nav-icon">üí≥</span>
                        Contas a Pagar
                    </a>
                    <a href="contas-receber.html" class="nav-item">
                        <span class="nav-icon">ü§ë</span>
                        Contas a Receber
                    </a>
                    <a href="fluxo-caixa.html" class="nav-item">
                        <span class="nav-icon">üìà</span>
                        Fluxo de Caixa
                    </a>
                </div>

                <div class="nav-separator"></div>

                <a href="dre.html" class="nav-item">
                    <span class="nav-icon">üìã</span>
                    DRE
                </a>
                <a href="analiticos.html" class="nav-item">
                    <span class="nav-icon">üîç</span>
                    Anal√≠ticos
                </a>
                <a href="relatorios.html" class="nav-item">
                    <span class="nav-icon">üìÑ</span>
                    Relat√≥rios
                </a>
            </nav>
            <div class="logout-section">
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Dashboard Comercial</h1>
                <p class="page-subtitle">Vis√£o completa do pipeline de vendas e performance comercial</p>
            </div>

            <!-- Filtro de M√™s com Bot√µes -->
            <div class="chart-card" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <label style="font-weight: 600; color: var(--text-dark); margin-right: 10px;">Per√≠odo:</label>
                    <input type="hidden" id="monthFilter" value="2025-11">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="selectMonth('2025-10')" id="btn-2025-10" class="month-btn" style="padding: 12px 24px; border: 2px solid var(--primary-green); border-radius: 8px; font-size: 14px; font-weight: 600; background: white; color: var(--primary-green); cursor: pointer; transition: all 0.3s ease;">
                            Outubro 2025
                        </button>
                        <button onclick="selectMonth('2025-11')" id="btn-2025-11" class="month-btn month-btn-active" style="padding: 12px 24px; border: 2px solid var(--primary-green); border-radius: 8px; font-size: 14px; font-weight: 600; background: var(--primary-green); color: white; cursor: pointer; transition: all 0.3s ease;">
                            Novembro 2025
                        </button>
                        <button onclick="selectMonth('2025-12')" id="btn-2025-12" class="month-btn" style="padding: 12px 24px; border: 2px solid var(--primary-green); border-radius: 8px; font-size: 14px; font-weight: 600; background: white; color: var(--primary-green); cursor: pointer; transition: all 0.3s ease;">
                            Dezembro 2025
                        </button>
                    </div>
                </div>
            </div>

            <style>
                .month-btn:hover {
                    background: var(--secondary-green) !important;
                    color: white !important;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                }
                .month-btn-active {
                    background: var(--primary-green) !important;
                    color: white !important;
                }
            </style>

            <!-- KPIs Principais -->
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="kpi-card">
                    <div class="kpi-label">Total de Contratos Fechados (TCV)</div>
                    <div class="kpi-value" id="kpiTotalContratos">R$ 0</div>
                    <div class="kpi-trend" id="kpiTotalTrend">-</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-label">Ticket M√©dio</div>
                    <div class="kpi-value" id="kpiTicketMedio">R$ 0</div>
                    <div class="kpi-trend" id="kpiTicketTrend">-</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-label">Contratos Fechados</div>
                    <div class="kpi-value" id="kpiNumeroContratos">0</div>
                    <div class="kpi-trend" id="kpiNumeroTrend">-</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-label">MRR Novos Contratos</div>
                    <div class="kpi-value" id="kpiMRR">R$ 0</div>
                    <div class="kpi-trend" id="kpiMRRTrend">-</div>
                </div>

                <div class="kpi-card" style="border-left: 4px solid #3498db;">
                    <div class="kpi-label">LTV/CAC Ratio</div>
                    <div class="kpi-value" id="kpiLtvCac">-</div>
                    <div class="kpi-trend" id="kpiLtvCacTrend">Meta: > 3x</div>
                </div>

                <div class="kpi-card" style="border-left: 4px solid #e67e22;">
                    <div class="kpi-label">DSO - Prazo Recebimento</div>
                    <div class="kpi-value" id="kpiDSO">-</div>
                    <div class="kpi-trend" id="kpiDSOTrend">Meta: < 30 dias</div>
                </div>

                <div class="kpi-card" style="border-left: 4px solid #2ecc71;">
                    <div class="kpi-label">Working Capital</div>
                    <div class="kpi-value" id="kpiWorkingCapital">R$ 0</div>
                    <div class="kpi-trend" id="kpiWorkingCapitalTrend">-</div>
                </div>

                <div class="kpi-card" style="border-left: 4px solid #9b59b6;">
                    <div class="kpi-label">MRR Growth Rate</div>
                    <div class="kpi-value" id="kpiMrrGrowth">-</div>
                    <div class="kpi-trend" id="kpiMrrGrowthTrend">Meta: +10%/m√™s</div>
                </div>
            </div>

            <!-- Proje√ß√µes -->
            <div class="chart-card" style="margin-bottom: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="chart-card-header" style="border-bottom-color: rgba(255,255,255,0.2);">
                    <h3 class="chart-card-title" style="color: white;" id="projecoesTitle">üéØ Proje√ß√µes - Novembro 2025</h3>
                </div>
                <div style="padding: 20px;">
                    <style>
                        .projections-grid {
                            display: grid;
                            grid-template-columns: repeat(6, 1fr);
                            gap: 20px;
                        }
                        @media (max-width: 1800px) {
                            .projections-grid {
                                grid-template-columns: repeat(3, 1fr);
                            }
                        }
                        @media (max-width: 1200px) {
                            .projections-grid {
                                grid-template-columns: repeat(2, 1fr);
                            }
                        }
                        @media (max-width: 768px) {
                            .projections-grid {
                                grid-template-columns: 1fr;
                            }
                        }
                    </style>
                    <div class="projections-grid">
                        <!-- Proje√ß√£o MRR Mensal -->
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üìà Proje√ß√£o MRR Mensal</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;" id="projecaoMRR">R$ 34.768</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="projecaoMRRDesc">Total a receber recorrente</div>
                        </div>

                        <!-- Faturamento em Contratos -->
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí∞ Faturamento Contratos</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;" id="faturamentoContratos">R$ 0</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="faturamentoDesc">Valor mensal dos contratos</div>
                        </div>

                        <!-- TCV - Total Contract Value -->
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üìä TCV - Total Fechado</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;" id="tcvTotal">R$ 0</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="tcvDesc">Valor total dos contratos</div>
                        </div>

                        <!-- Meta M√™s -->
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;" id="metaMesLabel">üéØ Meta do M√™s</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;" id="metaMesValor">R$ 90.000</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="metaDesc">Meta em contratos fechados</div>
                        </div>

                        <!-- Atingimento da Meta -->
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üéñÔ∏è Atingimento</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;" id="atingimentoPercent">0%</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="atingimentoDesc">Da meta mensal</div>
                        </div>

                        <!-- Pipeline Ativo -->
                        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üî• Pipeline Ativo</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;" id="pipelineTotal">R$ 0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Oportunidades em negocia√ß√£o</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">Funil de Vendas</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">Convers√µes Mensais</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="conversionsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">Vendas por Origem</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">Performance Mensal</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- An√°lises Financeiras Avan√ßadas -->
            <div class="charts-grid" style="margin-top: 30px;">
                <!-- Cash Flow Forecast -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">üí∞ Cash Flow Forecast (90 dias)</h3>
                    </div>
                    <div style="padding: 20px;">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>

                <!-- Aging de Receb√≠veis -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">üìÖ Aging de Receb√≠veis</h3>
                    </div>
                    <div style="padding: 20px;">
                        <canvas id="agingChart"></canvas>
                        <div style="margin-top: 15px; font-size: 12px; color: #666;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>üü¢ 0-30 dias:</span>
                                <strong id="aging0-30">R$ 0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>üü° 31-60 dias:</span>
                                <strong id="aging31-60">R$ 0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>üü† 61-90 dias:</span>
                                <strong id="aging61-90">R$ 0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>üî¥ > 90 dias:</span>
                                <strong id="aging90plus">R$ 0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- An√°lise de Margem e Efici√™ncia -->
            <div class="chart-card full-width" style="margin-top: 30px;">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">üìä An√°lise de Margem e Efici√™ncia Operacional</h3>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px;">
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Margem Bruta</div>
                            <div style="font-size: 32px; font-weight: 700; color: #2ecc71;" id="margemBruta">-</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">Meta: > 80%</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">EBITDA</div>
                            <div style="font-size: 32px; font-weight: 700; color: #3498db;" id="ebitda">-</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">Meta: > 30%</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Margem L√≠quida</div>
                            <div style="font-size: 32px; font-weight: 700; color: #9b59b6;" id="margemLiquida">-</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">Meta: > 20%</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Cash Conversion Cycle</div>
                            <div style="font-size: 32px; font-weight: 700; color: #e67e22;" id="ccc">-</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">DSO - DPO</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Break-Even</div>
                            <div style="font-size: 32px; font-weight: 700; color: #e74c3c;" id="breakEven">-</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">clientes necess√°rios</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sistema de Alertas -->
            <div class="chart-card full-width" style="margin-top: 30px; border-left: 4px solid #f39c12;">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">üö® Alertas e Insights Autom√°ticos</h3>
                </div>
                <div id="alertsContainer" style="padding: 20px;">
                    <!-- Alertas ser√£o inseridos via JavaScript -->
                </div>
            </div>

            <!-- Contratos Fechados -->
            <div class="chart-card full-width">
                <div class="chart-card-header">
                    <h3 class="chart-card-title" id="contratosFechadosTitle">Contratos Fechados - Novembro 2025</h3>
                </div>
                <table class="pipeline-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Valor Mensal</th>
                            <th>Dura√ß√£o</th>
                            <th>Valor Total</th>
                            <th>Data Fechamento</th>
                            <th>Observa√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="contratosFechadosBody">
                        <!-- Preenchido via JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pipeline Detalhado -->
            <div class="chart-card full-width">
                <div class="chart-card-header">
                    <h3 class="chart-card-title" id="pipelineTitle">Pipeline Ativo - Novembro 2025</h3>
                </div>
                <table class="pipeline-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Est√°gio</th>
                            <th>Valor Estimado</th>
                            <th>Probabilidade</th>
                            <th>Previs√£o Fechamento</th>
                            <th>Origem</th>
                        </tr>
                    </thead>
                    <tbody id="pipelineTableBody">
                        <!-- Preenchido via JavaScript -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // Prote√ß√£o de autentica√ß√£o
        if (!isAuthenticated()) {
            window.location.href = '../login.html';
        } else {
            console.log('‚úÖ Usu√°rio autenticado, iniciando dashboard...');
        }

        // Dados dos Contratos Fechados por M√™s
        const contratosFechadosPorMes = {
            '2025-10': [],
            '2025-11': [
                { cliente: 'Smart Home', valorMensal: 297, duracao: 'Recorrente', valorTotal: 297, dataFechamento: '15/11/2025', obs: 'R$ 297/m√™s + 15% das vendas' },
                { cliente: 'Suprema Pizza', valorMensal: 2000, duracao: '3 meses', valorTotal: 6000, dataFechamento: '18/11/2025', obs: 'Contrato de 3 meses' },
                { cliente: 'Saporitto Pizzaria', valorMensal: 2500, duracao: '6 meses', valorTotal: 15000, dataFechamento: '20/11/2025', obs: 'Plano Premium' },
                { cliente: 'Saporitto Pizzaria', valorMensal: 1500, duracao: '6 meses', valorTotal: 9000, dataFechamento: '20/11/2025', obs: 'Plano B√°sico' },
                { cliente: 'Shield Car', valorMensal: 297, duracao: 'Recorrente', valorTotal: 297, dataFechamento: '22/11/2025', obs: 'R$ 297/m√™s + comiss√£o' }
            ],
            '2025-12': [],
            '2026-01': [],
            '2026-02': [],
            '2026-03': []
        };

        // Dados do Pipeline Ativo por M√™s
        const pipelinePorMes = {
            '2025-10': [],
            '2025-11': [],
            '2025-12': [],
            '2026-01': [],
            '2026-02': [],
            '2026-03': []
        };

        let charts = {};

        // Fun√ß√£o para atualizar KPIs
        function updateKPIs(mes) {
            console.log('üìä Atualizando KPIs para:', mes);
            const contratos = contratosFechadosPorMes[mes] || [];
            console.log('üìã Contratos encontrados:', contratos.length);

            // Calcular totais
            const totalContratos = contratos.reduce((sum, c) => sum + c.valorTotal, 0);
            const numeroContratos = contratos.length;
            const ticketMedio = numeroContratos > 0 ? totalContratos / numeroContratos : 0;
            const mrrNovos = contratos.reduce((sum, c) => sum + c.valorMensal, 0);

            console.log('üí∞ Total:', totalContratos, 'Ticket M√©dio:', ticketMedio, 'MRR:', mrrNovos);

            // Atualizar DOM
            document.getElementById('kpiTotalContratos').textContent = `R$ ${totalContratos.toLocaleString('pt-BR')}`;
            document.getElementById('kpiTicketMedio').textContent = `R$ ${ticketMedio.toLocaleString('pt-BR', {maximumFractionDigits: 0})}`;
            document.getElementById('kpiNumeroContratos').textContent = numeroContratos;
            document.getElementById('kpiMRR').textContent = `R$ ${mrrNovos.toLocaleString('pt-BR')}`;

            // Trends (comparar com m√™s anterior se poss√≠vel)
            document.getElementById('kpiTotalTrend').textContent = numeroContratos > 0 ? `${numeroContratos} contratos fechados` : 'Nenhum contrato';
            document.getElementById('kpiTicketTrend').textContent = numeroContratos > 0 ? 'M√©dia por contrato' : '-';
            document.getElementById('kpiNumeroTrend').textContent = numeroContratos > 0 ? 'Total do per√≠odo' : '-';
            document.getElementById('kpiMRRTrend').textContent = numeroContratos > 0 ? 'Receita mensal recorrente' : '-';
        }

        // Fun√ß√£o para atualizar tabela de contratos fechados
        function updateContratosFechados(mes) {
            const contratos = contratosFechadosPorMes[mes] || [];
            const tbody = document.getElementById('contratosFechadosBody');
            tbody.innerHTML = '';

            if (contratos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-light);">Nenhum contrato fechado neste per√≠odo</td></tr>';
                return;
            }

            contratos.forEach(contrato => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${contrato.cliente}</strong></td>
                    <td>R$ ${contrato.valorMensal.toLocaleString('pt-BR')}</td>
                    <td>${contrato.duracao}</td>
                    <td><strong style="color: var(--success)">R$ ${contrato.valorTotal.toLocaleString('pt-BR')}</strong></td>
                    <td>${contrato.dataFechamento}</td>
                    <td style="font-size: 13px; color: var(--text-light);">${contrato.obs}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fun√ß√£o para atualizar tabela de pipeline
        function updatePipeline(mes) {
            const pipeline = pipelinePorMes[mes] || [];
            const tbody = document.getElementById('pipelineTableBody');
            tbody.innerHTML = '';

            if (pipeline.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-light);">Nenhuma oportunidade ativa neste per√≠odo</td></tr>';
                return;
            }

            pipeline.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.cliente}</td>
                    <td><span class="status-badge ${item.estagio}">${item.estagio.toUpperCase()}</span></td>
                    <td>R$ ${item.valor.toLocaleString('pt-BR')}</td>
                    <td>${item.probabilidade}</td>
                    <td>${item.fechamento}</td>
                    <td>${item.origem}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fun√ß√£o para selecionar m√™s via bot√µes
        function selectMonth(mes) {
            // Atualizar valor hidden
            document.getElementById('monthFilter').value = mes;

            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.classList.remove('month-btn-active');
                btn.style.background = 'white';
                btn.style.color = 'var(--primary-green)';
            });

            // Adicionar classe active ao bot√£o clicado
            const btnClicado = document.getElementById(`btn-${mes}`);
            if (btnClicado) {
                btnClicado.classList.add('month-btn-active');
                btnClicado.style.background = 'var(--primary-green)';
                btnClicado.style.color = 'white';
            }

            // Atualizar dashboard
            updateDashboard();
        }

        // Fun√ß√£o principal de atualiza√ß√£o
        function updateDashboard() {
            const mes = document.getElementById('monthFilter').value;
            const mesNome = {
                '2025-10': 'Outubro 2025',
                '2025-11': 'Novembro 2025',
                '2025-12': 'Dezembro 2025',
                '2026-01': 'Janeiro 2026',
                '2026-02': 'Fevereiro 2026',
                '2026-03': 'Mar√ßo 2026'
            }[mes];

            // Atualizar t√≠tulos
            document.getElementById('contratosFechadosTitle').textContent = `Contratos Fechados - ${mesNome}`;
            document.getElementById('pipelineTitle').textContent = `Pipeline Ativo - ${mesNome}`;

            // Atualizar dados
            updateKPIs(mes);
            updateContratosFechados(mes);
            updatePipeline(mes);
            updatePipelineTotal(mes);
            updateProjecoes(mes);
        }

        // Fun√ß√£o para atualizar total do pipeline
        function updatePipelineTotal(mes) {
            const pipeline = pipelinePorMes[mes] || [];
            const total = pipeline.reduce((sum, p) => sum + p.valor, 0);
            const pipelineElement = document.getElementById('pipelineTotal');
            if (pipelineElement) {
                pipelineElement.textContent = `R$ ${total.toLocaleString('pt-BR')}`;
            }
        }

        // Fun√ß√£o para atualizar proje√ß√µes
        function updateProjecoes(mes) {
            const mesNome = {
                '2025-10': 'Outubro',
                '2025-11': 'Novembro',
                '2025-12': 'Dezembro',
                '2026-01': 'Janeiro',
                '2026-02': 'Fevereiro',
                '2026-03': 'Mar√ßo'
            }[mes];

            const mesCompleto = {
                '2025-10': 'Outubro 2025',
                '2025-11': 'Novembro 2025',
                '2025-12': 'Dezembro 2025',
                '2026-01': 'Janeiro 2026',
                '2026-02': 'Fevereiro 2026',
                '2026-03': 'Mar√ßo 2026'
            }[mes];

            // Metas por m√™s
            const metas = {
                '2025-10': 30000,
                '2025-11': 90000,
                '2025-12': 120000,
                '2026-01': 100000,
                '2026-02': 120000,
                '2026-03': 120000
            };

            // Dados reais de MRR por m√™s (Total a Receber)
            const mrrRealPorMes = {
                '2025-10': {
                    totalReceber: 0,
                    recebido: 0,
                    pendente: 0,
                    taxaRecebimento: 0
                },
                '2025-11': {
                    totalReceber: 34768.18,
                    recebido: 12924.18,
                    pendente: 21844.00,
                    taxaRecebimento: 37.2
                },
                '2025-12': {
                    totalReceber: 70000, // Proje√ß√£o MRR Dezembro
                    recebido: 0,
                    pendente: 0,
                    taxaRecebimento: 0
                },
                '2026-01': {
                    totalReceber: 0,
                    recebido: 0,
                    pendente: 0,
                    taxaRecebimento: 0
                },
                '2026-02': {
                    totalReceber: 0,
                    recebido: 0,
                    pendente: 0,
                    taxaRecebimento: 0
                },
                '2026-03': {
                    totalReceber: 0,
                    recebido: 0,
                    pendente: 0,
                    taxaRecebimento: 0
                }
            };

            // Proje√ß√£o de MRR (baseada no Total a Receber + proje√ß√µes futuras)
            const projecaoMRR = {
                '2025-11': { valor: 34768, percentual: -17, descricao: 'MRR Real' },
                '2025-12': { valor: 42000, percentual: 0, descricao: 'Proje√ß√£o' },
                '2026-01': { valor: 48000, percentual: 15, descricao: 'Proje√ß√£o' },
                '2026-02': { valor: 52000, percentual: 24, descricao: 'Proje√ß√£o' },
                '2026-03': { valor: 56000, percentual: 34, descricao: 'Proje√ß√£o' }
            };

            // Atualizar t√≠tulo
            document.getElementById('projecoesTitle').textContent = `üéØ Proje√ß√µes - ${mesCompleto}`;

            // Obter dados de MRR do m√™s
            const mrrDados = mrrRealPorMes[mes] || mrrRealPorMes['2025-11'];

            // 1. Atualizar MRR Mensal (Total a Receber)
            document.getElementById('projecaoMRR').textContent = `R$ ${mrrDados.totalReceber.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('projecaoMRRDesc').textContent = `Total a receber recorrente`;

            // 2. Obter contratos do m√™s
            const contratos = contratosFechadosPorMes[mes] || [];

            // Calcular Faturamento (soma dos valores mensais)
            const faturamentoMensal = contratos.reduce((sum, c) => sum + c.valorMensal, 0);
            document.getElementById('faturamentoContratos').textContent = `R$ ${faturamentoMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('faturamentoDesc').textContent = `${contratos.length} contrato${contratos.length !== 1 ? 's' : ''} fechado${contratos.length !== 1 ? 's' : ''}`;

            // 3. Calcular TCV (soma dos valores totais)
            const tcvTotal = contratos.reduce((sum, c) => sum + c.valorTotal, 0);
            document.getElementById('tcvTotal').textContent = `R$ ${tcvTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('tcvDesc').textContent = `Valor total dos contratos`;

            // 4. Atualizar Meta do m√™s
            const metaMes = metas[mes] || 0;
            document.getElementById('metaMesLabel').textContent = `üéØ Meta ${mesNome}`;
            document.getElementById('metaMesValor').textContent = `R$ ${metaMes.toLocaleString('pt-BR')}`;
            document.getElementById('metaDesc').textContent = `Meta em contratos fechados`;

            // 5. Calcular Atingimento
            const percentualMeta = metaMes > 0 ? Math.round((tcvTotal / metaMes) * 100) : 0;
            document.getElementById('atingimentoPercent').textContent = `${percentualMeta}%`;

            let statusAtingimento = '';
            if (percentualMeta >= 100) statusAtingimento = 'üéâ Meta atingida!';
            else if (percentualMeta >= 80) statusAtingimento = 'üî• Quase l√°!';
            else if (percentualMeta >= 50) statusAtingimento = 'üìà No caminho certo';
            else if (percentualMeta > 0) statusAtingimento = '‚è≥ Em andamento';
            else statusAtingimento = 'üéØ Vamos come√ßar!';

            document.getElementById('atingimentoDesc').textContent = statusAtingimento;
        }

        // Inicializar gr√°ficos
        // Gr√°fico: Funil de Vendas
        const funnelCtx = document.getElementById('funnelChart').getContext('2d');
        charts.funnel = new Chart(funnelCtx, {
            type: 'bar',
            data: {
                labels: ['Prospec√ß√£o', 'Qualifica√ß√£o', 'Proposta', 'Negocia√ß√£o', 'Fechado'],
                datasets: [{
                    label: 'N√∫mero de Oportunidades',
                    data: [45, 32, 18, 12, 8],
                    backgroundColor: [
                        'rgba(33, 150, 243, 0.7)',
                        'rgba(255, 152, 0, 0.7)',
                        'rgba(156, 39, 176, 0.7)',
                        'rgba(255, 235, 59, 0.7)',
                        'rgba(76, 175, 80, 0.7)'
                    ],
                    borderColor: [
                        'rgba(33, 150, 243, 1)',
                        'rgba(255, 152, 0, 1)',
                        'rgba(156, 39, 176, 1)',
                        'rgba(255, 235, 59, 1)',
                        'rgba(76, 175, 80, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Gr√°fico: Convers√µes Mensais
        const conversionsCtx = document.getElementById('conversionsChart').getContext('2d');
        charts.conversions = new Chart(conversionsCtx, {
            type: 'line',
            data: {
                labels: ['Out', 'Nov'],
                datasets: [{
                    label: 'Vendas Fechadas',
                    data: [4, 5],
                    borderColor: '#4A6B54',
                    backgroundColor: 'rgba(74, 107, 84, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Gr√°fico: Vendas por Origem
        const sourceCtx = document.getElementById('sourceChart').getContext('2d');
        charts.source = new Chart(sourceCtx, {
            type: 'doughnut',
            data: {
                labels: ['Indica√ß√£o', 'Website', 'LinkedIn', 'Instagram', 'Cold Call'],
                datasets: [{
                    data: [35, 28, 18, 12, 7],
                    backgroundColor: [
                        '#4A6B54',
                        '#7A9B84',
                        '#B8D4BE',
                        '#27ae60',
                        '#f39c12'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Gr√°fico: Performance Mensal (Valor de Contratos Fechados)
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        charts.performance = new Chart(performanceCtx, {
            type: 'bar',
            data: {
                labels: ['Out', 'Nov', 'Dez'],
                datasets: [
                    {
                        label: 'Meta',
                        data: [30000, 90000, 120000],
                        backgroundColor: 'rgba(231, 76, 60, 0.5)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Realizado',
                        data: [24000, 30594, 0],
                        backgroundColor: 'rgba(74, 107, 84, 0.7)',
                        borderColor: 'rgba(74, 107, 84, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Mostrar menu Gest√£o apenas para CEO
        function showGestaoMenuForCEO() {
            if (typeof isCEO === 'function' && isCEO()) {
                const gestaoMenu = document.getElementById('menu-gestao-financeira');
                if (gestaoMenu) {
                    gestaoMenu.style.setProperty('display', 'flex', 'important');
                }
            }
        }

        // Inicializar dashboard com dados de novembro
        console.log('üöÄ Inicializando dashboard...');
        console.log('üì¶ Dados dispon√≠veis:', Object.keys(contratosFechadosPorMes));

        // Aguardar DOM estar totalmente carregado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('‚úÖ DOM carregado, chamando updateDashboard()');
                updateDashboard();
                showGestaoMenuForCEO();
            });
        } else {
            console.log('‚úÖ DOM j√° carregado, chamando updateDashboard()');
            updateDashboard();
            showGestaoMenuForCEO();
        }
    </script>
</body>
</html>
