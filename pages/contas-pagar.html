<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contas a Pagar - STARK Intelligence</title>
    <script src="../auth.js"></script>
    <script src="../theme.js"></script>
    <script src="../js/stark-core.js"></script>
    <script src="../js/stark-realtime.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #4A6B54;
            --secondary-green: #7A9B84;
            --light-green: #B8D4BE;
            --bg-gray: #f5f7fa;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #e1e8ed;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-gray);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--primary-green);
            color: var(--white);
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 100;
            transition: transform 0.2s ease;
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-image {
            width: 140px;
            height: auto;
            display: block;
            margin: 0 auto 15px;
        }

        .company-info {
            text-align: center;
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 8px;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--white);
            border-left-color: var(--light-green);
        }

        .nav-item.active {
            background-color: rgba(255,255,255,0.15);
            color: var(--white);
            border-left-color: var(--white);
            font-weight: 600;
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            transition: margin-left 0.2s ease;
        }

        .sidebar-toggle {
            position: fixed;
            top: 90px;
            left: 260px;
            transform: translateX(-50%);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--white);
            color: var(--text-dark);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            z-index: 120;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .sidebar-collapsed .sidebar {
            transform: translateX(-100%);
        }

        .sidebar-collapsed .main-content {
            margin-left: 0;
        }

        .sidebar-collapsed .sidebar-toggle {
            left: 18px;
            transform: none;
        }

        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-title-section {
            flex: 1;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-light);
            font-size: 14px;
        }

        /* Controls Bar */
        .controls-bar {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-selector-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .month-select {
            padding: 10px 15px;
            border: 2px solid var(--primary-green);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            background-color: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .month-select:focus {
            outline: none;
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 3px rgba(74, 107, 84, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .import-status {
            display: flex;
            align-items: stretch;
            gap: 16px;
            flex-wrap: wrap;
        }

        .import-status-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg-gray);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 14px;
            min-width: 220px;
        }

        .import-status-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .import-status-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 160px;
        }

        .import-status-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .import-status-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .diagnostic-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .diagnostic-table th,
        .diagnostic-table td {
            border-bottom: 1px solid var(--border-color);
            padding: 8px 6px;
            text-align: left;
        }

        .diagnostic-table th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-light);
        }

        .diagnostic-section {
            margin-top: 16px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-gray);
        }

        .diagnostic-section-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-dark);
        }

        .diagnostic-list {
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-green);
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-secondary {
            background-color: var(--bg-gray);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .summary-card.total::before { background-color: var(--info); }
        .summary-card.pago::before { background-color: var(--success); }
        .summary-card.pendente::before { background-color: var(--warning); }
        .summary-card.taxa::before { background-color: var(--primary-green); }

        .summary-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .summary-value.success { color: var(--success); }
        .summary-value.warning { color: var(--warning); }

        .summary-change {
            font-size: 12px;
            margin-top: 8px;
        }

        .summary-change.positive { color: var(--success); }

        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
        }

        .progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--light-green));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-light);
        }

        /* Data Table */
        .data-table-container {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-gray) 0%, var(--white) 100%);
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--white);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        .filter-badge {
            background: var(--primary-green);
            color: white;
            border-radius: 999px;
            font-size: 11px;
            padding: 2px 6px;
            margin-left: 6px;
            display: inline-flex;
            align-items: center;
            line-height: 1;
        }

        /* Campo de Pesquisa */
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 8px 12px 8px 35px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
            width: 200px;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(74, 107, 84, 0.1);
            width: 250px;
        }

        .search-input::placeholder {
            color: var(--text-light);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: var(--text-light);
            font-size: 14px;
        }

        .clear-search {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 16px;
            display: none;
            padding: 2px 6px;
        }

        .clear-search:hover {
            color: var(--danger-color);
        }

        .search-input:not(:placeholder-shown) + .clear-search {
            display: block;
        }

        /* Dropdown RÃ¡pido de Categoria */
        .category-badge {
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .category-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .category-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-dropdown.active {
            display: block;
        }

        .category-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .category-dropdown-item:last-child {
            border-bottom: none;
        }

        .category-dropdown-item:hover {
            background: #f8f9fa;
        }

        .category-dropdown-item.selected {
            background: rgba(74, 107, 84, 0.1);
            color: var(--primary-green);
            font-weight: 600;
        }

        .category-dropdown-item .cat-icon {
            font-size: 16px;
        }

        .category-cell {
            position: relative;
        }

        /* Filtros Visuais Modernos */
        .filters-bar {
            display: flex;
            gap: 15px;
            padding: 15px 20px;
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-gray);
            border-radius: 10px;
            padding: 4px;
        }

        .filter-group-label {
            font-size: 11px;
            color: var(--text-light);
            padding-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-chip {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            background: transparent;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-light);
            font-weight: 500;
        }

        .filter-chip:hover {
            background: rgba(74, 107, 84, 0.1);
            color: var(--primary-green);
        }

        .filter-chip.active {
            background: var(--primary-green);
            color: white;
        }

        .filter-chip.pessoal.active { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
        .filter-chip.comercial.active { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
        .filter-chip.estrutura.active { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .filter-chip.ferramentas.active { background: linear-gradient(135deg, #06b6d4, #22d3ee); }
        .filter-chip.alpha.active { background: linear-gradient(135deg, #ec4899, #f472b6); }

        .filter-divider {
            width: 1px;
            height: 30px;
            background: var(--border-color);
        }

        .filters-summary {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-light);
        }

        .filters-summary strong {
            color: var(--primary-green);
            font-weight: 600;
        }

        .table-count {
            font-size: 14px;
            color: var(--text-light);
            background: var(--bg-gray);
            padding: 6px 12px;
            border-radius: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--bg-gray);
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.text-right { text-align: right; }
        th.text-center { text-align: center; }

        td {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            font-size: 14px;
            vertical-align: middle;
        }

        td.text-right { text-align: right; }
        td.text-center { text-align: center; }

        tr {
            transition: background-color 0.2s ease;
        }

        tr:hover {
            background-color: rgba(74, 107, 84, 0.03);
        }

        tr.row-pago {
            background-color: rgba(39, 174, 96, 0.05);
        }

        tr.row-custom {
            border-left: 3px solid var(--info);
        }

        tr.row-vencido {
            background-color: rgba(231, 76, 60, 0.08);
        }

        /* Drag and Drop Styles */
        tr[draggable="true"] {
            cursor: grab;
        }

        tr[draggable="true"]:active {
            cursor: grabbing;
        }

        tr.dragging {
            opacity: 0.5;
            background: #e3f2fd !important;
        }

        tr.drag-over {
            border-top: 3px solid var(--primary-green);
        }

        tr.drag-over-bottom {
            border-bottom: 3px solid var(--primary-green);
        }

        .drag-handle {
            cursor: grab;
            color: #ccc;
            padding-right: 10px;
            user-select: none;
        }

        .drag-handle:hover {
            color: var(--primary-green);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .vencimento-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .vencimento-badge.vencido {
            background: #ffebee;
            color: #c62828;
        }

        .vencimento-badge.hoje {
            background: #fff3e0;
            color: #e65100;
        }

        .vencimento-badge.proximo {
            background: #fff8e1;
            color: #f57f17;
        }

        .item-name {
            font-weight: 500;
            color: var(--text-dark);
        }

        .item-info {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .custom-badge {
            display: inline-block;
            background: var(--info);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .parcial-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
            cursor: help;
        }

        .category-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .category-pessoal { background: #e8f5e9; color: #2e7d32; }
        .category-comercial { background: #e3f2fd; color: #1565c0; }
        .category-estrutura { background: #fff3e0; color: #ef6c00; }
        .category-ferramentas { background: #f3e5f5; color: #7b1fa2; }
        .category-alpha { background: #fff8e1; color: #f57f17; }
        .category-outros { background: #eceff1; color: #546e7a; }

        .amount {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-dark);
        }

        /* Status Toggle Switch */
        .status-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #e74c3c;
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #27ae60;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::before {
            transform: translateX(24px);
        }

        .toggle-label {
            font-size: 12px;
            font-weight: 600;
            min-width: 60px;
        }

        .toggle-label.pendente { color: #e74c3c; }
        .toggle-label.pago { color: #27ae60; }

        .payment-date {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .status-badge-pago {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: #28a745;
        }

        .status-badge-pendente {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            color: #856404;
            border-color: #ffc107;
        }

        .status-badge-vencido {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-color: #dc3545;
            animation: pulse-warning 2s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
        }

        .status-icon {
            font-size: 14px;
            font-weight: 700;
        }

        .status-text {
            white-space: nowrap;
        }

        /* Date Badges */
        .date-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .date-badge-pago {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .date-badge-empty {
            background: #f5f5f5;
            color: #999;
        }

        /* Import Area Styles */
        .import-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-gray);
        }

        .import-area:hover, .import-area.dragover {
            border-color: var(--primary-green);
            background: rgba(74, 107, 84, 0.05);
        }

        .import-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .reconciliation-list {
            max-height: 640px;
            overflow-y: auto;
        }

        .group-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin: 15px 0 8px 0;
        }

        .group-card {
            background: var(--bg-gray);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .group-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .group-card.active {
            border-color: var(--primary-green);
            background: rgba(74, 107, 84, 0.08);
            box-shadow: 0 2px 10px rgba(74, 107, 84, 0.15);
        }

        .group-card-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
        }

        .group-card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }

        .group-card-value {
            font-weight: 700;
            color: var(--text-dark);
            margin-top: 6px;
            font-size: 14px;
        }

        .group-filter-info {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .import-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-light);
        }

        .import-summary strong {
            color: var(--text-dark);
        }

        .reconcile-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1.2fr 0.6fr 1.4fr 0.6fr;
            gap: 15px;
            align-items: center;
        }

        .reconcile-item.matched {
            border-left: 4px solid var(--success);
        }

        .reconcile-item.unmatched {
            border-left: 4px solid var(--warning);
        }

        .bank-transaction {
            font-size: 13px;
        }

        .bank-desc { font-weight: 600; color: var(--text-dark); }
        .bank-date { color: var(--text-light); font-size: 11px; }
        .bank-amount { font-weight: 700; }

        .match-suggestion {
            font-size: 13px;
            padding: 8px;
            background: var(--bg-gray);
            border-radius: 6px;
        }

        .import-fields {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .import-selects {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
        }

        .import-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .import-action-btn {
            padding: 6px 10px;
            font-size: 12px;
        }

        .date-badge-imported {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .import-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-light);
        }

        .import-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        @media (max-width: 900px) {
            .reconcile-item {
                grid-template-columns: 1fr;
                align-items: flex-start;
            }

            .import-selects {
                grid-template-columns: 1fr;
            }

            .import-actions {
                align-items: flex-start;
            }
        }

        /* Action Buttons */in Table */
        .row-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .action-btn.edit {
            background: #e3f2fd;
            color: #1565c0;
        }

        .action-btn.edit:hover {
            background: #1565c0;
            color: white;
        }

        .action-btn.delete {
            background: #ffebee;
            color: #c62828;
        }

        .action-btn.delete:hover {
            background: #c62828;
            color: white;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 550px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .import-modal {
            max-width: 1200px;
            max-height: 97vh;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-gray);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--border-color);
            color: var(--text-dark);
        }

        .modal-body {
            padding: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(74, 107, 84, 0.1);
        }

        .form-input.error {
            border-color: var(--danger);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-gray);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--text-dark);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { background: var(--success); }
        .toast.warning { background: var(--warning); }
        .toast.error { background: var(--danger); }

        /* Confirm Dialog */
        .confirm-dialog {
            text-align: center;
            padding: 20px 0;
        }

        .confirm-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .confirm-message {
            font-size: 16px;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .confirm-details {
            font-size: 14px;
            color: var(--text-light);
        }

        /* Filter Indicator */
        .filter-indicator {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-indicator-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-indicator-icon {
            font-size: 24px;
        }

        .filter-indicator-text {
            font-size: 14px;
            color: #856404;
        }

        .filter-indicator-text strong {
            color: #5d4507;
            font-weight: 700;
        }

        .filter-indicator-stats {
            background: rgba(255,255,255,0.7);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: #5d4507;
            font-weight: 600;
        }

        .filter-indicator-stats span {
            font-weight: 700;
            color: #d97706;
        }

        .filter-indicator-clear {
            margin-left: auto;
            background: #fff;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-indicator-clear:hover {
            background: #c62828;
            color: #fff;
            border-color: #c62828;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .table-actions {
                justify-content: flex-start;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 12px 10px;
            }

            .row-actions {
                flex-direction: column;
                gap: 4px;
            }
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: var(--bg-gray);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-light);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-toggle-btn:hover {
            color: var(--text-dark);
        }

        .view-toggle-btn.active {
            background: var(--white);
            color: var(--primary-green);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Kanban Board */
        .kanban-container {
            display: none;
            margin-bottom: 30px;
        }

        .kanban-container.active {
            display: block;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            min-height: 500px;
        }

        @media (max-width: 1024px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
        }

        .kanban-column {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 16px;
            min-height: 400px;
        }

        .kanban-column.pendente {
            border-top: 4px solid var(--danger);
        }

        .kanban-column.parcial {
            border-top: 4px solid var(--warning);
        }

        .kanban-column.pago {
            border-top: 4px solid var(--success);
        }

        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .kanban-column-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kanban-column-count {
            background: var(--white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
        }

        .kanban-column-total {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 300px;
        }

        .kanban-card {
            background: var(--white);
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            cursor: grab;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .kanban-card:active {
            cursor: grabbing;
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .kanban-card.custom {
            border-left-color: var(--info);
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .kanban-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .kanban-card-amount {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-green);
            white-space: nowrap;
        }

        .kanban-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .kanban-card-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .kanban-card-badge.category {
            background: var(--bg-gray);
            color: var(--text-light);
        }

        .kanban-card-badge.vencido {
            background: #ffebee;
            color: #c62828;
        }

        .kanban-card-badge.hoje {
            background: #fff3e0;
            color: #e65100;
        }

        .kanban-card-badge.proximo {
            background: #e3f2fd;
            color: #1565c0;
        }

        .kanban-card-actions {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .kanban-action-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kanban-action-btn.pay {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .kanban-action-btn.pay:hover {
            background: #2e7d32;
            color: white;
        }

        .kanban-action-btn.unpay {
            background: #fff3e0;
            color: #e65100;
        }

        .kanban-action-btn.unpay:hover {
            background: #e65100;
            color: white;
        }

        .kanban-column.drag-over {
            background: rgba(74, 107, 84, 0.1);
        }

        .kanban-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
            font-size: 14px;
        }

        .kanban-empty-icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Kanban Card Enhanced */
        .kanban-card {
            position: relative;
        }

        .kanban-card:hover {
            cursor: pointer;
        }

        .kanban-card .card-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-gray);
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .kanban-card:hover .card-edit-btn {
            opacity: 1;
        }

        .kanban-card .card-edit-btn:hover {
            background: var(--primary-green);
            color: white;
        }

        /* Kanban Card Delete Button */
        .kanban-card .card-delete-btn {
            position: absolute;
            top: 8px;
            right: 42px;
            width: 28px;
            height: 28px;
            border: none;
            background: #ffebee;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #c62828;
        }

        .kanban-card:hover .card-delete-btn {
            opacity: 1;
        }

        .kanban-card .card-delete-btn:hover {
            background: #c62828;
            color: white;
            transform: scale(1.1);
        }

        /* Kanban Card Status Styles */
        .kanban-card.status-pago {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }

        .kanban-card.status-pago .kanban-card-amount {
            color: #27ae60;
        }

        .kanban-card.status-pendente {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }

        .kanban-card.status-vencido {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            animation: pulse-vencido 2s infinite;
        }

        @keyframes pulse-vencido {
            0%, 100% { box-shadow: 0 2px 6px rgba(231, 76, 60, 0.2); }
            50% { box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4); }
        }

        .kanban-card.status-vencido .kanban-card-amount {
            color: #e74c3c;
        }

        /* Card info extra */
        .kanban-card-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-light);
            margin-top: 8px;
        }

        .kanban-card-date {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kanban-card-date.vencido {
            color: #e74c3c;
            font-weight: 600;
        }

        .kanban-card-date.pago {
            color: #27ae60;
        }

        /* Drag over feedback */
        .kanban-column.drag-over .kanban-column-content {
            background: rgba(74, 107, 84, 0.1);
            border: 2px dashed var(--primary-green);
            border-radius: 8px;
        }

        /* Delete confirmation in card */
        .kanban-delete-confirm {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-radius: 10px;
            z-index: 10;
        }

        .kanban-delete-confirm p {
            font-size: 13px;
            color: var(--text-dark);
            text-align: center;
        }

        .kanban-delete-confirm-btns {
            display: flex;
            gap: 8px;
        }

        .kanban-delete-confirm-btns button {
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .kanban-delete-confirm-btns .confirm-yes {
            background: #e74c3c;
            color: white;
        }

        .kanban-delete-confirm-btns .confirm-no {
            background: var(--bg-gray);
            color: var(--text-dark);
        }

        /* Modal de Pagamento Kanban */
        .kanban-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .kanban-modal-overlay.active {
            display: flex;
        }

        .kanban-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: kanbanModalSlideIn 0.3s ease;
        }

        @keyframes kanbanModalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .kanban-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #f8faf9 0%, #ffffff 100%);
            border-radius: 16px 16px 0 0;
        }

        .kanban-modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kanban-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-gray);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-light);
            transition: all 0.2s ease;
        }

        .kanban-modal-close:hover {
            background: #ffebee;
            color: #e74c3c;
        }

        .kanban-modal-body {
            padding: 24px;
        }

        .kanban-modal-item-info {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .kanban-modal-item-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .kanban-modal-item-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-green);
        }

        .kanban-modal-item-category {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        .kanban-form-group {
            margin-bottom: 16px;
        }

        .kanban-form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .kanban-form-group input,
        .kanban-form-group select,
        .kanban-form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .kanban-form-group input:focus,
        .kanban-form-group select:focus,
        .kanban-form-group textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(74, 107, 84, 0.1);
        }

        .kanban-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .kanban-status-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .kanban-status-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kanban-status-option:hover {
            border-color: var(--text-light);
        }

        .kanban-status-option.selected {
            border-color: var(--primary-green);
            background: rgba(74, 107, 84, 0.1);
        }

        .kanban-status-option .status-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .kanban-status-option .status-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .kanban-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--bg-gray);
            border-radius: 0 0 16px 16px;
        }

        .kanban-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kanban-modal-btn.cancel {
            border: 2px solid var(--border-color);
            background: white;
            color: var(--text-dark);
        }

        .kanban-modal-btn.cancel:hover {
            background: var(--bg-gray);
        }

        .kanban-modal-btn.save {
            border: none;
            background: linear-gradient(135deg, var(--primary-green) 0%, #5d8a6b 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 107, 84, 0.3);
        }

        .kanban-modal-btn.save:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(74, 107, 84, 0.4);
        }

        .kanban-modal-btn.delete {
            border: 2px solid #e74c3c;
            background: white;
            color: #e74c3c;
        }

        .kanban-modal-btn.delete:hover {
            background: #e74c3c;
            color: white;
        }

        /* ============================================
           CHECKBOXES E BARRA DE AÃÃES EM MASSA
           ============================================ */
        .row-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #4A6B54;
        }

        .checkbox-cell {
            width: 40px !important;
            text-align: center;
            padding: 0 10px !important;
        }

        tr.selected {
            background: rgba(74, 107, 84, 0.15) !important;
        }

        tr.selected:hover {
            background: rgba(74, 107, 84, 0.2) !important;
        }

        /* Barra de aÃ§Ãµes flutuante */
        .bulk-actions-bar {
            display: none !important;
        }

        .bulk-actions-bar.visible {
            display: none !important;
        }

        .bulk-actions-bar .selected-count {
            color: #4A6B54;
            font-weight: 700;
            font-size: 15px;
            padding-right: 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .bulk-actions-bar .selected-total {
            color: #eee;
            font-size: 14px;
            padding-right: 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .bulk-action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .bulk-action-btn.primary {
            background: linear-gradient(135deg, #4A6B54, #5d8a6b);
            color: white;
        }

        .bulk-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 107, 84, 0.4);
        }

        .bulk-action-btn.danger {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .bulk-action-btn.danger:hover {
            background: #e74c3c;
            color: white;
        }

        .bulk-action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #ccc;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .bulk-action-btn.secondary:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .bulk-close-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            margin-left: 10px;
        }

        .bulk-close-btn:hover {
            color: #e74c3c;
        }

        .bulk-action-btn.category {
            background: rgba(155, 89, 182, 0.15);
            color: #b39ddb;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }

        .bulk-action-btn.category:hover {
            background: rgba(155, 89, 182, 0.3);
        }

        .bulk-action-btn.date {
            background: rgba(52, 152, 219, 0.15);
            color: #64b5f6;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .bulk-action-btn.date:hover {
            background: rgba(52, 152, 219, 0.3);
        }

        .bulk-dropdown-wrapper {
            position: relative;
        }

        .bulk-category-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            margin-bottom: 10px;
        }

        .bulk-category-dropdown.active {
            display: block;
            animation: dropdownUp 0.2s ease;
        }

        @keyframes dropdownUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bulk-category-dropdown .cat-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #333;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .bulk-category-dropdown .cat-item:last-child {
            border-bottom: none;
        }

        .bulk-category-dropdown .cat-item:hover {
            background: #f8f9fa;
        }

        .bulk-category-dropdown .cat-item .cat-icon {
            font-size: 18px;
        }

        /* Filtro de selecionados */
        .filter-btn[data-filter="selecionados"] {
            background: rgba(74, 107, 84, 0.2);
            border-color: #4A6B54;
        }

        .filter-btn[data-filter="selecionados"].active {
            background: #4A6B54;
            color: white;
        }

        .date-picker {
            position: absolute;
            background: #fff;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 280px;
            z-index: 4000;
            display: none;
            user-select: none;
        }

        .date-picker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .date-picker-nav {
            cursor: pointer;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 2px 6px;
            color: #4A6B54;
        }

        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 8px 10px 12px;
        }

        .date-picker-day-name {
            text-align: center;
            font-size: 11px;
            color: #7f8c8d;
            padding: 4px 0;
        }

        .date-picker-day {
            text-align: center;
            font-size: 12px;
            padding: 6px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .date-picker-day:hover {
            background: #f0f4f1;
        }

        .date-picker-day.is-other {
            color: #b8bfc6;
        }

        .date-picker-day.is-today {
            border: 1px solid #4A6B54;
        }

        .date-picker-day.is-selected {
            background: #4A6B54;
            color: white;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <button class="sidebar-toggle" id="sidebarToggle" type="button">â¨</button>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../logo-starken.png" alt="STARK Intelligence" class="logo-image">
                <div class="company-info">STARK Intelligence<br>Starken Tecnologia Ltda</div>
            </div>
            <nav class="sidebar-nav">
                <a href="../index.html" class="nav-item">
                    <span class="nav-icon">ð</span>
                    Dashboard Financeiro
                </a>
                <a href="dashboard-comercial.html" class="nav-item">
                    <span class="nav-icon">ð¼</span>
                    Dashboard Comercial
                </a>

                <div class="nav-separator"></div>

                <a href="stark.html" class="nav-item">
                    <span class="nav-icon">â¡</span>
                    STARK - CFO Virtual
                </a>

                <div class="nav-separator"></div>

                <!-- Menu GestÃ£o Financeira ExpansÃ­vel -->
                <div class="nav-item nav-item-expandable" data-menu="submenu-gestao" onclick="ThemeManager.toggleSubMenu('submenu-gestao')">
                    <span class="nav-icon">ð°</span>
                    GestÃ£o Financeira
                    <span class="menu-arrow">â¶</span>
                </div>
                <div id="submenu-gestao" class="submenu expanded">
                    <a href="contas-pagar.html" class="nav-item active">
                        <span class="nav-icon">ð³</span>
                        Contas a Pagar
                    </a>
                    <a href="contas-receber.html" class="nav-item">
                        <span class="nav-icon">ð¤</span>
                        Contas a Receber
                    </a>
                    <a href="fluxo-caixa.html" class="nav-item">
                        <span class="nav-icon">ð</span>
                        Fluxo de Caixa
                    </a>
                    <a href="financeiro-pessoal.html" class="nav-item">
                        <span class="nav-icon">ð</span>
                        FinanÃ§as Pessoais
                    </a>
                </div>

                <div class="nav-separator"></div>

                <a href="dre.html" class="nav-item">
                    <span class="nav-icon">ð</span>
                    DRE
                </a>
                <a href="analiticos.html" class="nav-item">
                    <span class="nav-icon">ð</span>
                    AnalÃ­ticos
                </a>
                <a href="relatorios.html" class="nav-item">
                    <span class="nav-icon">ð</span>
                    RelatÃ³rios
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title-section">
                    <h1 class="page-title">Contas a Pagar</h1>
                    <p class="page-subtitle" id="pageSubtitle">GestÃ£o completa de despesas e pagamentos</p>
                </div>
            </div>

            <!-- Controls Bar -->
            <div class="controls-bar">
                <div class="month-selector">
                    <span class="month-selector-label">ð PerÃ­odo:</span>
                    <select class="month-select" id="monthSelect" onchange="changeMonth()">
                        <option value="2025-10">Outubro 2025</option>
                        <option value="2025-11">Novembro 2025</option>
                        <option value="2025-12">Dezembro 2025</option>
                        <option value="2026-01">Janeiro 2026</option>
                        <option value="2026-02">Fevereiro 2026</option>
                        <option value="2026-03">MarÃ§o 2026</option>
                        <option value="2026-04">Abril 2026</option>
                        <option value="2026-05">Maio 2026</option>
                        <option value="2026-06">Junho 2026</option>
                    </select>
                </div>
                <div class="month-selector">
                    <span class="month-selector-label">ð·ï¸ Categoria:</span>
                    <select class="month-select" id="categorySelect" onchange="changeCategory()" style="min-width: 180px;">
                        <option value="todas">Todas as Categorias</option>
                        <option value="pessoal">Pessoal / SalÃ¡rios</option>
                        <option value="comercial">Comercial</option>
                        <option value="estrutura">Estrutura / Aluguel</option>
                        <option value="ferramentas">Ferramentas / Software</option>
                        <option value="alpha_franquia">Alpha Franquia</option>
                        <option value="alimentacao">AlimentaÃ§Ã£o</option>
                        <option value="operacionais">Operacionais</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="openAddModal()">
                        â Nova Despesa
                    </button>
                    <button class="btn btn-primary" onclick="openImportModal()" style="background-color: #6610f2; border-color: #6610f2;" title="Importar Extrato BancÃ¡rio (OFX/CSV)">
                        ð¥ Importar
                    </button>
                    <button class="btn btn-primary" onclick="exportarBackup()" title="Salvar backup dos dados">
                        ð¾ Backup
                    </button>
                    <button class="btn btn-secondary" onclick="exportarParaProducao()" title="Enviar dados locais para produÃ§Ã£o">
                        ð Exportar ProduÃ§Ã£o
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" title="Restaurar dados de backup">
                        ð Restaurar
                    </button>
                    <button class="btn btn-secondary" onclick="openImportDiagnostics()" title="DiagnÃ³stico das importaÃ§Ãµes">
                        ð DiagnÃ³stico
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarBackup(this)">
                </div>
                <div class="import-status">
                    <div class="import-status-card">
                        <span class="import-status-title">Extratos do Asaas</span>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãltima importaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastImportAsaas">-</span>
                        </div>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãltima conciliaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastReconcileAsaas">-</span>
                        </div>
                    </div>
                    <div class="import-status-card">
                        <span class="import-status-title">Extratos do Conta Simples</span>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãltima importaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastImportContaSimples">-</span>
                        </div>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãltima conciliaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastReconcileContaSimples">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicador de Filtro Ativo -->
            <div class="filter-indicator" id="filterIndicator" style="display: none;">
                <div class="filter-indicator-content">
                    <span class="filter-indicator-icon">ð</span>
                    <span class="filter-indicator-text">Filtrando por: <strong id="filterCategoryName">-</strong></span>
                    <span class="filter-indicator-stats">
                        <span id="filterTotal">R$ 0</span> em
                        <span id="filterCount">0</span> despesas
                    </span>
                    <button class="filter-indicator-clear" onclick="clearCategoryFilter()">â Limpar filtro</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card total">
                    <div class="summary-icon">ð³</div>
                    <div class="summary-label">Total de Despesas</div>
                    <div class="summary-value" id="totalDespesas">R$ 0,00</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressPago">R$ 0 pago</span>
                            <span id="progressPendente">R$ 0 pendente</span>
                        </div>
                    </div>
                </div>
                <div class="summary-card pago">
                    <div class="summary-icon">â</div>
                    <div class="summary-label">Pagas no MÃªs</div>
                    <div class="summary-value success" id="totalPago">R$ 0,00</div>
                    <div class="summary-change positive" id="qtdPagas">0 despesas pagas</div>
                </div>
                <div class="summary-card pendente">
                    <div class="summary-icon">â³</div>
                    <div class="summary-label">Pendente</div>
                    <div class="summary-value warning" id="totalPendente">R$ 0,00</div>
                    <div class="summary-change" id="qtdPendentes">0 despesas pendentes</div>
                </div>
                <div class="summary-card taxa">
                    <div class="summary-icon">ð</div>
                    <div class="summary-label">Taxa de Pagamento</div>
                    <div class="summary-value" id="taxaPagamento">0%</div>
                    <div class="summary-change" id="metaStatus">Meta: 100%</div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="controls-bar" style="padding: 15px 20px;">
                <div class="table-title" style="font-size: 16px;">
                    ð Despesas do MÃªs
                </div>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" onclick="setView('table')" id="viewTableBtn">
                            ð Tabela
                        </button>
                        <button class="view-toggle-btn" onclick="setView('kanban')" id="viewKanbanBtn">
                            ð Kanban
                        </button>
                    </div>
                    <div class="search-input-wrapper">
                        <span class="search-icon">ð</span>
                        <input type="text" class="search-input" id="searchInput" placeholder="Buscar por nome..." oninput="filtrarPorPesquisa()">
                        <button class="clear-search" onclick="limparPesquisa()">Ã</button>
                    </div>
                    <div class="table-actions">
                        <button class="filter-btn active" data-filter="todos" onclick="filtrarDespesas('todos')">Todos</button>
                        <button class="filter-btn" data-filter="pendente" onclick="filtrarDespesas('pendente')">Pendentes</button>
                        <button class="filter-btn" data-filter="pago" onclick="filtrarDespesas('pago')">Pagos</button>
                        <button class="filter-btn" onclick="openAdvancedFilters()">Filtros avanÃ§ados <span class="filter-badge" id="advancedFilterBadge" style="display: none;">0</span></button>
                        <span class="table-count" id="tableCount">0 registros</span>
                    </div>
                </div>
            </div>

            <!-- Kanban View -->
            <div class="kanban-container" id="kanbanContainer">
                <div class="kanban-board">
                    <div class="kanban-column pendente" data-status="pendente"
                         ondragover="handleKanbanDragOver(event)"
                         ondragleave="handleKanbanDragLeave(event)"
                         ondrop="handleKanbanDrop(event, 'pendente')">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                ð´ Pendente
                                <span class="kanban-column-count" id="kanbanPendenteCount">0</span>
                            </div>
                            <div class="kanban-column-total" id="kanbanPendenteTotal">R$ 0</div>
                        </div>
                        <div class="kanban-cards" id="kanbanPendente">
                            <!-- Cards dinÃ¢micos -->
                        </div>
                    </div>

                    <div class="kanban-column parcial" data-status="parcial"
                         ondragover="handleKanbanDragOver(event)"
                         ondragleave="handleKanbanDragLeave(event)"
                         ondrop="handleKanbanDrop(event, 'parcial')">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                ð¡ Vencendo
                                <span class="kanban-column-count" id="kanbanParcialCount">0</span>
                            </div>
                            <div class="kanban-column-total" id="kanbanParcialTotal">R$ 0</div>
                        </div>
                        <div class="kanban-cards" id="kanbanParcial">
                            <!-- Cards dinÃ¢micos -->
                        </div>
                    </div>

                    <div class="kanban-column pago" data-status="pago"
                         ondragover="handleKanbanDragOver(event)"
                         ondragleave="handleKanbanDragLeave(event)"
                         ondrop="handleKanbanDrop(event, 'pago')">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                ð¢ Pago
                                <span class="kanban-column-count" id="kanbanPagoCount">0</span>
                            </div>
                            <div class="kanban-column-total" id="kanbanPagoTotal">R$ 0</div>
                        </div>
                        <div class="kanban-cards" id="kanbanPago">
                            <!-- Cards dinÃ¢micos -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros Visuais -->
            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-group-label">Status</span>
                    <button class="filter-chip active" data-filter="todos" onclick="filtrarDespesas('todos')">Todos</button>
                    <button class="filter-chip" data-filter="pendente" onclick="filtrarDespesas('pendente')">â³ Pendentes</button>
                    <button class="filter-chip" data-filter="pago" onclick="filtrarDespesas('pago')">â Pagos</button>
                </div>

                <div class="filter-divider"></div>

                <div class="filter-group">
                    <span class="filter-group-label">Categoria</span>
                    <button class="filter-chip pessoal" data-filter="pessoal" onclick="filtrarDespesas('pessoal')">ð¤ Pessoal</button>
                    <button class="filter-chip comercial" data-filter="comercial" onclick="filtrarDespesas('comercial')">ð Comercial</button>
                    <button class="filter-chip estrutura" data-filter="estrutura" onclick="filtrarDespesas('estrutura')">ð¢ Estrutura</button>
                    <button class="filter-chip ferramentas" data-filter="ferramentas" onclick="filtrarDespesas('ferramentas')">ð ï¸ Ferramentas</button>
                    <button class="filter-chip alpha" data-filter="alpha" onclick="filtrarDespesas('alpha')">â­ Alpha</button>
                </div>

                <div class="filters-summary">
                    <span id="filtersSummary">Mostrando <strong>todos</strong> os registros</span>
                </div>
            </div>

            <!-- Data Table -->
            <div class="data-table-container" id="tableContainer">
                <div class="table-header" style="display: none;">
                    <div class="table-title">
                        ð Despesas do MÃªs
                    </div>
                    <div class="table-actions">
                        <button class="filter-btn active" data-filter="todos" onclick="filtrarDespesas('todos')">Todos</button>
                        <button class="filter-btn" data-filter="pendente" onclick="filtrarDespesas('pendente')">Pendentes</button>
                        <button class="filter-btn" data-filter="pago" onclick="filtrarDespesas('pago')">Pagos</button>
                        <button class="filter-btn" data-filter="selecionados" onclick="filtrarDespesas('selecionados')" id="btnSelecionados" style="display: none;">ð Selecionados (<span id="countSelecionados">0</span>)</button>
                        <span class="table-count" id="tableCount2">0 registros</span>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="selectAll" class="row-checkbox" onclick="toggleSelectAll(this)" title="Selecionar todos"></th>
                            <th style="width: 23%;">DescriÃ§Ã£o</th>
                            <th style="width: 11%;">Categoria</th>
                            <th class="text-center" style="width: 11%;">Vencimento</th>
                            <th class="text-center" style="width: 11%;">Pagamento</th>
                            <th class="text-right" style="width: 11%;">Valor</th>
                            <th class="text-center" style="width: 11%;">Status</th>
                            <th class="text-center" style="width: 12%;">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dados carregados dinamicamente -->
                    </tbody>
                    <tfoot id="tableFooter">
                        <tr style="background: linear-gradient(135deg, #4A6B54 0%, #5d8a6b 100%); color: white; font-weight: 600;">
                            <td colspan="5" style="padding: 15px 20px; font-size: 16px;">TOTAL FILTRADO</td>
                            <td class="text-right" style="padding: 15px 20px; font-size: 18px;" id="totalFiltrado">R$ 0,00</td>
                            <td colspan="2" style="padding: 15px 20px; text-align: center;" id="totalInfo">0 despesas</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal: Adicionar/Editar Despesa -->
    <div class="modal-overlay" id="despesaModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nova Despesa</h3>
                <button class="modal-close" onclick="closeModal('despesaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="despesaForm">
                    <input type="hidden" id="editMode" value="add">
                    <input type="hidden" id="originalName" value="">
                    <input type="hidden" id="isCustomItem" value="false">

                    <div class="form-group full-width">
                        <label class="form-label">DescriÃ§Ã£o <span class="required">*</span></label>
                        <input type="text" class="form-input" id="despesaNome" placeholder="Ex: Aluguel do escritÃ³rio" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor <span class="required">*</span></label>
                            <input type="text" class="form-input" id="despesaValor" placeholder="R$ 0,00" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="despesaCategoria">
                                <option value="pessoal">Pessoal / SalÃ¡rios</option>
                                <option value="comercial">Comercial</option>
                                <option value="estrutura">Estrutura / Aluguel</option>
                                <option value="ferramentas">Ferramentas / Software</option>
                                <option value="alpha_franquia">Alpha Franquia</option>
                                <option value="alimentacao">AlimentaÃ§Ã£o</option>
                                <option value="operacionais">Operacionais</option>
                                <option value="outros" selected>Outros</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Grupo</label>
                            <input type="text" class="form-input" id="despesaTipo" placeholder="Ex: Mensageria/CobranÃ§a, Taxas BancÃ¡rias">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="text" class="form-input js-date-input" id="despesaVencimento" placeholder="dd/mm/aaaa">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="despesaStatus">
                                <option value="A Pagar">A Pagar</option>
                                <option value="Pago">Pago</option>
                            </select>
                        </div>
                        <div class="form-group" id="dataPagamentoGroup" style="display: none;">
                            <label class="form-label">Data do Pagamento</label>
                            <input type="text" class="form-input js-date-input" id="despesaDataPagamento" placeholder="dd/mm/aaaa">
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('despesaModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveDespesa()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Importar Extrato -->
    <div class="modal-overlay" id="importModal">
        <div class="modal import-modal">
            <div class="modal-header">
                <h3 class="modal-title">Importar Extrato BancÃ¡rio</h3>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Passo 1: Upload -->
                <div id="importStep1">
                    <div class="import-area" id="dropZone" onclick="document.getElementById('bankFile').click()">
                        <div class="import-icon">ð</div>
                        <h4 style="margin-bottom: 10px;">Arraste seu extrato aqui</h4>
                        <p style="color: var(--text-light); font-size: 13px;">Suporta arquivos OFX e CSV</p>
                        <input type="file" id="bankFile" accept=".ofx,.csv" style="display: none" onchange="handleBankFile(this)">
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <p class="small" style="color: var(--text-light);">
                            Recomendamos usar o formato <strong>OFX</strong> para maior precisÃ£o.
                        </p>
                    </div>
                </div>

                <!-- Passo 2: ConciliaÃ§Ã£o -->
                <div id="importStep2" style="display: none;">
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0;">ConciliaÃ§Ã£o de TransaÃ§Ãµes</h4>
                        <div class="summary-badges">
                            <span class="date-badge date-badge-pago" id="foundCount">0 Encontrados</span>
                            <span class="date-badge date-badge-empty" id="newCount">0 Novos</span>
                        </div>
                    </div>
                    <div class="import-summary">
                        <div>MÃªs ativo: <strong id="importMonthLabel">-</strong></div>
                        <div>PerÃ­odo OFX: <strong id="importOfxRange">-</strong></div>
                    </div>
                    <div class="import-hint">Edite descriÃ§Ã£o, grupo, categoria e status antes de confirmar. Clique em um grupo para filtrar.</div>
                    <div class="group-summary" id="groupSummary"></div>
                    <div class="group-filter-info" id="groupFilterInfo"></div>
                    
                    <div class="reconciliation-list" id="reconciliationList">
                        <!-- Lista de transaÃ§Ãµes gerada via JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancelar</button>
                <button class="btn btn-secondary" id="btnRestoreImport" onclick="restoreLastImports(1)" style="display: none;">
                    Restaurar Ãºltimo import
                </button>
                <button class="btn btn-primary" id="btnProcessImport" onclick="processReconciliation()" style="display: none;">
                    Confirmar ImportaÃ§Ã£o
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="diagnosticModal">
        <div class="modal" style="max-width: 820px;">
            <div class="modal-header">
                <h3 class="modal-title">DiagnÃ³stico de ImportaÃ§Ãµes</h3>
                <button class="modal-close" onclick="closeModal('diagnosticModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="diagnosticContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="refreshImportDiagnostics()">Atualizar</button>
                <button class="btn btn-warning" onclick="clearBaseItemsForTargetMonths()">Limpar base Nov-Dez-Jan</button>
                <button class="btn btn-danger" onclick="resetImportsForTargetMonths()">Resetar Nov-Dez-Jan</button>
                <button class="btn btn-primary" onclick="closeModal('diagnosticModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="customValueModal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h3 class="modal-title" id="customValueTitle">Criar</h3>
                <button class="modal-close" onclick="closeCustomValueModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" id="customValueLabel">Nome</label>
                    <input type="text" class="form-input" id="customValueInput" placeholder="">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomValueModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmCustomValue()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmar ExclusÃ£o -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar ExclusÃ£o</h3>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirm-dialog">
                    <div class="confirm-icon">â ï¸</div>
                    <div class="confirm-message">Tem certeza que deseja excluir esta despesa?</div>
                    <div class="confirm-details" id="deleteDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmar Pagamento -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title" id="paymentModalTitle">Confirmar Pagamento</h3>
                <button class="modal-close" onclick="closeModal('paymentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #7f8c8d;">Valor Total</div>
                    <div style="font-size: 24px; font-weight: 700; color: #2c3e50;" id="paymentTotalValue">R$ 0,00</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de Pagamento</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="paymentType" value="full" checked onchange="togglePartialPayment()">
                            <span style="font-weight: 500;">Pagamento Total</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="paymentType" value="partial" onchange="togglePartialPayment()">
                            <span style="font-weight: 500;">Pagamento Parcial</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="partialValueGroup" style="display: none;">
                    <label class="form-label">Valor a Pagar Agora <span class="required">*</span></label>
                    <input type="text" class="form-input" id="partialValue" placeholder="R$ 0,00" oninput="maskMoney(this); updateRemainingValue()">
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                        <span style="color: #7f8c8d;">Valor restante:</span>
                        <span style="color: #e74c3c; font-weight: 600;" id="remainingValue">R$ 0,00</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Data do Pagamento</label>
                    <input type="text" class="form-input js-date-input" id="paymentDate" placeholder="dd/mm/aaaa">
                </div>

                <div id="partialNote" style="display: none; background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 8px; font-size: 13px; color: #856404;">
                    <strong>Nota:</strong> SerÃ¡ criada uma nova despesa com o valor restante automaticamente.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmPayment()">Confirmar Pagamento</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="advancedFilterModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3 class="modal-title">Filtros AvanÃ§ados</h3>
                <button class="modal-close" onclick="closeModal('advancedFilterModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Vencimento (de)</label>
                        <input type="text" class="form-input js-date-input" id="filterVencimentoMin" placeholder="dd/mm/aaaa">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vencimento (atÃ©)</label>
                        <input type="text" class="form-input js-date-input" id="filterVencimentoMax" placeholder="dd/mm/aaaa">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Pagamento (de)</label>
                        <input type="text" class="form-input js-date-input" id="filterPagamentoMin" placeholder="dd/mm/aaaa">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pagamento (atÃ©)</label>
                        <input type="text" class="form-input js-date-input" id="filterPagamentoMax" placeholder="dd/mm/aaaa">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor mÃ­nimo</label>
                        <input type="text" class="form-input" id="filterValorMin" placeholder="R$ 0,00" oninput="maskMoney(this)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor mÃ¡ximo</label>
                        <input type="text" class="form-input" id="filterValorMax" placeholder="R$ 0,00" oninput="maskMoney(this)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="clearAdvancedFilters()">Limpar</button>
                <button class="btn btn-primary" onclick="applyAdvancedFilters()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastIcon">â</span>
        <span id="toastMessage">OperaÃ§Ã£o realizada com sucesso!</span>
    </div>

    <!-- Scripts -->
    <script src="../dados-mensais.js"></script>
    <script src="../gestao-financeira.js"></script>
    <script>
        // Estado global
        // Calcular mÃªs atual automaticamente
        const hoje = new Date();
        const anoAtual = hoje.getFullYear();
        const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
        let currentMonth = `${anoAtual}-${mesAtual}`;

        let currentFilter = 'todos';
        let currentCategory = 'todas';
        let pendingDelete = null;
        let pendingPayment = null;
        let allItems = []; // Armazena todos os itens para filtrar

        // Formatar valor em BRL
        function formatMoney(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Parse valor BRL para nÃºmero
        function parseMoney(value) {
            if (!value) return 0;
            // Remove R$, espaÃ§os e pontos de milhar, troca vÃ­rgula por ponto
            let cleaned = value
                .replace(/R\$\s*/g, '')  // Remove R$
                .replace(/\./g, '')       // Remove pontos (separador de milhar)
                .replace(',', '.')        // Troca vÃ­rgula por ponto (decimal)
                .trim();
            return parseFloat(cleaned) || 0;
        }

        // MÃ¡scara de valor
        function maskMoney(input) {
            let value = input.value.replace(/\D/g, '');
            if (!value) {
                input.value = 'R$ 0,00';
                return;
            }
            // Converter para nÃºmero e formatar
            let numValue = parseInt(value) / 100;
            // Usar toLocaleString para formataÃ§Ã£o brasileira correta
            input.value = 'R$ ' + numValue.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Mapear categorias
        function getCategoryName(categoria) {
            if (typeof categoriaLabels !== 'undefined' && categoriaLabels[categoria]) {
                return categoriaLabels[categoria];
            }
            const map = {
                'pessoal': 'Pessoal',
                'locacao_aluguel': 'Estrutura',
                'adiantamentos': 'Adiantamentos',
                'alpha_franquia': 'Alpha',
                'outros': 'Outros',
                'ferramentas': 'Ferramentas',
                'alimentacao': 'AlimentaÃ§Ã£o',
                'operacionais': 'Operacional',
                'combustivel': 'CombustÃ­vel',
                'comercial': 'Comercial',
                'estrutura': 'Estrutura',
                'equipamentos': 'Equipamentos',
                'servicos': 'ServiÃ§os'
            };
            return map[categoria] || categoria.charAt(0).toUpperCase() + categoria.slice(1);
        }

        function getGroupLabel(grupo) {
            if (typeof grupoLabels !== 'undefined' && grupoLabels[grupo]) {
                return grupoLabels[grupo];
            }
            return grupo;
        }

        // Obter classe da categoria
        function getCategoryClass(categoria) {
            const map = {
                'pessoal': 'category-pessoal',
                'comercial': 'category-comercial',
                'estrutura': 'category-estrutura',
                'ferramentas': 'category-ferramentas',
                'alpha_franquia': 'category-alpha',
                'locacao_aluguel': 'category-estrutura',
                'equipamentos': 'category-ferramentas'
            };
            return map[categoria] || 'category-outros';
        }

        // Formatar data
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleString('pt-BR');
        }

        function formatDateInput(dateStr) {
            if (!dateStr) return '';
            if (String(dateStr).includes('/')) return dateStr;
            return formatDate(dateStr);
        }

        function parseDateInputToISO(value) {
            const raw = String(value || '').trim();
            if (!raw) return '';
            if (raw.includes('/')) {
                const [d, m, y] = raw.split('/');
                if (!d || !m || !y) return '';
                return `${y.padStart(4, '0')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }
            if (raw.includes('-')) return raw;
            return '';
        }

        function parseInputToDate(value) {
            const iso = parseDateInputToISO(value);
            if (!iso) return null;
            const date = new Date(iso + 'T00:00:00');
            if (Number.isNaN(date.getTime())) return null;
            return date;
        }

        function formatDateFromDate(date) {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        let datePickerEl = null;
        const datePickerState = { year: 0, month: 0, selected: null, input: null };

        function ensureDatePicker() {
            if (datePickerEl) return;
            datePickerEl = document.createElement('div');
            datePickerEl.className = 'date-picker';
            document.body.appendChild(datePickerEl);
        }

        function positionDatePicker(input) {
            const rect = input.getBoundingClientRect();
            const top = rect.bottom + window.scrollY + 6;
            const left = rect.left + window.scrollX;
            datePickerEl.style.top = `${top}px`;
            datePickerEl.style.left = `${left}px`;
        }

        function isSameDate(a, b) {
            return a && b && a.getFullYear() === b.getFullYear()
                && a.getMonth() === b.getMonth()
                && a.getDate() === b.getDate();
        }

        function renderDatePicker() {
            const monthNames = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const dayNames = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
            const { year, month, selected } = datePickerState;
            const firstOfMonth = new Date(year, month, 1);
            const startDay = firstOfMonth.getDay();
            const startDate = new Date(year, month, 1 - startDay);
            const today = new Date();

            let daysHtml = '';
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const isOther = date.getMonth() !== month;
                const isToday = isSameDate(date, today);
                const isSelected = selected && isSameDate(date, selected);
                const iso = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const classes = [
                    'date-picker-day',
                    isOther ? 'is-other' : '',
                    isToday ? 'is-today' : '',
                    isSelected ? 'is-selected' : ''
                ].filter(Boolean).join(' ');
                daysHtml += `<div class="${classes}" data-date="${iso}">${date.getDate()}</div>`;
            }

            datePickerEl.innerHTML = `
                <div class="date-picker-header">
                    <span class="date-picker-nav" data-dir="-1">â¹</span>
                    <span>${monthNames[month]} ${year}</span>
                    <span class="date-picker-nav" data-dir="1">âº</span>
                </div>
                <div class="date-picker-grid">
                    ${dayNames.map(name => `<div class="date-picker-day-name">${name}</div>`).join('')}
                    ${daysHtml}
                </div>
            `;

            datePickerEl.querySelectorAll('.date-picker-nav').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const dir = parseInt(btn.dataset.dir, 10);
                    const next = new Date(datePickerState.year, datePickerState.month + dir, 1);
                    datePickerState.year = next.getFullYear();
                    datePickerState.month = next.getMonth();
                    renderDatePicker();
                });
            });

            datePickerEl.querySelectorAll('.date-picker-day').forEach(dayEl => {
                dayEl.addEventListener('click', () => {
                    const iso = dayEl.dataset.date;
                    if (datePickerState.input) {
                        datePickerState.input.value = formatDateInput(iso);
                        datePickerState.input.dispatchEvent(new Event('change'));
                    }
                    datePickerState.selected = parseInputToDate(iso);
                    closeDatePicker();
                });
            });
        }

        function openDatePicker(input) {
            ensureDatePicker();
            const current = parseInputToDate(input.value) || new Date();
            datePickerState.year = current.getFullYear();
            datePickerState.month = current.getMonth();
            datePickerState.selected = current;
            datePickerState.input = input;
            renderDatePicker();
            positionDatePicker(input);
            datePickerEl.style.display = 'block';
        }

        function closeDatePicker() {
            if (datePickerEl) {
                datePickerEl.style.display = 'none';
            }
            datePickerState.input = null;
        }

        function initDateInputs() {
            document.querySelectorAll('.js-date-input').forEach(input => {
                input.addEventListener('focus', () => openDatePicker(input));
                input.addEventListener('click', () => openDatePicker(input));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeDatePicker();
                });
                input.addEventListener('blur', () => {
                    if (!input.value) return;
                    const date = parseInputToDate(input.value);
                    if (date) {
                        input.value = formatDateFromDate(date);
                    }
                });
            });

            document.addEventListener('click', (e) => {
                if (!datePickerEl || datePickerEl.style.display !== 'block') return;
                if (datePickerEl.contains(e.target)) return;
                if (e.target.classList && e.target.classList.contains('js-date-input')) return;
                closeDatePicker();
            });
        }

        function buildDateForMonth(mesBase, dia) {
            const [ano, mes] = mesBase.split('-').map(Number);
            const diaNum = parseInt(dia, 10);
            if (!ano || !mes || !diaNum) return '';
            const ultimoDia = new Date(ano, mes, 0).getDate();
            const diaFinal = Math.min(diaNum, ultimoDia);
            return `${ano}-${String(mes).padStart(2, '0')}-${String(diaFinal).padStart(2, '0')}`;
        }

        function getExistingDespesaNames(mesChave) {
            const nomes = new Set();
            if (typeof dadosMensais !== 'undefined' && dadosMensais[mesChave]?.despesas?.categorias) {
                Object.values(dadosMensais[mesChave].despesas.categorias).forEach(cat => {
                    if (cat && Array.isArray(cat.itens)) {
                        cat.itens.forEach(item => {
                            if (item && item.nome) nomes.add(item.nome);
                        });
                    }
                });
            }
            if (GestaoFinanceira.customItems && GestaoFinanceira.customItems[mesChave]?.despesas) {
                GestaoFinanceira.customItems[mesChave].despesas.forEach(item => {
                    if (item && item.nome) nomes.add(item.nome);
                });
            }
            return nomes;
        }

        function gerarLancamentosRoyaltiesAlpha(mesChave) {
            const todosClientes = JSON.parse(localStorage.getItem('starken_manual_clients') || '[]');
            const deletedIds = JSON.parse(localStorage.getItem('starken_deleted_cards') || '[]').map(id => String(id));
            const deletedDespesas = new Set(GestaoFinanceira.getDeletedItems(mesChave).despesas || []);
            const royaltiesDeleted = new Set(loadRoyaltiesDeleted());
            const nomesExistentes = getExistingDespesaNames(mesChave);

            const clientesAtivos = todosClientes.filter(c => {
                if (deletedIds.includes(String(c.id))) return false;
                if (c.isProjecao && !c.mesInicio) return false;
                if (c.mesesPersonalizados && c.mesesPersonalizados.length > 0) {
                    return c.mesesPersonalizados.includes(mesChave);
                }
                if (c.statusRenovacao && c.mesRenovacao === mesChave) {
                    return true;
                }
                if (c.tipoValor === 'mrr') {
                    if (!c.mesInicio) return false;
                    const [anoInicio, mesInicio] = c.mesInicio.split('-').map(Number);
                    const dataInicio = new Date(anoInicio, mesInicio - 1, 1);
                    const [anoMes, mesMes] = mesChave.split('-').map(Number);
                    const dataMes = new Date(anoMes, mesMes - 1, 1);
                    if (c.isProjecao) {
                        const duracao = c.projecaoDuracao ? (parseInt(c.projecaoDuracao) || 12) : 12;
                        const dataFim = new Date(dataInicio);
                        dataFim.setMonth(dataFim.getMonth() + duracao);
                        return dataMes >= dataInicio && dataMes < dataFim;
                    }
                    const dataFim = new Date(dataInicio);
                    dataFim.setMonth(dataFim.getMonth() + 60);
                    return dataMes >= dataInicio && dataMes < dataFim;
                }
                return false;
            });

            clientesAtivos.forEach(c => {
                if (c.empresa !== 'alpha' || c.tipoValor !== 'mrr') return;
                if (!c.naoRepassarRoyalties) return;

                const ajusteMensal = c.ajustesMensais && c.ajustesMensais[mesChave];
                let valorBruto = ajusteMensal ? ajusteMensal.valor : c.valor;

                const datasParcelasMRR = Array.isArray(c.datasParcelasMRR) ? c.datasParcelasMRR.filter(Boolean) : [];
                const dataBaseMRR = c.dataPagamentoMRR || (datasParcelasMRR[0] || '');
                if (dataBaseMRR) {
                    const mesPrimeiroVencimento = dataBaseMRR.substring(0, 7);
                    if (mesChave < mesPrimeiroVencimento) {
                        valorBruto = 0;
                    }
                }

                if (!valorBruto || valorBruto <= 0) return;

                const parcelasMRR = parseInt(c.parcelasMRR) || 1;
                let datasParcelaFinal = [];

                if (parcelasMRR > 1 && datasParcelasMRR.length > 0) {
                    const datasNoMes = datasParcelasMRR.filter(data => data && data.substring(0, 7) === mesChave);
                    datasParcelaFinal = datasNoMes;
                    if (datasParcelaFinal.length === 0) {
                        const diasBase = datasParcelasMRR
                            .map(data => (data.includes('-') ? data.split('-')[2] : ''))
                            .filter(Boolean)
                            .slice(0, parcelasMRR);
                        datasParcelaFinal = diasBase.map(dia => buildDateForMonth(mesChave, dia)).filter(Boolean);
                    }
                }

                if (parcelasMRR > 1 && datasParcelaFinal.length > 0) {
                    const valorParcela = valorBruto / parcelasMRR;
                    const valorRoyaltyParcela = valorParcela * 0.15;
                    datasParcelaFinal.forEach((data, index) => {
                        const nome = `Alpha Royalties - ${c.nome} (${index + 1}/${parcelasMRR})`;
                        const blocked = isRoyaltiesName(nome) ? royaltiesDeleted.has(nome) : deletedDespesas.has(nome);
                        if (nomesExistentes.has(nome) || blocked) return;
                        GestaoFinanceira.addDespesa(mesChave, {
                            nome: nome,
                            valor: valorRoyaltyParcela,
                            categoria: 'alpha_franquia',
                            tipo: 'Royalties',
                            vencimento: data,
                            status: 'A Pagar',
                            empresa: 'Alpha',
                            importSource: 'royalties-alpha-smart',
                            importRunId: `royalties-${mesChave}`,
                            importedAt: new Date().toISOString()
                        });
                        nomesExistentes.add(nome);
                    });
                    return;
                }

                let vencimento = '';
                if (dataBaseMRR) {
                    const diaBase = dataBaseMRR.split('-')[2];
                    vencimento = buildDateForMonth(mesChave, diaBase);
                }

                const nome = `Alpha Royalties - ${c.nome}`;
                const blocked = isRoyaltiesName(nome) ? royaltiesDeleted.has(nome) : deletedDespesas.has(nome);
                if (nomesExistentes.has(nome) || blocked) return;
                const valorRoyalty = valorBruto * 0.15;
                GestaoFinanceira.addDespesa(mesChave, {
                    nome: nome,
                    valor: valorRoyalty,
                    categoria: 'alpha_franquia',
                    tipo: 'Royalties',
                    vencimento: vencimento,
                    status: 'A Pagar',
                    empresa: 'Alpha',
                    importSource: 'royalties-alpha-smart',
                    importRunId: `royalties-${mesChave}`,
                    importedAt: new Date().toISOString()
                });
                nomesExistentes.add(nome);
            });
        }

        // Carregar dados do mÃªs
        function loadMonthData(mes) {
            currentMonth = mes;
            restoreCustomItemsFromDeleted(mes);
            gerarLancamentosRoyaltiesAlpha(mes);
            const dados = GestaoFinanceira.getDadosMesComStatus(mes);

            if (!dados) {
                console.error('Dados nÃ£o encontrados para o mÃªs:', mes);
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#999;">Nenhum dado encontrado para este mÃªs</td></tr>';
                return;
            }

            // Atualizar subtÃ­tulo
            document.getElementById('pageSubtitle').textContent =
                `GestÃ£o completa de despesas e pagamentos - ${dados.periodo}`;
            updateImportInfo(mes);

            // Processar despesas
            const itensParaTabela = [];
            const categorias = dados.despesas.categorias;

            for (const [categoriaKey, categoriaData] of Object.entries(categorias)) {
                if (categoriaData.itens && Array.isArray(categoriaData.itens)) {
                    categoriaData.itens.forEach(item => {
                        const isPago = item.status === 'Pago' || item.status === 'Feito';
                        itensParaTabela.push({
                            ...item,
                            categoria: categoriaKey,
                            isPago: isPago
                        });
                    });
                }
            }

            // Armazenar todos os itens
            allItems = itensParaTabela;

            // Aplicar filtro de categoria e atualizar UI
            applyFiltersAndRender();
        }

        function restoreCustomItemsFromDeleted(mes) {
            const customData = GestaoFinanceira.customItems[mes];
            const deleted = GestaoFinanceira.deletedItems[mes];
            if (!deleted || !deleted.despesas || deleted.despesas.length === 0) {
                return;
            }
            const customNames = new Set((customData?.despesas || []).map(item => item.nome));
            const royaltiesDeleted = new Set(loadRoyaltiesDeleted());
            const filtered = deleted.despesas.filter(nome => {
                if (customNames.has(nome)) return false;
                if (isRoyaltiesName(nome)) return royaltiesDeleted.has(nome);
                if (isAlphaFeeName(nome)) return false;
                return true;
            });
            if (filtered.length !== deleted.despesas.length) {
                GestaoFinanceira.deletedItems[mes].despesas = filtered;
                GestaoFinanceira.saveToStorage();
            }
        }

        function clearLocalPaidForMonth(mes) {
            let removedStatus = 0;
            let removedCustom = 0;
            const statusData = GestaoFinanceira.statusData || {};
            Object.keys(statusData).forEach(id => {
                if (!id.startsWith(`${mes}_despesa_`)) return;
                const status = statusData[id]?.status;
                if (status === 'Pago' || status === 'Feito') {
                    delete statusData[id];
                    removedStatus += 1;
                }
            });
            GestaoFinanceira.statusData = statusData;

            const customItems = GestaoFinanceira.customItems || {};
            if (customItems[mes]?.despesas) {
                const before = customItems[mes].despesas.length;
                customItems[mes].despesas = customItems[mes].despesas.filter(item => {
                    const status = item?.status;
                    return status !== 'Pago' && status !== 'Feito';
                });
                removedCustom = before - customItems[mes].despesas.length;
            }
            GestaoFinanceira.customItems = customItems;
            if (typeof GestaoFinanceira.saveToStorage === 'function') {
                GestaoFinanceira.saveToStorage();
            }
            return { removedStatus, removedCustom };
        }

        function updateImportInfo(mes) {
            const importAsaasEl = document.getElementById('lastImportAsaas');
            const reconcileAsaasEl = document.getElementById('lastReconcileAsaas');
            const importContaEl = document.getElementById('lastImportContaSimples');
            const reconcileContaEl = document.getElementById('lastReconcileContaSimples');
            if (!importAsaasEl || !reconcileAsaasEl || !importContaEl || !reconcileContaEl) return;
            ensureImportMetaSynced();
            const latest = getLatestImportTimesForMonth(mes);
            const asaas = latest.asaas;
            const conta = latest.conta_simples;

            importAsaasEl.textContent = formatDateTime(asaas.lastImportAt);
            reconcileAsaasEl.textContent = formatDateTime(asaas.lastReconcileAt);
            importContaEl.textContent = formatDateTime(conta.lastImportAt);
            reconcileContaEl.textContent = formatDateTime(conta.lastReconcileAt);
        }

        let advancedFilters = {
            vencimentoMin: '',
            vencimentoMax: '',
            pagamentoMin: '',
            pagamentoMax: '',
            valorMin: null,
            valorMax: null
        };

        function getAdvancedFilterCount() {
            const keys = ['vencimentoMin', 'vencimentoMax', 'pagamentoMin', 'pagamentoMax', 'valorMin', 'valorMax'];
            return keys.reduce((acc, key) => {
                const val = advancedFilters[key];
                if (val === null || val === undefined || val === '') return acc;
                return acc + 1;
            }, 0);
        }

        function updateAdvancedFilterBadge() {
            const badge = document.getElementById('advancedFilterBadge');
            const count = getAdvancedFilterCount();
            if (badge) {
                badge.textContent = String(count);
                badge.style.display = count > 0 ? 'inline-flex' : 'none';
            }
            const summary = document.getElementById('filtersSummary');
            if (summary) {
                const base = summary.dataset.base || summary.innerHTML;
                summary.dataset.base = base;
                summary.innerHTML = base;
                if (count > 0) {
                    summary.innerHTML += ` â¢ <strong>${count} filtros avanÃ§ados</strong>`;
                }
            }
        }

        function filterItemsByAdvanced(itens) {
            let filtered = itens;
            const vencimentoMin = advancedFilters.vencimentoMin ? new Date(advancedFilters.vencimentoMin + 'T00:00:00') : null;
            const vencimentoMax = advancedFilters.vencimentoMax ? new Date(advancedFilters.vencimentoMax + 'T00:00:00') : null;
            const pagamentoMin = advancedFilters.pagamentoMin ? new Date(advancedFilters.pagamentoMin + 'T00:00:00') : null;
            const pagamentoMax = advancedFilters.pagamentoMax ? new Date(advancedFilters.pagamentoMax + 'T00:00:00') : null;
            const valorMin = advancedFilters.valorMin;
            const valorMax = advancedFilters.valorMax;

            if (vencimentoMin) {
                filtered = filtered.filter(item => item.vencimento && new Date(item.vencimento + 'T00:00:00') >= vencimentoMin);
            }
            if (vencimentoMax) {
                filtered = filtered.filter(item => item.vencimento && new Date(item.vencimento + 'T00:00:00') <= vencimentoMax);
            }
            if (pagamentoMin) {
                filtered = filtered.filter(item => item.dataPagamento && new Date(item.dataPagamento + 'T00:00:00') >= pagamentoMin);
            }
            if (pagamentoMax) {
                filtered = filtered.filter(item => item.dataPagamento && new Date(item.dataPagamento + 'T00:00:00') <= pagamentoMax);
            }
            if (valorMin !== null && valorMin !== undefined) {
                filtered = filtered.filter(item => item.valor >= valorMin);
            }
            if (valorMax !== null && valorMax !== undefined) {
                filtered = filtered.filter(item => item.valor <= valorMax);
            }
            return filtered;
        }

        function openAdvancedFilters() {
            const setValue = (id, value) => {
                const input = document.getElementById(id);
                if (input) input.value = value;
            };
            setValue('filterVencimentoMin', formatDateInput(advancedFilters.vencimentoMin));
            setValue('filterVencimentoMax', formatDateInput(advancedFilters.vencimentoMax));
            setValue('filterPagamentoMin', formatDateInput(advancedFilters.pagamentoMin));
            setValue('filterPagamentoMax', formatDateInput(advancedFilters.pagamentoMax));
            setValue('filterValorMin', advancedFilters.valorMin !== null && advancedFilters.valorMin !== undefined ? formatMoney(advancedFilters.valorMin) : '');
            setValue('filterValorMax', advancedFilters.valorMax !== null && advancedFilters.valorMax !== undefined ? formatMoney(advancedFilters.valorMax) : '');
            openModal('advancedFilterModal');
        }

        function applyAdvancedFilters() {
            const vencimentoMin = parseDateInputToISO(document.getElementById('filterVencimentoMin').value);
            const vencimentoMax = parseDateInputToISO(document.getElementById('filterVencimentoMax').value);
            const pagamentoMin = parseDateInputToISO(document.getElementById('filterPagamentoMin').value);
            const pagamentoMax = parseDateInputToISO(document.getElementById('filterPagamentoMax').value);
            const valorMinRaw = document.getElementById('filterValorMin').value.trim();
            const valorMaxRaw = document.getElementById('filterValorMax').value.trim();
            const valorMin = valorMinRaw ? parseMoney(valorMinRaw) : null;
            const valorMax = valorMaxRaw ? parseMoney(valorMaxRaw) : null;

            advancedFilters = {
                vencimentoMin,
                vencimentoMax,
                pagamentoMin,
                pagamentoMax,
                valorMin,
                valorMax
            };
            updateAdvancedFilterBadge();
            closeModal('advancedFilterModal');
            applyFiltersAndRender();
        }

        function clearAdvancedFilters() {
            advancedFilters = {
                vencimentoMin: '',
                vencimentoMax: '',
                pagamentoMin: '',
                pagamentoMax: '',
                valorMin: null,
                valorMax: null
            };
            ['filterVencimentoMin', 'filterVencimentoMax', 'filterPagamentoMin', 'filterPagamentoMax', 'filterValorMin', 'filterValorMax'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });
            updateAdvancedFilterBadge();
            closeModal('advancedFilterModal');
            applyFiltersAndRender();
        }

        // Aplicar filtros e renderizar
        function applyFiltersAndRender() {
            // Filtrar por categoria
            let itensFiltrados = allItems;
            if (currentCategory !== 'todas') {
                // Mapear categorias similares
                const categoryMap = {
                    'estrutura': ['estrutura', 'locacao_aluguel'],
                    'pessoal': ['pessoal'],
                    'comercial': ['comercial'],
                    'ferramentas': ['ferramentas', 'equipamentos'],
                    'alpha_franquia': ['alpha_franquia'],
                    'alimentacao': ['alimentacao'],
                    'operacionais': ['operacionais', 'combustivel'],
                    'outros': ['outros', 'servicos', 'adiantamentos']
                };

                const categoriasValidas = categoryMap[currentCategory] || [currentCategory];
                itensFiltrados = allItems.filter(item => categoriasValidas.includes(item.categoria));
            }

            itensFiltrados = filterItemsByAdvanced(itensFiltrados);

            // Calcular totais baseado nos itens filtrados
            let totalDespesas = 0;
            let totalPago = 0;
            let totalPendente = 0;
            let qtdPagas = 0;
            let qtdPendentes = 0;

            itensFiltrados.forEach(item => {
                totalDespesas += item.valor;
                if (item.isPago) {
                    totalPago += item.valor;
                    qtdPagas++;
                } else {
                    totalPendente += item.valor;
                    qtdPendentes++;
                }
            });

            // Atualizar cards com valores filtrados
            document.getElementById('totalDespesas').textContent = formatMoney(totalDespesas);
            document.getElementById('totalPago').textContent = formatMoney(totalPago);
            document.getElementById('totalPendente').textContent = formatMoney(totalPendente);
            document.getElementById('qtdPagas').textContent = `${qtdPagas} despesas pagas`;
            document.getElementById('qtdPendentes').textContent = `${qtdPendentes} despesas pendentes`;

            const taxa = totalDespesas > 0 ? ((totalPago / totalDespesas) * 100) : 0;
            document.getElementById('taxaPagamento').textContent = taxa.toFixed(1) + '%';
            document.getElementById('progressFill').style.width = taxa + '%';
            document.getElementById('progressPago').textContent = formatMoney(totalPago) + ' pago';
            document.getElementById('progressPendente').textContent = formatMoney(totalPendente) + ' pendente';

            const metaStatus = document.getElementById('metaStatus');
            if (taxa >= 100) {
                metaStatus.textContent = 'ð Tudo pago!';
                metaStatus.className = 'summary-change positive';
            } else {
                metaStatus.textContent = `Faltam ${(100 - taxa).toFixed(1)}%`;
                metaStatus.className = 'summary-change';
            }

            // Mostrar/ocultar indicador de filtro
            const filterIndicator = document.getElementById('filterIndicator');
            if (currentCategory !== 'todas') {
                filterIndicator.style.display = 'block';
                document.getElementById('filterCategoryName').textContent = getCategoryName(currentCategory);
                document.getElementById('filterTotal').textContent = formatMoney(totalDespesas);
                document.getElementById('filterCount').textContent = itensFiltrados.length;
            } else {
                filterIndicator.style.display = 'none';
            }

            // Renderizar tabela
            renderTable(itensFiltrados);

            // Atualizar Kanban se estiver ativo
            if (typeof currentView !== 'undefined' && currentView === 'kanban') {
                renderKanban();
            }
            updateAdvancedFilterBadge();
        }

        // Mudar categoria
        function changeCategory() {
            currentCategory = document.getElementById('categorySelect').value;
            applyFiltersAndRender();
        }

        // Limpar filtro de categoria
        function clearCategoryFilter() {
            currentCategory = 'todas';
            document.getElementById('categorySelect').value = 'todas';
            applyFiltersAndRender();
        }

        // Renderizar tabela
        function renderTable(itens) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Aplicar filtro
            let itensFiltrados = itens;
            if (currentFilter === 'pendente') {
                itensFiltrados = itens.filter(i => !i.isPago);
            } else if (currentFilter === 'pago') {
                itensFiltrados = itens.filter(i => i.isPago);
            } else if (currentFilter === 'pessoal') {
                itensFiltrados = itens.filter(i => i.categoria === 'pessoal');
            } else if (currentFilter === 'comercial') {
                itensFiltrados = itens.filter(i => i.categoria === 'comercial');
            } else if (currentFilter === 'estrutura') {
                itensFiltrados = itens.filter(i => i.categoria === 'estrutura' || i.categoria === 'locacao_aluguel');
            } else if (currentFilter === 'ferramentas') {
                itensFiltrados = itens.filter(i => i.categoria === 'ferramentas' || i.categoria === 'equipamentos');
            } else if (currentFilter === 'alpha') {
                itensFiltrados = itens.filter(i => i.categoria === 'alpha_franquia' || i.categoria === 'alpha');
            } else if (currentFilter === 'selecionados') {
                itensFiltrados = itens.filter(i => selectedItems.has(i.nome));
            }

            // Aplicar filtro de pesquisa por nome
            if (searchTerm) {
                itensFiltrados = itensFiltrados.filter(i =>
                    i.nome.toLowerCase().includes(searchTerm) ||
                    (i.categoria && i.categoria.toLowerCase().includes(searchTerm)) ||
                    (i.tipo && i.tipo.toLowerCase().includes(searchTerm))
                );
            }

            // Aplicar ordem customizada se existir, senÃ£o ordenar por padrÃ£o
            const customOrder = getCustomOrder();
            if (customOrder && customOrder.length > 0) {
                itensFiltrados = applyCustomOrder(itensFiltrados);
            } else {
                // Ordenar: pendentes primeiro, depois por valor
                itensFiltrados.sort((a, b) => {
                    if (a.isPago !== b.isPago) return a.isPago ? 1 : -1;
                    return b.valor - a.valor;
                });
            }

            if (itensFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#999;">Nenhuma despesa encontrada</td></tr>';
                document.getElementById('tableCount').textContent = '0 registros';
                return;
            }

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            itensFiltrados.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = item.isPago ? 'row-pago' : '';
                if (item.isCustom) tr.className += ' row-custom';

                // Drag and drop attributes
                tr.draggable = true;
                tr.dataset.index = index;
                tr.dataset.nome = item.nome;

                const switchClass = item.isPago ? 'active' : '';
                const labelClass = item.isPago ? 'pago' : 'pendente';
                const labelText = item.isPago ? 'Pago' : 'A Pagar';

                // Verificar vencimento
                let vencimentoHtml = '<span style="color: #999;">-</span>';
                let isVencido = false;
                let isHoje = false;
                let isProximo = false;

                if (item.vencimento && !item.isPago) {
                    const dataVenc = new Date(item.vencimento + 'T00:00:00');
                    const diffDays = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        isVencido = true;
                        vencimentoHtml = `<span class="vencimento-badge vencido">â ï¸ ${formatDate(item.vencimento)}</span>`;
                    } else if (diffDays === 0) {
                        isHoje = true;
                        vencimentoHtml = `<span class="vencimento-badge hoje">ð Hoje</span>`;
                    } else if (diffDays <= 3) {
                        isProximo = true;
                        vencimentoHtml = `<span class="vencimento-badge proximo">â° ${formatDate(item.vencimento)}</span>`;
                    } else {
                        vencimentoHtml = `<span style="color: #666;">${formatDate(item.vencimento)}</span>`;
                    }
                } else if (item.vencimento) {
                    vencimentoHtml = `<span style="color: #999; text-decoration: line-through;">${formatDate(item.vencimento)}</span>`;
                }

                if (isVencido) tr.className += ' row-vencido';

                // Status badge HTML
                const statusBadgeClass = item.isPago ? 'status-badge-pago' : (isVencido ? 'status-badge-vencido' : 'status-badge-pendente');
                const statusIcon = item.isPago ? 'â' : (isVencido ? '!' : 'â');

                // Data pagamento HTML
                const dataPagamentoHtml = item.dataPagamento
                    ? `<span class="date-badge date-badge-pago">${formatDate(item.dataPagamento)}</span>`
                    : '<span class="date-badge date-badge-empty">-</span>';

                // Badge para pagamento parcial
                const parcialBadge = item.origemParcial
                    ? `<span class="parcial-badge" title="Origem: ${item.origemParcial}${item.valorOriginal ? ' - Original: R$ ' + item.valorOriginal.toFixed(2) : ''}">â¡ Parcial</span>`
                    : '';
                const observacaoInfo = item.observacao
                    ? `<div class="item-info" style="font-style: italic; color: #7f8c8d;">ð ${item.observacao}</div>`
                    : '';

                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" data-nome="${item.nome}" data-valor="${item.valor}" data-status="${item.isPago ? 'pago' : 'pendente'}" data-custom="${item.isCustom || false}" onchange="handleRowSelect(this)">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <span class="drag-handle" title="Arraste para reordenar">â®â®</span>
                            <div>
                                <div class="item-name">
                                    ${item.nome}
                                    ${item.isCustom ? '<span class="custom-badge">Manual</span>' : ''}
                                    ${parcialBadge}
                                </div>
                                ${item.tipo ? `<div class="item-info">${getGroupLabel(item.tipo)}</div>` : ''}
                                ${item.empresa ? `<div class="item-info">Banco: ${item.empresa}</div>` : ''}
                                ${item.funcao ? `<div class="item-info">${item.funcao}</div>` : ''}
                                ${observacaoInfo}
                            </div>
                        </div>
                    </td>
                    <td class="category-cell">
                        <span class="category-badge ${getCategoryClass(item.categoria)} js-category-badge" data-nome="${item.nome}" data-categoria="${item.categoria}" data-custom="${item.isCustom || false}" title="Clique para alterar categoria">
                            ${getCategoryName(item.categoria)}
                        </span>
                    </td>
                    <td class="text-center">
                        ${vencimentoHtml}
                    </td>
                    <td class="text-center">
                        ${dataPagamentoHtml}
                    </td>
                    <td class="text-right">
                        <span class="amount">${formatMoney(item.valor)}</span>
                    </td>
                    <td class="text-center">
                        <span class="status-badge ${statusBadgeClass} js-toggle-status" title="Clique para alterar status">
                            <span class="status-icon">${statusIcon}</span>
                            <span class="status-text">${labelText}</span>
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="row-actions">
                            <button class="action-btn edit js-edit-btn" title="Editar">
                                âï¸
                            </button>
                            <button class="action-btn delete js-delete-btn" title="Excluir">
                                ðï¸
                            </button>
                        </div>
                    </td>
                `;

                // Adicionar event listeners (evita problemas com caracteres especiais)
                const toggleBtn = tr.querySelector('.js-toggle-status');
                toggleBtn.addEventListener('click', () => {
                    toggleStatus(
                        item.nome,
                        item.isCustom || false,
                        item.valor,
                        item.categoria,
                        item.tipo || '',
                        item.vencimento || '',
                        item.importSource || ''
                    );
                });

                const editBtn = tr.querySelector('.js-edit-btn');
                editBtn.addEventListener('click', () => {
                    openEditModal(item.nome, item.categoria, item.valor, item.tipo || '', item.status, item.isCustom || false, item.vencimento || '');
                });

                const deleteBtn = tr.querySelector('.js-delete-btn');
                deleteBtn.addEventListener('click', () => {
                    openDeleteModal(item);
                });

                // Category quick change
                const categoryBadge = tr.querySelector('.js-category-badge');
                categoryBadge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openCategoryDropdown(categoryBadge, item.nome, item.categoria, item.isCustom || false);
                });

                // Drag and drop event listeners
                tr.addEventListener('dragstart', handleDragStart);
                tr.addEventListener('dragend', handleDragEnd);
                tr.addEventListener('dragover', handleDragOver);
                tr.addEventListener('dragenter', handleDragEnter);
                tr.addEventListener('dragleave', handleDragLeave);
                tr.addEventListener('drop', handleDrop);

                tbody.appendChild(tr);
            });

            document.getElementById('tableCount').textContent = `${itensFiltrados.length} de ${itens.length} registros`;

            // Calcular e exibir total filtrado
            const totalValor = itensFiltrados.reduce((sum, item) => sum + item.valor, 0);
            const totalPago = itensFiltrados.filter(i => i.isPago).reduce((sum, item) => sum + item.valor, 0);
            const totalPendente = totalValor - totalPago;

            document.getElementById('totalFiltrado').textContent = formatMoney(totalValor);
            document.getElementById('totalInfo').innerHTML = `${itensFiltrados.length} despesas | <span style="color: #90EE90;">Pago: ${formatMoney(totalPago)}</span> | <span style="color: #FFB6C1;">Pend: ${formatMoney(totalPendente)}</span>`;
        }

        // ========== DRAG AND DROP FUNCTIONS ==========
        let draggedRow = null;

        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('tr.drag-over, tr.drag-over-bottom').forEach(row => {
                row.classList.remove('drag-over', 'drag-over-bottom');
            });
            draggedRow = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedRow) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over', 'drag-over-bottom');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            if (draggedRow && this !== draggedRow) {
                const tbody = document.getElementById('tableBody');
                const allRows = Array.from(tbody.querySelectorAll('tr[draggable="true"]'));
                const draggedIndex = allRows.indexOf(draggedRow);
                const targetIndex = allRows.indexOf(this);

                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedRow, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedRow, this);
                }

                // Salvar nova ordem
                saveCustomOrder();
                showToast('Ordem das despesas atualizada', 'success');
            }

            this.classList.remove('drag-over', 'drag-over-bottom');
        }

        function saveCustomOrder() {
            const tbody = document.getElementById('tableBody');
            const rows = tbody.querySelectorAll('tr[draggable="true"]');
            const order = Array.from(rows).map(row => row.dataset.nome);

            const orderKey = `despesas_order_${currentMonth}`;
            localStorage.setItem(orderKey, JSON.stringify(order));
        }

        function getCustomOrder() {
            const orderKey = `despesas_order_${currentMonth}`;
            const saved = localStorage.getItem(orderKey);
            return saved ? JSON.parse(saved) : null;
        }

        function applyCustomOrder(itens) {
            const customOrder = getCustomOrder();
            if (!customOrder || customOrder.length === 0) return itens;

            const orderMap = new Map(customOrder.map((nome, index) => [nome, index]));

            return [...itens].sort((a, b) => {
                const indexA = orderMap.has(a.nome) ? orderMap.get(a.nome) : 999;
                const indexB = orderMap.has(b.nome) ? orderMap.get(b.nome) : 999;
                return indexA - indexB;
            });
        }

        // Filtrar despesas (por status: todos, pendente, pago)
        // ========================================
        // PESQUISA E FILTRO POR NOME
        // ========================================
        let searchTerm = '';

        function filtrarPorPesquisa() {
            const input = document.getElementById('searchInput');
            searchTerm = input.value.toLowerCase().trim();

            // Mostrar/esconder botÃ£o de limpar
            const clearBtn = input.parentElement.querySelector('.clear-search');
            clearBtn.style.display = searchTerm ? 'block' : 'none';

            // Recarregar tabela com filtro de pesquisa
            loadMonthData(currentMonth);
        }

        function limparPesquisa() {
            const input = document.getElementById('searchInput');
            input.value = '';
            searchTerm = '';

            const clearBtn = input.parentElement.querySelector('.clear-search');
            clearBtn.style.display = 'none';

            loadMonthData(currentMonth);
            input.focus();
        }

        // ========================================
        // DROPDOWN RÃPIDO DE CATEGORIA
        // ========================================
        const CATEGORIAS_DISPONIVEIS = [
            { id: 'pessoal', nome: 'Pessoal', icon: 'ð¤' },
            { id: 'comercial', nome: 'Comercial', icon: 'ð¼' },
            { id: 'estrutura', nome: 'Estrutura', icon: 'ð¢' },
            { id: 'locacao_aluguel', nome: 'Aluguel', icon: 'ð ' },
            { id: 'ferramentas', nome: 'Ferramentas', icon: 'ð§' },
            { id: 'equipamentos', nome: 'Equipamentos', icon: 'ð»' },
            { id: 'combustivel', nome: 'CombustÃ­vel', icon: 'â½' },
            { id: 'alimentacao', nome: 'AlimentaÃ§Ã£o', icon: 'ð½ï¸' },
            { id: 'servicos', nome: 'ServiÃ§os', icon: 'ð ï¸' },
            { id: 'operacionais', nome: 'Operacional', icon: 'âï¸' },
            { id: 'alpha_franquia', nome: 'Alpha', icon: 'ð°ï¸' },
            { id: 'adiantamentos', nome: 'Adiantamentos', icon: 'ðµ' },
            { id: 'impostos', nome: 'Impostos', icon: 'ð' },
            { id: 'taxas', nome: 'Taxas BancÃ¡rias', icon: 'ð¦' },
            { id: 'marketing', nome: 'Marketing', icon: 'ð¢' },
            { id: 'software', nome: 'Software', icon: 'ð¾' },
            { id: 'transporte', nome: 'Transporte', icon: 'ð' },
            { id: 'saude', nome: 'SaÃºde', icon: 'ð¥' },
            { id: 'outros', nome: 'Outros', icon: 'ð¦' }
        ];

        let activeDropdown = null;

        function openCategoryDropdown(badge, itemNome, currentCategoria, isCustom) {
            // Fechar dropdown anterior
            closeCategoryDropdown();

            console.log('Abrindo dropdown para:', itemNome, 'categoria atual:', currentCategoria);

            // Criar dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'category-dropdown active';
            dropdown.id = 'activeCategoryDropdown';

            // Prevenir que cliques no dropdown fechem ele
            dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            CATEGORIAS_DISPONIVEIS.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'category-dropdown-item' + (cat.id === currentCategoria ? ' selected' : '');
                item.innerHTML = `<span class="cat-icon">${cat.icon}</span> ${cat.nome}`;

                // Usar funÃ§Ã£o separada para evitar problemas de closure
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Clicou na categoria:', cat.id);
                    const nome = itemNome;
                    const novaCat = cat.id;
                    const custom = isCustom;
                    // Fechar dropdown primeiro
                    closeCategoryDropdown();
                    // Depois alterar categoria
                    changeCategoryFast(nome, novaCat, custom);
                });

                dropdown.appendChild(item);
            });

            // Posicionar dropdown
            const cell = badge.closest('.category-cell');
            cell.appendChild(dropdown);
            activeDropdown = dropdown;

            // Fechar ao clicar fora (com delay maior)
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);
        }

        function handleOutsideClick(e) {
            if (activeDropdown && !activeDropdown.contains(e.target)) {
                closeCategoryDropdown();
            }
        }

        function closeCategoryDropdown() {
            if (activeDropdown) {
                activeDropdown.remove();
                activeDropdown = null;
            }
            document.removeEventListener('click', handleOutsideClick);
        }

        async function changeCategoryFast(itemNome, novaCategoria, isCustom) {
            closeCategoryDropdown();

            console.log('Alterando categoria:', itemNome, 'para', novaCategoria, 'isCustom:', isCustom);

            // Atualizar no GestaoFinanceira
            const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);
            if (!dados) {
                console.error('Dados do mÃªs nÃ£o encontrados');
                return;
            }

            let updated = false;
            let found = false;

            // Para itens customizados, atualizar diretamente no customItems
            if (isCustom) {
                try {
                    console.log('Atualizando item customizado...');
                    const customData = GestaoFinanceira.customItems[currentMonth];
                    if (customData && customData.despesas) {
                        const item = customData.despesas.find(d => d.nome === itemNome);
                        if (item) {
                            console.log('Item encontrado em customItems:', item);
                            item.categoria = novaCategoria;
                            GestaoFinanceira.saveToStorage();
                            console.log('Categoria atualizada para:', novaCategoria);
                        } else {
                            console.warn('Item nÃ£o encontrado em customItems');
                        }
                    }
                    // Tentar sync (pode falhar mas os dados locais estÃ£o salvos)
                    try {
                        await GestaoFinanceira.syncToServer();
                    } catch (syncError) {
                        console.warn('Sync falhou, mas dados locais foram salvos:', syncError);
                    }
                    loadMonthData(currentMonth);
                    showToast(`Categoria alterada para "${getCategoryName(novaCategoria)}"`);
                } catch (e) {
                    console.error('Erro ao atualizar:', e);
                    showToast('Erro ao salvar alteraÃ§Ã£o');
                }
                return;
            }

            // Para itens nÃ£o-custom, buscar em todas as categorias de despesas
            for (const catKey of Object.keys(dados.despesas.categorias)) {
                const items = dados.despesas.categorias[catKey];

                // Verificar se Ã© um array
                if (!Array.isArray(items)) {
                    console.log('Categoria', catKey, 'nÃ£o Ã© array, pulando');
                    continue;
                }

                const itemIndex = items.findIndex(i => i.nome === itemNome);

                if (itemIndex >= 0) {
                    found = true;
                    const item = items[itemIndex];
                    console.log('Item encontrado na categoria:', catKey);

                    // Se a categoria mudou
                    if (catKey !== novaCategoria) {
                        // Remover da categoria atual
                        items.splice(itemIndex, 1);

                        // Adicionar na nova categoria
                        if (!dados.despesas.categorias[novaCategoria]) {
                            dados.despesas.categorias[novaCategoria] = [];
                        }
                        item.categoria = novaCategoria;
                        dados.despesas.categorias[novaCategoria].push(item);
                        updated = true;
                        console.log('Item movido para categoria:', novaCategoria);
                    } else {
                        console.log('Mesma categoria, nada a fazer');
                    }
                    break;
                }
            }

            if (!found) {
                console.warn('Item nÃ£o encontrado nas categorias:', itemNome);
            }

            if (updated) {
                try {
                    await GestaoFinanceira.syncToServer();
                    loadMonthData(currentMonth);
                    showToast(`Categoria alterada para "${getCategoryName(novaCategoria)}"`);
                } catch (e) {
                    console.error('Erro ao sincronizar:', e);
                    showToast('Erro ao salvar alteraÃ§Ã£o');
                }
            }
        }

        // Toast notification simples
        function showToast(message) {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 9999;
                animation: toastIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ========================================
        // AÃÃES EM MASSA - CATEGORIA E VENCIMENTO
        // ========================================

        // Toggle dropdown de categoria em massa
        function toggleBulkCategoryDropdown(event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const dropdown = document.getElementById('bulkCategoryDropdown');
            if (!dropdown) {
                console.error('Dropdown nÃ£o encontrado');
                return;
            }

            const isActive = dropdown.classList.contains('active');

            // Fechar qualquer dropdown aberto
            document.querySelectorAll('.bulk-category-dropdown.active').forEach(d => d.classList.remove('active'));

            if (!isActive) {
                // Popular dropdown
                dropdown.innerHTML = '';
                CATEGORIAS_DISPONIVEIS.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'cat-item';
                    item.innerHTML = `<span class="cat-icon">${cat.icon}</span> ${cat.nome}`;
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        applyBulkCategory(cat.id);
                    });
                    dropdown.appendChild(item);
                });
                dropdown.classList.add('active');

                // Fechar ao clicar fora
                setTimeout(() => {
                    document.addEventListener('click', closeBulkCategoryDropdown);
                }, 50);
            }
        }

        function closeBulkCategoryDropdown(e) {
            const dropdown = document.getElementById('bulkCategoryDropdown');
            if (!dropdown) return;

            const wrapper = dropdown.closest('.bulk-dropdown-wrapper');
            if (e && wrapper && wrapper.contains(e.target)) return;

            dropdown.classList.remove('active');
            document.removeEventListener('click', closeBulkCategoryDropdown);
        }

        // Aplicar categoria em massa
        async function applyBulkCategory(novaCategoria) {
            closeBulkCategoryDropdown();

            if (selectedItems.size === 0) {
                console.log('Nenhum item selecionado');
                return;
            }

            console.log('=== ALTERAÃÃO DE CATEGORIA EM MASSA ===');
            console.log('Itens selecionados:', Array.from(selectedItems));
            console.log('Nova categoria:', novaCategoria);

            let updated = 0;

            for (const itemNome of selectedItems) {
                console.log('--- Processando item:', itemNome, '---');

                // Buscar o item NA UI (allItems) para saber a categoria EXIBIDA
                const itemNaUI = allItems.find(i => i.nome === itemNome);
                if (!itemNaUI) {
                    console.log('â  Item nÃ£o encontrado na UI:', itemNome);
                    continue;
                }

                const categoriaAtualUI = itemNaUI.categoria;
                const isCustomUI = itemNaUI.isCustom === true;
                console.log('UI mostra categoria:', categoriaAtualUI, '| isCustom:', isCustomUI);

                // Se a categoria exibida jÃ¡ Ã© a desejada, pular
                if (categoriaAtualUI === novaCategoria) {
                    console.log('Categoria jÃ¡ Ã©', novaCategoria, '- pulando');
                    continue;
                }

                // Verificar se existe duplicata em customItems
                const customData = GestaoFinanceira.customItems[currentMonth];
                if (customData && customData.despesas) {
                    const customItemIdx = customData.despesas.findIndex(d => d.nome === itemNome);
                    if (customItemIdx !== -1) {
                        const customItem = customData.despesas[customItemIdx];
                        console.log('Existe em customItems com categoria:', customItem.categoria);

                        // Se o item da UI NÃO Ã© custom, mas existe um custom com mesmo nome,
                        // precisamos remover o custom duplicado e usar editDespesa no base
                        if (!isCustomUI) {
                            console.log('â  Duplicata detectada! Removendo de customItems...');
                            customData.despesas.splice(customItemIdx, 1);
                        } else {
                            // Item da UI Ã o custom, entÃ£o atualizar ele
                            customItem.categoria = novaCategoria;
                            updated++;
                            console.log('â customItem.categoria alterada para:', novaCategoria);
                            continue;
                        }
                    }
                }

                // Item Ã© dos dados base - usar editDespesa
                console.log('Usando editDespesa para item base');
                GestaoFinanceira.editDespesa(currentMonth, itemNome, {
                    nome: itemNaUI.nome,
                    valor: itemNaUI.valor,
                    categoria: novaCategoria
                });
                updated++;
                console.log('â editDespesa chamado para:', itemNome);
            }

            console.log('=== TOTAL ATUALIZADO:', updated, '===');

            // SEMPRE salvar e recarregar
            GestaoFinanceira.saveToStorage();
            try {
                await GestaoFinanceira.syncToServer();
            } catch (e) {
                console.warn('Sync falhou:', e);
            }

            clearSelection();
            loadMonthData(currentMonth);

            if (updated > 0) {
                showToast(`${updated} itens alterados para "${getCategoryName(novaCategoria)}"`);
            } else {
                showToast('Nenhuma alteraÃ§Ã£o necessÃ¡ria');
            }
        }

        // Modal de vencimento em massa
        function openBulkDateModal() {
            if (selectedItems.size === 0) return;

            document.getElementById('bulkDateCount').textContent = selectedItems.size;
            document.getElementById('bulkDateInput').value = '';
            document.getElementById('bulkDateModal').classList.add('show');
        }

        function closeBulkDateModal() {
            document.getElementById('bulkDateModal').classList.remove('show');
        }

        // Aplicar vencimento em massa
        async function applyBulkDate() {
            const novaData = document.getElementById('bulkDateInput').value;
            if (!novaData) {
                alert('Selecione uma data');
                return;
            }

            closeBulkDateModal();

            if (selectedItems.size === 0) return;

            let updated = 0;

            for (const itemNome of selectedItems) {
                const itemNaUI = allItems.find(i => i.nome === itemNome);
                if (!itemNaUI) continue;

                const vencimentoAtualUI = itemNaUI.vencimento || '';
                const isCustomUI = itemNaUI.isCustom === true;

                if ((vencimentoAtualUI || '') === novaData) continue;

                const customData = GestaoFinanceira.customItems[currentMonth];
                if (customData && customData.despesas) {
                    const customItemIdx = customData.despesas.findIndex(d => d.nome === itemNome);
                    if (customItemIdx !== -1) {
                        const customItem = customData.despesas[customItemIdx];
                        if (!isCustomUI) {
                            customData.despesas.splice(customItemIdx, 1);
                        } else {
                            customData.despesas[customItemIdx] = {
                                ...customItem,
                                vencimento: novaData,
                                isCustom: true
                            };
                            updated++;
                            continue;
                        }
                    }
                }

                GestaoFinanceira.editDespesa(currentMonth, itemNome, {
                    nome: itemNaUI.nome,
                    valor: itemNaUI.valor,
                    categoria: itemNaUI.categoria,
                    tipo: itemNaUI.tipo,
                    vencimento: novaData
                });
                updated++;
            }

            if (updated > 0) {
                showToast(`Vencimento alterado para ${updated} itens`);
            }
            GestaoFinanceira.saveToStorage();
            try {
                await GestaoFinanceira.syncToServer();
            } catch (e) {
                console.warn('Sync falhou:', e);
            }
            loadMonthData(currentMonth);
        }

        function filtrarDespesas(filtro) {
            currentFilter = filtro;

            // Atualiza filter-btn (antigos)
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filtro);
            });

            // Atualiza filter-chip (novos)
            document.querySelectorAll('.filter-chip').forEach(chip => {
                if (filtro === 'todos') {
                    chip.classList.toggle('active', chip.dataset.filter === 'todos');
                } else {
                    chip.classList.toggle('active', chip.dataset.filter === filtro);
                }
            });

            // Atualiza resumo dos filtros
            const summary = document.getElementById('filtersSummary');
            if (summary) {
                const labels = {
                    'todos': 'todos os registros',
                    'pendente': 'pendentes',
                    'pago': 'pagos',
                    'selecionados': 'selecionados',
                    'pessoal': 'Pessoal',
                    'comercial': 'Comercial',
                    'estrutura': 'Estrutura',
                    'ferramentas': 'Ferramentas',
                    'alpha': 'Alpha'
                };
                summary.innerHTML = `Mostrando <strong>${labels[filtro] || filtro}</strong>`;
                summary.dataset.base = summary.innerHTML;
            }

            applyFiltersAndRender();
        }

        // Toggle status
        function toggleStatus(nome, isCustom, valor, categoria, tipo, vencimento, importSource = '') {
            const currentStatus = GestaoFinanceira.getStatus(currentMonth, 'despesa', nome);
            const isPago = currentStatus && (currentStatus.status === 'Pago' || currentStatus.status === 'Feito');

            if (isPago) {
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', nome, 'A Pagar', null);
                showToast('Despesa marcada como pendente', 'warning');
                loadMonthData(currentMonth);
            } else {
                pendingPayment = { nome, isCustom, valor, categoria, tipo, vencimento, importSource };
                document.getElementById('paymentDate').value = formatDateInput(new Date().toISOString().split('T')[0]);
                document.getElementById('paymentModalTitle').textContent = `Confirmar Pagamento - ${nome}`;
                document.getElementById('paymentTotalValue').textContent = formatMoney(valor);

                // Reset pagamento parcial
                document.querySelector('input[name="paymentType"][value="full"]').checked = true;
                document.getElementById('partialValueGroup').style.display = 'none';
                document.getElementById('partialNote').style.display = 'none';
                document.getElementById('partialValue').value = '';
                document.getElementById('remainingValue').textContent = 'R$ 0,00';

                openModal('paymentModal');
            }
        }

        // Toggle pagamento parcial
        function togglePartialPayment() {
            const isPartial = document.querySelector('input[name="paymentType"]:checked').value === 'partial';
            document.getElementById('partialValueGroup').style.display = isPartial ? 'block' : 'none';
            document.getElementById('partialNote').style.display = isPartial ? 'block' : 'none';

            if (isPartial) {
                document.getElementById('partialValue').focus();
            }
        }

        // Atualizar valor restante
        function updateRemainingValue() {
            if (!pendingPayment) return;

            const totalValor = pendingPayment.valor;
            const partialValor = parseMoney(document.getElementById('partialValue').value);
            const remaining = totalValor - partialValor;

            document.getElementById('remainingValue').textContent = formatMoney(Math.max(0, remaining));

            // Mudar cor se valor parcial for maior que total
            const remainingEl = document.getElementById('remainingValue');
            if (partialValor > totalValor) {
                remainingEl.style.color = '#c0392b';
            } else if (partialValor > 0) {
                remainingEl.style.color = '#e74c3c';
            } else {
                remainingEl.style.color = '#e74c3c';
            }
        }

        // Confirmar pagamento
        function confirmPayment() {
            if (!pendingPayment) return;

            const isPartial = document.querySelector('input[name="paymentType"]:checked').value === 'partial';
            const date = parseDateInputToISO(document.getElementById('paymentDate').value);

            if (isPartial) {
                const partialValor = parseMoney(document.getElementById('partialValue').value);
                const totalValor = pendingPayment.valor;

                // ValidaÃ§Ãµes
                if (partialValor <= 0) {
                    showToast('Informe o valor do pagamento parcial', 'error');
                    return;
                }

                if (partialValor >= totalValor) {
                    showToast('Para pagamento total, selecione a opÃ§Ã£o "Pagamento Total"', 'error');
                    return;
                }

                const remainingValor = totalValor - partialValor;
                const nomeBase = pendingPayment.nome.replace(/ \(Restante.*\)$/, '').replace(/ \(Parcial\)$/, '').replace(/ \(Pago.*\)$/, '');
                const nomeOriginal = pendingPayment.origemParcial || pendingPayment.nome;
                const valorOriginalTotal = pendingPayment.valorOriginal || totalValor;

                // 1. Deletar o item original
                markRoyaltiesDeleted(pendingPayment.nome, pendingPayment.importSource || '');
                GestaoFinanceira.deleteDespesa(currentMonth, pendingPayment.nome, pendingPayment.isCustom);

                // 2. Criar item PAGO com o valor parcial
                const nomePago = nomeBase + ' (Pago ' + formatDate(date) + ')';
                GestaoFinanceira.addDespesa(currentMonth, {
                    nome: nomePago,
                    valor: partialValor,
                    categoria: pendingPayment.categoria || 'outros',
                    tipo: pendingPayment.tipo || '',
                    status: 'Pago',
                    origemParcial: nomeOriginal,
                    valorOriginal: valorOriginalTotal,
                    observacao: `Pagamento parcial de "${nomeOriginal}" - Original: ${formatMoney(valorOriginalTotal)}`
                });
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', nomePago, 'Pago', date);

                // 3. Criar item PENDENTE com o valor restante (referencia a despesa mÃ£e)
                const nomeRestante = nomeBase + ' (Restante de ' + formatMoney(valorOriginalTotal) + ')';
                GestaoFinanceira.addDespesa(currentMonth, {
                    nome: nomeRestante,
                    valor: remainingValor,
                    categoria: pendingPayment.categoria || 'outros',
                    tipo: pendingPayment.tipo || '',
                    status: 'A Pagar',
                    origemParcial: nomeOriginal,
                    valorOriginal: valorOriginalTotal,
                    observacao: `Saldo restante de "${nomeOriginal}" - JÃ¡ pago: ${formatMoney(valorOriginalTotal - remainingValor)}`
                });

                showToast(`Pago ${formatMoney(partialValor)}. Restam ${formatMoney(remainingValor)} a pagar.`, 'success');
            } else {
                // Pagamento total
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', pendingPayment.nome, 'Pago', date);
                showToast('Pagamento confirmado!', 'success');
            }

            pendingPayment = null;
            closeModal('paymentModal');
            loadMonthData(currentMonth);
        }

        // Abrir modal de adicionar
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Nova Despesa';
            document.getElementById('editMode').value = 'add';
            document.getElementById('originalName').value = '';
            document.getElementById('isCustomItem').value = 'false';
            document.getElementById('despesaForm').reset();
            document.getElementById('despesaValor').value = '';
            document.getElementById('dataPagamentoGroup').style.display = 'none';
            openModal('despesaModal');
        }

        // Abrir modal de editar
        function openEditModal(nome, categoria, valor, tipo, status, isCustom, vencimento) {
            document.getElementById('modalTitle').textContent = 'Editar Despesa';
            document.getElementById('editMode').value = 'edit';
            document.getElementById('originalName').value = nome;
            document.getElementById('isCustomItem').value = isCustom.toString();

            document.getElementById('despesaNome').value = nome;
            document.getElementById('despesaValor').value = formatMoney(valor);
            document.getElementById('despesaCategoria').value = categoria;
            document.getElementById('despesaTipo').value = tipo;
            document.getElementById('despesaVencimento').value = formatDateInput(vencimento || '');
            document.getElementById('despesaStatus').value = status === 'Feito' ? 'Pago' : status;

            document.getElementById('dataPagamentoGroup').style.display =
                (status === 'Pago' || status === 'Feito') ? 'block' : 'none';

            openModal('despesaModal');
        }

        // Salvar despesa
        function saveDespesa() {
            const nome = document.getElementById('despesaNome').value.trim();
            const valor = parseMoney(document.getElementById('despesaValor').value);
            const categoria = document.getElementById('despesaCategoria').value;
            let tipo = document.getElementById('despesaTipo').value.trim();
            const vencimento = parseDateInputToISO(document.getElementById('despesaVencimento').value);
            const status = document.getElementById('despesaStatus').value;
            const dataPagamento = parseDateInputToISO(document.getElementById('despesaDataPagamento').value);

            if (!nome) {
                showToast('Informe a descriÃ§Ã£o da despesa', 'error');
                document.getElementById('despesaNome').classList.add('error');
                return;
            }

            if (valor <= 0) {
                showToast('Informe um valor vÃ¡lido', 'error');
                document.getElementById('despesaValor').classList.add('error');
                return;
            }

            if (!tipo) {
                const sugerido = suggestGroup(nome);
                if (sugerido) {
                    tipo = sugerido;
                    document.getElementById('despesaTipo').value = sugerido;
                }
            }

            const editMode = document.getElementById('editMode').value;
            const originalName = document.getElementById('originalName').value;
            const isCustom = document.getElementById('isCustomItem').value === 'true';

            if (editMode === 'add') {
                // Adicionar nova despesa
                GestaoFinanceira.addDespesa(currentMonth, {
                    nome,
                    valor,
                    categoria,
                    tipo,
                    vencimento,
                    status
                });

                if (status === 'Pago') {
                    GestaoFinanceira.updateStatus(currentMonth, 'despesa', nome, 'Pago', dataPagamento || new Date().toISOString().split('T')[0]);
                }

                showToast('Despesa adicionada com sucesso!', 'success');
            } else {
                // Editar despesa existente
                if (isCustom) {
                    const customData = GestaoFinanceira.customItems[currentMonth];
                    if (customData && customData.despesas) {
                        const idx = customData.despesas.findIndex(d => d.nome === originalName);
                        if (idx !== -1) {
                            const existing = customData.despesas[idx];
                            customData.despesas[idx] = {
                                ...existing,
                                nome,
                                valor,
                                categoria,
                                tipo,
                                vencimento,
                                status,
                                isCustom: true
                            };
                        } else {
                            GestaoFinanceira.addDespesa(currentMonth, {
                                nome,
                                valor,
                                categoria,
                                tipo,
                                vencimento,
                                status
                            });
                        }
                    } else {
                        GestaoFinanceira.addDespesa(currentMonth, {
                            nome,
                            valor,
                            categoria,
                            tipo,
                            vencimento,
                            status
                        });
                    }
                    if (GestaoFinanceira.deletedItems[currentMonth]?.despesas?.length) {
                        GestaoFinanceira.deletedItems[currentMonth].despesas = GestaoFinanceira.deletedItems[currentMonth].despesas.filter(n => n !== originalName && n !== nome);
                    }
                    if (isRoyaltiesName(nome) || isRoyaltiesName(originalName)) {
                        const royaltiesDeleted = loadRoyaltiesDeleted().filter(n => n !== nome && n !== originalName);
                        saveRoyaltiesDeleted(royaltiesDeleted);
                    }
                    GestaoFinanceira.saveToStorage();
                } else {
                    // Editar item original
                    GestaoFinanceira.editDespesa(currentMonth, originalName, {
                        nome,
                        valor,
                        categoria,
                        tipo,
                        vencimento
                    });
                }

                // Atualizar status
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', nome, status, status === 'Pago' ? (dataPagamento || new Date().toISOString().split('T')[0]) : null);

                showToast('Despesa atualizada com sucesso!', 'success');
            }

            closeModal('despesaModal');
            loadMonthData(currentMonth);
        }

        // Abrir modal de exclusÃ£o
        function openDeleteModal(item) {
            const nome = item?.nome || '';
            const valor = item?.valor || 0;
            const isCustom = item?.isCustom || false;
            pendingDelete = {
                nome,
                valor,
                isCustom,
                importSource: item?.importSource || '',
                categoria: item?.categoria || '',
                tipo: item?.tipo || ''
            };
            document.getElementById('deleteDetails').innerHTML = `
                <strong>${nome}</strong><br>
                Valor: ${formatMoney(valor)}
            `;
            openModal('deleteModal');
        }

        // Confirmar exclusÃ£o
        function confirmDelete() {
            if (pendingDelete) {
                try {
                    console.log('Deletando:', pendingDelete);
                    markRoyaltiesDeleted(pendingDelete.nome, pendingDelete.importSource);
                    GestaoFinanceira.deleteDespesa(currentMonth, pendingDelete.nome, pendingDelete.isCustom);
                    closeModal('deleteModal');
                    showToast('Despesa excluÃ­da com sucesso!', 'success');
                    loadMonthData(currentMonth);
                } catch (error) {
                    console.error('Erro ao excluir:', error);
                    showToast('Erro ao excluir despesa', 'error');
                    closeModal('deleteModal');
                } finally {
                    pendingDelete = null;
                }
            }
        }

        // Abrir modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        // Fechar modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                // ForÃ§ar reflow
                setTimeout(() => {
                    modal.style.display = '';
                }, 10);
            }
            // Limpar erros
            document.querySelectorAll('.form-input.error').forEach(el => el.classList.remove('error'));
        }

        // Mostrar toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toastMessage.textContent = message;
            toast.className = `toast ${type}`;

            if (type === 'success') toastIcon.textContent = 'â';
            else if (type === 'warning') toastIcon.textContent = 'â ';
            else if (type === 'error') toastIcon.textContent = 'â';

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Mudar mÃªs
        function changeMonth() {
            const selectedMonth = document.getElementById('monthSelect').value;
            loadMonthData(selectedMonth);
        }

        // ========================================
        // BACKUP E RESTAURAÃÃO
        // ========================================

        // Exportar backup dos dados
        function exportarBackup() {
            try {
                GestaoFinanceira.exportData();
                showToast('Backup salvo com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showToast('Erro ao salvar backup', 'error');
            }
        }

        async function exportarParaProducao() {
            try {
                const sucesso = await GestaoFinanceira.exportToRailway();
                if (sucesso) {
                    showToast('Dados enviados para produÃ§Ã£o!', 'success');
                } else {
                    showToast('Falha ao enviar dados para produÃ§Ã£o', 'error');
                }
            } catch (error) {
                showToast('Erro ao enviar dados para produÃ§Ã£o', 'error');
            }
        }

        // Importar backup dos dados
        function importarBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('Isso vai substituir todos os dados atuais. Deseja continuar?')) {
                input.value = '';
                return;
            }

            GestaoFinanceira.importData(file)
                .then(result => {
                    showToast('Dados restaurados com sucesso!', 'success');
                    // Recarregar a pÃ¡gina para aplicar os dados
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    showToast('Erro ao restaurar: ' + error.message, 'error');
                })
                .finally(() => {
                    input.value = '';
                });
        }

        // Exportar dados
        function exportarDados() {
            const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);

            let csv = 'DescriÃ§Ã£o,Categoria,Valor,Status,Data Pagamento,Grupo\n';

            for (const [catKey, catData] of Object.entries(dados.despesas.categorias)) {
                if (catData.itens) {
                    catData.itens.forEach(item => {
                        csv += `"${item.nome}","${getCategoryName(catKey)}","${item.valor}","${item.status}","${item.dataPagamento || ''}","${item.tipo ? getGroupLabel(item.tipo) : ''}"\n`;
                    });
                }
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `contas-pagar-${currentMonth}.csv`;
            link.click();

            showToast('Dados exportados com sucesso!', 'success');
        }

        // Event listeners
        document.getElementById('despesaValor').addEventListener('input', function() {
            maskMoney(this);
        });

        document.getElementById('despesaStatus').addEventListener('change', function() {
            document.getElementById('dataPagamentoGroup').style.display =
                this.value === 'Pago' ? 'block' : 'none';
        });

        // Fechar modais ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // Tecla ESC fecha modais
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });

        // ========================================
        // KANBAN VIEW
        // ========================================

        let currentView = 'table';
        let kanbanDraggedCard = null;

        // Alternar entre views
        function setView(view) {
            currentView = view;
            const tableContainer = document.getElementById('tableContainer');
            const kanbanContainer = document.getElementById('kanbanContainer');
            const tableBtn = document.getElementById('viewTableBtn');
            const kanbanBtn = document.getElementById('viewKanbanBtn');

            if (view === 'table') {
                tableContainer.style.display = 'block';
                kanbanContainer.classList.remove('active');
                tableBtn.classList.add('active');
                kanbanBtn.classList.remove('active');
            } else {
                tableContainer.style.display = 'none';
                kanbanContainer.classList.add('active');
                tableBtn.classList.remove('active');
                kanbanBtn.classList.add('active');
                renderKanban();
            }

            localStorage.setItem('contas_pagar_view', view);
        }

        // Renderizar Kanban
        function renderKanban() {
            // Limpar mapa de itens
            kanbanItemsMap = {};

            // Buscar dados diretamente
            const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);
            if (!dados) {
                console.log('Kanban: dados nÃ£o encontrados');
                return;
            }

            // Processar despesas igual ao loadMonthData
            const itensProcessados = [];
            const categorias = dados.despesas.categorias;

            for (const [categoriaKey, categoriaData] of Object.entries(categorias)) {
                if (categoriaData.itens && Array.isArray(categoriaData.itens)) {
                    categoriaData.itens.forEach(item => {
                        const isPago = item.status === 'Pago' || item.status === 'Feito';
                        itensProcessados.push({
                            ...item,
                            categoria: categoriaKey,
                            isPago: isPago
                        });
                    });
                }
            }

            // Incluir itens customizados do localStorage
            const customData = GestaoFinanceira.customItems[currentMonth];
            if (customData && customData.despesas) {
                customData.despesas.forEach(item => {
                    const isPago = item.status === 'Pago' || item.status === 'Feito';
                    itensProcessados.push({
                        ...item,
                        isPago: isPago,
                        isCustom: true
                    });
                });
            }

            const todosItens = itensProcessados;
            console.log('Kanban: total de itens =', todosItens.length);
            console.log('Kanban: primeiro item =', todosItens[0]);

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            const pendentes = [];
            const vencendo = [];
            const pagos = [];

            todosItens.forEach(item => {
                const isPago = item.isPago || item.status === 'Pago' || item.status === 'Feito';
                const isCustom = item.isCustom;
                const vencimento = item.vencimento ? new Date(item.vencimento + 'T00:00:00') : null;

                const cardData = {
                    ...item,
                    isCustom,
                    isPago,
                    vencimento
                };

                if (isPago) {
                    pagos.push(cardData);
                } else {
                    // Todos os nÃ£o pagos vÃ£o para pendentes ou vencendo
                    if (vencimento) {
                        const diffDays = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                        if (diffDays <= 7) {
                            cardData.vencimentoStatus = diffDays <= 0 ? 'vencido' : 'proximo';
                            vencendo.push(cardData);
                        } else {
                            pendentes.push(cardData);
                        }
                    } else {
                        pendentes.push(cardData);
                    }
                }
            });

            console.log('Kanban: pendentes =', pendentes.length, 'vencendo =', vencendo.length, 'pagos =', pagos.length);

            // Renderizar colunas
            renderKanbanColumn('kanbanPendente', pendentes, 'Pendente');
            renderKanbanColumn('kanbanParcial', vencendo, 'Vencendo');
            renderKanbanColumn('kanbanPago', pagos, 'Pago');

            // Atualizar contadores e totais
            document.getElementById('kanbanPendenteCount').textContent = pendentes.length;
            document.getElementById('kanbanParcialCount').textContent = vencendo.length;
            document.getElementById('kanbanPagoCount').textContent = pagos.length;

            const totalPendente = pendentes.reduce((sum, i) => sum + (i.valor || 0), 0);
            const totalVencendo = vencendo.reduce((sum, i) => sum + (i.valor || 0), 0);
            const totalPago = pagos.reduce((sum, i) => sum + (i.valor || 0), 0);

            document.getElementById('kanbanPendenteTotal').textContent = formatMoney(totalPendente);
            document.getElementById('kanbanParcialTotal').textContent = formatMoney(totalVencendo);
            document.getElementById('kanbanPagoTotal').textContent = formatMoney(totalPago);
        }

        // Renderizar coluna do Kanban
        function renderKanbanColumn(containerId, items, status) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="kanban-empty">
                        <div class="kanban-empty-icon">${status === 'Pago' ? 'â' : 'ð­'}</div>
                        <div>Nenhum item</div>
                    </div>
                `;
                return;
            }

            // Ordenar por valor (maior primeiro)
            items.sort((a, b) => (b.valor || 0) - (a.valor || 0));

            container.innerHTML = items.map(item => createKanbanCard(item)).join('');

            // Adicionar eventos de drag
            container.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('dragstart', handleKanbanCardDragStart);
                card.addEventListener('dragend', handleKanbanCardDragEnd);
            });
        }

        // Criar card do Kanban
        // Armazenar itens do Kanban para acesso rÃ¡pido
        let kanbanItemsMap = {};

        function createKanbanCard(item) {
            // Armazenar item para acesso posterior
            kanbanItemsMap[item.nome] = item;

            const categoryLabels = {
                'pessoal': 'Pessoal',
                'comercial': 'Comercial',
                'estrutura': 'Estrutura',
                'ferramentas': 'Ferramentas',
                'alpha_franquia': 'Alpha',
                'alimentacao': 'AlimentaÃ§Ã£o',
                'operacionais': 'Operacional',
                'outros': 'Outros'
            };

            const categoria = categoryLabels[item.categoria] || item.categoria || 'Outros';

            // Determinar status visual do card
            let statusClass = 'status-pendente';
            let statusIcon = 'â³';
            if (item.isPago) {
                statusClass = 'status-pago';
                statusIcon = 'â';
            } else if (item.vencimentoStatus === 'vencido') {
                statusClass = 'status-vencido';
                statusIcon = 'â ï¸';
            }

            let vencimentoBadge = '';
            if (item.vencimentoStatus === 'vencido') {
                vencimentoBadge = '<span class="kanban-card-badge vencido">â ï¸ Vencido</span>';
            } else if (item.vencimentoStatus === 'proximo') {
                vencimentoBadge = '<span class="kanban-card-badge proximo">ð PrÃ³ximo</span>';
            }

            // Data info
            let dateInfo = '';
            if (item.isPago && item.dataPagamento) {
                dateInfo = `<span class="kanban-card-date pago">â Pago em ${formatDate(item.dataPagamento)}</span>`;
            } else if (item.vencimento) {
                const vencDate = new Date(item.vencimento + 'T00:00:00');
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const diffDays = Math.ceil((vencDate - hoje) / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    dateInfo = `<span class="kanban-card-date vencido">â ï¸ Venceu hÃ¡ ${Math.abs(diffDays)} dias</span>`;
                } else if (diffDays === 0) {
                    dateInfo = `<span class="kanban-card-date vencido">ð Vence HOJE</span>`;
                } else if (diffDays <= 7) {
                    dateInfo = `<span class="kanban-card-date">ð Vence em ${diffDays} dias</span>`;
                } else {
                    dateInfo = `<span class="kanban-card-date">ð ${formatDate(item.vencimento)}</span>`;
                }
            }

            // BotÃµes de aÃ§Ã£o
            const actionBtns = item.isPago ?
                `<button class="kanban-action-btn unpay" onclick="event.stopPropagation(); openKanbanPaymentModal(kanbanItemsMap['${item.nome.replace(/'/g, "\\'")}'], 'pendente')">â© Desfazer</button>` :
                `<button class="kanban-action-btn pay" onclick="event.stopPropagation(); openKanbanPaymentModal(kanbanItemsMap['${item.nome.replace(/'/g, "\\'")}'], 'pago')">â Pagar</button>`;

            // Escapar nome para uso em atributos e funÃ§Ãµes
            const nomeEscaped = item.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const nomeAttr = item.nome.replace(/"/g, '&quot;');

            return `
                <div class="kanban-card ${item.isCustom ? 'custom' : ''} ${statusClass}"
                     draggable="true"
                     data-nome="${nomeAttr}"
                     data-valor="${item.valor || 0}"
                     data-is-custom="${item.isCustom || false}"
                     onclick="openKanbanPaymentModal(kanbanItemsMap['${nomeEscaped}'])">
                    <button class="card-delete-btn" onclick="event.stopPropagation(); showKanbanDeleteConfirm(this, '${nomeEscaped}', ${item.isCustom || false})" title="Excluir">ðï¸</button>
                    <button class="card-edit-btn" onclick="event.stopPropagation(); openKanbanPaymentModal(kanbanItemsMap['${nomeEscaped}'])" title="Editar">âï¸</button>
                    <div class="kanban-card-header">
                        <div class="kanban-card-title">${statusIcon} ${item.nome}</div>
                        <div class="kanban-card-amount">${formatMoney(item.valor || 0)}</div>
                    </div>
                    <div class="kanban-card-meta">
                        <span class="kanban-card-badge category">${categoria}</span>
                        ${vencimentoBadge}
                        ${item.isCustom ? '<span class="kanban-card-badge" style="background: #e3f2fd; color: #1565c0;">âï¸ Manual</span>' : ''}
                    </div>
                    ${dateInfo ? `<div class="kanban-card-info">${dateInfo}</div>` : ''}
                    <div class="kanban-card-actions">
                        ${actionBtns}
                    </div>
                </div>
            `;
        }

        // Mostrar confirmaÃ§Ã£o de exclusÃ£o no card
        function showKanbanDeleteConfirm(btn, nome, isCustom) {
            const card = btn.closest('.kanban-card');

            // Remover confirmaÃ§Ãµes anteriores
            document.querySelectorAll('.kanban-delete-confirm').forEach(el => el.remove());

            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'kanban-delete-confirm';
            confirmDiv.innerHTML = `
                <p>Excluir "${nome}"?</p>
                <div class="kanban-delete-confirm-btns">
                    <button class="confirm-yes" onclick="confirmKanbanDelete('${nome}', ${isCustom})">Excluir</button>
                    <button class="confirm-no" onclick="this.closest('.kanban-delete-confirm').remove()">Cancelar</button>
                </div>
            `;

            card.appendChild(confirmDiv);
        }

        // Confirmar exclusÃ£o do Kanban
        function confirmKanbanDelete(nome, isCustom) {
            if (isCustom) {
                // Deletar item customizado
                const customData = GestaoFinanceira.customItems[currentMonth];
                if (customData && customData.despesas) {
                    const index = customData.despesas.findIndex(i => i.nome === nome);
                    if (index !== -1) {
                        customData.despesas.splice(index, 1);
                        GestaoFinanceira.saveToStorage();
                        showToast('Item excluÃ­do com sucesso!', 'success');
                    }
                }
            } else {
                // Marcar item como deletado
                if (!GestaoFinanceira.deletedItems[currentMonth]) {
                    GestaoFinanceira.deletedItems[currentMonth] = { despesas: [], receitas: [] };
                }
                GestaoFinanceira.deletedItems[currentMonth].despesas.push(nome);
                GestaoFinanceira.saveToStorage();
                showToast('Item removido da lista!', 'success');
            }

            loadMonthData(currentMonth);
        }

        // Toggle status via Kanban (legacy - agora usa modal)
        function toggleKanbanStatus(nome, pagar) {
            const item = kanbanItemsMap[nome];
            if (item) {
                openKanbanPaymentModal(item, pagar ? 'pago' : 'pendente');
                return;
            }
            const newStatus = pagar ? 'Pago' : 'A Pagar';
            const date = pagar ? new Date().toISOString().split('T')[0] : null;

            GestaoFinanceira.updateStatus(currentMonth, 'despesa', nome, newStatus, date);
            showToast(pagar ? 'Despesa marcada como paga!' : 'Despesa marcada como pendente', pagar ? 'success' : 'warning');
            loadMonthData(currentMonth);
        }

        // Drag and Drop Kanban
        function handleKanbanCardDragStart(e) {
            kanbanDraggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.nome);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleKanbanCardDragEnd(e) {
            this.classList.remove('dragging');
            kanbanDraggedCard = null;
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleKanbanDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleKanbanDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleKanbanDrop(e, targetStatus) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const nome = e.dataTransfer.getData('text/plain');
            if (!nome) return;

            // Buscar item no mapa
            const item = kanbanItemsMap[nome];
            if (!item) return;

            // Determinar novo status baseado na coluna de destino
            let newStatus, newDate;

            if (targetStatus === 'pago') {
                newStatus = 'Pago';
                newDate = new Date().toISOString().split('T')[0];
                showToast(`"${nome}" marcado como pago!`, 'success');
            } else if (targetStatus === 'pendente') {
                newStatus = 'A Pagar';
                newDate = null;
                showToast(`"${nome}" movido para pendentes`, 'warning');
            } else if (targetStatus === 'parcial') {
                // Para a coluna do meio (Vencendo/Parcial), abrir modal
                openKanbanPaymentModal(item, 'pendente');
                return;
            }

            // Atualizar status diretamente
            GestaoFinanceira.updateStatus(currentMonth, 'despesa', nome, newStatus, newDate);

            // Recarregar dados
            loadMonthData(currentMonth);
        }

        // ========================================
        // SELEÃÃO E AÃÃES EM MASSA
        // ========================================

        let selectedItems = new Set();

        function handleRowSelect(checkbox) {
            const nome = checkbox.dataset.nome;
            const tr = checkbox.closest('tr');

            if (checkbox.checked) {
                selectedItems.add(nome);
                tr.classList.add('selected');
            } else {
                selectedItems.delete(nome);
                tr.classList.remove('selected');
            }

            updateBulkActionsBar();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll(checkbox) {
            const rowCheckboxes = document.querySelectorAll('#tableBody .row-checkbox');

            rowCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const tr = cb.closest('tr');
                const nome = cb.dataset.nome;

                if (checkbox.checked) {
                    selectedItems.add(nome);
                    tr.classList.add('selected');
                } else {
                    selectedItems.delete(nome);
                    tr.classList.remove('selected');
                }
            });

            updateBulkActionsBar();
        }

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('#tableBody .row-checkbox');
            const checkedCount = document.querySelectorAll('#tableBody .row-checkbox:checked').length;

            if (checkedCount === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCount === rowCheckboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        function updateBulkActionsBar() {
            const countText = document.getElementById('selectedCountText');
            const totalText = document.getElementById('selectedTotalText');
            const btnSelecionados = document.getElementById('btnSelecionados');
            const countSelecionados = document.getElementById('countSelecionados');

            if (selectedItems.size > 0) {
                btnSelecionados.style.display = 'inline-block';

                // Calcular total selecionado
                let total = 0;
                document.querySelectorAll('#tableBody .row-checkbox:checked').forEach(cb => {
                    total += parseFloat(cb.dataset.valor) || 0;
                });

                countText.textContent = `${selectedItems.size} selecionado${selectedItems.size > 1 ? 's' : ''}`;
                totalText.textContent = formatMoney(total);
                countSelecionados.textContent = selectedItems.size;
            } else {
                btnSelecionados.style.display = 'none';
            }
        }

        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('#tableBody .row-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('selected');
            });
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAll').indeterminate = false;
            updateBulkActionsBar();

            // Se estava filtrando por selecionados, voltar para todos
            if (currentFilter === 'selecionados') {
                filtrarDespesas('todos');
            }
        }

        async function bulkMarkAsPaid() {
            if (selectedItems.size === 0) return;

            const hoje = new Date().toISOString().split('T')[0];

            for (const nome of selectedItems) {
                await GestaoFinanceira.updateStatus(currentMonth, 'despesa', nome, 'Pago', hoje);
            }

            clearSelection();
            loadMonthData(currentMonth);
        }

        async function bulkMarkAsPending() {
            if (selectedItems.size === 0) return;

            for (const nome of selectedItems) {
                await GestaoFinanceira.updateStatus(currentMonth, 'despesa', nome, 'A Pagar', null);
            }

            clearSelection();
            loadMonthData(currentMonth);
        }

        async function bulkDelete() {
            if (selectedItems.size === 0) return;

            if (!confirm(`Tem certeza que deseja excluir ${selectedItems.size} item(s)?`)) {
                return;
            }

            for (const nome of selectedItems) {
                const item = allItems.find(existing => existing.nome === nome);
                markRoyaltiesDeleted(nome, item?.importSource || '');
                GestaoFinanceira.deleteDespesa(currentMonth, nome, item?.isCustom || false);
            }

            // Sincronizar com servidor
            await GestaoFinanceira.syncToServer();

            clearSelection();
            loadMonthData(currentMonth);
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', async function() {
            GestaoFinanceira.init(); // NÃ£o bloqueia mais
            initDateInputs();

            // SEMPRE usar o mÃªs atual ao carregar a pÃ¡gina
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) {
                monthSelect.value = currentMonth; // ForÃ§a para o mÃªs atual
            }

            await GestaoFinanceira.loadFromServer();
            if (currentMonth === '2026-02') {
                const cleanupKey = `starken_clear_paid_${currentMonth}`;
                if (!localStorage.getItem(cleanupKey)) {
                    clearLocalPaidForMonth(currentMonth);
                    localStorage.setItem(cleanupKey, new Date().toISOString());
                }
            }
            console.log('ð Carregando Contas a Pagar para o mÃªs:', currentMonth);
            loadMonthData(currentMonth);

            // Restaurar view salva
            const savedView = localStorage.getItem('contas_pagar_view');
            if (savedView) {
                setView(savedView);
            }

            // ð ATIVAR SINCRONIZAÃÃO EM TEMPO REAL
            if (typeof GestaoFinanceira.startPolling === 'function') {
                GestaoFinanceira.startPolling(currentMonth);
                console.log('â SincronizaÃ§Ã£o em tempo real ativada!');
            }

            const params = new URLSearchParams(window.location.search);
            if (params.get('diagnostico') === '1') {
                openImportDiagnostics();
            }
        });

        // Atualizar dados quando sync completar (background)
        window.addEventListener('gestao-sync-complete', function() {
            console.log('ð Sync completo, atualizando dados...');
            loadMonthData(currentMonth);
        });

        // Atualizar dados quando Railway sync completar
        window.addEventListener('gestao-railway-sync', function(event) {
            console.log('ð Railway sync completo:', event.detail);
            loadMonthData(currentMonth);

            // Mostrar notificaÃ§Ã£o discreta
            const indicator = document.getElementById('sync-indicator');
            if (indicator) {
                indicator.innerHTML = 'â Sincronizado';
                indicator.style.background = '#27ae60';
                setTimeout(() => {
                    indicator.remove();
                }, 2000);
            }
        });

        // ========================================
        // MODAL DE PAGAMENTO KANBAN
        // ========================================

        let kanbanSelectedItem = null;
        let kanbanTargetStatus = null;

        // Abrir modal de pagamento
        function openKanbanPaymentModal(item, targetStatus = null) {
            kanbanSelectedItem = item;
            kanbanTargetStatus = targetStatus;

            // Preencher informaÃ§Ãµes do item
            document.getElementById('kanbanItemName').textContent = item.nome;
            document.getElementById('kanbanItemValue').textContent = formatMoney(item.valor || 0);
            document.getElementById('kanbanItemCategory').textContent = getCategoryLabel(item.categoria);

            // Definir status selecionado
            const currentStatus = item.isPago ? 'pago' : 'pendente';
            const statusToSelect = targetStatus || currentStatus;
            selectKanbanStatus(statusToSelect);

            // Preencher data
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('kanbanPaymentDate').value = formatDateInput(item.dataPagamento || today);

            // Preencher observaÃ§Ãµes
            document.getElementById('kanbanObservations').value = item.observacao || '';

            // Reset campos de pagamento parcial
            document.querySelector('input[name="kanbanPaymentType"][value="full"]').checked = true;
            document.getElementById('kanbanPartialValueGroup').style.display = 'none';
            document.getElementById('kanbanPartialValue').value = '';
            document.getElementById('kanbanRemainingValue').textContent = 'R$ 0,00';

            // Mostrar modal
            document.getElementById('kanbanPaymentModal').classList.add('active');
        }

        // Fechar modal
        function closeKanbanPaymentModal() {
            document.getElementById('kanbanPaymentModal').classList.remove('active');
            kanbanSelectedItem = null;
            kanbanTargetStatus = null;
        }

        // Selecionar status
        function selectKanbanStatus(status) {
            document.querySelectorAll('.kanban-status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.kanban-status-option[data-status="${status}"]`).classList.add('selected');

            // Mostrar opÃ§Ãµes de tipo de pagamento apenas quando "pago" for selecionado
            const paymentTypeGroup = document.getElementById('kanbanPaymentTypeGroup');
            if (status === 'pago') {
                paymentTypeGroup.style.display = 'block';
            } else {
                paymentTypeGroup.style.display = 'none';
                document.getElementById('kanbanPartialValueGroup').style.display = 'none';
            }
        }

        // Obter status selecionado
        function getSelectedKanbanStatus() {
            const selected = document.querySelector('.kanban-status-option.selected');
            return selected ? selected.dataset.status : 'pendente';
        }

        // Toggle pagamento parcial no Kanban
        function toggleKanbanPartialPayment() {
            const isPartial = document.querySelector('input[name="kanbanPaymentType"]:checked')?.value === 'partial';
            const partialGroup = document.getElementById('kanbanPartialValueGroup');
            partialGroup.style.display = isPartial ? 'block' : 'none';

            if (isPartial) {
                document.getElementById('kanbanPartialValue').focus();
            }
        }

        // Atualizar valor restante do pagamento no Kanban
        function updateKanbanRemainingValue() {
            if (!kanbanSelectedItem) return;

            const totalValor = kanbanSelectedItem.valor || 0;
            const partialInput = document.getElementById('kanbanPartialValue').value;
            const partialValor = parseMoney(partialInput);

            const remaining = totalValor - partialValor;
            document.getElementById('kanbanRemainingValue').textContent = formatMoney(Math.max(0, remaining));
        }

        // Salvar alteraÃ§Ãµes do modal
        function saveKanbanPayment() {
            if (!kanbanSelectedItem) return;

            const status = getSelectedKanbanStatus();
            const date = parseDateInputToISO(document.getElementById('kanbanPaymentDate').value);
            const observacao = document.getElementById('kanbanObservations').value;

            // Se nÃ£o for pago, apenas atualizar status
            if (status !== 'pago') {
                const newStatus = status === 'parcial' ? 'Parcial' : 'A Pagar';
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', kanbanSelectedItem.nome, newStatus, null);

                // Salvar observaÃ§Ã£o se houver
                if (observacao) {
                    const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);
                    const despesa = dados.despesas.find(d => d.nome === kanbanSelectedItem.nome);
                    if (despesa) {
                        despesa.observacao = observacao;
                        GestaoFinanceira.saveDados(currentMonth, dados);
                    }
                }

                closeKanbanPaymentModal();
                showToast('Status atualizado!', 'success');
                loadMonthData(currentMonth);
                return;
            }

            // Verificar se Ã© pagamento parcial
            const paymentType = document.querySelector('input[name="kanbanPaymentType"]:checked')?.value || 'full';

            if (paymentType === 'full') {
                // Pagamento total
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', kanbanSelectedItem.nome, 'Pago', date);

                // Salvar observaÃ§Ã£o
                if (observacao) {
                    const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);
                    const despesa = dados.despesas.find(d => d.nome === kanbanSelectedItem.nome);
                    if (despesa) {
                        despesa.observacao = observacao;
                        GestaoFinanceira.saveDados(currentMonth, dados);
                    }
                }

                closeKanbanPaymentModal();
                showToast('Pagamento total registrado!', 'success');
                loadMonthData(currentMonth);
            } else {
                // Pagamento parcial
                const partialInput = document.getElementById('kanbanPartialValue').value;
                const partialValor = parseMoney(partialInput);
                const totalValor = kanbanSelectedItem.valor || 0;

                // ValidaÃ§Ãµes
                if (partialValor <= 0) {
                    showToast('Informe o valor do pagamento parcial', 'error');
                    return;
                }

                if (partialValor >= totalValor) {
                    showToast('Para pagamento total, selecione a opÃ§Ã£o "Pagamento Total"', 'error');
                    return;
                }

                const remainingValor = totalValor - partialValor;
                const nomeBase = kanbanSelectedItem.nome.replace(/ \(Restante.*\)$/, '').replace(/ \(Parcial\)$/, '').replace(/ \(Pago.*\)$/, '');
                const nomeOriginal = kanbanSelectedItem.origemParcial || kanbanSelectedItem.nome;
                const valorOriginalTotal = kanbanSelectedItem.valorOriginal || totalValor;

                // 1. Deletar item original
                markRoyaltiesDeleted(kanbanSelectedItem.nome, kanbanSelectedItem.importSource || '');
                GestaoFinanceira.deleteDespesa(currentMonth, kanbanSelectedItem.nome, kanbanSelectedItem.isCustom);

                // 2. Criar item PAGO com valor parcial
                const nomePago = nomeBase + ' (Pago ' + formatMoney(partialValor) + ')';
                GestaoFinanceira.addDespesa(currentMonth, {
                    nome: nomePago,
                    valor: partialValor,
                    categoria: kanbanSelectedItem.categoria || 'outros',
                    tipo: kanbanSelectedItem.tipo || '',
                    status: 'Pago',
                    origemParcial: nomeOriginal,
                    valorOriginal: valorOriginalTotal,
                    observacao: `Pagamento parcial de "${nomeOriginal}" - Original: ${formatMoney(valorOriginalTotal)}${observacao ? ' - ' + observacao : ''}`
                });
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', nomePago, 'Pago', date);

                // 3. Criar item PENDENTE com valor restante
                const nomeRestante = nomeBase + ' (Restante de ' + formatMoney(valorOriginalTotal) + ')';
                GestaoFinanceira.addDespesa(currentMonth, {
                    nome: nomeRestante,
                    valor: remainingValor,
                    categoria: kanbanSelectedItem.categoria || 'outros',
                    tipo: kanbanSelectedItem.tipo || '',
                    status: 'A Pagar',
                    origemParcial: nomeOriginal,
                    valorOriginal: valorOriginalTotal,
                    observacao: `Saldo restante de "${nomeOriginal}" - JÃ¡ pago: ${formatMoney(valorOriginalTotal - remainingValor)}`
                });

                closeKanbanPaymentModal();
                showToast(`Pago ${formatMoney(partialValor)}. Restam ${formatMoney(remainingValor)} a pagar.`, 'success');
                loadMonthData(currentMonth);
            }
        }

        // Obter label da categoria
        const categoriaLabels = {
            'pessoal': 'Pessoal',
            'comercial': 'Comercial',
            'estrutura': 'Estrutura',
            'ferramentas': 'Ferramentas',
            'servicos': 'ServiÃ§os/Freelancers',
            'alpha_franquia': 'Alpha Franquia',
            'alimentacao': 'AlimentaÃ§Ã£o',
            'operacionais': 'Operacionais',
            'taxas_bancarias': 'Taxas BancÃ¡rias',
            'outros': 'Outros'
        };
        const baseCategoryKeys = new Set(Object.keys(categoriaLabels));

        function getCategoryLabel(categoria) {
            return categoriaLabels[categoria] || categoria || 'Outros';
        }

        function getCategoryOptionsHTML(selected) {
            const options = Object.entries(categoriaLabels).map(([value, label]) => {
                const isSelected = value === (selected || 'outros') ? 'selected' : '';
                return `<option value="${value}" ${isSelected}>${label}</option>`;
            }).join('');
            return options + `<option value="__custom__">Criar categoria...</option>`;
        }

        function getStatusOptionsHTML(tipo, selected) {
            const options = tipo === 'receita' ? ['Recebido', 'A Receber'] : ['Pago', 'A Pagar'];
            return options.map(option => {
                const isSelected = option === selected ? 'selected' : '';
                return `<option value="${option}" ${isSelected}>${option}</option>`;
            }).join('');
        }

        const categoriaRules = [
            { categoria: 'operacionais', keywords: ['farmacia', 'farmÃ¡cia', 'unibox', 'mercado juan'] },
            { categoria: 'pessoal', keywords: ['juan fernando mello minni', 'juan f mello minni', 'juan f. mello minni', 'juan f minni', 'juan minni', 'adiantamento lucro', 'lucro socios', 'lucro sÃ³cios', 'adiantamento socios', 'adiantamento sÃ³cios', 'dante martins', 'dante liberato martins'] },
            { categoria: 'operacionais', keywords: ['emilly laurindo'] },
            { categoria: 'operacionais', keywords: ['one market', 'mkt one market', 'padaria', 'portus padaria', 'confeitaria'] },
            { categoria: 'taxas_bancarias', keywords: ['taxa pix', 'taxa do pix', 'taxa pix fatura', 'taxa do pix fatura', 'taxa de pix fatura', 'tarifa pix', 'tarifa do pix', 'tarifa de pix', 'pix fee', 'fatura taxa pix', 'taxa mensageria', 'tarifa mensageria', 'mensageria', 'sms', 'whatsapp', 'notificacao', 'notificaÃ§Ã£o', 'cobranca', 'cobranÃ§a', 'taxa boleto', 'taxa de boleto', 'tarifa boleto', 'taxa do boleto', 'taxa de cobranÃ§a', 'tarifa de cobranÃ§a'] },
            { categoria: 'operacionais', keywords: ['restaurante', 'lanchonete', 'hamburgueria', 'pizza', 'sorveteria', 'mercado', 'supermercado', 'padaria', 'confeitaria', 'cafe', 'cafÃ©', 'almoÃ§o', 'jantar', 'delivery', 'ifood', 'food'] },
            { categoria: 'operacionais', keywords: ['posto', 'combustivel', 'combustÃ­vel', 'gasolina', 'etanol', 'diesel', 'abastec', 'pedagio', 'pedÃ¡gio', 'estacionamento', 'parking', 'rek parking', 'tarifa', 'taxa', 'boleto', 'pix'] },
            { categoria: 'ferramentas', keywords: ['software', 'licenca', 'licenÃ§a', 'assinatura', 'saas', 'adobe', 'google', 'microsoft', 'aws', 'netlify', 'hosting', 'hospedagem', 'dominio', 'domÃ­nio', 'notion', 'trello', 'slack'] },
            { categoria: 'estrutura', keywords: ['aluguel', 'condominio', 'condomÃ­nio', 'energia', 'luz', 'agua', 'Ã¡gua', 'internet', 'telefone', 'celular', 'iptu', 'seguro'] },
            { categoria: 'comercial', keywords: ['anuncio', 'anÃºncio', 'ads', 'google ads', 'facebook', 'instagram', 'meta', 'marketing', 'trafego', 'trÃ¡fego'] },
            { categoria: 'pessoal', keywords: ['salario', 'salÃ¡rio', 'folha', 'prolabore', 'prÃ³-labore', 'pro labore', 'funcionario', 'funcionÃ¡rio', 'colaborador', 'adiantamento', 'vale'] },
            { categoria: 'servicos', keywords: ['freelancer', 'freela', 'freelance', 'prestador', 'prestador de servico', 'prestador de serviÃ§o', 'servico', 'serviÃ§o', 'consultoria'] },
            { categoria: 'alpha_franquia', keywords: ['franquia', 'alpha'] }
        ];

        const grupoLabels = {
            '': 'Sem grupo',
            'adiantamento_lucro_socios': 'Adiantamento Lucro SÃ³cios',
            'mensageria_whatsapp': 'Mensageria/WhatsApp',
            'mensageria_sms': 'Mensageria/SMS',
            'mensageria_cobranca': 'Mensageria/CobranÃ§a',
            'taxa_pix': 'Taxa Pix',
            'taxa_boleto': 'Taxa Boletos',
            'taxas_asaas': 'Taxas Asaas',
            'taxas_conta_simples': 'Tarifas Conta Simples',
            'cartoes_conta_simples': 'CartÃµes Conta Simples',
            'freelancers': 'Freelancers',
            'colaboradores': 'Colaboradores',
            'taxas_bancarias': 'Taxas BancÃ¡rias',
            'combustivel_posto': 'CombustÃ­vel/Posto',
            'alimentacao': 'AlimentaÃ§Ã£o',
            'farmacia': 'FarmÃ¡cia',
            'mercado_juan': 'Mercado Juan',
            'outros': 'Outros'
        };
        const baseGroupKeys = new Set(Object.keys(grupoLabels));

        const grupoRules = [
            { grupo: 'adiantamento_lucro_socios', keywords: ['juan fernando mello minni', 'juan minni', 'adiantamento lucro', 'lucro socios', 'lucro sÃ³cios', 'adiantamento socios', 'adiantamento sÃ³cios'] },
            { grupo: 'taxa_pix', keywords: ['taxa pix', 'taxa do pix', 'taxa pix fatura', 'taxa do pix fatura', 'taxa de pix', 'taxa de pix fatura', 'taxa para pix', 'taxa para pix com chave', 'tarifa pix', 'tarifa do pix', 'tarifa de pix', 'pix fee', 'pix fatura'] },
            { grupo: 'taxa_boleto', keywords: ['taxa boleto', 'taxa de boleto', 'tarifa boleto', 'taxa do boleto', 'boleto fee', 'taxa de cobranÃ§a', 'tarifa de cobranÃ§a'] },
            { grupo: 'mensageria_whatsapp', keywords: ['whatsapp', 'wpp', 'zap'] },
            { grupo: 'mensageria_sms', keywords: ['sms'] },
            { grupo: 'mensageria_cobranca', keywords: ['mensageria', 'cobranca', 'cobranÃ§a', 'mensagem', 'notificacao', 'notificaÃ§Ã£o', 'disparo'] },
            { grupo: 'taxas_asaas', keywords: ['taxa asaas', 'tarifa asaas', 'asaas fee', 'taxa de intermediacao', 'taxa de intermediaÃ§Ã£o', 'taxa de antecipacao', 'taxa de antecipaÃ§Ã£o', 'taxa boleto asaas', 'tarifa boleto asaas', 'taxa pix asaas', 'tarifa pix asaas', 'fatura asaas', 'mensalidade asaas'] },
            { grupo: 'taxas_conta_simples', keywords: ['conta simples', 'conta-simples', 'cs bank', 'tarifa conta simples', 'mensalidade conta simples', 'taxa conta simples'] },
            { grupo: 'cartoes_conta_simples', keywords: ['cartao conta simples', 'cartÃ£o conta simples', 'cartoes conta simples', 'cartÃµes conta simples', 'fatura conta simples', 'fatura cartao conta simples', 'fatura cartÃ£o conta simples'] },
            { grupo: 'freelancers', keywords: ['emilly laurindo', 'freelancer', 'freela', 'freelance', 'prestador', 'prestador de servico', 'prestador de serviÃ§o', 'servico', 'serviÃ§o', 'consultoria'] },
            { grupo: 'colaboradores', keywords: ['dante martins', 'dante liberato martins', 'colaborador', 'colaboradores', 'funcionario', 'funcionÃ¡rio', 'salario', 'salÃ¡rio', 'folha', 'prolabore', 'prÃ³-labore', 'pro labore', 'admissao', 'admissÃ£o'] },
            { grupo: 'taxas_bancarias', keywords: ['tarifa', 'taxa', 'tac', 'iof', 'juros', 'multa', 'anuidade', 'manutencao', 'manutenÃ§Ã£o', 'ted', 'doc', 'pix', 'boleto', 'banco'] },
            { grupo: 'combustivel_posto', keywords: ['posto', 'combustivel', 'combustÃ­vel', 'gasolina', 'etanol', 'diesel', 'abastec', 'ipiranga', 'shell', 'petrobras', 'br', 'estacionamento', 'parking', 'rek parking'] },
            { grupo: 'farmacia', keywords: ['farmacia', 'farmÃ¡cia', 'droga', 'drogaria'] },
            { grupo: 'mercado_juan', keywords: ['unibox', 'mercado juan'] },
            { grupo: 'alimentacao', keywords: ['one market', 'mkt one market', 'padaria', 'portus padaria', 'confeitaria', 'restaurante', 'lanchonete', 'hamburgueria', 'pizza', 'sorveteria', 'mercado', 'supermercado', 'cafe', 'cafÃ©', 'almoÃ§o', 'jantar', 'delivery', 'ifood', 'food'] }
        ];

        const bancoLabels = {
            'asaas': 'Asaas',
            'conta_simples': 'Conta Simples'
        };

        const bancoRules = [
            { banco: 'asaas', keywords: ['asaas'] },
            { banco: 'conta_simples', keywords: ['conta simples', 'conta-simples', 'cs bank', 'contasimples'] }
        ];

        function normalizeBankKey(banco) {
            const normalized = normalizeText(banco || '');
            if (normalized.includes('conta simples') || normalized.includes('conta-simples') || normalized.includes('contasimples') || normalized.includes('conta_simples') || normalized.includes('cs bank')) {
                return 'conta_simples';
            }
            if (normalized.includes('asaas')) return 'asaas';
            if (bancoLabels[banco]) return banco;
            return 'asaas';
        }

        function normalizeText(text) {
            return (text || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        const CUSTOM_GROUPS_KEY = 'starken_financeiro_custom_groups';
        const CUSTOM_CATEGORIES_KEY = 'starken_financeiro_custom_categories';
        const IMPORTED_KEYS_KEY = 'starken_financeiro_imported_transactions';
        const LEARNED_RULES_KEY = 'starken_financeiro_learned_rules';
        const PAGAR_IMPORT_HISTORY_KEY = 'starken_contas_pagar_import_history';
        const PAGAR_IMPORT_META_KEY = 'starken_contas_pagar_import_meta';
        const PAGAR_MONTH_SNAPSHOT_KEY = 'starken_contas_pagar_month_snapshots';
        const ROYALTIES_DELETED_KEY = 'starken_contas_pagar_royalties_deleted';

        function slugifyLabel(label) {
            return normalizeText(label)
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_+|_+$/g, '');
        }

        function loadCustomCategories() {
            try {
                const saved = JSON.parse(localStorage.getItem(CUSTOM_CATEGORIES_KEY) || '[]');
                saved.forEach(item => {
                    if (item?.id && item?.label && !categoriaLabels[item.id]) {
                        categoriaLabels[item.id] = item.label;
                    }
                });
            } catch (error) {
                localStorage.removeItem(CUSTOM_CATEGORIES_KEY);
            }
        }

        function loadCustomGroups() {
            try {
                const saved = JSON.parse(localStorage.getItem(CUSTOM_GROUPS_KEY) || '[]');
                saved.forEach(item => {
                    if (item?.id && item?.label && !grupoLabels[item.id]) {
                        grupoLabels[item.id] = item.label;
                    }
                });
            } catch (error) {
                localStorage.removeItem(CUSTOM_GROUPS_KEY);
            }
        }

        function isRoyaltiesName(nome) {
            return String(nome || '').startsWith('Alpha Royalties -');
        }

        function isAlphaFeeName(nome) {
            return String(nome || '').startsWith('Taxa de Franquia Alpha');
        }

        function markRoyaltiesDeleted(nome, importSource) {
            if (!isRoyaltiesName(nome) && importSource !== 'royalties-alpha-smart') return;
            const royaltiesDeleted = new Set(loadRoyaltiesDeleted());
            royaltiesDeleted.add(nome);
            saveRoyaltiesDeleted(Array.from(royaltiesDeleted));
        }

        function loadRoyaltiesDeleted() {
            try {
                const saved = JSON.parse(localStorage.getItem(ROYALTIES_DELETED_KEY) || '[]');
                return Array.isArray(saved) ? saved : [];
            } catch (error) {
                localStorage.removeItem(ROYALTIES_DELETED_KEY);
                return [];
            }
        }

        function saveRoyaltiesDeleted(list) {
            localStorage.setItem(ROYALTIES_DELETED_KEY, JSON.stringify(Array.from(new Set(list))));
        }

        function saveCustomCategories() {
            const custom = Object.entries(categoriaLabels)
                .filter(([key]) => !baseCategoryKeys.has(key))
                .map(([id, label]) => ({ id, label }));
            localStorage.setItem(CUSTOM_CATEGORIES_KEY, JSON.stringify(custom));
        }

        function saveCustomGroups() {
            const custom = Object.entries(grupoLabels)
                .filter(([key]) => !baseGroupKeys.has(key))
                .map(([id, label]) => ({ id, label }));
            localStorage.setItem(CUSTOM_GROUPS_KEY, JSON.stringify(custom));
        }

        function addCustomCategory(label) {
            const normalized = label.trim();
            if (!normalized) return null;
            const id = slugifyLabel(normalized);
            if (!id) return null;
            if (!categoriaLabels[id]) {
                categoriaLabels[id] = normalized;
                saveCustomCategories();
            }
            return id;
        }

        function addCustomGroup(label) {
            const normalized = label.trim();
            if (!normalized) return null;
            const id = slugifyLabel(normalized);
            if (!id) return null;
            if (!grupoLabels[id]) {
                grupoLabels[id] = normalized;
                saveCustomGroups();
            }
            return id;
        }

        let customValueContext = null;

        function openCustomValueModal({ title, label, placeholder, onConfirm, onCancel }) {
            const modal = document.getElementById('customValueModal');
            const titleEl = document.getElementById('customValueTitle');
            const labelEl = document.getElementById('customValueLabel');
            const inputEl = document.getElementById('customValueInput');
            if (!modal || !titleEl || !labelEl || !inputEl) return;
            customValueContext = { onConfirm, onCancel };
            titleEl.textContent = title || 'Criar';
            labelEl.textContent = label || 'Nome';
            inputEl.placeholder = placeholder || '';
            inputEl.value = '';
            modal.classList.add('show');
            setTimeout(() => inputEl.focus(), 0);
        }

        function closeCustomValueModal() {
            const modal = document.getElementById('customValueModal');
            if (modal) modal.classList.remove('show');
            if (customValueContext?.onCancel) {
                const cancelFn = customValueContext.onCancel;
                customValueContext = null;
                cancelFn();
            } else {
                customValueContext = null;
            }
        }

        function confirmCustomValue() {
            const inputEl = document.getElementById('customValueInput');
            if (!inputEl) return;
            const value = inputEl.value.trim();
            if (!value) {
                inputEl.focus();
                return;
            }
            const ctx = customValueContext;
            customValueContext = null;
            const modal = document.getElementById('customValueModal');
            if (modal) modal.classList.remove('show');
            if (ctx?.onConfirm) ctx.onConfirm(value);
        }

        loadCustomCategories();
        loadCustomGroups();

        let importedKeySet = new Set();
        let learnedRules = [];
        let importHistoryCache = null;

        function loadImportedKeys() {
            try {
                const saved = JSON.parse(localStorage.getItem(IMPORTED_KEYS_KEY) || '[]');
                importedKeySet = new Set(saved);
            } catch (error) {
                importedKeySet = new Set();
                localStorage.removeItem(IMPORTED_KEYS_KEY);
            }
        }

        function saveImportedKeys() {
            localStorage.setItem(IMPORTED_KEYS_KEY, JSON.stringify(Array.from(importedKeySet)));
        }

        function buildImportKey(trans) {
            if (!trans) return '';
            const amount = Math.abs(parseFloat(trans.amount || 0)).toFixed(2);
            const date = trans.date || '';
            const desc = normalizeText(trans.sourceDescricao || trans.descricao || trans.memo || trans.name || '');
            const banco = trans.banco || '';
            const tipo = trans.tipo || '';
            return [tipo, date, amount, banco, desc].join('|');
        }

        function markTransactionImported(trans) {
            const key = buildImportKey(trans);
            if (!key) return;
            importedKeySet.add(key);
            saveImportedKeys();
            trans.importKey = key;
            trans.isImported = true;
        }

        function hasMatchingCustomImport(trans) {
            const custom = (GestaoFinanceira.customItems && GestaoFinanceira.customItems[currentMonth] && GestaoFinanceira.customItems[currentMonth].despesas) || [];
            const amount = Math.abs(parseFloat(trans.amount || 0));
            const date = trans.date || '';
            const name = normalizeText(trans.descricao || trans.memo || trans.name || '');
            const banco = trans.banco || '';
            return custom.some(item => {
                const itemAmount = Math.abs(parseFloat(item.valor || 0));
                if (Math.abs(itemAmount - amount) > 0.05) return false;
                const itemDate = item.vencimento || '';
                if (itemDate !== date) return false;
                const itemName = normalizeText(item.nome || '');
                if (itemName !== name) return false;
                const itemBanco = item.empresa || '';
                return itemBanco ? itemBanco === banco : true;
            });
        }

        function hasMatchingPaidItem(trans) {
            const items = Array.isArray(allItems) ? allItems : [];
            const amount = Math.abs(parseFloat(trans.amount || 0));
            const date = trans.date || '';
            const name = normalizeText(trans.descricao || trans.memo || trans.name || '');
            return items.some(item => {
                const itemAmount = Math.abs(parseFloat(item.valor || 0));
                if (Math.abs(itemAmount - amount) > 0.05) return false;
                const itemDate = item.dataPagamento || item.vencimento || '';
                if (itemDate !== date) return false;
                if (item.status !== 'Pago' && item.status !== 'Feito') return false;
                const itemName = normalizeText(item.nome || '');
                return itemName === name;
            });
        }

        function checkTransactionImported(trans) {
            const key = buildImportKey(trans);
            trans.importKey = key;
            if (!importedKeySet.has(key)) {
                trans.isImported = false;
                return false;
            }
            const exists = hasMatchingCustomImport(trans) || hasMatchingPaidItem(trans);
            if (!exists) {
                importedKeySet.delete(key);
                saveImportedKeys();
                trans.isImported = false;
                return false;
            }
            trans.isImported = true;
            return true;
        }

        loadImportedKeys();

        function loadImportHistory() {
            if (importHistoryCache) return importHistoryCache;
            try {
                const saved = JSON.parse(localStorage.getItem(PAGAR_IMPORT_HISTORY_KEY) || '[]');
                importHistoryCache = Array.isArray(saved) ? saved : [];
            } catch (error) {
                importHistoryCache = [];
                localStorage.removeItem(PAGAR_IMPORT_HISTORY_KEY);
            }
            return importHistoryCache;
        }

        function resetImportHistoryCache() {
            importHistoryCache = null;
        }

        function saveImportHistory(history) {
            importHistoryCache = history;
            localStorage.setItem(PAGAR_IMPORT_HISTORY_KEY, JSON.stringify(history));
        }

        function loadImportMeta() {
            try {
                const saved = JSON.parse(localStorage.getItem(PAGAR_IMPORT_META_KEY) || '{}');
                return saved && typeof saved === 'object' ? saved : {};
            } catch (error) {
                localStorage.removeItem(PAGAR_IMPORT_META_KEY);
                return {};
            }
        }

        function saveImportMeta(meta) {
            localStorage.setItem(PAGAR_IMPORT_META_KEY, JSON.stringify(meta));
        }

        function setImportMetaForMonth(month, updates) {
            const meta = loadImportMeta();
            const current = meta[month] || {};
            meta[month] = { ...current, ...updates };
            saveImportMeta(meta);
            return meta[month];
        }

        function getImportMetaForMonth(month) {
            const meta = loadImportMeta();
            return meta[month] || {};
        }

        function setImportMetaForMonthBank(month, bank, updates) {
            const meta = loadImportMeta();
            const current = meta[month] || {};
            const banks = current.banks || {};
            const bankKey = bank || 'asaas';
            const bankCurrent = banks[bankKey] || {};
            banks[bankKey] = { ...bankCurrent, ...updates };
            meta[month] = { ...current, banks };
            saveImportMeta(meta);
            return banks[bankKey];
        }

        function guessBankFromItem(item) {
            const explicitText = normalizeText(item?.importSource || item?.empresa || '');
            if (explicitText.includes('conta simples') || explicitText.includes('conta-simples') || explicitText.includes('contasimples') || explicitText.includes('conta_simples') || explicitText.includes('cs bank')) {
                return 'conta_simples';
            }
            if (explicitText.includes('asaas')) return 'asaas';
            const grupo = normalizeText(item?.grupo || '');
            if (grupo === 'taxas_conta_simples' || grupo === 'cartoes_conta_simples') {
                return 'conta_simples';
            }
            const text = normalizeText([item?.nome, item?.tipo, item?.categoria].filter(Boolean).join(' '));
            if (text.includes('conta simples') || text.includes('conta-simples') || text.includes('contasimples') || text.includes('conta_simples') || text.includes('cs bank')) {
                return 'conta_simples';
            }
            if (text.includes('asaas')) return 'asaas';
            return 'asaas';
        }

        function setMetaLatest(meta, month, bankKey, dateValue) {
            if (!month || !bankKey || !dateValue) return;
            const current = meta[month] || {};
            const banks = current.banks || {};
            const bankCurrent = banks[bankKey] || {};
            const newMs = Date.parse(dateValue);
            const existingMs = Date.parse(bankCurrent.lastImportAt || '');
            if (!bankCurrent.lastImportAt || (!Number.isNaN(newMs) && (Number.isNaN(existingMs) || newMs > existingMs))) {
                banks[bankKey] = { ...bankCurrent, lastImportAt: dateValue, lastReconcileAt: dateValue };
                meta[month] = { ...current, banks };
            }
        }

        function rebuildImportMetaFromSources() {
            const meta = {};
            const history = loadImportHistory();
            history.forEach(run => {
                const month = run.month;
                const sources = Array.isArray(run.sources) && run.sources.length ? run.sources : ['asaas'];
                sources.forEach(source => {
                    const bankKey = normalizeBankKey(source);
                    setMetaLatest(meta, month, bankKey, run.createdAt || '');
                });
            });
            const custom = GestaoFinanceira.customItems || {};
            Object.keys(custom).forEach(month => {
                const items = [
                    ...((custom[month]?.despesas) || []),
                    ...((custom[month]?.receitas) || [])
                ];
                items.forEach(item => {
                    const importedAt = item.importedAt || '';
                    if (!importedAt) return;
                    const bankKey = guessBankFromItem(item);
                    setMetaLatest(meta, month, bankKey, importedAt);
                });
            });
            saveImportMeta(meta);
        }

        function ensureImportMetaSynced() {
            rebuildImportMetaFromSources();
        }

        function getLatestImportTimesForMonth(mes) {
            const meta = getImportMetaForMonth(mes);
            const banksMeta = meta.banks || {};
            const result = {
                asaas: {
                    lastImportAt: banksMeta.asaas?.lastImportAt || '',
                    lastReconcileAt: banksMeta.asaas?.lastReconcileAt || ''
                },
                conta_simples: {
                    lastImportAt: banksMeta.conta_simples?.lastImportAt || '',
                    lastReconcileAt: banksMeta.conta_simples?.lastReconcileAt || ''
                }
            };
            const updateLatest = (target, dateValue) => {
                if (!dateValue) return;
                const newMs = Date.parse(dateValue);
                const currentMs = Date.parse(target.lastImportAt || '');
                if (!target.lastImportAt || (!Number.isNaN(newMs) && (Number.isNaN(currentMs) || newMs > currentMs))) {
                    target.lastImportAt = dateValue;
                    target.lastReconcileAt = dateValue;
                }
            };
            let genericLatest = '';
            const updateGeneric = (dateValue) => {
                if (!dateValue) return;
                const newMs = Date.parse(dateValue);
                const currentMs = Date.parse(genericLatest || '');
                if (!genericLatest || (!Number.isNaN(newMs) && (Number.isNaN(currentMs) || newMs > currentMs))) {
                    genericLatest = dateValue;
                }
            };
            const history = loadImportHistory().filter(run => run.month === mes);
            history.forEach(run => {
                const sources = Array.isArray(run.sources) && run.sources.length ? run.sources : ['asaas'];
                sources.forEach(source => {
                    const bankKey = normalizeBankKey(source);
                    if (result[bankKey]) {
                        updateLatest(result[bankKey], run.createdAt || '');
                    }
                });
                updateGeneric(run.createdAt || '');
            });
            const customMonth = GestaoFinanceira.customItems?.[mes] || { despesas: [], receitas: [] };
            const items = [
                ...(customMonth.despesas || []),
                ...(customMonth.receitas || [])
            ];
            items.forEach(item => {
                const importedAt = item.importedAt || '';
                if (!importedAt) return;
                const bankKey = guessBankFromItem(item);
                if (result[bankKey]) {
                    updateLatest(result[bankKey], importedAt);
                }
                updateGeneric(importedAt);
            });
            const statusData = GestaoFinanceira.statusData || {};
            Object.keys(statusData).forEach(key => {
                if (!key.startsWith(`${mes}_`)) return;
                const updatedAt = statusData[key]?.updatedAt || '';
                updateGeneric(updatedAt);
            });
            const hasAnyImport = history.length > 0 || items.some(item => item.importedAt) || Object.keys(statusData).some(key => key.startsWith(`${mes}_`));
            if (hasAnyImport) {
                if (!result.asaas.lastImportAt && genericLatest) {
                    updateLatest(result.asaas, genericLatest);
                }
                if (!result.conta_simples.lastImportAt && genericLatest) {
                    updateLatest(result.conta_simples, genericLatest);
                }
            }
            return result;
        }

        function renderImportDiagnostics() {
            const container = document.getElementById('diagnosticContent');
            if (!container) return;
            const months = ['2025-11', '2025-12', '2026-01'];
            const history = loadImportHistory();
            const custom = GestaoFinanceira.customItems || {};
            const statusData = GestaoFinanceira.statusData || {};

            const itemsByMonth = {};
            months.forEach(mes => {
                itemsByMonth[mes] = [
                    ...((custom[mes]?.despesas) || []),
                    ...((custom[mes]?.receitas) || [])
                ];
            });

            const getSourcesForRun = (run) => {
                if (!run) return [];
                if (Array.isArray(run.sources) && run.sources.length) return run.sources;
                const monthItems = itemsByMonth[run.month] || [];
                const derived = monthItems
                    .filter(item => item.importRunId && item.importRunId === run.id)
                    .map(item => guessBankFromItem(item));
                return Array.from(new Set(derived.filter(Boolean)));
            };

            const rows = months.map(mes => {
                const latest = getLatestImportTimesForMonth(mes);
                const runs = history.filter(run => run.month === mes);
                const lastRun = runs.reduce((acc, run) => {
                    const time = Date.parse(run.createdAt || '');
                    if (!acc || (Number.isFinite(time) && time > acc.time)) {
                        return { time, run };
                    }
                    return acc;
                }, null);
                const items = itemsByMonth[mes] || [];
                const importedItems = items.filter(item => item.importedAt);
                const asaasItems = importedItems.filter(item => guessBankFromItem(item) === 'asaas').length;
                const contaItems = importedItems.filter(item => guessBankFromItem(item) === 'conta_simples').length;
                const statusCount = Object.keys(statusData).filter(key => key.startsWith(`${mes}_`)).length;
                const lastRunSources = getSourcesForRun(lastRun?.run);
                return {
                    mes,
                    runs: runs.length,
                    lastRunAt: lastRun?.run?.createdAt || '',
                    lastRunSources: lastRunSources.length ? lastRunSources.join(', ') : '-',
                    importedItems: importedItems.length,
                    asaasItems,
                    contaItems,
                    statusCount,
                    asaasLast: latest.asaas.lastImportAt || '',
                    contaLast: latest.conta_simples.lastImportAt || ''
                };
            });

            const tableRows = rows.map(row => `
                <tr>
                    <td>${row.mes}</td>
                    <td>${row.runs}</td>
                    <td>${formatDateTime(row.lastRunAt)}</td>
                    <td>${row.lastRunSources}</td>
                    <td>${row.importedItems}</td>
                    <td>${row.asaasItems}</td>
                    <td>${row.contaItems}</td>
                    <td>${row.statusCount}</td>
                    <td>${formatDateTime(row.asaasLast)}</td>
                    <td>${formatDateTime(row.contaLast)}</td>
                </tr>
            `).join('');

            const historyDetails = rows.map(row => {
                const runs = history.filter(run => run.month === row.mes).slice(-5).reverse();
                const list = runs.map(run => {
                    const sources = getSourcesForRun(run);
                    const created = formatDateTime(run.createdAt);
                    const createdDespesas = run.createdDespesas?.length || 0;
                    const matched = run.matchedDespesas?.length || 0;
                    return `<span>${created} â¢ ${sources.length ? sources.join(', ') : '-'} â¢ criadas ${createdDespesas} â¢ conciliadas ${matched}</span>`;
                }).join('');
                const fallback = runs.length ? '' : '<span>Nenhum run encontrado no histÃ³rico.</span>';
                return `
                    <div class="diagnostic-section">
                        <div class="diagnostic-section-title">${row.mes}</div>
                        <div class="diagnostic-list">${list || fallback}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <table class="diagnostic-table">
                    <thead>
                        <tr>
                            <th>MÃªs</th>
                            <th>Runs</th>
                            <th>Ãltimo run</th>
                            <th>Fontes</th>
                            <th>Itens</th>
                            <th>Asaas</th>
                            <th>Conta</th>
                            <th>Status</th>
                            <th>Asaas Ãºltimo</th>
                            <th>Conta Ãºltimo</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
                ${historyDetails}
            `;
        }

        async function refreshImportDiagnostics() {
            resetImportHistoryCache();
            if (typeof GestaoFinanceira?.loadFromServer === 'function') {
                await GestaoFinanceira.loadFromServer();
            }
            ensureImportMetaSynced();
            renderImportDiagnostics();
            showToast('DiagnÃ³stico atualizado', 'success');
        }

        function openImportDiagnostics() {
            openModal('diagnosticModal');
            refreshImportDiagnostics();
        }

        function resetImportsForTargetMonths() {
            const targetMonths = ['2025-11', '2025-12', '2026-01'];
            if (!confirm('Isso vai remover lanÃ§amentos importados e limpar o histÃ³rico desses meses. Deseja continuar?')) {
                return;
            }

            const custom = GestaoFinanceira.customItems || {};
            const removedByMonth = {};
            targetMonths.forEach(month => {
                removedByMonth[month] = { despesas: new Set(), receitas: new Set() };
                const monthData = custom[month];
                if (!monthData) return;
                const despesas = Array.isArray(monthData.despesas) ? monthData.despesas : [];
                const receitas = Array.isArray(monthData.receitas) ? monthData.receitas : [];
                const filteredDespesas = despesas.filter(item => {
                    if (item?.importedAt || item?.importRunId) {
                        if (item?.nome) removedByMonth[month].despesas.add(item.nome);
                        return false;
                    }
                    return true;
                });
                const filteredReceitas = receitas.filter(item => {
                    if (item?.importedAt || item?.importRunId) {
                        if (item?.nome) removedByMonth[month].receitas.add(item.nome);
                        return false;
                    }
                    return true;
                });
                custom[month] = { despesas: filteredDespesas, receitas: filteredReceitas };
            });
            GestaoFinanceira.customItems = custom;

            const statusData = GestaoFinanceira.statusData || {};
            targetMonths.forEach(month => {
                const removed = removedByMonth[month];
                if (!removed) return;
                removed.despesas.forEach(nome => {
                    const id = GestaoFinanceira.generateId(month, 'despesa', nome);
                    delete statusData[id];
                });
                removed.receitas.forEach(nome => {
                    const id = GestaoFinanceira.generateId(month, 'receita', nome);
                    delete statusData[id];
                });
            });
            GestaoFinanceira.statusData = statusData;

            const history = loadImportHistory().filter(run => !targetMonths.includes(run.month));
            saveImportHistory(history);
            resetImportHistoryCache();

            const meta = loadImportMeta();
            targetMonths.forEach(month => {
                delete meta[month];
            });
            saveImportMeta(meta);

            importedKeySet = new Set();
            saveImportedKeys();

            if (typeof GestaoFinanceira.saveToStorage === 'function') {
                GestaoFinanceira.saveToStorage();
            }
            ensureImportMetaSynced();
            renderImportDiagnostics();
            loadMonthData(currentMonth);
            showToast('ImportaÃ§Ãµes dos meses resetadas.', 'success');
        }

        function clearBaseItemsForTargetMonths() {
            const targetMonths = ['2025-11', '2025-12', '2026-01'];
            if (!confirm('Isso vai ocultar os lanÃ§amentos base desses meses. Deseja continuar?')) {
                return;
            }

            if (!GestaoFinanceira.deletedItems) {
                GestaoFinanceira.deletedItems = {};
            }
            const statusData = GestaoFinanceira.statusData || {};

            targetMonths.forEach(month => {
                const base = dadosMensais?.[month]?.despesas?.categorias || {};
                const nomes = new Set();
                Object.values(base).forEach(categoria => {
                    (categoria?.itens || []).forEach(item => {
                        if (item?.nome) nomes.add(item.nome);
                    });
                });

                const deleted = GestaoFinanceira.deletedItems[month] || { despesas: [], receitas: [] };
                const merged = new Set(deleted.despesas || []);
                nomes.forEach(nome => merged.add(nome));
                GestaoFinanceira.deletedItems[month] = {
                    despesas: Array.from(merged),
                    receitas: deleted.receitas || []
                };

                nomes.forEach(nome => {
                    const id = GestaoFinanceira.generateId(month, 'despesa', nome);
                    delete statusData[id];
                });
            });

            GestaoFinanceira.statusData = statusData;
            if (typeof GestaoFinanceira.saveToStorage === 'function') {
                GestaoFinanceira.saveToStorage();
            }
            loadMonthData(currentMonth);
            renderImportDiagnostics();
            showToast('LanÃ§amentos base ocultados.', 'success');
        }

        function createImportRun() {
            return {
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                month: currentMonth,
                createdAt: new Date().toISOString(),
                createdDespesas: [],
                createdReceitas: [],
                matchedDespesas: [],
                sources: []
            };
        }

        function getCustomItemsForMonth() {
            const custom = (GestaoFinanceira.customItems && GestaoFinanceira.customItems[currentMonth]) || { despesas: [], receitas: [] };
            return {
                despesas: Array.isArray(custom.despesas) ? custom.despesas : [],
                receitas: Array.isArray(custom.receitas) ? custom.receitas : []
            };
        }

        function buildRecoveryRunFromMetadata() {
            const { despesas, receitas } = getCustomItemsForMonth();
            const items = [
                ...despesas.map(item => ({ ...item, tipo: 'despesa' })),
                ...receitas.map(item => ({ ...item, tipo: 'receita' }))
            ];
            const withRun = items.filter(item => item.importRunId && item.importedAt);
            if (withRun.length === 0) return null;
            const latest = withRun.reduce((acc, item) => {
                const time = new Date(item.importedAt).getTime();
                if (!acc || time > acc.time) {
                    return { time, runId: item.importRunId };
                }
                return acc;
            }, null);
            if (!latest) return null;
            const selected = withRun.filter(item => item.importRunId === latest.runId);
            return { source: 'metadata', items: selected };
        }

        function buildRecoveryRunFromCreationWindow(minutes = 30) {
            const { despesas, receitas } = getCustomItemsForMonth();
            const items = [
                ...despesas.map(item => ({ ...item, tipo: 'despesa' })),
                ...receitas.map(item => ({ ...item, tipo: 'receita' }))
            ];
            const withCreated = items.filter(item => item.dataCriacao);
            if (withCreated.length === 0) return null;
            const latestTime = withCreated.reduce((acc, item) => {
                const time = new Date(item.dataCriacao).getTime();
                return Number.isFinite(time) && time > acc ? time : acc;
            }, 0);
            if (!latestTime) return null;
            const cutoff = latestTime - minutes * 60 * 1000;
            const selected = withCreated.filter(item => {
                const time = new Date(item.dataCriacao).getTime();
                return Number.isFinite(time) && time >= cutoff;
            });
            return selected.length ? { source: 'window', items: selected } : null;
        }

        function getPreviousDespesaStatus(nome) {
            const savedStatus = GestaoFinanceira.getStatus(currentMonth, 'despesa', nome);
            if (savedStatus) return savedStatus;
            const existing = allItems.find(item => item.nome === nome);
            if (existing) {
                return {
                    status: existing.status || 'A Pagar',
                    dataPagamento: existing.dataPagamento || null
                };
            }
            return null;
        }

        function restoreLastImports(count = 1) {
            const history = loadImportHistory();
            const targetRuns = [];

            for (let i = history.length - 1; i >= 0 && targetRuns.length < count; i--) {
                if (history[i].month === currentMonth) targetRuns.push(history[i]);
            }

            if (targetRuns.length === 0) {
                const recoveryRun = buildRecoveryRunFromMetadata() || buildRecoveryRunFromCreationWindow();
                if (!recoveryRun) {
                    showToast('Nenhum import recente para restaurar neste mÃªs.', 'info');
                    return;
                }
                recoveryRun.items.forEach(item => {
                    if (item.tipo === 'despesa') {
                        GestaoFinanceira.deleteDespesa(currentMonth, item.nome, true);
                    } else {
                        GestaoFinanceira.deleteReceita(currentMonth, item.nome, true);
                    }
                });
                if (typeof GestaoFinanceira.syncToServer === 'function') {
                    GestaoFinanceira.syncToServer();
                }
                loadMonthData(currentMonth);
                const message = recoveryRun.source === 'metadata'
                    ? 'RestauraÃ§Ã£o concluÃ­da com base no Ãºltimo import.'
                    : 'RestauraÃ§Ã£o parcial: removidos lanÃ§amentos criados recentemente.';
                showToast(message, 'success');
                return;
            }

            targetRuns.forEach(run => {
                run.createdDespesas.forEach(item => {
                    GestaoFinanceira.deleteDespesa(currentMonth, item.nome, true);
                });
                run.createdReceitas.forEach(item => {
                    GestaoFinanceira.deleteReceita(currentMonth, item.nome, true);
                });
                run.matchedDespesas.forEach(item => {
                    const previous = item.previousStatus || { status: 'A Pagar', dataPagamento: null };
                    GestaoFinanceira.updateStatus(currentMonth, 'despesa', item.nome, previous.status, previous.dataPagamento || null);
                });
            });

            const updatedHistory = history.filter(run => !targetRuns.includes(run));
            saveImportHistory(updatedHistory);

            if (typeof GestaoFinanceira.syncToServer === 'function') {
                GestaoFinanceira.syncToServer();
            }

            loadMonthData(currentMonth);
            showToast('Ãltimo import restaurado.', 'success');
        }

        function loadLearnedRules() {
            try {
                const saved = JSON.parse(localStorage.getItem(LEARNED_RULES_KEY) || '[]');
                learnedRules = Array.isArray(saved) ? saved : [];
            } catch (error) {
                learnedRules = [];
                localStorage.removeItem(LEARNED_RULES_KEY);
            }
        }

        function saveLearnedRules() {
            localStorage.setItem(LEARNED_RULES_KEY, JSON.stringify(learnedRules));
        }

        function normalizeRulePattern(text) {
            return normalizeText(text || '').trim();
        }

        function buildLearnedPatterns(text) {
            const normalized = normalizeRulePattern(text);
            if (!normalized) return [];
            const patterns = new Set([normalized]);
            const prefixes = [
                'transacao via pix com qr code para',
                'transacao via pix com chave para',
                'transacao via pix para',
                'transacao via pix',
                'taxa do pix - fatura nr.',
                'taxa do pix - fatura',
                'taxa do pix',
                'taxa para pix com chave',
                'taxa para pix',
                'taxa pix',
                'cobranca recebida - fatura nr.',
                'cobranca recebida - fatura',
                'cobranca recebida'
            ];
            prefixes.forEach(prefix => {
                if (normalized.startsWith(prefix)) {
                    const rest = normalized.slice(prefix.length).trim();
                    if (rest.length >= 3) {
                        patterns.add(rest);
                    }
                }
            });
            const withoutNumbers = normalized.replace(/\b\d+\b/g, '').replace(/\s+/g, ' ').trim();
            if (withoutNumbers.length >= 3) {
                patterns.add(withoutNumbers);
            }
            return Array.from(patterns);
        }

        function upsertLearnedRule(pattern, data) {
            if (!pattern || pattern.length < 3) return;
            const idx = learnedRules.findIndex(rule => rule.pattern === pattern);
            const entry = {
                pattern,
                categoria: data.categoria || 'outros',
                grupo: data.grupo || '',
                banco: data.banco || ''
            };
            if (idx >= 0) {
                learnedRules[idx] = { ...learnedRules[idx], ...entry };
            } else {
                learnedRules.push(entry);
            }
            learnedRules.sort((a, b) => b.pattern.length - a.pattern.length);
            saveLearnedRules();
        }

        function findLearnedRule(descricao) {
            const normalized = normalizeRulePattern(descricao);
            if (!normalized) return null;
            return learnedRules.find(rule => normalized.includes(rule.pattern)) || null;
        }

        function learnFromTransaction(trans) {
            const source = trans?.sourceDescricao || trans?.descricao || trans?.memo || trans?.name || '';
            const patterns = buildLearnedPatterns(source);
            if (!patterns.length) return;
            patterns.forEach(pattern => {
                upsertLearnedRule(pattern, {
                    categoria: trans.categoria || 'outros',
                    grupo: trans.grupo || '',
                    banco: trans.banco || ''
                });
            });
        }

        function buildLearnedRulesFromHistory() {
            if (!window.GestaoFinanceira || !GestaoFinanceira.customItems) return;
            const months = Object.values(GestaoFinanceira.customItems);
            months.forEach(month => {
                (month?.despesas || []).forEach(item => {
                    const pattern = normalizeRulePattern(item?.nome);
                    if (!pattern) return;
                    upsertLearnedRule(pattern, {
                        categoria: item.categoria || 'outros',
                        grupo: item.tipo || '',
                        banco: item.empresa || ''
                    });
                });
            });
        }

        loadLearnedRules();
        buildLearnedRulesFromHistory();

        function refreshCategorySelects() {
            document.querySelectorAll('#reconciliationList .reconcile-item').forEach(row => {
                const index = parseInt(row.dataset.index, 10);
                const trans = importedTransactions[index];
                const select = row.querySelector('.import-category');
                if (!select || !trans) return;
                const current = trans.tipo === 'receita' ? 'outros' : (trans.categoria || 'outros');
                select.innerHTML = getCategoryOptionsHTML(current);
                select.value = current;
            });
        }

        function refreshGroupSelects() {
            document.querySelectorAll('#reconciliationList .reconcile-item').forEach(row => {
                const index = parseInt(row.dataset.index, 10);
                const trans = importedTransactions[index];
                const select = row.querySelector('.import-group');
                if (!select || !trans) return;
                const current = trans.tipo === 'receita' ? '' : (trans.grupo || '');
                select.innerHTML = getGroupOptionsHTML(current);
                select.value = current;
                row.dataset.group = current;
            });
        }

        function suggestCategory(descricao) {
            const learned = findLearnedRule(descricao);
            if (learned?.categoria) return learned.categoria;
            const normalized = normalizeText(descricao);
            for (const rule of categoriaRules) {
                if (rule.keywords.some(keyword => normalized.includes(normalizeText(keyword)))) {
                    return rule.categoria;
                }
            }
            return 'outros';
        }

        function suggestGroup(descricao) {
            const learned = findLearnedRule(descricao);
            if (learned?.grupo) return learned.grupo;
            const normalized = normalizeText(descricao);
            for (const rule of grupoRules) {
                if (rule.keywords.some(keyword => normalized.includes(normalizeText(keyword)))) {
                    return rule.grupo;
                }
            }
            return '';
        }

        function suggestBank(descricao) {
            const learned = findLearnedRule(descricao);
            if (learned?.banco) return learned.banco;
            const normalized = normalizeText(descricao);
            for (const rule of bancoRules) {
                if (rule.keywords.some(keyword => normalized.includes(normalizeText(keyword)))) {
                    return rule.banco;
                }
            }
            return 'asaas';
        }

        function getGroupOptionsHTML(selected) {
            const options = Object.entries(grupoLabels).map(([value, label]) => {
                const isSelected = value === (selected ?? '') ? 'selected' : '';
                return `<option value="${value}" ${isSelected}>${label}</option>`;
            }).join('');
            return options + `<option value="__custom__">Criar grupo...</option>`;
        }

        function getBankOptionsHTML(selected) {
            return Object.entries(bancoLabels).map(([value, label]) => {
                const isSelected = value === (selected || 'asaas') ? 'selected' : '';
                return `<option value="${value}" ${isSelected}>${label}</option>`;
            }).join('');
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeKanbanPaymentModal();
                closeCustomValueModal();
            }
        });

        // Fechar modal clicando fora
        document.getElementById('kanbanPaymentModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeKanbanPaymentModal();
            }
        });
        document.getElementById('customValueModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeCustomValueModal();
            }
        });
        // ========================================
        // IMPORTAÃÃO DE EXTRATO BANCÃRIO
        // ========================================
        let importedTransactions = [];
        let importedOfxRange = null;
        let selectedGroupFilter = 'all';
        let importBankHint = null;

        function buildGroupSummary(transactions) {
            const summary = {};
            transactions.forEach(trans => {
                const grupo = trans.grupo || '';
                if (!summary[grupo]) {
                    summary[grupo] = { grupo, count: 0, total: 0 };
                }
                summary[grupo].count += 1;
                summary[grupo].total += Math.abs(trans.amount || 0);
            });
            return Object.values(summary).sort((a, b) => b.total - a.total);
        }

        function renderGroupSummary(transactions) {
            const container = document.getElementById('groupSummary');
            if (!container) return;

            const totalCount = transactions.length;
            const totalValue = transactions.reduce((sum, trans) => sum + Math.abs(trans.amount || 0), 0);
            const summary = buildGroupSummary(transactions);
            const groupsSet = new Set(summary.map(item => item.grupo));

            if (selectedGroupFilter !== 'all' && !groupsSet.has(selectedGroupFilter)) {
                selectedGroupFilter = 'all';
            }

            const cards = [
                { grupo: 'all', label: 'Todos', count: totalCount, total: totalValue },
                ...summary.map(item => ({
                    grupo: item.grupo,
                    label: grupoLabels[item.grupo ?? ''] || item.grupo || 'Sem grupo',
                    count: item.count,
                    total: item.total
                }))
            ];

            container.innerHTML = cards.map(card => `
                <div class="group-card ${selectedGroupFilter === card.grupo ? 'active' : ''}" data-group="${card.grupo}">
                    <div class="group-card-title">${card.label}</div>
                    <div class="group-card-value">${formatMoney(card.total)}</div>
                    <div class="group-card-meta">
                        <span>${card.count} itens</span>
                        <span>${card.grupo === 'all' ? '100%' : Math.round((card.total / (totalValue || 1)) * 100)}%</span>
                    </div>
                </div>
            `).join('');

            container.onclick = (event) => {
                const card = event.target.closest('.group-card');
                if (!card) return;
                selectedGroupFilter = card.dataset.group;
                applyGroupFilter();
                renderGroupSummary(transactions);
            };
        }

        function applyGroupFilter() {
            const rows = document.querySelectorAll('#reconciliationList .reconcile-item');
            let visibleCount = 0;
            rows.forEach(row => {
                const grupo = row.dataset.group || '';
                const show = selectedGroupFilter === 'all' || grupo === selectedGroupFilter;
                row.style.display = show ? '' : 'none';
                if (show) visibleCount += 1;
            });

            const info = document.getElementById('groupFilterInfo');
            if (!info) return;
            if (selectedGroupFilter === 'all') {
                info.textContent = '';
            } else {
                const label = grupoLabels[selectedGroupFilter] || selectedGroupFilter;
                info.textContent = `Filtro ativo: ${label} â¢ ${visibleCount} itens`;
            }
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('btnProcessImport').style.display = 'none';
            document.getElementById('btnRestoreImport').style.display = 'none';
            document.getElementById('bankFile').value = '';
            importedTransactions = [];
            importedOfxRange = null;
            selectedGroupFilter = 'all';
            const monthLabel = document.getElementById('importMonthLabel');
            if (monthLabel) {
                monthLabel.textContent = formatMonthLabel(currentMonth);
            }
            const rangeLabel = document.getElementById('importOfxRange');
            if (rangeLabel) {
                rangeLabel.textContent = '-';
            }
        }

        function handleBankFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const ext = file.name.split('.').pop().toLowerCase();
                importedOfxRange = null;
                importBankHint = null;

                const normalizedName = normalizeText(file.name);
                const sample = content ? content.slice(0, 20000) : '';
                const normalizedSample = normalizeText(sample);
                const isContaSimples =
                    normalizedName.includes('conta simples') ||
                    normalizedName.includes('conta-simples') ||
                    normalizedName.includes('conta_simples') ||
                    normalizedName.includes('contasimples') ||
                    normalizedName.includes('cs bank') ||
                    normalizedName.includes('csbank') ||
                    normalizedSample.includes('conta simples') ||
                    normalizedSample.includes('conta-simples') ||
                    normalizedSample.includes('conta_simples') ||
                    normalizedSample.includes('contasimples') ||
                    normalizedSample.includes('cs bank') ||
                    normalizedSample.includes('csbank') ||
                    /<org>.*conta\s*simples/i.test(sample) ||
                    /<bankname>.*conta\s*simples/i.test(sample);
                if (isContaSimples) {
                    importBankHint = 'conta_simples';
                }

                if (ext === 'ofx') {
                    parseOFX(content);
                } else if (ext === 'csv') {
                    parseCSV(content);
                } else {
                    alert('Formato nÃ£o suportado. Use OFX ou CSV.');
                    return;
                }

                showReconciliation();
            };
            reader.readAsText(file);
        }

        function parseOFX(content) {
            const transactions = [];
            const lines = content.split('\n');
            let currentTransaction = {};
            let inTransaction = false;

            lines.forEach(line => {
                if (line.includes('<STMTTRN>')) {
                    inTransaction = true;
                    currentTransaction = {};
                } else if (line.includes('</STMTTRN>')) {
                    inTransaction = false;
                    if (currentTransaction.amount && currentTransaction.date) {
                        transactions.push(currentTransaction);
                    }
                } else if (inTransaction) {
                    if (line.includes('<TRNAMT>')) currentTransaction.amount = parseFloat(line.split('<TRNAMT>')[1].split('<')[0]);
                    if (line.includes('<DTPOSTED>')) {
                        const dateStr = line.split('<DTPOSTED>')[1].split('<')[0];
                        currentTransaction.date = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                    }
                    if (line.includes('<MEMO>')) currentTransaction.memo = line.split('<MEMO>')[1].split('<')[0];
                    if (line.includes('<NAME>')) currentTransaction.name = line.split('<NAME>')[1].split('<')[0];
                }
            });
            importedOfxRange = extractOfxRange(content);
            normalizeImportedTransactions(transactions);
        }

        function parseCSV(content) {
            const transactions = [];
            const lines = content.split('\n');
            const separator = lines[0].includes(';') ? ';' : ',';

            lines.forEach((line, index) => {
                if (index === 0) return; // Skip header
                const cols = line.split(separator);
                if (cols.length >= 3) {
                    const date = cols[0].trim(); // Assumes YYYY-MM-DD or DD/MM/YYYY
                    const desc = cols[1].trim();
                    const amount = parseFloat(cols[2].replace(',', '.').trim());

                    if (date && !isNaN(amount)) {
                        let formattedDate = date;
                        if (date.includes('/')) {
                            const parts = date.split('/');
                            formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                        transactions.push({
                            date: formattedDate,
                            name: desc,
                            amount: amount,
                            memo: desc
                        });
                    }
                }
            });
            normalizeImportedTransactions(transactions);
        }

        function normalizeImportedTransactions(transactions) {
            const baseTransactions = transactions.map(t => {
                const amount = parseFloat(t.amount);
                const isExpense = amount < 0;
                const descricao = (t.memo || t.name || 'LanÃ§amento importado').trim();
                const categoria = isExpense ? suggestCategory(descricao) : 'outros';
                const grupo = isExpense ? suggestGroup(descricao) : '';
                const banco = importBankHint || (isExpense ? suggestBank(descricao) : 'asaas');
                return {
                    date: t.date,
                    amount: amount,
                    memo: t.memo,
                    name: t.name,
                    descricao: descricao,
                    sourceDescricao: descricao,
                    tipo: isExpense ? 'despesa' : 'receita',
                    categoria: categoria,
                    grupo: grupo,
                    banco: banco,
                    status: isExpense ? 'Pago' : 'Recebido',
                    matchName: ''
                };
            });

            const groupConfigs = [
                {
                    id: 'taxa_pix',
                    label: 'Taxa Pix (Agrupado)',
                    categoria: 'taxas_bancarias',
                    grupo: 'taxa_pix',
                    match: trans => trans.grupo === 'taxa_pix'
                },
                {
                    id: 'taxa_boleto',
                    label: 'Taxa Boleto (Agrupado)',
                    categoria: 'taxas_bancarias',
                    grupo: 'taxa_boleto',
                    match: trans => trans.grupo === 'taxa_boleto'
                },
                {
                    id: 'mensageria',
                    label: 'Mensageria (Agrupado)',
                    categoria: 'taxas_bancarias',
                    grupo: 'mensageria_cobranca',
                    match: trans => trans.grupo && trans.grupo.startsWith('mensageria_')
                },
                {
                    id: 'combustivel_posto',
                    label: 'CombustÃ­vel/Posto (Agrupado)',
                    categoria: 'operacionais',
                    grupo: 'combustivel_posto',
                    match: (trans, normalized) => trans.grupo === 'combustivel_posto' || ['estacionamento', 'parking', 'rek parking'].some(term => normalized.includes(term))
                },
                {
                    id: 'freelancers',
                    label: 'Freelancers (Agrupado)',
                    categoria: 'operacionais',
                    grupo: 'freelancers',
                    match: (trans, normalized) => normalized.includes('emilly laurindo')
                },
                {
                    id: 'alimentacao',
                    label: 'Operacionais/AlimentaÃ§Ã£o (Agrupado)',
                    categoria: 'operacionais',
                    grupo: 'alimentacao',
                    match: (trans, normalized) => ['restaurante', 'mercado', 'lanchonete', 'padaria', 'confeitaria', 'hamburgueria', 'pizza', 'sorveteria', 'supermercado', 'cafe', 'cafÃ©', 'almoÃ§o', 'jantar', 'delivery', 'ifood', 'food', 'one market'].some(term => normalized.includes(term))
                },
                {
                    id: 'farmacia',
                    label: 'Operacionais/FarmÃ¡cia (Agrupado)',
                    categoria: 'operacionais',
                    grupo: 'farmacia',
                    match: (trans, normalized) => ['farmacia', 'farmÃ¡cia', 'droga', 'drogaria'].some(term => normalized.includes(term))
                },
                {
                    id: 'mercado_juan',
                    label: 'Operacionais/Mercado Juan (Agrupado)',
                    categoria: 'operacionais',
                    grupo: 'mercado_juan',
                    match: (trans, normalized) => ['unibox', 'mercado juan', 'mercados'].some(term => normalized.includes(term))
                },
                {
                    id: 'adiantamento_lucro_socios',
                    label: 'Adiantamento Lucro SÃ³cios (Agrupado)',
                    categoria: 'pessoal',
                    grupo: 'adiantamento_lucro_socios',
                    match: (trans, normalized) => normalized.includes('juan minni') || normalized.includes('juan fernando mello minni')
                },
                
            ];

            const groupedMap = new Map();
            const remaining = [];

            baseTransactions.forEach(trans => {
                if (trans.tipo !== 'despesa') return;
                const normalized = normalizeText(trans.descricao || trans.memo || trans.name || '');
                const config = groupConfigs.find(item => item.match(trans, normalized));
                if (!config) {
                    remaining.push(trans);
                    return;
                }
                const key = [config.id, trans.banco || '', currentMonth].join('|');
                if (!groupedMap.has(key)) {
                    groupedMap.set(key, {
                        date: trans.date,
                        amount: 0,
                        memo: trans.memo,
                        name: trans.name,
                        descricao: config.label,
                        sourceDescricao: config.label,
                        tipo: 'despesa',
                        categoria: config.categoria,
                        grupo: config.grupo,
                        banco: trans.banco,
                        status: 'Pago',
                        matchName: ''
                    });
                }
                const entry = groupedMap.get(key);
                entry.amount += trans.amount;
                if (trans.date && (!entry.date || trans.date > entry.date)) {
                    entry.date = trans.date;
                }
            });

            importedTransactions = [...remaining, ...Array.from(groupedMap.values())]
                .filter(trans => trans.tipo === 'despesa')
                .map(trans => {
                    checkTransactionImported(trans);
                    return trans;
                });
        }

        function formatMonthLabel(mes) {
            if (!mes) return '-';
            const [ano, mesNum] = mes.split('-');
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const idx = parseInt(mesNum, 10) - 1;
            if (idx < 0 || idx > 11) return mes;
            return `${months[idx]}/${ano}`;
        }

        function parseOfxDate(dateStr) {
            if (!dateStr) return null;
            const clean = dateStr.trim();
            const year = clean.substring(0, 4);
            const month = clean.substring(4, 6);
            const day = clean.substring(6, 8);
            if (!year || !month || !day) return null;
            return `${year}-${month}-${day}`;
        }

        function extractOfxRange(content) {
            const startMatch = content.match(/<DTSTART>([^<\r\n]+)/i);
            const endMatch = content.match(/<DTEND>([^<\r\n]+)/i);
            const startDate = startMatch ? parseOfxDate(startMatch[1]) : null;
            const endDate = endMatch ? parseOfxDate(endMatch[1]) : null;
            if (!startDate && !endDate) return null;
            return { start: startDate, end: endDate };
        }

        function showReconciliation() {
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('importStep2').style.display = 'block';
            document.getElementById('btnProcessImport').style.display = 'block';
            document.getElementById('btnRestoreImport').style.display = 'block';

            const list = document.getElementById('reconciliationList');
            list.innerHTML = '';

            let foundCount = 0;
            let newCount = 0;

            const orderedTransactions = importedTransactions
                .map((trans, index) => ({ trans, index }))
                .sort((a, b) => {
                    if (a.trans.isImported === b.trans.isImported) return 0;
                    return a.trans.isImported ? 1 : -1;
                });

            orderedTransactions.forEach(({ trans, index }) => {
                const match = trans.tipo === 'despesa'
                    ? allItems.find(item =>
                        Math.abs(item.valor - Math.abs(trans.amount)) < 0.05 &&
                        (item.vencimento === trans.date || !item.vencimento)
                    )
                    : null;

                trans.matchName = match ? match.nome : '';

                const div = document.createElement('div');
                div.className = `reconcile-item ${trans.matchName ? 'matched' : 'unmatched'}`;
                div.dataset.index = index;
                div.dataset.group = trans.grupo || '';
                div.innerHTML = `
                    <div class="bank-transaction">
                        <div class="bank-desc">${trans.descricao}</div>
                        <div class="bank-date">${trans.date || '-'}</div>
                    </div>
                    <div class="bank-amount" style="color: ${trans.amount < 0 ? 'red' : 'green'}">${formatMoney(Math.abs(trans.amount))}</div>
                    <div class="import-fields">
                        <input type="text" class="form-input import-desc" value="${trans.descricao}">
                        <div class="import-selects">
                            <select class="form-select import-type">
                                <option value="despesa" ${trans.tipo === 'despesa' ? 'selected' : ''}>Despesa</option>
                                <option value="receita" ${trans.tipo === 'receita' ? 'selected' : ''}>Receita</option>
                            </select>
                            <select class="form-select import-category">
                                ${getCategoryOptionsHTML(trans.categoria)}
                            </select>
                            <select class="form-select import-group">
                                ${getGroupOptionsHTML(trans.grupo)}
                            </select>
                            <select class="form-select import-bank">
                                ${getBankOptionsHTML(trans.banco)}
                            </select>
                            <select class="form-select import-status">
                                ${getStatusOptionsHTML(trans.tipo, trans.status)}
                            </select>
                        </div>
                    </div>
                    <div class="import-actions">
                        <span class="date-badge ${trans.matchName ? 'date-badge-pago' : 'date-badge-empty'} import-match">${trans.matchName ? `Encontrado: ${trans.matchName}` : trans.tipo === 'receita' ? 'Receita' : 'Novo'}</span>
                        <span class="date-badge date-badge-imported import-imported" style="display: ${trans.isImported ? 'inline-block' : 'none'}">JÃ¡ importado</span>
                        <button class="btn btn-secondary import-action-btn import-now-btn" data-index="${index}" ${trans.isImported ? 'disabled' : ''}>${trans.isImported ? 'Importado' : 'Importar agora'}</button>
                        <label class="import-check">
                            <input type="checkbox" class="import-checkbox" checked data-index="${index}" data-match="${trans.matchName}">
                            Importar
                        </label>
                    </div>
                `;
                list.appendChild(div);
                updateRowControls(div, trans);

                if (trans.matchName) foundCount++; else newCount++;
            });

            list.oninput = (event) => {
                const row = event.target.closest('.reconcile-item');
                if (!row) return;
                const index = parseInt(row.dataset.index, 10);
                const trans = importedTransactions[index];
                if (event.target.classList.contains('import-desc')) {
                    trans.descricao = event.target.value.trim();
                    if (!trans.grupo) {
                        const sugerido = suggestGroup(trans.descricao);
                        if (sugerido) {
                            trans.grupo = sugerido;
                            const groupSelect = row.querySelector('.import-group');
                            if (groupSelect) groupSelect.value = sugerido;
                            row.dataset.group = sugerido;
                            renderGroupSummary(importedTransactions);
                            applyGroupFilter();
                        }
                    }
                }
            };

            list.onchange = (event) => {
                const row = event.target.closest('.reconcile-item');
                if (!row) return;
                const index = parseInt(row.dataset.index, 10);
                const trans = importedTransactions[index];

                if (event.target.classList.contains('import-type')) {
                    trans.tipo = event.target.value;
                    if (trans.tipo === 'despesa' && !['Pago', 'A Pagar'].includes(trans.status)) {
                        trans.status = 'Pago';
                    }
                    if (trans.tipo === 'receita' && !['Recebido', 'A Receber'].includes(trans.status)) {
                        trans.status = 'Recebido';
                    }
                    updateRowControls(row, trans);
                }

                if (event.target.classList.contains('import-category')) {
                    if (event.target.value === '__custom__') {
                        const previous = trans.categoria || 'outros';
                        openCustomValueModal({
                            title: 'Nova categoria',
                            label: 'Nome da categoria',
                            placeholder: 'Ex: Viagens',
                            onConfirm: (label) => {
                                const id = addCustomCategory(label);
                                if (id) {
                                    trans.categoria = id;
                                    refreshCategorySelects();
                                    event.target.value = trans.categoria;
                                } else {
                                    trans.categoria = previous;
                                    event.target.value = previous;
                                }
                            },
                            onCancel: () => {
                                event.target.value = previous;
                            }
                        });
                    } else {
                        trans.categoria = event.target.value;
                    }
                }

                if (event.target.classList.contains('import-group')) {
                    if (event.target.value === '__custom__') {
                        const previous = trans.grupo || '';
                        openCustomValueModal({
                            title: 'Novo grupo',
                            label: 'Nome do grupo',
                            placeholder: 'Ex: Taxas Asaas',
                            onConfirm: (label) => {
                                const id = addCustomGroup(label);
                                if (id) {
                                    trans.grupo = id;
                                    refreshGroupSelects();
                                    event.target.value = trans.grupo;
                                    row.dataset.group = trans.grupo || '';
                                    renderGroupSummary(importedTransactions);
                                    applyGroupFilter();
                                } else {
                                    trans.grupo = previous;
                                    event.target.value = previous;
                                }
                            },
                            onCancel: () => {
                                event.target.value = previous;
                            }
                        });
                    } else {
                        trans.grupo = event.target.value;
                        row.dataset.group = trans.grupo || '';
                        renderGroupSummary(importedTransactions);
                        applyGroupFilter();
                    }
                }

                if (event.target.classList.contains('import-bank')) {
                    trans.banco = event.target.value;
                }

                if (event.target.classList.contains('import-status')) {
                    trans.status = event.target.value;
                }
            };

            list.onclick = (event) => {
                const button = event.target.closest('.import-now-btn');
                if (!button) return;
                const index = parseInt(button.dataset.index, 10);
                processSingleImport(index);
            };

            document.getElementById('foundCount').textContent = `${foundCount} Encontrados`;
            document.getElementById('newCount').textContent = `${newCount} Novos`;
            const monthLabel = document.getElementById('importMonthLabel');
            if (monthLabel) {
                monthLabel.textContent = formatMonthLabel(currentMonth);
            }
            const rangeLabel = document.getElementById('importOfxRange');
            if (rangeLabel) {
                if (importedOfxRange) {
                    const start = importedOfxRange.start ? formatDate(importedOfxRange.start) : '-';
                    const end = importedOfxRange.end ? formatDate(importedOfxRange.end) : '-';
                    rangeLabel.textContent = `${start} a ${end}`;
                } else {
                    rangeLabel.textContent = '-';
                }
            }
            renderGroupSummary(importedTransactions);
            applyGroupFilter();
        }

        function updateRowControls(row, trans) {
            const categorySelect = row.querySelector('.import-category');
            const groupSelect = row.querySelector('.import-group');
            const statusSelect = row.querySelector('.import-status');
            const matchBadge = row.querySelector('.import-match');
            const checkbox = row.querySelector('.import-checkbox');
            const importedBadge = row.querySelector('.import-imported');
            const importNowButton = row.querySelector('.import-now-btn');

            statusSelect.innerHTML = getStatusOptionsHTML(trans.tipo, trans.status);

            if (trans.tipo === 'receita') {
                categorySelect.disabled = true;
                categorySelect.value = 'outros';
                if (groupSelect) {
                    groupSelect.disabled = true;
                    groupSelect.value = '';
                }
                row.classList.remove('matched');
                row.classList.add('unmatched');
                matchBadge.className = 'date-badge date-badge-empty import-match';
                matchBadge.textContent = 'Receita';
                checkbox.dataset.match = '';
            } else {
                categorySelect.disabled = false;
                if (groupSelect) {
                    groupSelect.disabled = false;
                }
                if (trans.matchName) {
                    row.classList.add('matched');
                    row.classList.remove('unmatched');
                    matchBadge.className = 'date-badge date-badge-pago import-match';
                    matchBadge.textContent = `Encontrado: ${trans.matchName}`;
                    checkbox.dataset.match = trans.matchName;
                } else {
                    row.classList.remove('matched');
                    row.classList.add('unmatched');
                    matchBadge.className = 'date-badge date-badge-empty import-match';
                    matchBadge.textContent = 'Novo';
                    checkbox.dataset.match = '';
                }
            }
            if (trans.isImported) {
                if (importedBadge) importedBadge.style.display = 'inline-block';
                checkbox.checked = false;
                checkbox.disabled = true;
                if (importNowButton) {
                    importNowButton.disabled = true;
                    importNowButton.textContent = 'Importado';
                }
            } else {
                if (importedBadge) importedBadge.style.display = 'none';
                checkbox.disabled = false;
                if (importNowButton) {
                    importNowButton.disabled = false;
                    importNowButton.textContent = 'Importar agora';
                }
            }
        }

        function applyImportForTransaction(trans, matchName, importRun) {
            const importRunId = importRun?.id || '';
            const importedAt = importRun?.createdAt || new Date().toISOString();
            const importSource = trans.banco || 'extrato';
            const bankKey = normalizeBankKey(trans.banco || importSource);
            if (importRun && bankKey) {
                if (!Array.isArray(importRun.sources)) importRun.sources = [];
                if (!importRun.sources.includes(bankKey)) {
                    importRun.sources.push(bankKey);
                }
            }
            if (trans.tipo === 'despesa') {
                if (matchName) {
                    if (importRun) {
                        importRun.matchedDespesas.push({
                            nome: matchName,
                            previousStatus: getPreviousDespesaStatus(matchName)
                        });
                    }
                    GestaoFinanceira.updateStatus(currentMonth, 'despesa', matchName, trans.status, trans.status === 'Pago' ? trans.date : null);
                } else {
                    const despesa = GestaoFinanceira.addDespesa(currentMonth, {
                        nome: trans.descricao || 'Despesa Importada',
                        valor: Math.abs(trans.amount),
                        categoria: trans.categoria || 'outros',
                        tipo: trans.grupo || '',
                        empresa: trans.banco || 'asaas',
                        vencimento: trans.date,
                        status: trans.status,
                        dataPagamento: trans.status === 'Pago' ? trans.date : null,
                        importRunId,
                        importedAt,
                        importSource
                    });
                    if (importRun) {
                        importRun.createdDespesas.push({ nome: despesa.nome });
                    }
                }
            } else {
                const receita = GestaoFinanceira.addReceita(currentMonth, {
                    nome: trans.descricao || 'Receita Importada',
                    valor: Math.abs(trans.amount),
                    status: trans.status,
                    origem: 'OFX',
                    empresa: 'Asaas',
                    importRunId,
                    importedAt,
                    importSource
                });
                GestaoFinanceira.updateStatus(currentMonth, 'receita', receita.nome, trans.status, trans.status === 'Recebido' ? trans.date : null);
                if (importRun) {
                    importRun.createdReceitas.push({ nome: receita.nome });
                }
            }
            learnFromTransaction(trans);
            markTransactionImported(trans);
        }

        function processSingleImport(index) {
            const trans = importedTransactions[index];
            if (!trans) return;
            if (trans.isImported) {
                showToast('Este lanÃ§amento jÃ¡ foi importado.', 'info');
                return;
            }
            const importRun = createImportRun();
            applyImportForTransaction(trans, trans.matchName || '', importRun);
            if (importRun.createdDespesas.length || importRun.createdReceitas.length || importRun.matchedDespesas.length) {
                const history = loadImportHistory();
                history.push(importRun);
                saveImportHistory(history);
                const sources = Array.isArray(importRun.sources) && importRun.sources.length ? importRun.sources : ['asaas'];
                sources.forEach(source => {
                    setImportMetaForMonthBank(currentMonth, source, {
                        lastImportAt: importRun.createdAt,
                        lastReconcileAt: importRun.createdAt
                    });
                });
            }
            const row = document.querySelector(`#reconciliationList .reconcile-item[data-index="${index}"]`);
            if (row) updateRowControls(row, trans);
            showToast('LanÃ§amento importado.', 'success');
            loadMonthData(currentMonth);
        }

        function processReconciliation() {
            const checkboxes = document.querySelectorAll('#reconciliationList input:checked');
            let processed = 0;
            const importRun = createImportRun();

            checkboxes.forEach(cb => {
                const index = cb.dataset.index;
                const trans = importedTransactions[index];
                const matchName = cb.dataset.match;

                if (trans.isImported) return;
                applyImportForTransaction(trans, matchName || '', importRun);
                processed++;
            });

            if (importRun.createdDespesas.length || importRun.createdReceitas.length || importRun.matchedDespesas.length) {
                const history = loadImportHistory();
                history.push(importRun);
                saveImportHistory(history);
                const sources = Array.isArray(importRun.sources) && importRun.sources.length ? importRun.sources : ['asaas'];
                sources.forEach(source => {
                    setImportMetaForMonthBank(currentMonth, source, {
                        lastImportAt: importRun.createdAt,
                        lastReconcileAt: importRun.createdAt
                    });
                });
            }

            closeModal('importModal');
            showToast(`${processed} transaÃ§Ãµes processadas!`, 'success');
            loadMonthData(currentMonth);
        }

        // ========================================
        // PAGAMENTO EM MASSA
        // ========================================
        function openBulkPaymentDateModal() {
            if (selectedItems.size === 0) return;
            document.getElementById('bulkPaymentDateCount').textContent = selectedItems.size;
            document.getElementById('bulkPaymentDateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('bulkPaymentDateModal').classList.add('show');
        }

        function closeBulkPaymentDateModal() {
            document.getElementById('bulkPaymentDateModal').classList.remove('show');
        }

        async function applyBulkPaymentDate() {
            const novaData = document.getElementById('bulkPaymentDateInput').value;
            if (!novaData) {
                alert('Selecione uma data');
                return;
            }
            closeBulkPaymentDateModal();
            if (selectedItems.size === 0) return;

            let updated = 0;
            for (const itemNome of selectedItems) {
                // Update status to Pago with date
                GestaoFinanceira.updateStatus(currentMonth, 'despesa', itemNome, 'Pago', novaData);
                updated++;
            }

            if (updated > 0) {
                loadMonthData(currentMonth);
                showToast(`Data de pagamento atualizada para ${updated} itens`);
            }
        }
    </script>

    <!-- Modal de Pagamento Kanban -->
    <div id="kanbanPaymentModal" class="kanban-modal-overlay">
        <div class="kanban-modal">
            <div class="kanban-modal-header">
                <h3>ð³ Registrar Pagamento</h3>
                <button class="kanban-modal-close" onclick="closeKanbanPaymentModal()">â</button>
            </div>
            <div class="kanban-modal-body">
                <div class="kanban-modal-item-info">
                    <div class="kanban-modal-item-name" id="kanbanItemName">-</div>
                    <div class="kanban-modal-item-value" id="kanbanItemValue">R$ 0,00</div>
                    <div class="kanban-modal-item-category" id="kanbanItemCategory">-</div>
                </div>

                <label style="font-size: 13px; font-weight: 600; margin-bottom: 12px; display: block;">Status do Pagamento</label>
                <div class="kanban-status-options">
                    <div class="kanban-status-option" data-status="pendente" onclick="selectKanbanStatus('pendente')">
                        <div class="status-icon">ð´</div>
                        <div class="status-label">Pendente</div>
                    </div>
                    <div class="kanban-status-option" data-status="parcial" onclick="selectKanbanStatus('parcial')">
                        <div class="status-icon">ð¡</div>
                        <div class="status-label">Parcial</div>
                    </div>
                    <div class="kanban-status-option" data-status="pago" onclick="selectKanbanStatus('pago')">
                        <div class="status-icon">ð¢</div>
                        <div class="status-label">Pago</div>
                    </div>
                </div>

                <div class="kanban-form-group" id="kanbanPaymentTypeGroup" style="display: none;">
                    <label style="font-size: 13px; font-weight: 600; margin-bottom: 12px; display: block;">Tipo de Pagamento</label>
                    <div style="display: flex; gap: 12px;">
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #27ae60; border-radius: 8px; cursor: pointer; background: #d4edda;">
                            <input type="radio" name="kanbanPaymentType" value="full" checked onchange="toggleKanbanPartialPayment()">
                            <span style="font-weight: 500;">Pagamento Total</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="kanbanPaymentType" value="partial" onchange="toggleKanbanPartialPayment()">
                            <span style="font-weight: 500;">Pagamento Parcial</span>
                        </label>
                    </div>
                </div>

                <div class="kanban-form-group" id="kanbanPartialValueGroup" style="display: none;">
                    <label for="kanbanPartialValue">Valor a Pagar Agora <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="kanbanPartialValue" placeholder="R$ 0,00" oninput="maskMoney(this); updateKanbanRemainingValue()">
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                        <span style="color: #7f8c8d;">Valor restante:</span>
                        <span style="color: #e74c3c; font-weight: 600;" id="kanbanRemainingValue">R$ 0,00</span>
                    </div>
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-top: 12px; font-size: 12px; color: #856404; border-radius: 4px;" id="kanbanPartialNote">
                        <strong>AtenÃ§Ã£o:</strong> SerÃ¡ criada uma nova despesa com o valor restante marcada como "A Pagar".
                    </div>
                </div>

                <div class="kanban-form-group">
                    <label for="kanbanPaymentDate">Data do Pagamento</label>
                    <input type="text" id="kanbanPaymentDate" class="js-date-input" placeholder="dd/mm/aaaa">
                </div>

                <div class="kanban-form-group">
                    <label for="kanbanObservations">ObservaÃ§Ãµes</label>
                    <textarea id="kanbanObservations" rows="3" placeholder="Adicione notas sobre este pagamento..."></textarea>
                </div>
            </div>
            <div class="kanban-modal-footer">
                <button class="kanban-modal-btn cancel" onclick="closeKanbanPaymentModal()">Cancelar</button>
                <button class="kanban-modal-btn save" onclick="saveKanbanPayment()">ð¾ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Barra de AÃ§Ãµes em Massa -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <span class="selected-count" id="selectedCountText">0 selecionados</span>
        <span class="selected-total" id="selectedTotalText">R$ 0,00</span>
        <button class="bulk-action-btn primary" onclick="bulkMarkAsPaid()">â Pago</button>
        <button class="bulk-action-btn secondary" onclick="bulkMarkAsPending()">â Pendente</button>
        <div class="bulk-dropdown-wrapper">
            <button class="bulk-action-btn category" onclick="toggleBulkCategoryDropdown(event)">ð·ï¸ Categoria â¾</button>
            <div class="bulk-category-dropdown" id="bulkCategoryDropdown"></div>
        </div>
        <button class="bulk-action-btn date" onclick="openBulkDateModal()">ð Vencimento</button>
        <button class="bulk-action-btn danger" onclick="bulkDelete()">ðï¸ Excluir</button>
        <button class="bulk-close-btn" onclick="clearSelection()" title="Limpar seleÃ§Ã£o">Ã</button>
    </div>

    <!-- Modal de Vencimento em Massa -->
    <div class="modal-overlay" id="bulkDateModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ð Alterar Vencimento</h3>
                <button class="modal-close" onclick="closeBulkDateModal()">Ã</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666;">
                    Alterar vencimento de <strong id="bulkDateCount">0</strong> itens selecionados
                </p>
                <div class="form-group">
                    <label>Nova Data de Vencimento</label>
                    <input type="date" id="bulkDateInput" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBulkDateModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="applyBulkDate()">Aplicar</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('sidebarToggle');
            if (!toggleButton) return;

            const applySidebarState = (collapsed) => {
                document.body.classList.toggle('sidebar-collapsed', collapsed);
                toggleButton.textContent = collapsed ? 'â©' : 'â¨';
            };

            const saved = localStorage.getItem('starken_sidebar_collapsed') === 'true';
            applySidebarState(saved);

            toggleButton.addEventListener('click', () => {
                const next = !document.body.classList.contains('sidebar-collapsed');
                applySidebarState(next);
                localStorage.setItem('starken_sidebar_collapsed', String(next));
            });
        });
    </script>
</body>
</html>
