<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contas a Receber - STARK Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="../auth.js"></script>
    <script src="../theme.js"></script>
    <script src="../js/stark-core.js"></script>
    <script src="../js/stark-realtime.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #4A6B54;
            --secondary-green: #7A9B84;
            --light-green: #B8D4BE;
            --bg-gray: #f5f7fa;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #e1e8ed;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-gray);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--primary-green);
            color: var(--white);
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 100;
            transition: transform 0.2s ease;
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-image {
            width: 140px;
            height: auto;
            display: block;
            margin: 0 auto 15px;
        }

        .company-info {
            text-align: center;
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 8px;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--white);
            border-left-color: var(--light-green);
        }

        .nav-item.active {
            background-color: rgba(255,255,255,0.15);
            color: var(--white);
            border-left-color: var(--white);
            font-weight: 600;
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            transition: margin-left 0.2s ease;
        }

        .sidebar-toggle {
            position: fixed;
            top: 90px;
            left: 260px;
            transform: translateX(-50%);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--white);
            color: var(--text-dark);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            z-index: 120;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .sidebar-collapsed .sidebar {
            transform: translateX(-100%);
        }

        .sidebar-collapsed .main-content {
            margin-left: 0;
        }

        .sidebar-collapsed .sidebar-toggle {
            left: 18px;
            transform: none;
        }

        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-title-section {
            flex: 1;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-light);
            font-size: 14px;
        }

        /* Controls Bar */
        .controls-bar {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-selector-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .month-select {
            padding: 10px 15px;
            border: 2px solid var(--primary-green);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            background-color: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .month-select:focus {
            outline: none;
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 3px rgba(74, 107, 84, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .import-status {
            display: flex;
            align-items: stretch;
            gap: 16px;
            flex-wrap: wrap;
        }

        .import-status-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg-gray);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 14px;
            min-width: 220px;
        }

        .import-status-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .import-status-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 160px;
        }

        .import-status-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .import-status-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-green);
        }

        .btn-secondary {
            background-color: var(--bg-gray);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .summary-card.total::before { background-color: var(--info); }
        .summary-card.recebido::before { background-color: var(--success); }
        .summary-card.pendente::before { background-color: var(--warning); }
        .summary-card.taxa::before { background-color: var(--primary-green); }

        .summary-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .summary-value.success { color: var(--success); }
        .summary-value.warning { color: var(--warning); }

        .summary-change {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .summary-change.positive { color: var(--success); }
        .summary-change.negative { color: var(--danger); }

        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
        }

        .progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--light-green));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-light);
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        .analytics-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .card-badge {
            font-size: 11px;
            padding: 4px 10px;
            background: #d4edda;
            color: #155724;
            border-radius: 12px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        /* KPI Cards */
        .kpi-card {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kpi-content {
            display: flex;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .kpi-icon {
            font-size: 48px;
            width: 72px;
            height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8faf9 0%, #e8f5e9 100%);
            border-radius: 16px;
        }

        .kpi-data {
            flex: 1;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-big-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 4px;
        }

        .kpi-trend {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Data Table */
        .data-table-container {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-gray) 0%, var(--white) 100%);
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--white);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        /* Filtros Visuais Modernos */
        .filters-bar {
            display: flex;
            gap: 15px;
            padding: 15px 20px;
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-gray);
            border-radius: 10px;
            padding: 4px;
        }

        .filter-group-label {
            font-size: 11px;
            color: var(--text-light);
            padding-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-chip {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            background: transparent;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-light);
            font-weight: 500;
        }

        .filter-chip:hover {
            background: rgba(74, 107, 84, 0.1);
            color: var(--primary-green);
        }

        .filter-chip.active {
            background: var(--primary-green);
            color: white;
        }

        .filter-chip.starken.active {
            background: linear-gradient(135deg, #4A6B54, #7A9B84);
        }

        .filter-chip.alpha.active {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }

        .filter-chip.mrr.active {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }

        .filter-chip.tcv.active {
            background: linear-gradient(135deg, #6366f1, #818cf8);
        }

        .filter-divider {
            width: 1px;
            height: 30px;
            background: var(--border-color);
        }

        .filters-summary {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-light);
        }

        .filters-summary strong {
            color: var(--primary-green);
            font-weight: 600;
        }

        .filters-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-gray);
            border-radius: 10px;
            padding: 6px 10px;
        }

        .filters-search input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            min-width: 220px;
            color: var(--text-dark);
        }

        .filters-search button {
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-light);
            font-size: 14px;
        }

        .table-count {
            font-size: 14px;
            color: var(--text-light);
            background: var(--bg-gray);
            padding: 6px 12px;
            border-radius: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--bg-gray);
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.text-right { text-align: right; }
        th.text-center { text-align: center; }

        td {
            padding: 18px 20px;
            border-top: 1px solid var(--border-color);
            font-size: 14px;
            vertical-align: middle;
        }

        td.text-right { text-align: right; }
        td.text-center { text-align: center; }

        tr {
            transition: background-color 0.2s ease;
        }

        tr:hover {
            background-color: rgba(74, 107, 84, 0.03);
        }

        tr.row-recebido {
            background-color: rgba(39, 174, 96, 0.05);
        }

        .client-name {
            font-weight: 500;
            color: var(--text-dark);
        }

        .client-info {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .empresa-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .empresa-starken { background: #e8f5e9; color: #2e7d32; }
        .empresa-alpha { background: #fff8e1; color: #f57f17; }

        .amount {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-dark);
        }

        /* Status Toggle Switch */
        .status-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 56px;
            height: 28px;
            background: #f39c12;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .toggle-switch.active {
            background: #27ae60;
        }

        .toggle-switch.disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::before {
            transform: translateX(28px);
        }

        .toggle-label {
            font-size: 12px;
            font-weight: 600;
            min-width: 80px;
        }

        .toggle-label.pendente { color: #f39c12; }
        .toggle-label.recebido { color: #27ae60; }
        .toggle-label.especial { color: #95a5a6; }

        .payment-date {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .status-badge-recebido {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: #28a745;
        }

        .status-badge-pendente {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            color: #856404;
            border-color: #ffc107;
        }

        .status-badge-especial {
            background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
            color: #383d41;
            border-color: #95a5a6;
            cursor: default;
        }

        .status-badge-especial:hover {
            transform: none;
            box-shadow: none;
        }

        .status-icon {
            font-size: 14px;
            font-weight: 700;
        }

        .status-text {
            white-space: nowrap;
        }

        /* Date Badges */
        .date-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .date-badge-recebido {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .date-badge-empty {
            background: #f5f5f5;
            color: #999;
        }

        /* Bulk Actions */
        .bulk-actions {
            background: var(--primary-green);
            color: white;
            padding: 15px 25px;
            display: none;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.3s ease;
        }

        .bulk-actions.show {
            display: flex;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bulk-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bulk-count {
            font-weight: 600;
        }

        .bulk-buttons {
            display: flex;
            gap: 10px;
        }

        .bulk-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bulk-btn.success {
            background: white;
            color: var(--success);
        }

        .bulk-btn.cancel {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Checkbox styling */
        .checkbox-cell {
            width: 40px;
        }

        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .custom-checkbox:hover {
            border-color: var(--primary-green);
        }

        .custom-checkbox.checked {
            background: var(--primary-green);
            border-color: var(--primary-green);
        }

        .custom-checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .custom-checkbox.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--text-dark);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { background: var(--success); }
        .toast.warning { background: var(--warning); }
        .toast.error { background: var(--danger); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-overlay.modal-top {
            z-index: 1200;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Import Modal Styles */
        .import-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-gray);
        }

        .import-area:hover {
            border-color: var(--primary-green);
            background: rgba(74, 107, 84, 0.05);
        }

        .import-icon {
            font-size: 48px;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .reconciliation-list {
            max-height: 520px;
            overflow-y: auto;
            border: 1px solid #e6edf2;
            border-radius: 14px;
            padding: 10px;
            background: #f7f9fb;
        }

        .reconciliation-item {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 16px 18px;
            border: 1px solid #e6edf2;
            border-radius: 12px;
            background: #ffffff;
            gap: 10px;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
            margin-bottom: 10px;
        }

        .reconciliation-item:last-child {
            margin-bottom: 0;
        }

        .reconciliation-item.matched {
            border-color: #b9e5c6;
            background: #f6fffa;
        }

        .rec-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rec-desc {
            flex: 1;
            font-weight: 600;
            color: var(--text-dark);
        }

        .rec-amount {
            font-weight: 700;
            min-width: 110px;
            text-align: right;
            font-size: 15px;
        }

        .rec-amount.positive { color: var(--success); }
        .rec-amount.negative { color: var(--danger); }

        .rec-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .rec-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rec-badge {
            background: #ecfdf3;
            color: #1f7a3f;
            border: 1px solid #b9e5c6;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .rec-badge.neutral {
            background: #f1f5f9;
            color: #475569;
            border-color: #e2e8f0;
        }

        .rec-badge.conf-high {
            background: #ecfdf3;
            color: #1f7a3f;
            border-color: #b9e5c6;
        }

        .rec-badge.conf-medium {
            background: #fff7ed;
            color: #b45309;
            border-color: #fed7aa;
        }

        .rec-badge.conf-low {
            background: #fef2f2;
            color: #b91c1c;
            border-color: #fecaca;
        }

        .rec-badge.duplicate {
            background: #eef2ff;
            color: #4338ca;
            border-color: #c7d2fe;
        }

        .rec-input {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 13px;
            outline: none;
            width: 100%;
            background: #fff;
        }

        .rec-match-info {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            background: #f8fafc;
            display: none;
            flex-direction: column;
            gap: 6px;
        }

        .rec-match-info.show {
            display: flex;
        }

        .rec-match-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 12px;
        }

        .rec-match-label {
            color: #64748b;
            font-weight: 600;
        }

        .rec-match-value {
            color: #0f172a;
            font-weight: 700;
        }

        .rec-match-pill {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            background: #e2e8f0;
            color: #334155;
        }

        .rec-match-pill.good {
            background: #dcfce7;
            color: #166534;
        }

        .rec-match-pill.warn {
            background: #fef3c7;
            color: #92400e;
        }

        .recon-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .recon-summary-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .recon-summary-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        .recon-summary-value {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
        }

        .rec-split {
            border-top: 1px dashed #e2e8f0;
            padding-top: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .rec-split-header {
            font-size: 12px;
            font-weight: 700;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .rec-split-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            max-height: 180px;
            overflow-y: auto;
        }

        .rec-split-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #fff;
            gap: 8px;
        }

        .rec-split-item input {
            margin-right: 8px;
        }

        .rec-split-name {
            font-size: 12px;
            font-weight: 600;
            color: #0f172a;
        }

        .rec-split-value {
            font-size: 12px;
            font-weight: 700;
            color: #16a34a;
        }

        .rec-split-summary {
            font-size: 12px;
            color: #475569;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rec-split-summary .ok {
            color: #16a34a;
            font-weight: 700;
        }

        .rec-split-summary .warn {
            color: #d97706;
            font-weight: 700;
        }

        .rec-diff-action {
            border: 1px solid #1d4ed8;
            background: #eff6ff;
            color: #1d4ed8;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 999px;
            cursor: pointer;
        }

        .rec-input:focus {
            border-color: #7a9b84;
            box-shadow: 0 0 0 3px rgba(122, 155, 132, 0.15);
        }

        .recon-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            padding: 12px;
            border: 1px solid #e6edf2;
            border-radius: 12px;
            background: #ffffff;
            margin-bottom: 12px;
        }

        .recon-toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .recon-toolbar .btn {
            padding: 8px 12px;
            font-size: 12px;
        }

        .recon-toolbar .recon-input {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 12px;
            min-width: 140px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 12px 10px;
            }

            .toggle-switch {
                width: 44px;
                height: 24px;
            }

            .toggle-switch::before {
                width: 18px;
                height: 18px;
            }

            .toggle-switch.active::before {
                transform: translateX(20px);
            }
        }

        /* Drag and Drop Styles */
        tr[draggable="true"] {
            cursor: grab;
        }

        tr[draggable="true"]:active {
            cursor: grabbing;
        }

        tr.dragging {
            opacity: 0.5;
            background: #e3f2fd !important;
        }

        tr.drag-over {
            border-top: 3px solid #4A6B54;
        }

        tr.drag-over-bottom {
            border-bottom: 3px solid #4A6B54;
        }

        /* Footer Total */
        tfoot tr {
            background: linear-gradient(135deg, #4A6B54 0%, #5d8a6b 100%);
            color: white;
            font-weight: 600;
        }

        tfoot td {
            padding: 15px 20px !important;
            border-top: 2px solid #3d5a45 !important;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: var(--bg-gray);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-light);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-toggle-btn:hover {
            color: var(--text-dark);
        }

        .view-toggle-btn.active {
            background: var(--white);
            color: var(--primary-green);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Kanban Board */
        .kanban-container {
            display: none;
            margin-bottom: 30px;
        }

        .kanban-container.active {
            display: block;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            min-height: 500px;
        }

        @media (max-width: 1200px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
        }

        .kanban-column {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 16px;
            min-height: 400px;
        }

        .kanban-column.pendente {
            border-top: 4px solid var(--warning);
        }

        .kanban-column.parcial {
            border-top: 4px solid var(--info);
        }

        .kanban-column.recebido {
            border-top: 4px solid var(--success);
        }

        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .kanban-column-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kanban-column-count {
            background: var(--white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
        }

        .kanban-column-total {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 300px;
        }

        .kanban-card {
            background: var(--white);
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            cursor: grab;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .kanban-card:active {
            cursor: grabbing;
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .kanban-card.starken {
            border-left-color: var(--primary-green);
        }

        .kanban-card.alpha {
            border-left-color: #f57f17;
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .kanban-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .kanban-card-amount {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-green);
            white-space: nowrap;
        }

        .kanban-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .kanban-card-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .kanban-card-badge.empresa-starken {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .kanban-card-badge.empresa-alpha {
            background: #fff8e1;
            color: #f57f17;
        }

        .kanban-card-badge.novo {
            background: #e3f2fd;
            color: #1565c0;
        }

        .kanban-card-actions {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .kanban-action-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kanban-action-btn.receive {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .kanban-action-btn.receive:hover {
            background: #2e7d32;
            color: white;
        }

        .kanban-action-btn.unreceive {
            background: #fff3e0;
            color: #e65100;
        }

        .kanban-action-btn.unreceive:hover {
            background: #e65100;
            color: white;
        }

        .kanban-column.drag-over {
            background: rgba(74, 107, 84, 0.1);
        }

        .kanban-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
            font-size: 14px;
        }

        .kanban-empty-icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Kanban Card Enhanced */
        .kanban-card {
            position: relative;
            cursor: pointer;
        }

        .kanban-card .card-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-gray);
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .kanban-card:hover .card-edit-btn {
            opacity: 1;
        }

        .kanban-card .card-edit-btn:hover {
            background: var(--primary-green);
            color: white;
        }

        /* Kanban Card Delete Button */
        .kanban-card .card-delete-btn {
            position: absolute;
            top: 8px;
            right: 42px;
            width: 28px;
            height: 28px;
            border: none;
            background: #ffebee;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #c62828;
        }

        .kanban-card:hover .card-delete-btn {
            opacity: 1;
        }

        .kanban-card .card-delete-btn:hover {
            background: #c62828;
            color: white;
            transform: scale(1.1);
        }

        /* Kanban Card Status Styles */
        .kanban-card.status-recebido {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }

        .kanban-card.status-recebido .kanban-card-amount {
            color: #27ae60;
        }

        .kanban-card.status-pendente {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }

        /* Card info extra */
        .kanban-card-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-light);
            margin-top: 8px;
        }

        .kanban-card-date {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kanban-card-date.recebido {
            color: #27ae60;
        }

        /* Drag over feedback */
        .kanban-column.drag-over .kanban-column-content {
            background: rgba(74, 107, 84, 0.1);
            border: 2px dashed var(--primary-green);
            border-radius: 8px;
        }

        /* Delete confirmation in card */
        .kanban-delete-confirm {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-radius: 10px;
            z-index: 10;
        }

        .kanban-delete-confirm p {
            font-size: 13px;
            color: var(--text-dark);
            text-align: center;
        }

        .kanban-delete-confirm-btns {
            display: flex;
            gap: 8px;
        }

        .kanban-delete-confirm-btns button {
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .kanban-delete-confirm-btns .confirm-yes {
            background: #e74c3c;
            color: white;
        }

        .kanban-delete-confirm-btns .confirm-no {
            background: var(--bg-gray);
            color: var(--text-dark);
        }

        /* Modal Nova Receita */
        .receita-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .receita-modal-overlay.active {
            display: flex;
        }

        .receita-modal {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 850px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .receita-modal .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-green) 0%, #5d8a6b 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }

        .receita-modal .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .receita-modal .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .receita-modal .modal-body {
            padding: 25px;
        }

        .receita-modal .form-group {
            margin-bottom: 20px;
        }

        .receita-modal .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .receita-modal .form-input,
        .receita-modal .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .receita-modal .form-input:focus,
        .receita-modal .form-select:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(74, 107, 84, 0.1);
        }

        .receita-modal .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .receita-modal .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        /* Layout de 2 colunas para Alpha */
        .alpha-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        /* Alpha Calculation Fields */
        .alpha-fields {
            display: none;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .alpha-fields.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .alpha-content-grid {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
            margin-top: 15px;
        }

        .alpha-inputs-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alpha-fields-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Resumo do Repasse */
        .repasse-summary {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-radius: 12px;
            padding: 20px;
            display: none;
            align-self: start;
        }

        .repasse-summary.visible {
            display: block;
        }

        .repasse-summary-title {
            font-size: 14px;
            font-weight: 700;
            color: #155724;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .repasse-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
            font-size: 13px;
        }

        .repasse-row:last-child {
            border-bottom: none;
        }

        .repasse-row.total {
            font-weight: 700;
            font-size: 16px;
            color: #155724;
            padding-top: 12px;
            margin-top: 8px;
            border-top: 2px solid rgba(0,0,0,0.1);
        }

        .repasse-row .label {
            color: var(--text-light);
        }

        .repasse-row .value {
            font-weight: 600;
        }

        .repasse-row .value.negative {
            color: #c0392b;
        }

        .repasse-row .value.positive {
            color: #27ae60;
        }

        .receita-modal .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg-gray);
            border-radius: 0 0 16px 16px;
        }

        .receita-modal .btn-cancel {
            padding: 12px 24px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .receita-modal .btn-save {
            padding: 12px 24px;
            border: none;
            background: linear-gradient(135deg, var(--primary-green) 0%, #5d8a6b 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .receita-modal .btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 107, 84, 0.3);
        }

        /* Checkbox toggle para novo/renovaÃ§Ã£o */
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Modal de Recebimento Kanban */
        .kanban-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .kanban-modal-overlay.active {
            display: flex;
        }

        .kanban-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: kanbanModalSlideIn 0.3s ease;
        }

        @keyframes kanbanModalSlideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .kanban-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #f8faf9 0%, #ffffff 100%);
            border-radius: 16px 16px 0 0;
        }

        .kanban-modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .kanban-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-gray);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-light);
        }

        .kanban-modal-body {
            padding: 24px;
        }

        .kanban-modal-item-info {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .kanban-modal-item-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .kanban-modal-item-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-green);
        }

        .kanban-form-group {
            margin-bottom: 16px;
        }

        .kanban-form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .kanban-form-group input,
        .kanban-form-group select,
        .kanban-form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
        }

        .kanban-status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .kanban-status-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kanban-status-option.selected {
            border-color: var(--primary-green);
            background: rgba(74, 107, 84, 0.1);
        }

        .kanban-status-option .status-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .kanban-status-option .status-label {
            font-size: 12px;
            font-weight: 600;
        }

        .kanban-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--bg-gray);
            border-radius: 0 0 16px 16px;
        }

        .kanban-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .kanban-modal-btn.cancel {
            border: 2px solid var(--border-color);
            background: white;
        }

        .kanban-modal-btn.save {
            border: none;
            background: linear-gradient(135deg, var(--primary-green) 0%, #5d8a6b 100%);
            color: white;
        }

        /* ============================================
           BOTÃ•ES DE AÃ‡ÃƒO NA TABELA
           ============================================ */
        .row-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .action-btn.edit {
            background: rgba(74, 107, 84, 0.1);
            color: #4A6B54;
        }

        .action-btn.edit:hover {
            background: #4A6B54;
            color: white;
            transform: scale(1.1);
        }

        .action-btn.delete {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .action-btn.delete:hover {
            background: #e74c3c;
            color: white;
            transform: scale(1.1);
        }

        /* ============================================
           MODAL DE EDIÃ‡ÃƒO DE RECEITA
           ============================================ */
        .edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .edit-modal-overlay.show {
            display: flex;
        }

        .edit-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(74, 107, 84, 0.3);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .edit-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .edit-modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
        }

        .edit-modal-close:hover {
            color: #e74c3c;
        }

        .edit-form-group {
            margin-bottom: 20px;
        }

        .edit-form-label {
            display: block;
            color: #aaa;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .edit-form-input,
        .edit-form-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-size: 15px;
            transition: all 0.2s;
        }

        .edit-form-input:focus,
        .edit-form-select:focus {
            outline: none;
            border-color: #4A6B54;
            background: rgba(74, 107, 84, 0.1);
        }

        .edit-form-select option {
            background: #1a1a2e;
            color: white;
        }

        .edit-modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .edit-modal-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-modal-btn.cancel {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            color: #ccc;
        }

        .edit-modal-btn.cancel:hover {
            background: rgba(255,255,255,0.2);
        }

        .edit-modal-btn.save {
            background: linear-gradient(135deg, #4A6B54, #5d8a6b);
            border: none;
            color: white;
        }

        .edit-modal-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 107, 84, 0.4);
        }

        .edit-modal-btn.delete {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }

        .edit-modal-btn.delete:hover {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <button class="sidebar-toggle" id="sidebarToggle" type="button">âŸ¨</button>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../logo-starken.png" alt="STARK Intelligence" class="logo-image">
                <div class="company-info">STARK Intelligence<br>Starken Tecnologia Ltda</div>
            </div>
            <nav class="sidebar-nav">
                <a href="../index.html" class="nav-item">
                    <span class="nav-icon">ðŸ“Š</span>
                    Dashboard Financeiro
                </a>
                <a href="dashboard-comercial.html" class="nav-item">
                    <span class="nav-icon">ðŸ’¼</span>
                    Dashboard Comercial
                </a>

                <div class="nav-separator"></div>

                <a href="stark.html" class="nav-item">
                    <span class="nav-icon">âš¡</span>
                    STARK - CFO Virtual
                </a>

                <div class="nav-separator"></div>

                <!-- Menu GestÃ£o Financeira ExpansÃ­vel -->
                <div class="nav-item nav-item-expandable" data-menu="submenu-gestao" onclick="ThemeManager.toggleSubMenu('submenu-gestao')">
                    <span class="nav-icon">ðŸ’°</span>
                    GestÃ£o Financeira
                    <span class="menu-arrow">â–¶</span>
                </div>
                <div id="submenu-gestao" class="submenu expanded">
                    <a href="contas-pagar.html" class="nav-item">
                        <span class="nav-icon">ðŸ’³</span>
                        Contas a Pagar
                    </a>
                    <a href="contas-receber.html" class="nav-item active">
                        <span class="nav-icon">ðŸ¤‘</span>
                        Contas a Receber
                    </a>
                    <a href="fluxo-caixa.html" class="nav-item">
                        <span class="nav-icon">ðŸ“ˆ</span>
                        Fluxo de Caixa
                    </a>
                    <a href="financeiro-pessoal.html" class="nav-item">
                        <span class="nav-icon">ðŸ”</span>
                        FinanÃ§as Pessoais
                    </a>
                </div>

                <div class="nav-separator"></div>

                <a href="dre.html" class="nav-item">
                    <span class="nav-icon">ðŸ“‹</span>
                    DRE
                </a>
                <a href="analiticos.html" class="nav-item">
                    <span class="nav-icon">ðŸ”</span>
                    AnalÃ­ticos
                </a>
                <a href="relatorios.html" class="nav-item">
                    <span class="nav-icon">ðŸ“„</span>
                    RelatÃ³rios
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title-section">
                    <h1 class="page-title">Contas a Receber</h1>
                    <p class="page-subtitle" id="pageSubtitle">GestÃ£o completa de receitas e recebimentos</p>
                </div>
            </div>

            <!-- Controls Bar -->
            <div class="controls-bar">
                <div class="month-selector">
                    <span class="month-selector-label">ðŸ“… PerÃ­odo:</span>
                    <select class="month-select" id="monthSelect" onchange="changeMonth()">
                        <option value="2025-10">Outubro 2025</option>
                        <option value="2025-11">Novembro 2025</option>
                        <option value="2025-12">Dezembro 2025</option>
                        <option value="2026-01">Janeiro 2026</option>
                        <option value="2026-02">Fevereiro 2026</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="marcarTodosRecebidos()">
                        âœ“ Marcar Todos
                    </button>
                    <button class="btn btn-primary" onclick="exportarBackup()" title="Salvar backup dos dados">
                        ðŸ’¾ Backup
                    </button>
                    <button class="btn btn-secondary" onclick="exportarParaProducao()" title="Enviar dados locais para produÃ§Ã£o">
                        ðŸš€ Exportar ProduÃ§Ã£o
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" title="Restaurar dados de backup">
            ðŸ“‚ Restaurar
        </button>
        <button class="btn btn-primary" onclick="openImportModal()" title="Importar Extrato BancÃ¡rio">
            ðŸ¦ Importar Extrato
        </button>
        <button class="btn btn-secondary" onclick="limparRecebiveisMes()" title="Remover todos os recebÃ­veis do mÃªs selecionado">
            ðŸ—‘ï¸ Limpar RecebÃ­veis
        </button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarBackup(this)">
                </div>
                <div class="import-status">
                    <div class="import-status-card">
                        <span class="import-status-title">Extratos do Asaas</span>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãšltima importaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastImportAsaas">-</span>
                        </div>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãšltima conciliaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastReconcileAsaas">-</span>
                        </div>
                    </div>
                    <div class="import-status-card">
                        <span class="import-status-title">Extratos do Conta Simples</span>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãšltima importaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastImportContaSimples">-</span>
                        </div>
                        <div class="import-status-item">
                            <span class="import-status-label">Ãšltima conciliaÃ§Ã£o</span>
                            <span class="import-status-value" id="lastReconcileContaSimples">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card total">
                    <div class="summary-icon">ðŸ’°</div>
                    <div class="summary-label">Total a Receber</div>
                    <div class="summary-value" id="totalAReceber">R$ 0,00</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressRecebido">R$ 0 recebido</span>
                            <span id="progressPendente">R$ 0 pendente</span>
                        </div>
                    </div>
                </div>
                <div class="summary-card recebido">
                    <div class="summary-icon">âœ…</div>
                    <div class="summary-label">Recebido no MÃªs</div>
                    <div class="summary-value success" id="totalRecebido">R$ 0,00</div>
                    <div class="summary-change positive" id="qtdRecebidos">0 clientes pagaram</div>
                </div>
                <div class="summary-card pendente">
                    <div class="summary-icon">â³</div>
                    <div class="summary-label">Pendente</div>
                    <div class="summary-value warning" id="totalPendente">R$ 0,00</div>
                    <div class="summary-change" id="qtdPendentes">0 clientes pendentes</div>
                </div>
                <div class="summary-card taxa">
                    <div class="summary-icon">ðŸ“Š</div>
                    <div class="summary-label">Taxa de Recebimento</div>
                    <div class="summary-value" id="taxaRecebimento">0%</div>
                    <div class="summary-change" id="metaStatus">Meta: 80%</div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="analytics-grid">
                <!-- GrÃ¡fico de Pizza: Recebido vs Pendente -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3 class="card-title">Status de Recebimentos</h3>
                        <span class="card-badge" id="statusBadge">Atualizado</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- GrÃ¡fico de Barras: Top 5 Clientes -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3 class="card-title">Top 5 Maiores Receitas</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="top5Chart"></canvas>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="analytics-card kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-icon">ðŸ“ˆ</div>
                        <div class="kpi-data">
                            <div class="kpi-label">Ticket MÃ©dio</div>
                            <div class="kpi-big-value" id="ticketMedio">R$ 0</div>
                            <div class="kpi-trend">por cliente ativo</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-card kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-icon">ðŸŽ¯</div>
                        <div class="kpi-data">
                            <div class="kpi-label">Meta de Recebimento</div>
                            <div class="kpi-big-value" id="metaRecebimento">0%</div>
                            <div class="kpi-trend" id="metaTrend">Meta: 80%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="controls-bar" style="padding: 15px 20px; margin-bottom: 20px;">
                <div class="table-title" style="font-size: 16px;">
                    ðŸ’° Receitas do MÃªs
                </div>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div class="summary-badges">
                        <span class="date-badge date-badge-recebido" id="totalClientesRecebiveis">Clientes: R$ 0</span>
                        <span class="date-badge date-badge-empty" id="totalOutrasEntradas">Outras entradas: R$ 0</span>
                        <span class="date-badge date-badge-empty" id="totalOutrasStarken">Outras â€¢ Starken: R$ 0</span>
                        <span class="date-badge date-badge-empty" id="totalOutrasContaSimples">Outras â€¢ Conta Simples: R$ 0</span>
                    </div>
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" onclick="setView('table')" id="viewTableBtn">
                            ðŸ“‹ Tabela
                        </button>
                        <button class="view-toggle-btn" onclick="setView('kanban')" id="viewKanbanBtn">
                            ðŸ“Š Kanban
                        </button>
                    </div>
                    <div class="table-actions">
                        <button class="filter-btn active" data-filter="todos" onclick="filtrarReceitas('todos')">Todos</button>
                        <button class="filter-btn" data-filter="pendente" onclick="filtrarReceitas('pendente')">Pendentes</button>
                        <button class="filter-btn" data-filter="recebido" onclick="filtrarReceitas('recebido')">Recebidos</button>
                        <span class="table-count" id="tableCount">0 registros</span>
                    </div>
                    <button class="btn-nova-receita" onclick="openNovaReceitaModal()" style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 10px 20px;
                        background: linear-gradient(135deg, var(--primary-green) 0%, #5d8a6b 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        box-shadow: 0 2px 8px rgba(74, 107, 84, 0.3);
                    ">
                        âž• Nova Receita
                    </button>
                </div>
            </div>

            <!-- Kanban View -->
            <div class="kanban-container" id="kanbanContainer">
                <div class="kanban-board">
                    <div class="kanban-column pendente" data-status="pendente"
                         ondragover="handleKanbanDragOver(event)"
                         ondragleave="handleKanbanDragLeave(event)"
                         ondrop="handleKanbanDrop(event, 'pendente')">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                ðŸŸ¡ Pendente
                                <span class="kanban-column-count" id="kanbanPendenteCount">0</span>
                            </div>
                            <div class="kanban-column-total" id="kanbanPendenteTotal">R$ 0</div>
                        </div>
                        <div class="kanban-cards" id="kanbanPendente">
                            <!-- Cards dinÃ¢micos -->
                        </div>
                    </div>

                    <div class="kanban-column parcial" data-status="starken" style="border-top-color: var(--primary-green);"
                         ondragover="handleKanbanDragOver(event)"
                         ondragleave="handleKanbanDragLeave(event)"
                         ondrop="handleKanbanDrop(event, 'starken')">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                ðŸš€ Starken
                                <span class="kanban-column-count" id="kanbanStarkenCount">0</span>
                            </div>
                            <div class="kanban-column-total" id="kanbanStarkenTotal">R$ 0</div>
                        </div>
                        <div class="kanban-cards" id="kanbanStarken">
                            <!-- Cards dinÃ¢micos -->
                        </div>
                    </div>

                    <div class="kanban-column parcial" data-status="alpha"
                         ondragover="handleKanbanDragOver(event)"
                         ondragleave="handleKanbanDragLeave(event)"
                         ondrop="handleKanbanDrop(event, 'alpha')">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                â­ Alpha
                                <span class="kanban-column-count" id="kanbanAlphaCount">0</span>
                            </div>
                            <div class="kanban-column-total" id="kanbanAlphaTotal">R$ 0</div>
                        </div>
                        <div class="kanban-cards" id="kanbanAlpha">
                            <!-- Cards dinÃ¢micos -->
                        </div>
                    </div>

                    <div class="kanban-column recebido" data-status="recebido"
                         ondragover="handleKanbanDragOver(event)"
                         ondragleave="handleKanbanDragLeave(event)"
                         ondrop="handleKanbanDrop(event, 'recebido')">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                ðŸŸ¢ Recebido
                                <span class="kanban-column-count" id="kanbanRecebidoCount">0</span>
                            </div>
                            <div class="kanban-column-total" id="kanbanRecebidoTotal">R$ 0</div>
                        </div>
                        <div class="kanban-cards" id="kanbanRecebido">
                            <!-- Cards dinÃ¢micos -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros Visuais -->
            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-group-label">Status</span>
                    <button class="filter-chip active" data-filter="todos" onclick="filtrarReceitas('todos')">Todos</button>
                    <button class="filter-chip" data-filter="pendente" onclick="filtrarReceitas('pendente')">â³ Pendentes</button>
                    <button class="filter-chip" data-filter="recebido" onclick="filtrarReceitas('recebido')">âœ… Recebidos</button>
                </div>

                <div class="filter-divider"></div>

                <div class="filter-group">
                    <span class="filter-group-label">Segmento</span>
                    <button class="filter-chip starken" data-filter="starken" onclick="filtrarReceitas('starken')">ðŸš€ Starken</button>
                    <button class="filter-chip alpha" data-filter="alpha" onclick="filtrarReceitas('alpha')">â­ Alpha</button>
                </div>

                <div class="filter-divider"></div>

                <div class="filter-group">
                    <span class="filter-group-label">Tipo</span>
                    <button class="filter-chip mrr" data-filter="mrr" onclick="filtrarReceitas('mrr')">ðŸ”„ MRR</button>
                    <button class="filter-chip tcv" data-filter="tcv" onclick="filtrarReceitas('tcv')">ðŸ“‹ TCV</button>
                </div>

                <div class="filter-divider"></div>
                <div class="filter-group">
                    <span class="filter-group-label">Origem</span>
                    <button class="filter-chip" data-filter="clientes" onclick="filtrarReceitas('clientes')">ðŸ‘¥ Clientes</button>
                    <button class="filter-chip" data-filter="outras" onclick="filtrarReceitas('outras')">ðŸ¦ Outras entradas</button>
                    <button class="filter-chip" data-filter="banco_starken" onclick="filtrarReceitas('banco_starken')">ðŸ¦ Starken</button>
                    <button class="filter-chip" data-filter="banco_conta_simples" onclick="filtrarReceitas('banco_conta_simples')">ðŸ¦ Conta Simples</button>
                </div>
                <div class="filter-divider"></div>
                <div class="filters-search">
                    <span class="filter-group-label">Buscar</span>
                    <input type="text" id="searchReceitas" placeholder="Cliente ou lanÃ§amento" oninput="onSearchReceitas()">
                    <button type="button" onclick="clearSearchReceitas()">âœ•</button>
                </div>
                <div class="filters-summary">
                    <span id="filtersSummary">Mostrando <strong>todos</strong> os registros</span>
                </div>
            </div>

            <!-- Data Table -->
            <div class="data-table-container" id="tableContainer">
                <div class="bulk-actions" id="bulkActions">
                    <div class="bulk-info">
                        <span class="bulk-count" id="selectedCount">0 selecionados</span>
                        <span>|</span>
                        <span id="selectedTotal">R$ 0,00</span>
                    </div>
                    <div class="bulk-buttons">
                        <button class="bulk-btn" onclick="openBulkDatesModal()" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">ðŸ“… Ajustar Datas</button>
                        <button class="bulk-btn success" onclick="marcarSelecionadosRecebidos()">âœ“ Marcar como Recebido</button>
                        <button class="bulk-btn danger" onclick="excluirSelecionados()" style="background: linear-gradient(135deg, #ef4444, #dc2626);">ðŸ—‘ï¸ Excluir Selecionados</button>
                        <button class="bulk-btn cancel" onclick="limparSelecao()">Cancelar</button>
                    </div>
                </div>
                <div class="table-header" style="display: none;">
                    <div class="table-title">
                        ðŸ“‹ Receitas do MÃªs
                    </div>
                    <div class="table-actions">
                        <button class="filter-btn active" data-filter="todos" onclick="filtrarReceitas('todos')">Todos</button>
                        <button class="filter-btn" data-filter="pendente" onclick="filtrarReceitas('pendente')">Pendentes</button>
                        <button class="filter-btn" data-filter="recebido" onclick="filtrarReceitas('recebido')">Recebidos</button>
                        <button class="filter-btn" data-filter="starken" onclick="filtrarReceitas('starken')">Starken</button>
                        <button class="filter-btn" data-filter="alpha" onclick="filtrarReceitas('alpha')">Alpha</button>
                        <span class="table-count" id="tableCount">0 registros</span>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell" style="width: 5%;">
                                <div class="custom-checkbox" id="selectAll" onclick="toggleSelectAll()"></div>
                            </th>
                            <th style="width: 22%;">Cliente</th>
                            <th style="width: 10%;">Empresa</th>
                            <th class="text-right" style="width: 10%;">Valor Previsto</th>
                            <th class="text-right" style="width: 10%;">Valor Recebido</th>
                            <th class="text-center" style="width: 11%;">Vencimento</th>
                            <th class="text-center" style="width: 11%;">Recebimento</th>
                            <th class="text-center" style="width: 12%;">Status</th>
                            <th class="text-center" style="width: 8%;">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dados carregados dinamicamente -->
                    </tbody>
                    <tfoot id="tableFooter">
                        <tr style="background: linear-gradient(135deg, #4A6B54 0%, #5d8a6b 100%); color: white; font-weight: 600;">
                            <td colspan="3" style="padding: 15px 20px; font-size: 16px;">TOTAL FILTRADO</td>
                            <td class="text-right" style="padding: 15px 20px; font-size: 18px;" id="totalFiltrado">R$ 0,00</td>
                            <td colspan="5" style="padding: 15px 20px; text-align: center;" id="totalInfo">0 receitas</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastIcon">âœ“</span>
        <span id="toastMessage">OperaÃ§Ã£o realizada com sucesso!</span>
    </div>

    <!-- Modal de ConfirmaÃ§Ã£o -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Confirmar Recebimento</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="form-group">
                    <label class="form-label">Data do Recebimento</label>
                    <input type="date" class="form-input" id="paymentDate">
                </div>
                <div class="form-group">
                    <label class="form-label">ObservaÃ§Ã£o (opcional)</label>
                    <input type="text" class="form-input" id="paymentNote" placeholder="Ex: Pago via PIX">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmBtn" onclick="confirmPayment()">Confirmar Recebimento</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay modal-top" id="importPartialModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3 class="modal-title">Recebimento do Cliente</h3>
                <button class="modal-close" onclick="closeImportPartialModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <div id="importPartialClientName" style="font-weight: 600;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor previsto</label>
                        <div id="importPartialTotal" style="font-weight: 600;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor no extrato</label>
                        <div id="importPartialExtrato" style="font-weight: 600;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de recebimento</label>
                    <div style="display: flex; gap: 10px; margin-top: 6px;">
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="importReceiveType" value="full" checked onchange="toggleImportPartialFields()">
                            <span>Recebimento total</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="importReceiveType" value="partial" onchange="toggleImportPartialFields()">
                            <span>Recebimento parcial</span>
                        </label>
                    </div>
                </div>
                <div class="form-group" id="importPartialGroup" style="display: none;">
                    <label class="form-label">Valor recebido agora</label>
                    <input type="text" class="form-input" id="importPartialValue" placeholder="R$ 0,00" oninput="maskMoney(this); updateImportPartialRemaining()">
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                        <span style="color: #7f8c8d;">Valor restante:</span>
                        <span style="color: #e74c3c; font-weight: 600;" id="importPartialRemaining">R$ 0,00</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Data do recebimento</label>
                    <input type="text" class="form-input" id="importPartialDate" placeholder="dd/mm/aaaa" oninput="maskDate(this)">
                </div>
                <div class="form-group" id="importPartialNextDateGroup" style="display: none;">
                    <label class="form-label">Data do prÃ³ximo recebimento</label>
                    <input type="text" class="form-input" id="importPartialNextDate" placeholder="dd/mm/aaaa" oninput="maskDate(this)">
                </div>
                <input type="hidden" id="importPartialTotalValue">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportPartialModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveImportPartial()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Modal ImportaÃ§Ã£o -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 1100px; width: 92%;">
            <div class="modal-header">
                <h3 class="modal-title">Importar Extrato BancÃ¡rio</h3>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Passo 1: Upload -->
                <div id="importStep1">
                    <div class="import-area" id="dropZone" onclick="document.getElementById('bankFile').click()">
                        <div class="import-icon">ðŸ“„</div>
                        <h4 style="margin-bottom: 10px;">Arraste seu extrato aqui</h4>
                        <p style="color: var(--text-light); font-size: 13px;">Suporta OFX, CSV, PDF e Excel</p>
                        <input type="file" id="bankFile" accept=".ofx,.csv,.pdf,.xls,.xlsx" style="display: none" onchange="handleBankFile(this)">
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <p class="small" style="color: var(--text-light);">
                            AnÃ¡lise inteligente ativa. Recomendamos usar o formato <strong>OFX</strong> para maior precisÃ£o.
                        </p>
                    </div>
                </div>

                <!-- Passo 2: ConciliaÃ§Ã£o -->
                <div id="importStep2" style="display: none;">
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0;">ConciliaÃ§Ã£o de TransaÃ§Ãµes</h4>
                        <div class="summary-badges">
                            <span class="date-badge date-badge-recebido" id="foundCount">0 Encontrados</span>
                            <span class="date-badge date-badge-empty" id="newCount">0 Novos</span>
                            <span class="date-badge date-badge-empty" id="duplicateCount">0 Duplicados</span>
                        </div>
                    </div>
                    <div class="recon-summary">
                        <div class="recon-summary-card">
                            <div class="recon-summary-label">PerÃ­odo do extrato</div>
                            <div class="recon-summary-value" id="importRange">-</div>
                        </div>
                        <div class="recon-summary-card">
                            <div class="recon-summary-label">Banco detectado</div>
                            <div class="recon-summary-value" id="importBankLabel">-</div>
                        </div>
                        <div class="recon-summary-card">
                            <div class="recon-summary-label">Arquivo do extrato</div>
                            <div class="recon-summary-value" id="importFileName">-</div>
                        </div>
                        <div class="recon-summary-card">
                            <div class="recon-summary-label">Entradas do extrato</div>
                            <div class="recon-summary-value" id="importTotalIn">R$ 0</div>
                        </div>
                        <div class="recon-summary-card">
                            <div class="recon-summary-label">TransaÃ§Ãµes</div>
                            <div class="recon-summary-value" id="importCount">0</div>
                        </div>
                    </div>
                    <div class="recon-toolbar">
                        <div class="recon-toolbar-group">
                            <button class="btn btn-secondary" onclick="applyActionToMatched('match')">Conciliar encontrados</button>
                            <button class="btn btn-secondary" onclick="applyActionToNew('new')">Marcar novos</button>
                            <button class="btn btn-secondary" onclick="applyActionToAll('ignore')">Ignorar todos</button>
                        </div>
                        <div class="recon-toolbar-group">
                            <input type="text" class="recon-input" id="bulkReconDate" placeholder="Data dd/mm/aaaa">
                            <button class="btn btn-primary" onclick="applyReconDate()">Aplicar data</button>
                            <button class="btn btn-secondary" onclick="resetLastImports(2)">Desfazer Ãºltimas 2 importaÃ§Ãµes</button>
                        </div>
                    </div>
                    <div class="reconciliation-list" id="reconciliationList">
                        <!-- Lista de transaÃ§Ãµes gerada via JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancelar</button>
                <button class="btn btn-primary" id="btnProcessImport" onclick="processReconciliation()" style="display: none;">
                    Confirmar ImportaÃ§Ã£o
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Despesa da DiferenÃ§a -->
    <div class="modal-overlay" id="diffExpenseModal">
        <div class="modal" style="max-width: 560px;">
            <div class="modal-header">
                <h3 class="modal-title">LanÃ§ar Despesa da DiferenÃ§a</h3>
                <button class="modal-close" onclick="closeDiffExpenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="diffExpenseIndex">
                <div class="form-group">
                    <label class="form-label">MÃªs da despesa</label>
                    <input type="text" class="form-input" id="diffExpenseMonth" placeholder="mm/aaaa">
                </div>
                <div class="form-group">
                    <label class="form-label">DescriÃ§Ã£o</label>
                    <input type="text" class="form-input" id="diffExpenseName" placeholder="Ex: Estorno / Taxa Marketing Alpha">
                </div>
                <div class="form-group">
                    <label class="form-label">Valor (R$)</label>
                    <input type="text" class="form-input" id="diffExpenseValue" oninput="maskMoney(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select class="form-select" id="diffExpenseCategory">
                        <option value="alpha_franquia">Alpha Franquia</option>
                        <option value="comercial">Comercial</option>
                        <option value="operacionais">Operacionais</option>
                        <option value="ferramentas">Ferramentas / Software</option>
                        <option value="estrutura">Estrutura / Aluguel</option>
                        <option value="alimentacao">AlimentaÃ§Ã£o</option>
                        <option value="pessoal">Pessoal / SalÃ¡rios</option>
                        <option value="outros" selected>Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Empresa</label>
                    <select class="form-select" id="diffExpenseCompany">
                        <option value="alpha">Alpha</option>
                        <option value="starken">Starken</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="diffExpenseStatus" onchange="toggleDiffExpensePaymentDate()">
                        <option value="A Pagar">A Pagar</option>
                        <option value="Pago">Pago</option>
                    </select>
                </div>
                <div class="form-group" id="diffExpensePaymentGroup" style="display: none;">
                    <label class="form-label">Data do Pagamento</label>
                    <input type="date" class="form-input" id="diffExpensePaymentDate">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">ObservaÃ§Ã£o</label>
                    <input type="text" class="form-input" id="diffExpenseNote" placeholder="Ex: DiferenÃ§a por estorno e taxa marketing">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDiffExpenseModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveDiffExpense()">Salvar despesa</button>
            </div>
        </div>
    </div>

    <!-- Modal Ajuste de Datas em Massa -->
    <div class="modal-overlay" id="bulkDatesModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3 class="modal-title">Ajuste de Datas em Massa</h3>
                <button class="modal-close" onclick="closeBulkDatesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 12px; color: var(--text-light);">
                    <span id="bulkDatesCount">0 selecionados</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Nova Data de Vencimento</label>
                    <input type="date" class="form-input" id="bulkDueDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Data de Pagamento (marcar como Recebido)</label>
                    <input type="date" class="form-input" id="bulkPaymentDate">
                </div>
                <p class="small" style="color: var(--text-light); margin-top: 6px;">
                    Se informar a data de pagamento, os itens serÃ£o marcados como Recebidos com essa data.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBulkDatesModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="applyBulkReceitaDates()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../dados-mensais.js"></script>
    <script src="../gestao-financeira.js"></script>
    <script>
        // Estado global
        // Calcular mÃªs atual automaticamente
        const hoje = new Date();
        const anoAtual = hoje.getFullYear();
        const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
        let currentMonth = `${anoAtual}-${mesAtual}`;

        let currentFilter = 'todos';
        let currentSearchTerm = '';
        let currentSearchDisplay = '';
        let selectedItems = new Set();
        let pendingPayment = null;
        let statusChart = null;
        let currentClientes = []; // Armazena todos os clientes carregados
        let top5Chart = null;

        // Formatar valor em BRL
        function formatMoney(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Formatar valor curto
        function formatMoneyShort(value) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Verificar se Ã© status especial (nÃ£o pode alterar)
        function isStatusEspecial(status) {
            return status === 'TCV' || status === 'BÃ´nus';
        }

        function getClientesContratoAtivos(mesChave) {
            const todosClientes = JSON.parse(localStorage.getItem('starken_manual_clients') || '[]');
            const deletedIds = JSON.parse(localStorage.getItem('starken_deleted_cards') || '[]');

            return todosClientes.filter(c => {
                if (deletedIds.includes(c.id)) return false;

                if (c.isProjecao && !c.mesInicio) {
                    return false;
                }

                if (c.mesesPersonalizados && c.mesesPersonalizados.length > 0) {
                    return c.mesesPersonalizados.includes(mesChave);
                }

                if (c.statusRenovacao && c.mesRenovacao === mesChave) {
                    return true;
                }

                if (c.tipoValor === 'tcv') {
                    const mesPagamento = (c.dataPagamentoTCV || c.mesInicio || '').substring(0, 7);
                    return mesPagamento === mesChave;
                }

                if (c.tipoValor === 'mrr') {
                    if (!c.mesInicio) return false;

                    const [anoInicio, mesInicio] = c.mesInicio.split('-').map(Number);
                    const dataInicio = new Date(anoInicio, mesInicio - 1, 1);
                    const [anoMes, mesMes] = mesChave.split('-').map(Number);
                    const dataMes = new Date(anoMes, mesMes - 1, 1);

                    if (c.isProjecao) {
                        const duracao = c.projecaoDuracao ? (parseInt(c.projecaoDuracao) || 12) : 12;
                        const dataFim = new Date(dataInicio);
                        dataFim.setMonth(dataFim.getMonth() + duracao);
                        return dataMes >= dataInicio && dataMes < dataFim;
                    }

                    const dataFim = new Date(dataInicio);
                    dataFim.setMonth(dataFim.getMonth() + 60);
                    return dataMes >= dataInicio && dataMes < dataFim;
                }

                return true;
            });
        }

        // ========================================
        // GERAR CONTAS A RECEBER DOS CLIENTES
        // ========================================
        function gerarContasReceberDosClientes(mesChave) {
            console.log('ðŸ“Š Gerando contas a receber para:', mesChave);

            const clientesAtivos = getClientesContratoAtivos(mesChave);

            console.log('ðŸ“‹ Clientes ativos no mÃªs:', clientesAtivos.length);

            // Transformar clientes em contas a receber
            const contasReceber = clientesAtivos.flatMap(c => {
                // Calcular valores (mesma lÃ³gica dos cards)
                const ajusteMensal = c.tipoValor === 'mrr' && c.ajustesMensais && c.ajustesMensais[mesChave];

                let valorBruto = ajusteMensal ? ajusteMensal.valor : c.valor;
                let valorLiquido = c.valorLiquido || c.valor;

                const temValorLiquidoManual = c.valorLiquidoManual !== null && c.valorLiquidoManual !== undefined && !Number.isNaN(Number(c.valorLiquidoManual));

                // MRR
                if (c.tipoValor === 'mrr') {
                    const datasParcelasMRR = Array.isArray(c.datasParcelasMRR) ? c.datasParcelasMRR.filter(Boolean) : [];
                    const dataBaseMRR = c.dataPagamentoMRR || (datasParcelasMRR[0] || '');
                    if (dataBaseMRR) {
                        const mesPrimeiroVencimento = dataBaseMRR.substring(0, 7);
                        if (mesChave < mesPrimeiroVencimento) {
                            valorBruto = 0;
                            valorLiquido = 0;
                        }
                    }

                    // Recalcular lÃ­quido
                    if (valorBruto > 0) {
                        valorLiquido = valorBruto;
                        if (c.empresa === 'alpha' && !c.naoRepassarRoyalties) {
                            valorLiquido = valorBruto * 0.85;
                        }
                        if (c.taxaJuros > 0) {
                            valorLiquido = valorLiquido * (1 - c.taxaJuros / 100);
                        }
                    }
                }

                // TCV
                if (c.tipoValor === 'tcv') {
                    valorBruto = c.tcvTotal || c.valor || 0;

                    // Verificar meses de receita
                    const temReceitaNestesMes = c.tcvMesesReceita && c.tcvMesesReceita.length > 0
                        ? c.tcvMesesReceita.includes(mesChave)
                        : true;

                    if (!temReceitaNestesMes) {
                        valorBruto = 0;
                        valorLiquido = 0;
                    } else {
                        if (temValorLiquidoManual) {
                            valorLiquido = Number(c.valorLiquidoManual);
                        } else if (c.origem === 'repasse-matriz' && c.empresa === 'alpha') {
                            valorLiquido = c.naoRepassarRoyalties ? valorBruto : valorBruto * 0.50;
                        } else {
                            valorLiquido = valorBruto;
                            if (c.empresa === 'alpha' && !c.naoRepassarRoyalties) {
                                valorLiquido = valorBruto * 0.85;
                            }
                            if (c.taxaJuros > 0) {
                                valorLiquido = valorLiquido * (1 - c.taxaJuros / 100);
                            }
                        }
                    }
                }

                if (temValorLiquidoManual && valorBruto > 0) {
                    valorLiquido = Number(c.valorLiquidoManual);
                }

                // Determinar se Ã© cliente novo (primeiro mÃªs)
                const isClienteNovo = c.mesInicio === mesChave;

                const buildDateForMonth = (mesBase, dia) => {
                    const [ano, mes] = mesBase.split('-').map(Number);
                    const diaNum = parseInt(dia, 10);
                    if (!ano || !mes || !diaNum) return '';
                    const ultimoDia = new Date(ano, mes, 0).getDate();
                    const diaFinal = Math.min(diaNum, ultimoDia);
                    return `${ano}-${String(mes).padStart(2, '0')}-${String(diaFinal).padStart(2, '0')}`;
                };

                // Data de vencimento
                let dataVencimento = '';
                if (c.tipoValor === 'tcv' && c.dataPagamentoTCV) {
                    dataVencimento = c.dataPagamentoTCV;
                } else if (c.tipoValor === 'mrr') {
                    const datasParcelasMRR = Array.isArray(c.datasParcelasMRR) ? c.datasParcelasMRR.filter(Boolean) : [];
                    const dataBaseMRR = c.dataPagamentoMRR || (datasParcelasMRR[0] || '');
                    if (dataBaseMRR) {
                        const diaBase = dataBaseMRR.split('-')[2];
                        dataVencimento = buildDateForMonth(mesChave, diaBase);
                    }
                }

                // Buscar status salvo no GestaoFinanceira
                const criarLinhaReceita = (nomeReceita, valorBrutoReceita, valorLiquidoReceita, dataVencimentoReceita) => {
                    const statusSalvo = GestaoFinanceira.getStatus(mesChave, 'receita', nomeReceita);
                    const status = statusSalvo ? statusSalvo.status : 'A Receber';
                    const dataPagamento = statusSalvo ? statusSalvo.dataPagamento : null;
                    const isRecebido = status === 'Recebido' || status === 'Feito';

                    return {
                        nome: nomeReceita,
                        empresa: c.empresa === 'alpha' ? 'Alpha' : 'Starken',
                        valor: valorLiquidoReceita,
                        valorBruto: valorBrutoReceita,
                        valorLiquido: valorLiquidoReceita,
                        valorLiquidoManual: temValorLiquidoManual ? Number(c.valorLiquidoManual) : null,
                        status: status,
                        dataPagamento: dataPagamento,
                        categoria: c.categoria,
                        origem: c.origem,
                        tipoValor: c.tipoValor,
                        isClienteNovo: isClienteNovo,
                        dataVencimento: dataVencimentoReceita,
                        formaPagamento: c.formaPagamento,
                        gateway: c.gateway,
                        parcelasCartao: c.parcelasCartao,
                        isRecebido: isRecebido,
                        isEspecial: valorBrutoReceita === 0 || valorLiquidoReceita === 0
                    };
                };

                if (c.tipoValor === 'mrr') {
                    const parcelasMRR = parseInt(c.parcelasMRR) || 1;
                    const datasParcelasMRR = Array.isArray(c.datasParcelasMRR) ? c.datasParcelasMRR.filter(Boolean) : [];
                    if (parcelasMRR > 1 && datasParcelasMRR.length > 0) {
                        const valorBrutoParcela = valorBruto / parcelasMRR;
                        const valorLiquidoParcela = valorLiquido / parcelasMRR;
                        const datasNoMes = datasParcelasMRR.filter(data => data && data.substring(0, 7) === mesChave);
                        let datasParcelaFinal = datasNoMes;
                        if (datasParcelaFinal.length === 0) {
                            const diasBase = datasParcelasMRR
                                .map(data => (data.includes('-') ? data.split('-')[2] : ''))
                                .filter(Boolean)
                                .slice(0, parcelasMRR);
                            datasParcelaFinal = diasBase.map(dia => buildDateForMonth(mesChave, dia)).filter(Boolean);
                        }
                        if (datasParcelaFinal.length > 0) {
                            return datasParcelaFinal.map((data, index) => {
                                const nomeParcela = `${c.nome} (${index + 1}/${parcelasMRR})`;
                                return criarLinhaReceita(nomeParcela, valorBrutoParcela, valorLiquidoParcela, data);
                            });
                        }
                    }
                }

                return [
                    criarLinhaReceita(c.nome, valorBruto, valorLiquido, dataVencimento)
                ];
            });

            console.log('ðŸ’° Contas a receber geradas:', contasReceber.length);
            console.log('ðŸ“Š Total bruto:', contasReceber.reduce((sum, c) => sum + (c.valorBruto || 0), 0));
            console.log('ðŸ“Š Total lÃ­quido:', contasReceber.reduce((sum, c) => sum + (c.valorLiquido || 0), 0));

            return contasReceber;
        }

        // Carregar dados do mÃªs
        function loadMonthData(mes) {
            currentMonth = mes;

            // ðŸŽ¯ NOVO: Gerar contas a receber dos clientes do localStorage
            const contasReceberDosClientes = gerarContasReceberDosClientes(mes);

            // Ainda buscar dados do GestaoFinanceira para manter compatibilidade (perÃ­odo)
            const dados = GestaoFinanceira.getDadosMesComStatus(mes);

            // Atualizar subtÃ­tulo
            const meses = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho',
                          'Jul ho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const [ano, mesNum] = mes.split('-');
            const periodo = `${meses[parseInt(mesNum) - 1]}/${ano}`;
            document.getElementById('pageSubtitle').textContent =
                `GestÃ£o completa de receitas e recebimentos - ${periodo}`;
            updateImportInfo(mes);

            // ðŸŽ¯ FILTRAR clientes deletados (recebimentos parciais deletam o cliente original)
            const deletedReceitas = GestaoFinanceira.getDeletedItems(mes).receitas || [];
            const receitasCustom = getReceitasCustomAtivas(mes, deletedReceitas);
            const nomesParciais = new Set(receitasCustom.filter(r => r.origemParcial).map(r => r.origemParcial));
            const clientesNaoDeletados = contasReceberDosClientes.filter(c => {
                if (!deletedReceitas.includes(c.nome)) {
                    const nomeBase = getNomeBaseParcela(c.nome);
                    if (nomeBase && deletedReceitas.includes(nomeBase)) {
                        return false;
                    }
                    return true;
                }
                return !nomesParciais.has(c.nome);
            });

            console.log('ðŸ—‘ï¸  Receitas deletadas:', deletedReceitas.length, deletedReceitas);
            console.log('âœ… Clientes nÃ£o deletados:', clientesNaoDeletados.length);

            // ðŸŽ¯ MESCLAR contas dos clientes (nÃ£o deletados) + customItems (recebimentos parciais, etc)
            const contasMescladas = [...clientesNaoDeletados];

            // Buscar customItems (receitas criadas manualmente ou por recebimento parcial)
            if (receitasCustom.length > 0) {
                receitasCustom.forEach(receita => {
                    // Buscar status
                    const statusSalvo = GestaoFinanceira.getStatus(mes, 'receita', receita.nome);
                    const status = statusSalvo ? statusSalvo.status : receita.status;
                    const dataPagamento = statusSalvo ? statusSalvo.dataPagamento : (receita.dataPagamento || null);
                    const isRecebido = status === 'Recebido' || status === 'Feito';
                    const valorLiquidoManualCustom = receita.valorLiquidoManual !== null && receita.valorLiquidoManual !== undefined && !Number.isNaN(Number(receita.valorLiquidoManual))
                        ? Number(receita.valorLiquidoManual)
                        : null;
                    const valorBaseCustom = valorLiquidoManualCustom !== null ? valorLiquidoManualCustom : (receita.valor || 0);

                    contasMescladas.push({
                        nome: receita.nome,
                        empresa: receita.empresa || 'Starken',
                        valor: valorBaseCustom,
                        valorBruto: receita.valor || 0,
                        valorLiquido: valorBaseCustom,
                        valorLiquidoManual: valorLiquidoManualCustom,
                        status: status,
                        dataPagamento: dataPagamento,
                        categoria: receita.categoria || '',
                        origem: receita.origem || '',
                        tipoValor: receita.tipoValor || 'tcv',
                        isClienteNovo: false,
                        dataVencimento: receita.dataVencimento || '',
                        formaPagamento: receita.formaPagamento || '',
                        gateway: receita.gateway || '',
                        parcelasCartao: receita.parcelasCartao || '',
                        isRecebido: isRecebido,
                        isEspecial: false,
                        isCustom: true,
                        origemParcial: receita.origemParcial || null,
                        valorOriginal: receita.valorOriginal || null,
                        observacao: receita.observacao || ''
                    });
                });

                console.log('ðŸ“¦ Receitas customizadas adicionadas:', receitasCustom.length);
            }

            const contasFiltradas = contasMescladas.filter(c => {
                if (deletedReceitas.includes(c.nome)) return false;
                const nomeBase = getNomeBaseParcela(c.nome);
                if (nomeBase && deletedReceitas.includes(nomeBase)) return false;
                return true;
            });

            // Remover duplicatas (se um cliente foi deletado para criar parcial)
            const nomesUnicos = new Set();
            const clientes = contasFiltradas.filter(c => {
                if (nomesUnicos.has(c.nome)) {
                    return false; // JÃ¡ existe
                }
                nomesUnicos.add(c.nome);
                return true;
            });

            console.log('ðŸ“Š Total de contas (clientes + custom):', clientes.length);
            let totalReal = 0;
            let recebido = 0;
            let pendente = 0;
            let qtdRecebidos = 0;
            let qtdPendentes = 0;

            const clientesParaTabela = [];

            clientes.forEach(cliente => {
                if ((cliente.status === 'BÃ´nus' || cliente.tipoValor === 'bonus') && (!cliente.valor || cliente.valor <= 0)) {
                    return;
                }
                // Ignorar valores zerados
                if (cliente.valor <= 0) {
                    return;
                }

                totalReal += cliente.valor;

                const isEspecial = isStatusEspecial(cliente.status);
                const isRecebido = cliente.status === 'Recebido' || cliente.status === 'Feito';

                if (isRecebido) {
                    recebido += cliente.valor;
                    qtdRecebidos++;
                } else if (!isEspecial) {
                    pendente += cliente.valor;
                    qtdPendentes++;
                }

                clientesParaTabela.push({
                    ...cliente,
                    isRecebido: isRecebido,
                    isEspecial: isEspecial
                });
            });

            const totalClientesRecebiveis = clientesParaTabela
                .filter(c => !isOtherEntry(c))
                .reduce((sum, c) => sum + (c.valor || 0), 0);
            const totalOutrasEntradas = clientesParaTabela
                .filter(c => isOtherEntry(c))
                .reduce((sum, c) => sum + (c.valor || 0), 0);
            const totalOutrasStarken = clientesParaTabela
                .filter(c => isOtherEntry(c) && getOtherEntryBankKey(c) === 'starken')
                .reduce((sum, c) => sum + (c.valor || 0), 0);
            const totalOutrasContaSimples = clientesParaTabela
                .filter(c => isOtherEntry(c) && getOtherEntryBankKey(c) === 'conta_simples')
                .reduce((sum, c) => sum + (c.valor || 0), 0);
            const totalClientesRecebiveisEl = document.getElementById('totalClientesRecebiveis');
            const totalOutrasEntradasEl = document.getElementById('totalOutrasEntradas');
            const totalOutrasStarkenEl = document.getElementById('totalOutrasStarken');
            const totalOutrasContaSimplesEl = document.getElementById('totalOutrasContaSimples');
            if (totalClientesRecebiveisEl) {
                totalClientesRecebiveisEl.textContent = `Clientes: ${formatMoney(totalClientesRecebiveis)}`;
            }
            if (totalOutrasEntradasEl) {
                totalOutrasEntradasEl.textContent = `Outras entradas: ${formatMoney(totalOutrasEntradas)}`;
            }
            if (totalOutrasStarkenEl) {
                totalOutrasStarkenEl.textContent = `Outras â€¢ Starken: ${formatMoney(totalOutrasStarken)}`;
            }
            if (totalOutrasContaSimplesEl) {
                totalOutrasContaSimplesEl.textContent = `Outras â€¢ Conta Simples: ${formatMoney(totalOutrasContaSimples)}`;
            }

            // Atualizar cards
            document.getElementById('totalAReceber').textContent = formatMoney(totalReal);
            document.getElementById('totalRecebido').textContent = formatMoney(recebido);
            document.getElementById('totalPendente').textContent = formatMoney(pendente);
            document.getElementById('qtdRecebidos').textContent = `${qtdRecebidos} clientes pagaram`;
            document.getElementById('qtdPendentes').textContent = `${qtdPendentes} clientes pendentes`;

            const taxa = totalReal > 0 ? ((recebido / totalReal) * 100) : 0;
            document.getElementById('taxaRecebimento').textContent = taxa.toFixed(1) + '%';
            document.getElementById('progressFill').style.width = taxa + '%';
            document.getElementById('progressRecebido').textContent = formatMoney(recebido) + ' recebido';
            document.getElementById('progressPendente').textContent = formatMoney(pendente) + ' pendente';

            // Status da meta (80%)
            const metaStatus = document.getElementById('metaStatus');
            if (taxa >= 80) {
                metaStatus.textContent = 'ðŸŽ‰ Meta atingida!';
                metaStatus.className = 'summary-change positive';
            } else {
                metaStatus.textContent = `Faltam ${(80 - taxa).toFixed(1)}% para meta`;
                metaStatus.className = 'summary-change';
            }

            // Atualizar KPIs
            const clientesAtivos = clientes.filter(c => c.valor > 0 && !isStatusEspecial(c.status)).length;
            const ticketMedio = clientesAtivos > 0 ? totalReal / clientesAtivos : 0;
            document.getElementById('ticketMedio').textContent = formatMoney(ticketMedio);
            document.getElementById('metaRecebimento').textContent = taxa.toFixed(1) + '%';

            const metaTrend = document.getElementById('metaTrend');
            if (taxa >= 80) {
                metaTrend.textContent = 'âœ… Meta atingida! (80%)';
                metaTrend.style.color = '#27ae60';
            } else {
                metaTrend.textContent = `Faltam ${(80 - taxa).toFixed(1)}% para meta de 80%`;
                metaTrend.style.color = '#f39c12';
            }

            // Atualizar grÃ¡ficos
            updateStatusChart(recebido, pendente);
            updateTop5Chart(clientes.filter(c => c.valor > 0));

            // Salvar clientes globalmente para uso em toggleItemStatus
            currentClientes = clientesParaTabela;

            // Renderizar tabela
            renderTable(clientesParaTabela);
        }

        // Atualizar grÃ¡fico de status
        function updateStatusChart(recebido, pendente) {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;

            if (statusChart) {
                statusChart.destroy();
            }

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Recebido', 'Pendente'],
                    datasets: [{
                        data: [recebido, pendente],
                        backgroundColor: ['#27ae60', '#f39c12'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13, weight: '600' },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatMoney(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar grÃ¡fico top 5
        function updateTop5Chart(clientes) {
            const ctx = document.getElementById('top5Chart');
            if (!ctx) return;

            const sortedClientes = [...clientes]
                .sort((a, b) => b.valor - a.valor)
                .slice(0, 5);

            const labels = sortedClientes.map(c => c.nome.replace(' (Alpha)', '').substring(0, 20));
            const values = sortedClientes.map(c => c.valor);

            if (top5Chart) {
                top5Chart.destroy();
            }

            top5Chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Receita',
                        data: values,
                        backgroundColor: '#4A6B54',
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatMoney(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + formatMoneyShort(value);
                                }
                            },
                            grid: { display: true, color: 'rgba(0,0,0,0.05)' }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // Formatar data
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleString('pt-BR');
        }

        function updateImportInfo(mes) {
            const importAsaasEl = document.getElementById('lastImportAsaas');
            const reconcileAsaasEl = document.getElementById('lastReconcileAsaas');
            const importContaEl = document.getElementById('lastImportContaSimples');
            const reconcileContaEl = document.getElementById('lastReconcileContaSimples');
            if (!importAsaasEl || !reconcileAsaasEl || !importContaEl || !reconcileContaEl) return;
            const meta = getImportMetaForMonth(mes);
            const banksMeta = meta.banks || {};
            const history = loadImportHistory();

            function resolveLastForBank(bankKey) {
                let lastImportAt = banksMeta[bankKey]?.lastImportAt || '';
                let lastReconcileAt = banksMeta[bankKey]?.lastReconcileAt || '';
                if (!lastImportAt || !lastReconcileAt) {
                    const latest = history.reduce((acc, run) => {
                        if (run.month !== mes) return acc;
                        const sources = Array.isArray(run.sources) && run.sources.length ? run.sources : ['asaas'];
                        if (!sources.includes(bankKey)) return acc;
                        const time = new Date(run.createdAt).getTime();
                        if (!Number.isFinite(time)) return acc;
                        if (!acc || time > acc.time) return { time, createdAt: run.createdAt };
                        return acc;
                    }, null);
                    if (!lastImportAt) lastImportAt = latest?.createdAt || '';
                    if (!lastReconcileAt) lastReconcileAt = latest?.createdAt || '';
                }
                return { lastImportAt, lastReconcileAt };
            }

            const asaas = resolveLastForBank('asaas');
            const conta = resolveLastForBank('conta_simples');

            importAsaasEl.textContent = formatDateTime(asaas.lastImportAt);
            reconcileAsaasEl.textContent = formatDateTime(asaas.lastReconcileAt);
            importContaEl.textContent = formatDateTime(conta.lastImportAt);
            reconcileContaEl.textContent = formatDateTime(conta.lastReconcileAt);
        }

        function formatMonthBr(monthStr) {
            if (!monthStr) return '';
            const [year, month] = monthStr.split('-');
            if (!year || !month) return '';
            return `${month}/${year}`;
        }

        function parseMonthBr(value) {
            const cleaned = String(value || '').trim();
            const match = cleaned.match(/^(\d{2})[\/\-](\d{4})$/);
            if (match) {
                return `${match[2]}-${match[1]}`;
            }
            if (/^\d{4}-\d{2}$/.test(cleaned)) {
                return cleaned;
            }
            return '';
        }

        // Ordem customizada salva no localStorage
        function getCustomOrder() {
            const saved = localStorage.getItem('contas_receber_order_' + currentMonth);
            return saved ? JSON.parse(saved) : null;
        }

        function saveCustomOrder(order) {
            localStorage.setItem('contas_receber_order_' + currentMonth, JSON.stringify(order));
        }

        // VariÃ¡veis para drag and drop
        let draggedRow = null;

        function isOtherEntry(item) {
            return !!(item && item.isCustom && !item.origemParcial);
        }

        function getOtherEntryBankKey(item) {
            if (!item) return 'outros';
            const raw = String(item.gateway || item.banco || item.formaPagamento || '').toLowerCase();
            if (raw.includes('conta_simples') || raw.includes('conta simples') || raw.includes('cs bank') || raw.includes('csbank')) {
                return 'conta_simples';
            }
            if (raw.includes('asaas') || raw.includes('starken')) {
                return 'starken';
            }
            return 'outros';
        }

        function filterClientesByCurrentFilters(clientes) {
            let clientesFiltrados = clientes;
            if (currentFilter === 'pendente') {
                clientesFiltrados = clientes.filter(c => !c.isRecebido && !c.isEspecial && c.valor > 0);
            } else if (currentFilter === 'recebido') {
                clientesFiltrados = clientes.filter(c => c.isRecebido);
            } else if (currentFilter === 'starken') {
                clientesFiltrados = clientes.filter(c => c.empresa === 'Starken');
            } else if (currentFilter === 'alpha') {
                clientesFiltrados = clientes.filter(c => c.empresa === 'Alpha');
            } else if (currentFilter === 'mrr') {
                clientesFiltrados = clientes.filter(c => c.tipo === 'MRR' || (!c.tipo && c.empresa === 'Alpha'));
            } else if (currentFilter === 'tcv') {
                clientesFiltrados = clientes.filter(c => c.tipo === 'TCV' || c.tipo === 'Projeto');
            } else if (currentFilter === 'clientes') {
                clientesFiltrados = clientes.filter(c => !isOtherEntry(c));
            } else if (currentFilter === 'outras') {
                clientesFiltrados = clientes.filter(c => isOtherEntry(c));
            } else if (currentFilter === 'banco_starken') {
                clientesFiltrados = clientes.filter(c => isOtherEntry(c) && getOtherEntryBankKey(c) === 'starken');
            } else if (currentFilter === 'banco_conta_simples') {
                clientesFiltrados = clientes.filter(c => isOtherEntry(c) && getOtherEntryBankKey(c) === 'conta_simples');
            }

            if (currentSearchTerm) {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    const text = normalizeText([
                        c.nome,
                        c.observacao,
                        c.origem,
                        c.empresa,
                        c.tipo,
                        c.gateway,
                        c.banco,
                        c.formaPagamento
                    ].filter(Boolean).join(' '));
                    return text.includes(currentSearchTerm);
                });
            }

            return clientesFiltrados;
        }

        function renderTable(clientes) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            let clientesFiltrados = filterClientesByCurrentFilters(clientes);

            // Aplicar ordem customizada se existir
            const customOrder = getCustomOrder();
            if (customOrder && currentFilter === 'todos') {
                clientesFiltrados.sort((a, b) => {
                    const indexA = customOrder.indexOf(a.nome);
                    const indexB = customOrder.indexOf(b.nome);
                    if (indexA === -1 && indexB === -1) return 0;
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            } else {
                // Ordenar: pendentes primeiro, depois por valor
                clientesFiltrados.sort((a, b) => {
                    if (a.isEspecial !== b.isEspecial) return a.isEspecial ? 1 : -1;
                    if (a.isRecebido !== b.isRecebido) return a.isRecebido ? 1 : -1;
                    return b.valor - a.valor;
                });
            }

            clientesFiltrados.forEach((cliente, index) => {
                const tr = document.createElement('tr');
                tr.className = cliente.isRecebido ? 'row-recebido' : '';
                tr.dataset.nome = cliente.nome;
                tr.dataset.index = index;
                tr.draggable = true;

                // Event listeners para drag and drop
                tr.addEventListener('dragstart', handleDragStart);
                tr.addEventListener('dragend', handleDragEnd);
                tr.addEventListener('dragover', handleDragOver);
                tr.addEventListener('drop', handleDrop);
                tr.addEventListener('dragleave', handleDragLeave);

                const isSelected = selectedItems.has(cliente.nome);
                const canSelect = !cliente.isEspecial && cliente.valor > 0;

                // Determinar status visual
                let statusClass = 'pendente';
                let statusText = 'A Receber';
                let switchClass = '';

                if (cliente.isEspecial) {
                    statusClass = 'especial';
                    statusText = cliente.status;
                    switchClass = 'disabled';
                } else if (cliente.isRecebido) {
                    statusClass = 'recebido';
                    statusText = 'Recebido';
                    switchClass = 'active';
                }

                // Status badge class
                let statusBadgeClass = 'status-badge-pendente';
                let statusIcon = 'â—‹';

                if (cliente.isEspecial) {
                    statusBadgeClass = 'status-badge-especial';
                    statusIcon = 'â˜…';
                } else if (cliente.isRecebido) {
                    statusBadgeClass = 'status-badge-recebido';
                    statusIcon = 'âœ“';
                }

                // Data recebimento HTML
                const dataRecebimentoHtml = cliente.dataPagamento
                    ? `<span class="date-badge date-badge-recebido">${formatDate(cliente.dataPagamento)}</span>`
                    : '<span class="date-badge date-badge-empty">-</span>';
                const dataVencimentoHtml = cliente.dataVencimento
                    ? `<span class="date-badge date-badge-recebido">${formatDate(cliente.dataVencimento)}</span>`
                    : '<span class="date-badge date-badge-empty">-</span>';
                const valorPrevisto = cliente.valorLiquido || cliente.valor || 0;
                const valorRecebido = cliente.isRecebido ? valorPrevisto : 0;
                const valorBrutoLabel = cliente.valorBruto || cliente.valor || 0;
                const percentualLiquido = valorBrutoLabel > 0
                    ? Math.round((valorPrevisto / valorBrutoLabel) * 100)
                    : 0;
                const mostrarPercentualAlpha = cliente.empresa === 'Alpha' && valorPrevisto > 0 && valorBrutoLabel > 0 && percentualLiquido < 100;

                const nomeAttr = toAttrJsString(cliente.nome);
                const empresaAttr = toAttrJsString(cliente.empresa || 'Starken');
                const statusAttr = toAttrJsString(cliente.isRecebido ? 'Recebido' : 'A Receber');
                const tipoAttr = toAttrJsString(cliente.tipo || 'TCV');
                const origemAttr = toAttrJsString(cliente.origem || 'ProspecÃ§Ã£o');
                const categoriaAttr = toAttrJsString(cliente.categoria || '');
                const dataPagamentoAttr = toAttrJsString(cliente.dataPagamento || '');
                const observacaoAttr = toAttrJsString(cliente.observacao || '');
                const dataVencimentoAttr = toAttrJsString(cliente.dataVencimento || '');
                const formaPagamentoAttr = toAttrJsString(cliente.formaPagamento || '');
                const gatewayAttr = toAttrJsString(cliente.gateway || '');
                const parcelasCartaoAttr = toAttrJsString(cliente.parcelasCartao || '');
                const valorLiquidoManualAttr = toAttrJsString(cliente.valorLiquidoManual ?? '');

                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <div class="custom-checkbox ${isSelected ? 'checked' : ''} ${!canSelect ? 'disabled' : ''}"
                             onclick="${canSelect ? `toggleItemSelection(${nomeAttr}, this)` : ''}"></div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="client-name">${cliente.nome}</div>
                            ${cliente.origemParcial ? `<span style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;" title="Origem: ${cliente.origemParcial}${cliente.valorOriginal ? ' - Original: R$ ' + cliente.valorOriginal.toFixed(2) : ''}">âš¡ Parcial</span>` : ''}
                        </div>
                        ${cliente.origem ? `<div class="client-info">${cliente.origem}</div>` : ''}
                        ${cliente.isClienteNovo ? `<div class="client-info" style="color: #27ae60; font-weight: 600;">âœ¨ Novo Cliente</div>` : `<div class="client-info" style="color: #3498db;">ðŸ“Š Base Existente</div>`}
                        ${cliente.observacao ? `<div class="client-info" style="font-style: italic; color: #7f8c8d;">ðŸ“ ${cliente.observacao}</div>` : ''}
                    </td>
                    <td>
                        <span class="empresa-badge empresa-${(cliente.empresa || 'starken').toLowerCase()}">
                            ${cliente.empresa || 'Starken'}
                        </span>
                    </td>
                    <td class="text-right">
                        <span class="amount" style="color: #667eea; font-weight: 600;">${valorPrevisto > 0 ? formatMoney(valorPrevisto) : '-'}</span>
                        ${mostrarPercentualAlpha ? `<div style="font-size: 10px; color: #6b7280; margin-top: 2px;">${percentualLiquido}% do bruto</div>` : ''}
                    </td>
                    <td class="text-right">
                        <span class="amount" style="color: #10b981; font-weight: 700;">${valorRecebido > 0 ? formatMoney(valorRecebido) : '-'}</span>
                    </td>
                    <td class="text-center">
                        ${dataVencimentoHtml}
                    </td>
                    <td class="text-center">
                        ${dataRecebimentoHtml}
                    </td>
                    <td class="text-center">
                        <span class="status-badge ${statusBadgeClass}"
                              onclick="${!cliente.isEspecial && cliente.valor > 0 ? `toggleItemStatus(${nomeAttr}, ${cliente.valor})` : ''}"
                              title="${!cliente.isEspecial && cliente.valor > 0 ? 'Clique para alterar status' : ''}">
                            <span class="status-icon">${statusIcon}</span>
                            <span class="status-text">${statusText}</span>
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="row-actions">
                            <button class="action-btn edit" onclick="openEditReceitaModal(${nomeAttr}, ${empresaAttr}, ${cliente.valor}, ${statusAttr}, ${cliente.isCustom || false}, ${tipoAttr}, ${origemAttr}, ${cliente.novo || false}, ${cliente.renovacao || false}, ${categoriaAttr}, ${dataPagamentoAttr}, ${observacaoAttr}, ${dataVencimentoAttr}, ${formaPagamentoAttr}, ${gatewayAttr}, ${parcelasCartaoAttr}, ${valorLiquidoManualAttr})" title="Editar">
                                âœï¸
                            </button>
                            <button class="action-btn delete" onclick="excluirReceita(${nomeAttr}, ${cliente.isCustom || false})" title="Excluir">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            // Atualizar contador
            const totalClientes = clientes.filter(c => c.valor > 0).length;
            document.getElementById('tableCount').textContent = `${clientesFiltrados.length} de ${totalClientes} registros`;

            // Atualizar totais do footer
            updateFooterTotals(clientesFiltrados);

            // Atualizar Kanban se estiver ativo
            if (typeof currentView !== 'undefined' && currentView === 'kanban') {
                renderKanban();
            }
        }

        // Atualizar totais do footer
        function updateFooterTotals(clientesFiltrados) {
            const totalValor = clientesFiltrados.reduce((sum, c) => sum + (c.valor > 0 ? c.valor : 0), 0);
            const totalRecebido = clientesFiltrados.filter(c => c.isRecebido).reduce((sum, c) => sum + c.valor, 0);
            const totalPendente = totalValor - totalRecebido;

            document.getElementById('totalFiltrado').textContent = formatMoney(totalValor);
            document.getElementById('totalInfo').innerHTML = `${clientesFiltrados.length} receitas | <span style="color: #90EE90;">Recebido: ${formatMoney(totalRecebido)}</span> | <span style="color: #FFB6C1;">Pend: ${formatMoney(totalPendente)}</span>`;
        }

        // Drag and Drop handlers
        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('tr.drag-over, tr.drag-over-bottom').forEach(row => {
                row.classList.remove('drag-over', 'drag-over-bottom');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            if (this === draggedRow) return;

            document.querySelectorAll('tr.drag-over, tr.drag-over-bottom').forEach(row => {
                row.classList.remove('drag-over', 'drag-over-bottom');
            });

            const rect = this.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;

            if (e.clientY < midY) {
                this.classList.add('drag-over');
            } else {
                this.classList.add('drag-over-bottom');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over', 'drag-over-bottom');
        }

        function handleDrop(e) {
            e.preventDefault();
            if (this === draggedRow) return;

            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const draggedIndex = rows.indexOf(draggedRow);
            const dropIndex = rows.indexOf(this);

            const rect = this.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;

            if (e.clientY < midY) {
                tbody.insertBefore(draggedRow, this);
            } else {
                tbody.insertBefore(draggedRow, this.nextSibling);
            }

            // Salvar nova ordem
            const newOrder = Array.from(tbody.querySelectorAll('tr')).map(row => row.dataset.nome);
            saveCustomOrder(newOrder);

            this.classList.remove('drag-over', 'drag-over-bottom');
            showToast('Ordem atualizada!', 'success');
        }

        // Toggle status de um item
        function toggleItemStatus(nome, valor) {
            // Buscar o cliente da lista global (inclui clientes do localStorage + customItems)
            const cliente = currentClientes.find(c => c.nome === nome);

            if (!cliente) {
                console.error('Cliente nÃ£o encontrado:', nome);
                console.log('Clientes disponÃ­veis:', currentClientes.map(c => c.nome));
                return;
            }

            const currentStatus = GestaoFinanceira.getStatus(currentMonth, 'receita', nome);
            const isRecebido = currentStatus && (currentStatus.status === 'Recebido' || currentStatus.status === 'Feito');

            if (isRecebido) {
                // Se jÃ¡ estÃ¡ recebido, marcar como pendente
                GestaoFinanceira.updateStatus(currentMonth, 'receita', nome, 'A Receber', null);
                showToast('Receita marcada como pendente', 'warning');
                loadMonthData(currentMonth);
            } else {
                // Abrir modal com opÃ§Ãµes de recebimento parcial
                openKanbanReceiveModal(cliente, 'recebido');
            }
        }

        // Confirmar recebimento
        function confirmPayment() {
            if (pendingPayment) {
                const date = document.getElementById('paymentDate').value;
                GestaoFinanceira.updateStatus(
                    currentMonth,
                    pendingPayment.tipo,
                    pendingPayment.nome,
                    'Recebido',
                    date
                );
                showToast(`${pendingPayment.nome} marcado como recebido!`, 'success');
                pendingPayment = null;
            }
            closeModal();
            loadMonthData(currentMonth);
        }

        // Fechar modal
        function closeModal(modalId) {
            if (modalId === 'importModal') {
                const importModal = document.getElementById('importModal');
                if (importModal) {
                    importModal.classList.remove('show');
                }
                return;
            }
            document.getElementById('modalOverlay').classList.remove('show');
            pendingPayment = null;
        }

        // Toggle seleÃ§Ã£o de item
        function toggleItemSelection(nome, checkbox) {
            if (selectedItems.has(nome)) {
                selectedItems.delete(nome);
                checkbox.classList.remove('checked');
            } else {
                selectedItems.add(nome);
                checkbox.classList.add('checked');
            }
            updateBulkActions();
        }

        // Toggle selecionar todos
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#tableBody .custom-checkbox:not(.disabled)');

            if (selectAll.classList.contains('checked')) {
                selectAll.classList.remove('checked');
                selectedItems.clear();
                checkboxes.forEach(cb => cb.classList.remove('checked'));
            } else {
                selectAll.classList.add('checked');
                checkboxes.forEach(cb => {
                    const nome = cb.closest('tr').dataset.nome;
                    selectedItems.add(nome);
                    cb.classList.add('checked');
                });
            }
            updateBulkActions();
        }

        // Atualizar aÃ§Ãµes em massa
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            const selectedTotal = document.getElementById('selectedTotal');

            if (selectedItems.size > 0) {
                bulkActions.classList.add('show');
                selectedCount.textContent = `${selectedItems.size} selecionados`;

                // Calcular total
                let total = 0;
                const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);
                dados.receitas.clientes.forEach(cliente => {
                    if (selectedItems.has(cliente.nome)) {
                        total += cliente.valor;
                    }
                });
                selectedTotal.textContent = formatMoney(total);
            } else {
                bulkActions.classList.remove('show');
            }
        }

        // Marcar selecionados como recebidos
        function marcarSelecionadosRecebidos() {
            const date = new Date().toISOString().split('T')[0];
            selectedItems.forEach(nome => {
                GestaoFinanceira.updateStatus(currentMonth, 'receita', nome, 'Recebido', date);
            });
            showToast(`${selectedItems.size} receitas marcadas como recebidas!`, 'success');
            limparSelecao();
            loadMonthData(currentMonth);
        }

        // Excluir selecionados
        async function excluirSelecionados() {
            const count = selectedItems.size;
            if (!confirm(`Tem certeza que deseja EXCLUIR ${count} receita(s)?\n\nEssa aÃ§Ã£o nÃ£o pode ser desfeita!`)) {
                return;
            }

            let excluidos = 0;
            for (const nome of selectedItems) {
                try {
                    const cliente = currentClientes.find(c => c.nome === nome);
                    const isCustom = cliente ? !!cliente.isCustom : false;

                    // Tenta excluir via API (para itens do banco)
                    await fetch('/.netlify/functions/sync-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            acao: 'remover-item',
                            dados: { tipo: 'receita', nome, mes: currentMonth }
                        })
                    });

                    // Remove do GestaoFinanceira local tambÃ©m
                    if (window.GestaoFinanceira && GestaoFinanceira.deleteReceita) {
                        GestaoFinanceira.deleteReceita(currentMonth, nome, isCustom);
                    }

                    excluidos++;
                } catch (error) {
                    console.error('Erro ao excluir:', nome, error);
                }
            }

            showToast(`${excluidos} receita(s) excluÃ­da(s) com sucesso!`, 'success');
            limparSelecao();
            loadMonthData(currentMonth);

            // Sincroniza com stark-core se disponÃ­vel
            if (window.stark) {
                window.stark.sincronizar(true);
            }
        }

        // Limpar seleÃ§Ã£o
        function limparSelecao() {
            selectedItems.clear();
            document.querySelectorAll('.custom-checkbox').forEach(cb => cb.classList.remove('checked'));
            updateBulkActions();
        }

        // Modal de ajuste de datas em massa
        function openBulkDatesModal() {
            if (selectedItems.size === 0) return;
            document.getElementById('bulkDatesCount').textContent = `${selectedItems.size} selecionados`;
            document.getElementById('bulkDueDate').value = '';
            document.getElementById('bulkPaymentDate').value = '';
            document.getElementById('bulkDatesModal').classList.add('show');
        }

        function closeBulkDatesModal() {
            document.getElementById('bulkDatesModal').classList.remove('show');
        }

        async function applyBulkReceitaDates() {
            const novaVenc = document.getElementById('bulkDueDate').value;
            const novaPag = document.getElementById('bulkPaymentDate').value;

            if (!novaVenc && !novaPag) {
                alert('Informe pelo menos uma das datas');
                return;
            }

            closeBulkDatesModal();

            if (selectedItems.size === 0) return;

            let updated = 0;

            // Atualizar dados no GestaoFinanceira
            for (const nome of selectedItems) {
                try {
                    if (novaVenc) {
                        // Atualiza ediÃ§Ã£o da receita com novo vencimento
                        GestaoFinanceira.editReceita(currentMonth, nome, { dataVencimento: novaVenc });
                    }
                    if (novaPag) {
                        // Marca como recebido com a data informada
                        GestaoFinanceira.updateStatus(currentMonth, 'receita', nome, 'Recebido', novaPag);
                    }
                    updated++;
                } catch (e) {
                    console.error('Erro ao atualizar datas para', nome, e);
                }
            }

            // Sincronizar se disponÃ­vel
            if (GestaoFinanceira.syncToServer) {
                await GestaoFinanceira.syncToServer();
            }

            loadMonthData(currentMonth);
            limparSelecao();
            showToast(`Datas atualizadas para ${updated} item(s)`, 'success');
        }

        // Marcar todos como recebidos
        function marcarTodosRecebidos() {
            if (!confirm('Deseja marcar TODAS as receitas como recebidas?')) return;

            const date = new Date().toISOString().split('T')[0];
            const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);

            dados.receitas.clientes.forEach(cliente => {
                if (cliente.valor > 0 && !isStatusEspecial(cliente.status)) {
                    GestaoFinanceira.updateStatus(currentMonth, 'receita', cliente.nome, 'Recebido', date);
                }
            });

            showToast('Todas as receitas marcadas como recebidas!', 'success');
            loadMonthData(currentMonth);
        }

        async function limparRecebiveisMes() {
            const mes = currentMonth;
            const dadosMes = dadosMensais?.[mes];
            const clientesBase = dadosMes?.receitas?.clientes || [];

            if (!GestaoFinanceira.deletedItems[mes]) {
                GestaoFinanceira.deletedItems[mes] = { despesas: [], receitas: [] };
            }

            clientesBase.forEach(cliente => {
                if (!GestaoFinanceira.deletedItems[mes].receitas.includes(cliente.nome)) {
                    GestaoFinanceira.deletedItems[mes].receitas.push(cliente.nome);
                }
            });

            if (GestaoFinanceira.customItems[mes]) {
                GestaoFinanceira.customItems[mes].receitas = [];
            }

            if (GestaoFinanceira.editedItems[mes]) {
                GestaoFinanceira.editedItems[mes].receitas = {};
            }

            Object.keys(GestaoFinanceira.statusData).forEach(key => {
                if (key.startsWith(`${mes}_receita_`)) {
                    delete GestaoFinanceira.statusData[key];
                }
            });

            const history = loadImportHistory();
            const monthHistory = history.filter(item => item.month === mes);
            const importedKeySet = loadImportedKeySet();
            monthHistory.forEach(run => {
                (run.importedKeys || []).forEach(key => importedKeySet.delete(key));
            });
            const monthPrefix = `${mes}-`;
            const filteredKeys = Array.from(importedKeySet).filter(key => {
                const parts = String(key || '').split('|');
                const date = parts[parts.length - 1] || '';
                return !date.startsWith(monthPrefix);
            });
            saveImportedKeys(filteredKeys);
            saveImportHistory(history.filter(item => item.month !== mes));

            GestaoFinanceira.saveToStorage();
            if (GestaoFinanceira.syncToServer) {
                await GestaoFinanceira.syncToServer();
            }
            loadMonthData(mes);
            showToast('RecebÃ­veis do mÃªs removidos.', 'success');
        }

        function updateFiltersSummary() {
            const summary = document.getElementById('filtersSummary');
            if (!summary) return;
            const labels = {
                'todos': 'todos os registros',
                'pendente': 'pendentes',
                'recebido': 'recebidos',
                'starken': 'Starken',
                'alpha': 'Alpha',
                'mrr': 'MRR (recorrentes)',
                'tcv': 'TCV (projetos)',
                'clientes': 'recebÃ­veis de clientes',
                'outras': 'outras entradas',
                'banco_starken': 'outras entradas â€¢ Starken',
                'banco_conta_simples': 'outras entradas â€¢ Conta Simples'
            };
            const filtroLabel = labels[currentFilter] || currentFilter;
            const searchLabel = currentSearchDisplay ? ` â€¢ busca: <strong>${escapeAttr(currentSearchDisplay)}</strong>` : '';
            summary.innerHTML = `Mostrando <strong>${filtroLabel}</strong>${searchLabel}`;
        }

        function onSearchReceitas() {
            const input = document.getElementById('searchReceitas');
            const value = input ? input.value.trim() : '';
            currentSearchDisplay = value;
            currentSearchTerm = normalizeText(value);
            updateFiltersSummary();
            loadMonthData(currentMonth);
        }

        function clearSearchReceitas() {
            const input = document.getElementById('searchReceitas');
            if (input) input.value = '';
            currentSearchDisplay = '';
            currentSearchTerm = '';
            updateFiltersSummary();
            loadMonthData(currentMonth);
        }

        // Filtrar receitas
        function filtrarReceitas(filtro) {
            currentFilter = filtro;

            // Atualiza filter-btn (antigos)
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filtro);
            });

            // Atualiza filter-chip (novos)
            document.querySelectorAll('.filter-chip').forEach(chip => {
                if (filtro === 'todos') {
                    chip.classList.toggle('active', chip.dataset.filter === 'todos');
                } else {
                    chip.classList.toggle('active', chip.dataset.filter === filtro);
                }
            });

            updateFiltersSummary();

            loadMonthData(currentMonth);
        }

        // Exportar dados
        function exportarDados() {
            const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);

            let csv = 'Cliente,Empresa,Valor,Status,Data Recebimento,Origem\n';

            dados.receitas.clientes.forEach(cliente => {
                csv += `"${cliente.nome}","${cliente.empresa || 'Starken'}","${cliente.valor}","${cliente.status}","${cliente.dataPagamento || ''}","${cliente.origem || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `contas-receber-${currentMonth}.csv`;
            link.click();

            showToast('Dados exportados com sucesso!', 'success');
        }

        // Mostrar toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toastMessage.textContent = message;
            toast.className = `toast ${type}`;

            if (type === 'success') toastIcon.textContent = 'âœ“';
            else if (type === 'warning') toastIcon.textContent = 'âš ';
            else if (type === 'error') toastIcon.textContent = 'âœ•';

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========================================
        // BACKUP E RESTAURAÃ‡ÃƒO
        // ========================================

        // Exportar backup dos dados
        function exportarBackup() {
            try {
                GestaoFinanceira.exportData();
                showToast('Backup salvo com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showToast('Erro ao salvar backup', 'error');
            }
        }

        async function exportarParaProducao() {
            try {
                const sucesso = await GestaoFinanceira.exportToRailway();
                if (sucesso) {
                    showToast('Dados enviados para produÃ§Ã£o!', 'success');
                } else {
                    showToast('Falha ao enviar dados para produÃ§Ã£o', 'error');
                }
            } catch (error) {
                showToast('Erro ao enviar dados para produÃ§Ã£o', 'error');
            }
        }

        // Importar backup dos dados
        function importarBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('Isso vai substituir todos os dados atuais. Deseja continuar?')) {
                input.value = '';
                return;
            }

            GestaoFinanceira.importData(file)
                .then(result => {
                    showToast('Dados restaurados com sucesso!', 'success');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    showToast('Erro ao restaurar: ' + error.message, 'error');
                })
                .finally(() => {
                    input.value = '';
                });
        }

        // Mudar mÃªs
        function changeMonth() {
            const selectedMonth = document.getElementById('monthSelect').value;
            limparSelecao();
            loadMonthData(selectedMonth);
        }

        // ========================================
        // KANBAN VIEW
        // ========================================

        let currentView = 'table';
        let kanbanDraggedCard = null;

        // Alternar entre views
        function setView(view) {
            currentView = view;
            const tableContainer = document.getElementById('tableContainer');
            const kanbanContainer = document.getElementById('kanbanContainer');
            const tableBtn = document.getElementById('viewTableBtn');
            const kanbanBtn = document.getElementById('viewKanbanBtn');

            if (view === 'table') {
                tableContainer.style.display = 'block';
                kanbanContainer.classList.remove('active');
                tableBtn.classList.add('active');
                kanbanBtn.classList.remove('active');
            } else {
                tableContainer.style.display = 'none';
                kanbanContainer.classList.add('active');
                tableBtn.classList.remove('active');
                kanbanBtn.classList.add('active');
                renderKanban();
            }

            localStorage.setItem('contas_receber_view', view);
        }

        // Renderizar Kanban
        function renderKanban() {
            // Limpar mapa de itens
            kanbanItemsMap = {};

            // Buscar dados diretamente
            const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);
            if (!dados) {
                console.log('Kanban Receber: dados nÃ£o encontrados');
                return;
            }

            // Processar clientes igual ao loadMonthData
            const clientes = dados.receitas.clientes || [];
            const clientesProcessados = [];

            clientes.forEach(cliente => {
                const isEspecial = cliente.valor <= 0 || isStatusEspecial(cliente.status);
                const isRecebido = cliente.status === 'Recebido' || cliente.status === 'Feito';

                clientesProcessados.push({
                    ...cliente,
                    isRecebido: isRecebido,
                    isEspecial: isEspecial
                });
            });

            console.log('Kanban Receber: total de clientes =', clientesProcessados.length);

            const clientesFiltrados = filterClientesByCurrentFilters(clientesProcessados);

            const pendentes = clientesFiltrados.filter(c => !c.isRecebido && !c.isEspecial && c.valor > 0);
            const starkenClientes = clientesFiltrados.filter(c => (c.empresa || 'Starken') === 'Starken' && !c.isRecebido && c.valor > 0);
            const alphaClientes = clientesFiltrados.filter(c => (c.empresa || 'Starken') === 'Alpha' && !c.isRecebido && c.valor > 0);
            const recebidos = clientesFiltrados.filter(c => c.isRecebido);

            // Renderizar colunas
            renderKanbanColumn('kanbanPendente', pendentes, 'Pendente');
            renderKanbanColumn('kanbanStarken', starkenClientes, 'Starken');
            renderKanbanColumn('kanbanAlpha', alphaClientes, 'Alpha');
            renderKanbanColumn('kanbanRecebido', recebidos, 'Recebido');

            // Atualizar contadores e totais
            document.getElementById('kanbanPendenteCount').textContent = pendentes.length;
            document.getElementById('kanbanStarkenCount').textContent = starkenClientes.length;
            document.getElementById('kanbanAlphaCount').textContent = alphaClientes.length;
            document.getElementById('kanbanRecebidoCount').textContent = recebidos.length;

            const totalPendente = pendentes.reduce((sum, c) => sum + (c.valor || 0), 0);
            const totalStarken = starkenClientes.reduce((sum, c) => sum + (c.valor || 0), 0);
            const totalAlpha = alphaClientes.reduce((sum, c) => sum + (c.valor || 0), 0);
            const totalRecebido = recebidos.reduce((sum, c) => sum + (c.valor || 0), 0);

            document.getElementById('kanbanPendenteTotal').textContent = formatMoney(totalPendente);
            document.getElementById('kanbanStarkenTotal').textContent = formatMoney(totalStarken);
            document.getElementById('kanbanAlphaTotal').textContent = formatMoney(totalAlpha);
            document.getElementById('kanbanRecebidoTotal').textContent = formatMoney(totalRecebido);
        }

        // Renderizar coluna do Kanban
        function renderKanbanColumn(containerId, items, status) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="kanban-empty">
                        <div class="kanban-empty-icon">${status === 'Recebido' ? 'âœ…' : 'ðŸ“­'}</div>
                        <div>Nenhum item</div>
                    </div>
                `;
                return;
            }

            items.sort((a, b) => (b.valor || 0) - (a.valor || 0));

            container.innerHTML = items.map(item => createKanbanCard(item)).join('');

            container.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('dragstart', handleKanbanCardDragStart);
                card.addEventListener('dragend', handleKanbanCardDragEnd);
            });
        }

        // Criar card do Kanban
        function createKanbanCard(item) {
            // Armazenar item para acesso posterior
            kanbanItemsMap[item.nome] = item;

            const empresa = (item.empresa || 'Starken').toLowerCase();
            const empresaLabel = item.empresa || 'Starken';

            // Determinar status visual
            let statusClass = item.isRecebido ? 'status-recebido' : 'status-pendente';
            let statusIcon = item.isRecebido ? 'âœ…' : 'â³';

            let badges = `<span class="kanban-card-badge empresa-${empresa}">${empresaLabel}</span>`;
            if (item.novo) {
                badges += '<span class="kanban-card-badge novo">âœ¨ Novo</span>';
            }
            if (item.renovacao) {
                badges += '<span class="kanban-card-badge" style="background: #e3f2fd; color: #1565c0;">ðŸ”„ RenovaÃ§Ã£o</span>';
            }
            if (item.isCustom) {
                badges += '<span class="kanban-card-badge" style="background: #e3f2fd; color: #1565c0;">âœï¸ Manual</span>';
            }

            // Data info
            let dateInfo = '';
            if (item.isRecebido && item.dataPagamento) {
                dateInfo = `<span class="kanban-card-date recebido">âœ“ Recebido em ${formatDate(item.dataPagamento)}</span>`;
            }

            const actionBtn = item.isRecebido ?
                `<button class="kanban-action-btn unreceive" onclick="event.stopPropagation(); openKanbanReceiveModal(kanbanItemsMap['${item.nome.replace(/'/g, "\\'")}'], 'pendente')">â†© Desfazer</button>` :
                `<button class="kanban-action-btn receive" onclick="event.stopPropagation(); openKanbanReceiveModal(kanbanItemsMap['${item.nome.replace(/'/g, "\\'")}'], 'recebido')">âœ“ Receber</button>`;

            // Escapar nome para uso em atributos e funÃ§Ãµes
            const nomeEscaped = item.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const nomeAttr = item.nome.replace(/"/g, '&quot;');

            return `
                <div class="kanban-card ${empresa} ${statusClass}"
                     draggable="true"
                     data-nome="${nomeAttr}"
                     data-valor="${item.valor || 0}"
                     data-is-custom="${item.isCustom || false}"
                     onclick="openKanbanReceiveModal(kanbanItemsMap['${nomeEscaped}'])">
                    <button class="card-delete-btn" onclick="event.stopPropagation(); showKanbanDeleteConfirm(this, '${nomeEscaped}', ${item.isCustom || false})" title="Excluir">ðŸ—‘ï¸</button>
                    <button class="card-edit-btn" onclick="event.stopPropagation(); openKanbanReceiveModal(kanbanItemsMap['${nomeEscaped}'])" title="Editar">âœï¸</button>
                    <div class="kanban-card-header">
                        <div class="kanban-card-title">${statusIcon} ${item.nome}</div>
                        <div class="kanban-card-amount">${formatMoney(item.valor || 0)}</div>
                    </div>
                    <div class="kanban-card-meta">
                        ${badges}
                    </div>
                    ${dateInfo ? `<div class="kanban-card-info">${dateInfo}</div>` : ''}
                    <div class="kanban-card-actions">
                        ${actionBtn}
                    </div>
                </div>
            `;
        }

        // Mostrar confirmaÃ§Ã£o de exclusÃ£o no card
        function showKanbanDeleteConfirm(btn, nome, isCustom) {
            const card = btn.closest('.kanban-card');

            // Remover confirmaÃ§Ãµes anteriores
            document.querySelectorAll('.kanban-delete-confirm').forEach(el => el.remove());

            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'kanban-delete-confirm';
            confirmDiv.innerHTML = `
                <p>Excluir "${nome}"?</p>
                <div class="kanban-delete-confirm-btns">
                    <button class="confirm-yes" onclick="confirmKanbanDelete('${nome}', ${isCustom})">Excluir</button>
                    <button class="confirm-no" onclick="this.closest('.kanban-delete-confirm').remove()">Cancelar</button>
                </div>
            `;

            card.appendChild(confirmDiv);
        }

        // Confirmar exclusÃ£o do Kanban
        function confirmKanbanDelete(nome, isCustom) {
            if (isCustom) {
                // Deletar item customizado
                const customData = GestaoFinanceira.customItems[currentMonth];
                if (customData && customData.receitas) {
                    const index = customData.receitas.findIndex(i => i.nome === nome);
                    if (index !== -1) {
                        customData.receitas.splice(index, 1);
                        GestaoFinanceira.saveToStorage();
                        showToast('Item excluÃ­do com sucesso!', 'success');
                    }
                }
            } else {
                // Marcar item como deletado
                if (!GestaoFinanceira.deletedItems[currentMonth]) {
                    GestaoFinanceira.deletedItems[currentMonth] = { despesas: [], receitas: [] };
                }
                GestaoFinanceira.deletedItems[currentMonth].receitas.push(nome);
                GestaoFinanceira.saveToStorage();
                showToast('Item removido da lista!', 'success');
            }

            loadMonthData(currentMonth);
        }

        // Toggle status via Kanban
        function toggleKanbanStatus(nome, receber) {
            const newStatus = receber ? 'Recebido' : 'A Receber';
            const date = receber ? new Date().toISOString().split('T')[0] : null;

            GestaoFinanceira.updateStatus(currentMonth, 'receita', nome, newStatus, date);
            showToast(receber ? 'Receita marcada como recebida!' : 'Receita marcada como pendente', receber ? 'success' : 'warning');
            loadMonthData(currentMonth);
        }

        // Drag and Drop Kanban
        function handleKanbanCardDragStart(e) {
            kanbanDraggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.nome);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleKanbanCardDragEnd(e) {
            this.classList.remove('dragging');
            kanbanDraggedCard = null;
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleKanbanDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleKanbanDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleKanbanDrop(e, targetStatus) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const nome = e.dataTransfer.getData('text/plain');
            if (!nome) return;

            // Buscar item no mapa
            const item = kanbanItemsMap[nome];
            if (!item) return;

            // Determinar novo status baseado na coluna de destino
            let newStatus, newDate;

            if (targetStatus === 'recebido') {
                newStatus = 'Recebido';
                newDate = new Date().toISOString().split('T')[0];
                showToast(`"${nome}" marcado como recebido!`, 'success');
            } else if (targetStatus === 'pendente') {
                newStatus = 'A Receber';
                newDate = null;
                showToast(`"${nome}" movido para pendentes`, 'warning');
            }

            // Atualizar status diretamente
            GestaoFinanceira.updateStatus(currentMonth, 'receita', nome, newStatus, newDate);

            // Recarregar dados
            loadMonthData(currentMonth);
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', function() {
            GestaoFinanceira.init();

            // SEMPRE usar o mÃªs atual ao carregar a pÃ¡gina
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) {
                monthSelect.value = currentMonth; // ForÃ§a para o mÃªs atual
            }

            console.log('ðŸ“… Carregando Contas a Receber para o mÃªs:', currentMonth);
            loadMonthData(currentMonth);

            // Restaurar view salva
            const savedView = localStorage.getItem('contas_receber_view');
            if (savedView) {
                setView(savedView);
            }

            // ðŸ”„ ATIVAR SINCRONIZAÃ‡ÃƒO EM TEMPO REAL
            if (typeof GestaoFinanceira.startPolling === 'function') {
                GestaoFinanceira.startPolling(currentMonth);
                console.log('âœ… SincronizaÃ§Ã£o em tempo real ativada!');
            }
        });

        // Atualizar dados quando sync completar (background)
        window.addEventListener('gestao-sync-complete', function() {
            console.log('ðŸ”„ Sync completo, atualizando dados...');
            loadMonthData(currentMonth);
        });

        // Atualizar dados quando Railway sync completar
        window.addEventListener('gestao-railway-sync', function(event) {
            console.log('ðŸ”„ Railway sync completo:', event.detail);
            loadMonthData(currentMonth);

            // Mostrar notificaÃ§Ã£o discreta
            const indicator = document.getElementById('sync-indicator');
            if (indicator) {
                indicator.innerHTML = 'âœ… Sincronizado';
                indicator.style.background = '#27ae60';
                setTimeout(() => {
                    indicator.remove();
                }, 2000);
            }
        });

        // Fechar modal ao clicar fora
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal('importModal');
            }
        });

        document.getElementById('diffExpenseModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDiffExpenseModal();
            }
        });

        // ========================================
        // IMPORTAÃ‡ÃƒO DE EXTRATO BANCÃRIO
        // ========================================
        let importedTransactions = [];
        let importBankHint = null;
        let importFileName = null;
        let pendingIndexByName = new Map();
        let pendingByMonth = new Map();
        let clientesByMonth = new Map();
        const RECEBER_IMPORT_HISTORY_KEY = 'starken_receber_import_history';
        const RECEBER_IMPORTED_KEYS_KEY = 'starken_receber_imported_keys';
        const RECEBER_IMPORT_META_KEY = 'starken_receber_import_meta';
        const SMART_IMPORT_ENDPOINT = '/api/upload-processor';

        function normalizeText(text) {
            return (text || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function escapeAttr(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function toAttrJsString(value) {
            const escaped = String(value ?? '')
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/\r?\n/g, ' ');
            return escapeAttr(`'${escaped}'`);
        }

        function parseBrazilianDate(value) {
            const cleaned = String(value || '').trim();
            const match = cleaned.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
            if (!match) return null;
            const [, d, m, y] = match;
            return `${y}-${m}-${d}`;
        }

        function loadImportHistory() {
            try {
                return JSON.parse(localStorage.getItem(RECEBER_IMPORT_HISTORY_KEY) || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveImportHistory(history) {
            localStorage.setItem(RECEBER_IMPORT_HISTORY_KEY, JSON.stringify(history.slice(-20)));
        }

        function loadImportMeta() {
            try {
                const saved = JSON.parse(localStorage.getItem(RECEBER_IMPORT_META_KEY) || '{}');
                return saved && typeof saved === 'object' ? saved : {};
            } catch (e) {
                localStorage.removeItem(RECEBER_IMPORT_META_KEY);
                return {};
            }
        }

        function saveImportMeta(meta) {
            localStorage.setItem(RECEBER_IMPORT_META_KEY, JSON.stringify(meta));
        }

        function setImportMetaForMonthBank(month, bank, updates) {
            const meta = loadImportMeta();
            const current = meta[month] || {};
            const banks = current.banks || {};
            const bankKey = bank || 'asaas';
            const bankCurrent = banks[bankKey] || {};
            banks[bankKey] = { ...bankCurrent, ...updates };
            meta[month] = { ...current, banks };
            saveImportMeta(meta);
            return banks[bankKey];
        }

        function getImportMetaForMonth(month) {
            const meta = loadImportMeta();
            return meta[month] || {};
        }

        function loadImportedKeys() {
            try {
                return JSON.parse(localStorage.getItem(RECEBER_IMPORTED_KEYS_KEY) || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveImportedKeys(keys) {
            localStorage.setItem(RECEBER_IMPORTED_KEYS_KEY, JSON.stringify(keys.slice(-2000)));
        }

        function loadImportedKeySet() {
            return new Set(loadImportedKeys());
        }

        function resetStatusEntry(mes, nome, previousStatus) {
            const id = GestaoFinanceira.generateId(mes, 'receita', nome);
            if (previousStatus) {
                GestaoFinanceira.statusData[id] = previousStatus;
            } else {
                delete GestaoFinanceira.statusData[id];
            }
        }

        function resetLastImports(count = 2) {
            const history = loadImportHistory();
            const monthHistory = history.filter(h => h.month === currentMonth);
            if (monthHistory.length >= count) {
                const runs = monthHistory.slice(-count);
                runs.forEach(run => {
                    const items = GestaoFinanceira.customItems[currentMonth]?.receitas || [];
                    GestaoFinanceira.customItems[currentMonth].receitas = items.filter(item => item.importBatchId !== run.id);
                    run.matchedItems.forEach(match => {
                        const targetMonth = match.month || currentMonth;
                        resetStatusEntry(targetMonth, match.nome, match.previousStatus);
                    });
                });
                const importedKeySet = loadImportedKeySet();
                runs.forEach(run => {
                    (run.importedKeys || []).forEach(key => importedKeySet.delete(key));
                });
                saveImportedKeys(Array.from(importedKeySet));
                saveImportHistory(history.filter(h => !runs.includes(h)));
                GestaoFinanceira.saveToStorage();
                if (GestaoFinanceira.syncToServer) {
                    GestaoFinanceira.syncToServer();
                }
                loadMonthData(currentMonth);
                showToast('Ãšltimas importaÃ§Ãµes desfeitas.', 'success');
                return;
            }

            const items = GestaoFinanceira.customItems[currentMonth]?.receitas || [];
            const importedItems = items.filter(item => item.observacao === 'Importado via OFX/CSV');
            const removeCount = Math.min(importedItems.length, count * 5);
            let removed = 0;
            for (let i = items.length - 1; i >= 0 && removed < removeCount; i--) {
                if (items[i].observacao === 'Importado via OFX/CSV') {
                    items.splice(i, 1);
                    removed++;
                }
            }
            GestaoFinanceira.customItems[currentMonth].receitas = items;

            const statusEntries = Object.entries(GestaoFinanceira.statusData)
                .filter(([key, value]) => key.startsWith(`${currentMonth}_receita_`) && value?.status === 'Recebido')
                .sort((a, b) => new Date(b[1].updatedAt || 0) - new Date(a[1].updatedAt || 0));
            statusEntries.slice(0, count * 5).forEach(([key]) => {
                delete GestaoFinanceira.statusData[key];
            });

            GestaoFinanceira.saveToStorage();
            if (GestaoFinanceira.syncToServer) {
                GestaoFinanceira.syncToServer();
            }
            loadMonthData(currentMonth);
            showToast('ImportaÃ§Ãµes recentes desfeitas.', 'success');
        }

        function applyActionToAll(action) {
            importedTransactions.forEach((t, index) => {
                if (t.locked) return;
                t.action = action;
                updateRowAction(index);
            });
        }

        function applyActionToMatched(action) {
            importedTransactions.forEach((t, index) => {
                if (!t.matchName || t.locked) return;
                t.action = action;
                updateRowAction(index);
            });
        }

        function applyActionToNew(action) {
            importedTransactions.forEach((t, index) => {
                if (t.matchName || t.locked) return;
                t.action = action;
                updateRowAction(index);
            });
        }

        function applyReconDate() {
            const input = document.getElementById('bulkReconDate');
            if (!input) return;
            const iso = parseBrazilianDate(input.value);
            if (!iso) {
                showToast('Data invÃ¡lida. Use dd/mm/aaaa.', 'error');
                return;
            }
            importedTransactions.forEach((t, index) => {
                t.date = iso;
                const row = document.querySelector(`.reconciliation-item[data-index="${index}"]`);
                if (row) {
                    const dateInput = row.querySelector('.rec-date-br');
                    if (dateInput) {
                        dateInput.value = formatDate(iso);
                    }
                }
            });
        }

        function updateRowAction(index) {
            const row = document.querySelector(`.reconciliation-item[data-index="${index}"]`);
            if (!row) return;
            const actionSelect = row.querySelector('.import-action');
            const matchSelect = row.querySelector('.import-match');
            const bankSelect = row.querySelector('.import-bank');
            const locked = importedTransactions[index]?.locked;
            if (actionSelect) {
                actionSelect.value = importedTransactions[index].action || 'new';
                if (locked) {
                    actionSelect.disabled = true;
                }
            }
            if (matchSelect) {
                matchSelect.disabled = locked;
            }
            if (bankSelect && locked) {
                bankSelect.disabled = true;
            }
            toggleSplitPanel(index);
            updateMatchInfo(index, getPendentesForIndex(index), importedTransactions[index]?.matchMonth || currentMonth);
        }

        function toggleSplitPanel(index) {
            const row = document.querySelector(`.reconciliation-item[data-index="${index}"]`);
            if (!row) return;
            const panel = row.querySelector('.rec-split');
            if (!panel) return;
            const action = importedTransactions[index]?.action || 'new';
            panel.style.display = action === 'split' ? 'flex' : 'none';
            if (action === 'split') {
                updateSplitSummary(index);
            }
        }

        function renderSplitOptions(pendentes, trans, index) {
            const selected = new Set(trans.splitClients || []);
            return pendentes.map(p => {
                const checked = selected.has(p.nome) ? 'checked' : '';
                return `
                    <label class="rec-split-item">
                        <div>
                            <input type="checkbox" class="split-client" data-index="${index}" data-name="${escapeAttr(p.nome)}" ${checked}>
                            <span class="rec-split-name">${escapeAttr(p.nome)}</span>
                        </div>
                        <span class="rec-split-value">${formatMoney(p.valor || 0)}</span>
                    </label>
                `;
            }).join('');
        }

        function getSplitDifference(index) {
            const trans = importedTransactions[index];
            if (!trans) return { total: 0, amount: 0, diff: 0 };
            const selected = trans.splitClients || [];
            const total = selected.reduce((sum, name) => {
                const item = pendingIndexByName.get(name);
                return sum + (item?.valor || 0);
            }, 0);
            const amount = Math.abs(parseFloat(trans.amount) || 0);
            const diffRaw = total - amount;
            const diffLancado = trans.diffLancado || 0;
            const diff = diffRaw - diffLancado;
            return { total, amount, diff, diffRaw, diffLancado };
        }

        function updateSplitSummary(index) {
            const row = document.querySelector(`.reconciliation-item[data-index="${index}"]`);
            if (!row) return;
            const summary = row.querySelector('.rec-split-summary');
            if (!summary) return;
            const trans = importedTransactions[index];
            const selected = trans.splitClients || [];
            const { total, diff, diffRaw, diffLancado } = getSplitDifference(index);
            let diffLabel = 'warn';
            if (Math.abs(diff) < 0.01) {
                diffLabel = 'ok';
            }
            const shouldShowAction = Math.abs(diff) >= 0.01;
            summary.innerHTML = `
                <span>${selected.length} clientes</span>
                <span>Total: ${formatMoney(total)}</span>
                <span class="${diffLabel}">DiferenÃ§a: ${formatMoney(diff)}</span>
                ${Math.abs(diffLancado) > 0.01 ? `<span>LanÃ§ado: ${formatMoney(Math.abs(diffRaw - diff))}</span>` : ''}
                ${shouldShowAction ? `<button class="rec-diff-action" onclick="openDiffExpenseModal(${index})">LanÃ§ar despesa</button>` : ''}
            `;
        }

        function toggleDiffExpensePaymentDate() {
            const status = document.getElementById('diffExpenseStatus').value;
            const group = document.getElementById('diffExpensePaymentGroup');
            group.style.display = status === 'Pago' ? 'block' : 'none';
        }

        function openDiffExpenseModal(index) {
            const trans = importedTransactions[index];
            if (!trans) return;
            const { diff } = getSplitDifference(index);
            if (Math.abs(diff) < 0.01) return;
            const memo = trans.memo || trans.name || 'Recebimento';
            const normalized = memo.toLowerCase();
            const isAlpha = normalized.includes('alpha');
            const monthRef = trans.date ? trans.date.substring(0, 7) : currentMonth;
            const desc = `DiferenÃ§a de recebimento - ${memo}`;
            const note = `DiferenÃ§a de conciliaÃ§Ã£o: ${formatMoney(diff)} â€¢ ${trans.banco || 'Banco nÃ£o informado'}`;
            const paymentDate = trans.date || new Date().toISOString().split('T')[0];

            document.getElementById('diffExpenseIndex').value = index;
            document.getElementById('diffExpenseMonth').value = formatMonthBr(monthRef);
            document.getElementById('diffExpenseName').value = desc;
            document.getElementById('diffExpenseValue').value = formatMoney(Math.abs(diff));
            document.getElementById('diffExpenseCategory').value = isAlpha ? 'alpha_franquia' : 'outros';
            document.getElementById('diffExpenseCompany').value = isAlpha ? 'alpha' : 'starken';
            document.getElementById('diffExpenseStatus').value = 'Pago';
            document.getElementById('diffExpensePaymentDate').value = paymentDate;
            document.getElementById('diffExpenseNote').value = note;
            toggleDiffExpensePaymentDate();

            document.getElementById('diffExpenseModal').classList.add('show');
        }

        function closeDiffExpenseModal() {
            const modal = document.getElementById('diffExpenseModal');
            modal.classList.remove('show');
            modal.querySelectorAll('input:not([type="hidden"])').forEach(input => input.value = '');
            modal.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            toggleDiffExpensePaymentDate();
        }

        function saveDiffExpense() {
            const mes = parseMonthBr(document.getElementById('diffExpenseMonth').value) || currentMonth;
            const nome = document.getElementById('diffExpenseName').value.trim();
            const valor = parseMoney(document.getElementById('diffExpenseValue').value);
            const categoria = document.getElementById('diffExpenseCategory').value;
            const empresa = document.getElementById('diffExpenseCompany').value;
            const observacao = document.getElementById('diffExpenseNote').value.trim();
            const status = document.getElementById('diffExpenseStatus').value;
            const paymentDate = document.getElementById('diffExpensePaymentDate').value;
            const index = parseInt(document.getElementById('diffExpenseIndex').value, 10);

            if (!nome) {
                showToast('Informe a descriÃ§Ã£o da despesa', 'error');
                return;
            }
            if (valor <= 0) {
                showToast('Informe um valor vÃ¡lido', 'error');
                return;
            }
            const trans = importedTransactions[index];
            if (trans) {
                const { diffRaw, diffLancado } = getSplitDifference(index);
                const remaining = Math.abs(diffRaw - diffLancado);
                if (valor - remaining > 0.01) {
                    showToast('Valor maior que a diferenÃ§a restante', 'error');
                    return;
                }
            }

            GestaoFinanceira.addDespesa(mes, {
                nome,
                valor,
                categoria,
                empresa,
                status,
                observacao
            });

            if (status === 'Pago') {
                const date = paymentDate || new Date().toISOString().split('T')[0];
                GestaoFinanceira.updateStatus(mes, 'despesa', nome, 'Pago', date);
            }

            if (trans) {
                const { diffRaw } = getSplitDifference(index);
                const sign = diffRaw === 0 ? 1 : Math.sign(diffRaw);
                trans.diffLancado = (trans.diffLancado || 0) + (valor * sign);
                updateSplitSummary(index);
                const importedKeySet = loadImportedKeySet();
                const transKey = createTransactionKey(trans.memo || trans.name || '', trans.amount, trans.date);
                if (!importedKeySet.has(transKey)) {
                    importedKeySet.add(transKey);
                    saveImportedKeys(Array.from(importedKeySet));
                }
            }

            showToast('Despesa adicionada em Contas a Pagar', 'success');
            closeDiffExpenseModal();
        }

        function updateImportSummary(transactions) {
            const dates = transactions
                .map(({ trans }) => trans.date)
                .filter(Boolean)
                .map(date => new Date(`${date}T00:00:00`))
                .filter(date => !isNaN(date));
            const minDate = dates.length ? new Date(Math.min(...dates)) : null;
            const maxDate = dates.length ? new Date(Math.max(...dates)) : null;
            const total = transactions.reduce((sum, { trans }) => sum + (parseFloat(trans.amount) || 0), 0);
            const banks = Array.from(new Set(transactions.map(({ trans }) => trans.banco).filter(Boolean)));
            const bankLabel = banks.length
                ? banks.map(b => bancoLabels[b] || b).join(', ')
                : (importBankHint ? (bancoLabels[importBankHint] || importBankHint) : '-');

            const rangeEl = document.getElementById('importRange');
            const bankEl = document.getElementById('importBankLabel');
            const fileEl = document.getElementById('importFileName');
            const totalEl = document.getElementById('importTotalIn');
            const countEl = document.getElementById('importCount');

            if (rangeEl) {
                rangeEl.textContent = minDate && maxDate ? `${minDate.toLocaleDateString('pt-BR')} - ${maxDate.toLocaleDateString('pt-BR')}` : '-';
            }
            if (bankEl) {
                bankEl.textContent = bankLabel;
            }
            if (fileEl) {
                fileEl.textContent = importFileName || '-';
            }
            if (totalEl) {
                totalEl.textContent = formatMoney(total);
            }
            if (countEl) {
                countEl.textContent = String(transactions.length);
            }
        }

        function parseAmount(raw) {
            if (!raw) return NaN;
            let cleaned = String(raw).replace(/[^\d,.-]/g, '');
            if (cleaned.includes(',') && cleaned.includes('.')) {
                if (cleaned.lastIndexOf(',') > cleaned.lastIndexOf('.')) {
                    cleaned = cleaned.replace(/\./g, '').replace(',', '.');
                } else {
                    cleaned = cleaned.replace(/,/g, '');
                }
            } else {
                cleaned = cleaned.replace(',', '.');
            }
            return parseFloat(cleaned);
        }

        function extractNumbers(text) {
            const matches = String(text || '').match(/\d{5,}/g);
            return matches ? matches : [];
        }

        function getTokens(text) {
            const stopwords = new Set(['cobranca', 'cobranÃ§a', 'recebida', 'recebido', 'fatura', 'fat', 'nr', 'n', 'nota', 'pix', 'transferencia', 'transferÃªncia', 'boleto', 'cliente', 'pagamento', 'pagto']);
            return normalizeText(text)
                .replace(/[^a-z0-9]+/g, ' ')
                .split(' ')
                .map(t => t.trim())
                .filter(t => t.length > 2 && !stopwords.has(t));
        }

        function getNameScore(memoTokens, nameTokens) {
            if (!memoTokens.length || !nameTokens.length) return 0;
            const memoSet = new Set(memoTokens);
            let matches = 0;
            nameTokens.forEach(t => {
                if (memoSet.has(t)) matches++;
            });
            if (matches >= 3) return 3;
            if (matches === 2) return 2;
            if (matches === 1) return 1;
            return 0;
        }

        function isAmountMatch(target, amount) {
            const tolerance = Math.max(0.05, target * 0.01);
            return Math.abs(target - amount) <= tolerance;
        }

        function getBestMatch(trans, pendentes) {
            const amount = parseFloat(trans.amount);
            const memoRaw = trans.memo || trans.name || '';
            const memo = normalizeText(memoRaw);
            const memoTokens = getTokens(memoRaw);
            const memoNumbers = extractNumbers(memoRaw);
            const amountMatches = pendentes.filter(p => isAmountMatch(p.valorLiquido || p.valor || 0, amount));

            let best = null;
            let bestScore = 0;

            pendentes.forEach(p => {
                const target = p.valorLiquido || p.valor || 0;
                const nameTokens = getTokens(p.nome || '');
                const nameNorm = normalizeText(p.nome || '');
                const pNumbers = extractNumbers(p.nome || '');
                let score = 0;

                if (isAmountMatch(target, amount)) score += 4;
                if (nameNorm && memo.includes(nameNorm)) score += 3;
                score += getNameScore(memoTokens, nameTokens);
                if (memoNumbers.length && pNumbers.length && memoNumbers.some(n => pNumbers.includes(n))) score += 3;
                score += getDateScore(trans.date, p);

                if (score > bestScore) {
                    bestScore = score;
                    best = p;
                }
            });

            if (bestScore >= 5) return { match: best, score: bestScore };
            if (bestScore >= 4 && amountMatches.length >= 1) return { match: best, score: bestScore };
            if (amountMatches.length === 1) return { match: amountMatches[0], score: 4 };
            return { match: null, score: bestScore };
        }

        function getDateScore(transDate, cliente) {
            if (!transDate) return 0;
            const candidate = cliente.dataPagamento || cliente.dataVencimento || '';
            if (!candidate) return 0;
            const t = new Date(transDate);
            const c = new Date(candidate);
            if (isNaN(t.getTime()) || isNaN(c.getTime())) return 0;
            const diff = Math.abs(t - c) / (1000 * 60 * 60 * 24);
            if (diff === 0) return 3;
            if (diff <= 3) return 2;
            if (t.getFullYear() === c.getFullYear() && t.getMonth() === c.getMonth()) return 1;
            return 0;
        }

        function getConfidenceLevel(score) {
            if (score >= 8) return { label: 'Alta', className: 'conf-high' };
            if (score >= 6) return { label: 'MÃ©dia', className: 'conf-medium' };
            if (score >= 4) return { label: 'Baixa', className: 'conf-low' };
            return { label: 'Baixa', className: 'conf-low' };
        }

        function getPaymentDeltaLabel(dueDate, paidDate) {
            if (!dueDate || !paidDate) return null;
            const due = new Date(`${dueDate}T00:00:00`);
            const paid = new Date(`${paidDate}T00:00:00`);
            if (isNaN(due.getTime()) || isNaN(paid.getTime())) return null;
            const diffDays = Math.round((paid - due) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return { text: 'na data', className: 'good' };
            if (diffDays < 0) return { text: `${Math.abs(diffDays)} dias antes`, className: 'good' };
            return { text: `${diffDays} dias depois`, className: 'warn' };
        }

        function getClienteInfoByName(name, pendentes, mes) {
            if (!name) return null;
            const pendentesList = pendentes || [];
            const clientesMes = mes ? (clientesByMonth.get(mes) || []) : [];
            return pendentesList.find(p => p.nome === name) || clientesMes.find(c => c.nome === name) || currentClientes.find(c => c.nome === name);
        }

        function renderMatchInfoHTML(trans, pendentes, mes) {
            if (!trans || !trans.matchName || trans.action !== 'match') {
                return '';
            }
            const cliente = getClienteInfoByName(trans.matchName, pendentes, mes);
            if (!cliente) {
                return '';
            }
            const valor = cliente.valorLiquido || cliente.valor || 0;
            const vencimento = cliente.dataVencimento;
            const status = cliente.status || 'A Receber';
            const dataPagamento = cliente.dataPagamento;
            const pagamentoExtrato = trans.date;
            const delta = getPaymentDeltaLabel(vencimento, pagamentoExtrato);
            const deltaHtml = delta ? `<span class="rec-match-pill ${delta.className}">${delta.text}</span>` : '';
            const partial = trans.partialReceive;
            const partialInfo = partial && partial.type === 'partial' ? (() => {
                const parcialValor = partial.value || 0;
                const totalValor = partial.total || valor || 0;
                const remainingValor = Math.max(0, totalValor - parcialValor);
                const dataParcial = partial.date || pagamentoExtrato;
                const dataRestante = partial.nextDate;
                return `
                    <div class="rec-match-row">
                        <span class="rec-match-label">Recebimento parcial</span>
                        <span class="rec-match-value">${formatMoney(parcialValor)}</span>
                        <span class="rec-match-label">Data</span>
                        <span class="rec-match-value">${formatDate(dataParcial)}</span>
                    </div>
                    <div class="rec-match-row">
                        <span class="rec-match-label">DiferenÃ§a</span>
                        <span class="rec-match-value">${formatMoney(remainingValor)}</span>
                        <span class="rec-match-label">LanÃ§amento novo</span>
                        <span class="rec-match-value">Restante ${dataRestante ? `â€¢ ${formatDate(dataRestante)}` : ''}</span>
                    </div>
                `;
            })() : '';

            return `
                <div class="rec-match-row">
                    <span class="rec-match-label">Cliente</span>
                    <span class="rec-match-value">${escapeAttr(cliente.nome || trans.matchName)}</span>
                    <span class="rec-match-pill">${status}</span>
                </div>
                <div class="rec-match-row">
                    <span class="rec-match-label">Valor original</span>
                    <span class="rec-match-value">${formatMoney(valor)}</span>
                    <span class="rec-match-label">Vencimento</span>
                    <span class="rec-match-value">${formatDate(vencimento)}</span>
                </div>
                <div class="rec-match-row">
                    <span class="rec-match-label">Pagamento no extrato</span>
                    <span class="rec-match-value">${formatDate(pagamentoExtrato)}</span>
                    ${deltaHtml}
                </div>
                <div class="rec-match-row">
                    <span class="rec-match-label">Pagamento registrado</span>
                    <span class="rec-match-value">${dataPagamento ? formatDate(dataPagamento) : '-'}</span>
                </div>
                ${partialInfo}
            `;
        }

        function updateMatchInfo(index, pendentes, mes) {
            const row = document.querySelector(`.reconciliation-item[data-index="${index}"]`);
            if (!row) return;
            const panel = row.querySelector('.rec-match-info');
            if (!panel) return;
            const trans = importedTransactions[index];
            const html = renderMatchInfoHTML(trans, pendentes, mes);
            if (html) {
                panel.innerHTML = html;
                panel.classList.add('show');
            } else {
                panel.innerHTML = '';
                panel.classList.remove('show');
            }
        }

        let importPartialIndex = null;

        function openImportPartialModal(index) {
            const trans = importedTransactions[index];
            if (!trans || !trans.matchName) return;
            const pendentes = getPendentesForIndex(index);
            const cliente = getClienteInfoByName(trans.matchName, pendentes, trans.matchMonth || currentMonth);
            if (!cliente) return;

            const totalValor = cliente.valorLiquido || cliente.valor || 0;
            const extratoValor = Math.abs(parseFloat(trans.amount) || 0);
            const partial = trans.partialReceive || {};
            const tipo = partial.type || 'full';
            const valorParcial = partial.value !== undefined && partial.value !== null ? partial.value : extratoValor;
            const dataParcial = partial.date || trans.receiveDate || trans.date || new Date().toISOString().split('T')[0];
            const dataRestante = partial.nextDate || cliente.dataVencimento || '';

            importPartialIndex = index;
            document.getElementById('importPartialClientName').textContent = cliente.nome || trans.matchName;
            document.getElementById('importPartialTotal').textContent = formatMoney(totalValor);
            document.getElementById('importPartialExtrato').textContent = formatMoney(extratoValor);
            document.getElementById('importPartialTotalValue').value = String(totalValor);
            document.getElementById('importPartialDate').value = dataParcial ? formatDate(dataParcial) : '';
            document.getElementById('importPartialNextDate').value = dataRestante ? formatDate(dataRestante) : '';

            document.querySelector('input[name="importReceiveType"][value="full"]').checked = tipo === 'full';
            document.querySelector('input[name="importReceiveType"][value="partial"]').checked = tipo === 'partial';
            document.getElementById('importPartialValue').value = valorParcial ? formatMoney(valorParcial) : '';

            toggleImportPartialFields();
            updateImportPartialRemaining();
            document.getElementById('importPartialModal').classList.add('show');
        }

        function closeImportPartialModal() {
            document.getElementById('importPartialModal').classList.remove('show');
            importPartialIndex = null;
        }

        function toggleImportPartialFields() {
            const isPartial = document.querySelector('input[name="importReceiveType"]:checked')?.value === 'partial';
            const group = document.getElementById('importPartialGroup');
            const nextDateGroup = document.getElementById('importPartialNextDateGroup');
            group.style.display = isPartial ? 'block' : 'none';
            nextDateGroup.style.display = isPartial ? 'block' : 'none';
            if (isPartial && !document.getElementById('importPartialValue').value) {
                const trans = importedTransactions[importPartialIndex];
                const extratoValor = trans ? Math.abs(parseFloat(trans.amount) || 0) : 0;
                document.getElementById('importPartialValue').value = extratoValor ? formatMoney(extratoValor) : '';
            }
            if (!isPartial) {
                document.getElementById('importPartialNextDate').value = '';
            }
            updateImportPartialRemaining();
        }

        function updateImportPartialRemaining() {
            const total = parseFloat(document.getElementById('importPartialTotalValue').value || 0);
            const parcial = parseMoney(document.getElementById('importPartialValue').value);
            const remaining = Math.max(0, total - parcial);
            document.getElementById('importPartialRemaining').textContent = formatMoney(remaining);
        }

        function normalizeDateInput(value) {
            const cleaned = String(value || '').trim();
            if (!cleaned) return '';
            const iso = parseBrazilianDate(cleaned);
            if (iso) return iso;
            if (/^\d{4}-\d{2}-\d{2}$/.test(cleaned)) return cleaned;
            return null;
        }

        function saveImportPartial() {
            if (importPartialIndex === null) return;
            const trans = importedTransactions[importPartialIndex];
            if (!trans) return;

            const tipo = document.querySelector('input[name="importReceiveType"]:checked')?.value || 'full';
            const total = parseFloat(document.getElementById('importPartialTotalValue').value || 0);
            const parcial = parseMoney(document.getElementById('importPartialValue').value);
            const dataParcialRaw = document.getElementById('importPartialDate').value;
            const dataRestanteRaw = document.getElementById('importPartialNextDate').value;
            const parsedParcial = normalizeDateInput(dataParcialRaw);
            const parsedRestante = normalizeDateInput(dataRestanteRaw);
            const dataParcial = parsedParcial || trans.date || new Date().toISOString().split('T')[0];
            const dataRestante = parsedRestante || '';

            if (dataParcialRaw && !parsedParcial) {
                showToast('Informe a data do recebimento no formato dd/mm/aaaa', 'error');
                return;
            }
            if (dataRestanteRaw && !parsedRestante) {
                showToast('Informe a data do prÃ³ximo recebimento no formato dd/mm/aaaa', 'error');
                return;
            }

            if (tipo === 'partial') {
                if (parcial <= 0) {
                    showToast('Informe o valor do recebimento parcial', 'error');
                    return;
                }
                if (parcial >= total) {
                    showToast('Para recebimento total, selecione a opÃ§Ã£o "Recebimento total"', 'error');
                    return;
                }
                trans.partialReceive = { type: 'partial', value: parcial, total, date: dataParcial, nextDate: dataRestante };
                showToast('Recebimento parcial configurado', 'success');
            } else {
                trans.partialReceive = null;
                trans.receiveDate = dataParcial;
                showToast('Recebimento total configurado', 'success');
            }

            closeImportPartialModal();
        }

        function createTransactionKey(text, amount, date) {
            const normalized = normalizeText(text || '').replace(/[^a-z0-9]+/g, ' ').trim();
            const amt = parseFloat(amount || 0).toFixed(2);
            const d = (date || '').substring(0, 10);
            return `${normalized}|${amt}|${d}`;
        }

        function buildExistingReceiptIndex() {
            const keys = new Set();
            const custom = GestaoFinanceira.customItems?.[currentMonth]?.receitas || [];
            custom
                .filter(c => c.importBatchId || c.observacao === 'Importado via OFX/CSV')
                .forEach(c => {
                    keys.add(createTransactionKey(c.nome, c.valor, c.dataPagamento || ''));
                });
            const importedKeys = loadImportedKeys();
            importedKeys.forEach(key => keys.add(key));
            return keys;
        }

        function detectBankHintFromName(name) {
            const normalizedName = normalizeText(name || '');
            const isContaSimples =
                normalizedName.includes('conta simples') ||
                normalizedName.includes('conta-simples') ||
                normalizedName.includes('conta_simples') ||
                normalizedName.includes('contasimples') ||
                normalizedName.includes('cs bank') ||
                normalizedName.includes('csbank');
            if (isContaSimples) {
                return 'conta_simples';
            }
            const isAsaas =
                normalizedName.includes('asaas') ||
                normalizedName.includes('extrato asaas') ||
                normalizedName.includes('extratoasaas');
            if (isAsaas) {
                return 'asaas';
            }
            return null;
        }

        async function uploadAndParseBankFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch(SMART_IMPORT_ENDPOINT, { method: 'POST', body: formData });
            const data = await response.json();
            if (!response.ok || !data || data.success === false) {
                throw new Error(data?.error || 'Erro ao processar arquivo');
            }
            return data;
        }

        function normalizeImportedItems(items) {
            return (items || [])
                .map(item => {
                    const amount = item.valor ?? item.amount ?? item.value ?? 0;
                    const tipo = (item.tipo || item.type || '').toLowerCase();
                    const memo = item.descricao || item.memo || item.name || item.historico || item.nome || '';
                    let date = item.data || item.date || '';
                    if (typeof date === 'string' && date.includes('/')) {
                        const parsed = parseBrazilianDate(date);
                        if (parsed) date = parsed;
                    } else if (typeof date === 'string' && /^\d{8}$/.test(date)) {
                        date = `${date.substring(0, 4)}-${date.substring(4, 6)}-${date.substring(6, 8)}`;
                    }
                    return { amount, memo, date, tipo };
                })
                .filter(item => parseFloat(item.amount) > 0 && item.tipo !== 'despesa');
        }

        function parseLocalFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const ext = file.name.split('.').pop().toLowerCase();
                    importBankHint = importBankHint || detectBankHintFromContent(file.name, content);

                    if (ext === 'ofx') {
                        parseOFX(content);
                        resolve();
                        return;
                    }
                    if (ext === 'csv') {
                        parseCSV(content);
                        resolve();
                        return;
                    }
                    reject(new Error('Formato nÃ£o suportado'));
                };
                reader.readAsText(file);
            });
        }

        function detectBankHintFromContent(name, content) {
            const normalizedName = normalizeText(name || '');
            const sample = content ? content.slice(0, 20000) : '';
            const normalizedSample = normalizeText(sample);
            const isContaSimples =
                normalizedName.includes('conta simples') ||
                normalizedName.includes('conta-simples') ||
                normalizedName.includes('conta_simples') ||
                normalizedName.includes('contasimples') ||
                normalizedName.includes('cs bank') ||
                normalizedName.includes('csbank') ||
                normalizedSample.includes('conta simples') ||
                normalizedSample.includes('conta-simples') ||
                normalizedSample.includes('conta_simples') ||
                normalizedSample.includes('contasimples') ||
                normalizedSample.includes('cs bank') ||
                normalizedSample.includes('csbank') ||
                /<org>.*conta\s*simples/i.test(sample) ||
                /<bankname>.*conta\s*simples/i.test(sample);
            if (isContaSimples) {
                return 'conta_simples';
            }
            const isAsaas =
                normalizedName.includes('asaas') ||
                normalizedName.includes('extrato asaas') ||
                normalizedName.includes('extratoasaas') ||
                normalizedSample.includes('asaas') ||
                /<org>.*asaas/i.test(sample) ||
                /<bankname>.*asaas/i.test(sample);
            if (isAsaas) {
                return 'asaas';
            }
            return null;
        }

        function openImportModal() {
            const modal = document.getElementById('importModal');
            if(modal) {
                modal.classList.add('show');
                document.getElementById('importStep1').style.display = 'block';
                document.getElementById('importStep2').style.display = 'none';
                document.getElementById('btnProcessImport').style.display = 'none';
                document.getElementById('bankFile').value = '';
                importedTransactions = [];
                importBankHint = null;
                importFileName = null;
            }
        }

        async function handleBankFile(input) {
            const file = input.files[0];
            if (!file) return;

            const ext = file.name.split('.').pop().toLowerCase();
            importBankHint = detectBankHintFromName(file.name);
            importFileName = file.name;
            importedTransactions = [];

            let smartProcessed = false;
            if (['ofx', 'csv', 'pdf', 'xls', 'xlsx'].includes(ext)) {
                try {
                    const result = await uploadAndParseBankFile(file);
                    const normalized = normalizeImportedItems(result.items || []);
                    if (normalized.length > 0) {
                        importedTransactions = normalized;
                        smartProcessed = true;
                    }
                } catch (e) {
                    smartProcessed = false;
                }
            }

            if (!smartProcessed) {
                try {
                    await parseLocalFile(file);
                } catch (e) {
                    alert('Formato nÃ£o suportado. Use OFX, CSV ou PDF.');
                    return;
                }
            }

            showReconciliation();
        }

        function parseOFX(content) {
            const transactions = [];
            const lines = content.split('\n');
            let currentTrans = {};
            let inTrans = false;

            for (const line of lines) {
                if (line.includes('<STMTTRN>')) {
                    inTrans = true;
                    currentTrans = {};
                } else if (line.includes('</STMTTRN>')) {
                    inTrans = false;
                    // Para Contas a Receber, queremos valores positivos
                    if (currentTrans.amount && parseFloat(currentTrans.amount) > 0) {
                        transactions.push(currentTrans);
                    }
                } else if (inTrans) {
                    if (line.includes('<TRNAMT>')) {
                        currentTrans.amount = line.split('<TRNAMT>')[1].split('<')[0].trim();
                    } else if (line.includes('<DTPOSTED>')) {
                        const dateStr = line.split('<DTPOSTED>')[1].split('<')[0].trim();
                        if (dateStr && dateStr.length >= 8) {
                            const y = dateStr.substring(0, 4);
                            const m = dateStr.substring(4, 6);
                            const d = dateStr.substring(6, 8);
                            currentTrans.date = `${y}-${m}-${d}`;
                        }
                    } else if (line.includes('<MEMO>')) {
                        currentTrans.memo = line.split('<MEMO>')[1].split('<')[0].trim();
                    } else if (line.includes('<NAME>')) {
                        currentTrans.name = line.split('<NAME>')[1].split('<')[0].trim();
                    }
                }
            }
            importedTransactions = transactions;
        }

        function parseCSV(content) {
            const transactions = [];
            const lines = content.split('\n');
            if (!lines.length) return;

            const headerRaw = lines[0].trim();
            const headerParts = headerRaw.includes(';') ? headerRaw.split(';') : headerRaw.split(',');
            const headerTokens = headerParts.map(p => normalizeText(p));
            const hasHeader = headerTokens.some(h => ['data', 'date', 'descricao', 'descriÃ§Ã£o', 'historico', 'hist', 'lancamento', 'valor', 'credito', 'crÃ©dito', 'debito', 'dÃ©bito', 'entrada', 'saida', 'saÃ­da', 'memo', 'nome'].some(k => h.includes(normalizeText(k))));

            let dateIndex = 0;
            let descIndex = 1;
            let amountIndex = 2;
            let creditIndex = -1;
            let debitIndex = -1;

            if (hasHeader) {
                headerTokens.forEach((h, idx) => {
                    if (h.includes('data')) dateIndex = idx;
                    if (h.includes('descricao') || h.includes('descriÃ§Ã£o') || h.includes('historico') || h.includes('hist') || h.includes('lancamento') || h.includes('memo') || h.includes('nome')) descIndex = idx;
                    if (h.includes('valor') || h.includes('amount')) amountIndex = idx;
                    if (h.includes('credito') || h.includes('crÃ©dito') || h.includes('entrada')) creditIndex = idx;
                    if (h.includes('debito') || h.includes('dÃ©bito') || h.includes('saida') || h.includes('saÃ­da')) debitIndex = idx;
                });
            }

            const startIndex = hasHeader ? 1 : 0;
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Tentar separar por ; ou ,
                const parts = line.includes(';') ? line.split(';') : line.split(',');
                
                if (parts.length >= 3) {
                    let date = (parts[dateIndex] || '').trim();
                    let desc = (parts[descIndex] || '').trim();
                    let amountStr = (parts[amountIndex] || '').trim();
                    if (creditIndex >= 0 && parts[creditIndex]) {
                        amountStr = parts[creditIndex].trim();
                    } else if (debitIndex >= 0 && parts[debitIndex] && !amountStr) {
                        amountStr = parts[debitIndex].trim();
                    }
                    
                    // Tratamento de data DD/MM/AAAA
                    if (date.includes('/')) {
                        const [d, m, y] = date.split('/');
                        date = `${y}-${m}-${d}`;
                    }
                    
                    let amount = parseAmount(amountStr);
                    
                    if (!isNaN(amount) && amount > 0) {
                        transactions.push({
                            date: date,
                            memo: desc,
                            amount: amount
                        });
                    }
                }
            }
            importedTransactions = transactions;
        }

        const bancoLabels = {
            'asaas': 'Asaas',
            'conta_simples': 'Conta Simples'
        };

        const bancoRules = [
            { banco: 'asaas', keywords: ['asaas'] },
            { banco: 'conta_simples', keywords: ['conta simples', 'conta-simples', 'cs bank', 'contasimples'] }
        ];

        function normalizeBankKey(banco) {
            const normalized = normalizeText(banco || '');
            if (normalized.includes('conta simples') || normalized.includes('conta-simples') || normalized.includes('contasimples') || normalized.includes('cs bank') || normalized.includes('csbank')) {
                return 'conta_simples';
            }
            if (normalized.includes('asaas')) return 'asaas';
            if (bancoLabels[banco]) return banco;
            return 'asaas';
        }

        function suggestBank(descricao) {
            const normalized = normalizeText(descricao || '');
            for (const rule of bancoRules) {
                if (rule.keywords.some(keyword => normalized.includes(normalizeText(keyword)))) {
                    return rule.banco;
                }
            }
            return 'asaas';
        }

        function getBankOptionsHTML(selected) {
            return Object.entries(bancoLabels).map(([value, label]) => {
                const isSelected = value === (selected || 'asaas') ? 'selected' : '';
                return `<option value="${value}" ${isSelected}>${label}</option>`;
            }).join('');
        }

        function getPendingOptionsHTML(pendentes, selectedName) {
            const base = `<option value="">NÃ£o conciliar</option>`;
            const options = pendentes.map(p => {
                const isSelected = p.nome === selectedName ? 'selected' : '';
                return `<option value="${escapeAttr(p.nome)}" ${isSelected}>${escapeAttr(p.nome)}</option>`;
            }).join('');
            return base + options;
        }

        function getMonthOptionsHTML(selected) {
            const select = document.getElementById('monthSelect');
            const options = select ? Array.from(select.options) : [];
            if (!options.length) {
                return `<option value="${currentMonth}" selected>${currentMonth}</option>`;
            }
            return options.map(opt => {
                const value = opt.value;
                const label = opt.textContent.trim();
                const isSelected = value === selected ? 'selected' : '';
                return `<option value="${value}" ${isSelected}>${label}</option>`;
            }).join('');
        }

        function getReceitasCustomAtivas(mes, deletedReceitas) {
            const receitasCustom = GestaoFinanceira.customItems?.[mes]?.receitas || [];
            if (!receitasCustom.length || !deletedReceitas.length) {
                return receitasCustom;
            }
            const filtradas = receitasCustom.filter(r => !deletedReceitas.includes(r.nome));
            if (filtradas.length !== receitasCustom.length) {
                if (!GestaoFinanceira.customItems[mes]) {
                    GestaoFinanceira.customItems[mes] = { despesas: [], receitas: [] };
                }
                GestaoFinanceira.customItems[mes].receitas = filtradas;
                GestaoFinanceira.saveToStorage();
                if (GestaoFinanceira.syncToServer) {
                    GestaoFinanceira.syncToServer();
                }
            }
            return filtradas;
        }

        function getNomeBaseParcela(nome) {
            const match = (nome || '').match(/^(.*)\s\(\d+\/\d+\)$/);
            return match ? match[1].trim() : '';
        }

        function isReceitaDeletada(nome, deletedReceitas) {
            if (deletedReceitas.includes(nome)) return true;
            const nomeBase = getNomeBaseParcela(nome);
            if (nomeBase && deletedReceitas.includes(nomeBase)) return true;
            return false;
        }

        function getClientesParaMes(mes) {
            const contasReceberDosClientes = gerarContasReceberDosClientes(mes);
            const deletedReceitas = GestaoFinanceira.getDeletedItems(mes).receitas || [];
            const receitasCustom = getReceitasCustomAtivas(mes, deletedReceitas);
            const nomesParciais = new Set(receitasCustom.filter(r => r.origemParcial).map(r => r.origemParcial));
            const clientesNaoDeletados = contasReceberDosClientes.filter(c => {
                if (!deletedReceitas.includes(c.nome)) {
                    const nomeBase = getNomeBaseParcela(c.nome);
                    if (nomeBase && deletedReceitas.includes(nomeBase)) {
                        return false;
                    }
                    return true;
                }
                return !nomesParciais.has(c.nome);
            });
            const contasMescladas = [...clientesNaoDeletados];
            if (receitasCustom.length > 0) {
                receitasCustom.forEach(receita => {
                    const statusSalvo = GestaoFinanceira.getStatus(mes, 'receita', receita.nome);
                    const status = statusSalvo ? statusSalvo.status : receita.status;
                    const dataPagamento = statusSalvo ? statusSalvo.dataPagamento : (receita.dataPagamento || null);
                    const isRecebido = status === 'Recebido' || status === 'Feito';
                    const valorLiquidoManualCustom = receita.valorLiquidoManual !== null && receita.valorLiquidoManual !== undefined && !Number.isNaN(Number(receita.valorLiquidoManual))
                        ? Number(receita.valorLiquidoManual)
                        : null;
                    const valorBaseCustom = valorLiquidoManualCustom !== null ? valorLiquidoManualCustom : (receita.valor || 0);
                    contasMescladas.push({
                        nome: receita.nome,
                        empresa: receita.empresa || 'Starken',
                        valor: valorBaseCustom,
                        valorBruto: receita.valor || 0,
                        valorLiquido: valorBaseCustom,
                        valorLiquidoManual: valorLiquidoManualCustom,
                        status: status,
                        dataPagamento: dataPagamento,
                        categoria: receita.categoria || '',
                        origem: receita.origem || '',
                        tipoValor: receita.tipoValor || 'tcv',
                        isClienteNovo: false,
                        dataVencimento: receita.dataVencimento || '',
                        formaPagamento: receita.formaPagamento || '',
                        gateway: receita.gateway || '',
                        parcelasCartao: receita.parcelasCartao || '',
                        isRecebido: isRecebido,
                        isEspecial: false,
                        isCustom: true,
                        origemParcial: receita.origemParcial || null,
                        valorOriginal: receita.valorOriginal || null,
                        observacao: receita.observacao || ''
                    });
                });
            }
            const contasFiltradas = contasMescladas.filter(c => {
                if (deletedReceitas.includes(c.nome)) return false;
                const nomeBase = getNomeBaseParcela(c.nome);
                if (nomeBase && deletedReceitas.includes(nomeBase)) return false;
                return true;
            });
            const nomesUnicos = new Set();
            const clientes = contasFiltradas.filter(c => {
                if (nomesUnicos.has(c.nome)) {
                    return false;
                }
                nomesUnicos.add(c.nome);
                return true;
            });
            const clientesParaTabela = [];
            clientes.forEach(cliente => {
                if ((cliente.status === 'BÃ´nus' || cliente.tipoValor === 'bonus') && (!cliente.valor || cliente.valor <= 0)) {
                    return;
                }
                if (cliente.valor <= 0) {
                    return;
                }
                const isEspecial = isStatusEspecial(cliente.status);
                const isRecebido = cliente.status === 'Recebido' || cliente.status === 'Feito';
                clientesParaTabela.push({
                    ...cliente,
                    isRecebido: isRecebido,
                    isEspecial: isEspecial
                });
            });
            return clientesParaTabela;
        }

        function getPendentesParaMes(mes) {
            if (!clientesByMonth.has(mes)) {
                clientesByMonth.set(mes, getClientesParaMes(mes));
            }
            const clientes = clientesByMonth.get(mes) || [];
            return clientes.filter(c => !c.isRecebido);
        }

        function getPendentesForIndex(index) {
            const trans = importedTransactions[index];
            const mes = trans?.matchMonth || currentMonth;
            return getPendentesParaMes(mes);
        }

        function showReconciliation() {
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('importStep2').style.display = 'block';
            document.getElementById('btnProcessImport').style.display = 'block';

            const list = document.getElementById('reconciliationList');
            list.innerHTML = '';

            let foundCount = 0;
            let newCount = 0;
            let duplicateCount = 0;

            const monthSelect = document.getElementById('monthSelect');
            const monthValues = monthSelect ? Array.from(monthSelect.options).map(o => o.value) : [currentMonth];
            clientesByMonth = new Map();
            pendingByMonth = new Map();
            monthValues.forEach(mes => {
                const clientesMes = getClientesParaMes(mes);
                clientesByMonth.set(mes, clientesMes);
                pendingByMonth.set(mes, clientesMes.filter(c => !c.isRecebido));
            });
            const pendentes = pendingByMonth.get(currentMonth) || [];
            const existingIndex = buildExistingReceiptIndex();
            pendingIndexByName = new Map(pendentes.map(p => [p.nome, p]));

            const positiveTransactions = importedTransactions
                .map((trans, index) => ({ trans, index }))
                .filter(({ trans }) => parseFloat(trans.amount) > 0);

            positiveTransactions.forEach(({ trans }) => {
                if (!trans.banco) {
                    trans.banco = importBankHint || suggestBank(trans.memo || trans.name || '');
                }
            });

            updateImportSummary(positiveTransactions);

            positiveTransactions.forEach(({ trans, index }) => {
                const amount = parseFloat(trans.amount);

                const { match, score } = getBestMatch(trans, pendentes);
                const confidence = match ? getConfidenceLevel(score) : null;
                const transKey = createTransactionKey(trans.memo || trans.name || '', amount, trans.date);
                const isDuplicate = existingIndex.has(transKey);

                trans.locked = isDuplicate;
                if (!trans.matchMonth) {
                    trans.matchMonth = currentMonth;
                }
                if (isDuplicate) {
                    trans.action = 'ignore';
                    trans.matchName = '';
                } else {
                    trans.action = match ? 'match' : 'new';
                    trans.matchName = match ? match.nome : '';
                }
                trans.confidence = confidence ? confidence.label : null;

                const div = document.createElement('div');
                div.className = `reconciliation-item ${match && !isDuplicate ? 'matched' : ''}`;
                div.dataset.index = index;
                if (isDuplicate) {
                    duplicateCount++;
                } else if (match) {
                    foundCount++;
                } else {
                    newCount++;
                }

                let badgeHtml = `<span class="rec-badge neutral">Novo lanÃ§amento</span>`;
                if (isDuplicate) {
                    badgeHtml = `<span class="rec-badge duplicate">JÃ¡ importado</span>`;
                } else if (match) {
                    badgeHtml = `<span class="rec-badge ${confidence.className}">Conciliar automÃ¡tico â€¢ ConfianÃ§a ${confidence.label}</span>`;
                }

                const pendentesForRow = pendingByMonth.get(trans.matchMonth || currentMonth) || pendentes;
                const splitOptions = renderSplitOptions(pendentesForRow, trans, index);
                const monthOptions = getMonthOptionsHTML(trans.matchMonth || currentMonth);

                div.innerHTML = `
                    <div class="rec-top">
                        <div class="rec-desc">
                            <input class="rec-input rec-memo" data-index="${index}" value="${escapeAttr(trans.memo || trans.name || 'Sem descriÃ§Ã£o')}">
                        </div>
                        <div class="rec-amount positive">${formatMoney(amount)}</div>
                    </div>
                    <div class="rec-meta">
                        ${badgeHtml}
                        <div class="rec-actions">
                            <input type="text" class="rec-input rec-date-br" data-index="${index}" placeholder="dd/mm/aaaa" value="${formatDate(trans.date)}">
                            <select class="form-select import-action" data-index="${index}">
                                <option value="match" ${trans.action === 'match' ? 'selected' : ''}>Conciliar</option>
                                <option value="new" ${trans.action === 'new' ? 'selected' : ''}>Novo</option>
                                <option value="split" ${trans.action === 'split' ? 'selected' : ''}>Dividir</option>
                                <option value="ignore">Ignorar</option>
                            </select>
                            <select class="form-select import-month" data-index="${index}">
                                ${monthOptions}
                            </select>
                            <select class="form-select import-match" data-index="${index}" ${trans.locked ? 'disabled' : ''}>
                                ${getPendingOptionsHTML(pendentesForRow, trans.matchName)}
                            </select>
                            <select class="form-select import-bank" data-index="${index}">
                                ${getBankOptionsHTML(trans.banco)}
                            </select>
                        </div>
                    </div>
                    <div class="rec-match-info" data-index="${index}"></div>
                    <div class="rec-split" data-index="${index}">
                        <div class="rec-split-header">Distribuir para clientes</div>
                        <div class="rec-split-list">${splitOptions}</div>
                        <div class="rec-split-summary" data-index="${index}"></div>
                    </div>
                `;
                list.appendChild(div);
                if (trans.locked) {
                    updateRowAction(index);
                } else if (trans.action === 'split') {
                    toggleSplitPanel(index);
                }
                updateMatchInfo(index, pendentesForRow, trans.matchMonth || currentMonth);
            });

            document.getElementById('foundCount').textContent = `${foundCount} Encontrados`;
            document.getElementById('newCount').textContent = `${newCount} Novos`;
            document.getElementById('duplicateCount').textContent = `${duplicateCount} Duplicados`;

            list.onchange = (event) => {
                const index = event.target.dataset.index;
                if (index === undefined) return;
                if (event.target.classList.contains('import-bank')) {
                    importedTransactions[index].banco = event.target.value;
                }
                if (event.target.classList.contains('import-action')) {
                    importedTransactions[index].action = event.target.value;
                    const row = event.target.closest('.reconciliation-item');
                    const matchSelect = row ? row.querySelector('.import-match') : null;
                    if (matchSelect) {
                        matchSelect.disabled = importedTransactions[index].locked;
                    }
                    if (importedTransactions[index].action !== 'match') {
                        importedTransactions[index].partialReceive = null;
                    }
                    updateRowAction(index);
                    updateMatchInfo(index, getPendentesForIndex(index), importedTransactions[index].matchMonth || currentMonth);
                }
                if (event.target.classList.contains('import-month')) {
                    importedTransactions[index].matchMonth = event.target.value;
                    const row = event.target.closest('.reconciliation-item');
                    const matchSelect = row ? row.querySelector('.import-match') : null;
                    const splitList = row ? row.querySelector('.rec-split-list') : null;
                    const pendentesMes = getPendentesForIndex(index);
                    if (matchSelect) {
                        matchSelect.innerHTML = getPendingOptionsHTML(pendentesMes, importedTransactions[index].matchName);
                        if (!pendentesMes.some(p => p.nome === importedTransactions[index].matchName)) {
                            importedTransactions[index].matchName = '';
                            matchSelect.value = '';
                            importedTransactions[index].partialReceive = null;
                        }
                    }
                    if (splitList) {
                        importedTransactions[index].splitClients = [];
                        splitList.innerHTML = renderSplitOptions(pendentesMes, importedTransactions[index], index);
                        updateSplitSummary(index);
                    }
                    if (!importedTransactions[index].locked && importedTransactions[index].action === 'match' && !importedTransactions[index].matchName) {
                        importedTransactions[index].action = 'new';
                    }
                    updateRowAction(index);
                    updateMatchInfo(index, pendentesMes, importedTransactions[index].matchMonth || currentMonth);
                }
                if (event.target.classList.contains('import-match')) {
                    const value = event.target.value;
                    importedTransactions[index].matchName = value;
                    if (!importedTransactions[index].locked) {
                        if (value) {
                            importedTransactions[index].action = 'match';
                        } else if (importedTransactions[index].action === 'match') {
                            importedTransactions[index].action = 'new';
                        }
                        updateRowAction(index);
                    }
                    if (value && importedTransactions[index].action === 'match' && !importedTransactions[index].locked) {
                        openImportPartialModal(index);
                    } else if (!value) {
                        importedTransactions[index].partialReceive = null;
                    }
                    updateMatchInfo(index, getPendentesForIndex(index), importedTransactions[index].matchMonth || currentMonth);
                }
                if (event.target.classList.contains('split-client')) {
                    const name = event.target.dataset.name;
                    const selected = new Set(importedTransactions[index].splitClients || []);
                    if (event.target.checked) {
                        selected.add(name);
                    } else {
                        selected.delete(name);
                    }
                    importedTransactions[index].splitClients = Array.from(selected);
                    updateSplitSummary(index);
                }
            };

            list.oninput = (event) => {
                const index = event.target.dataset.index;
                if (index === undefined) return;
                if (event.target.classList.contains('rec-memo')) {
                    importedTransactions[index].memo = event.target.value;
                }
                if (event.target.classList.contains('rec-date-br')) {
                    const iso = parseBrazilianDate(event.target.value);
                    if (iso) {
                        importedTransactions[index].date = iso;
                    }
                }
            };
        }

        async function processReconciliation() {
            let processed = 0;
            const btn = document.getElementById('btnProcessImport');
            const originalText = btn.textContent;
            btn.textContent = 'Processando...';
            btn.disabled = true;
            const importRun = {
                id: `import_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,
                month: currentMonth,
                createdItems: [],
                matchedItems: [],
                importedKeys: [],
                createdAt: new Date().toISOString(),
                sources: []
            };
            const importedKeySet = loadImportedKeySet();
            let hasNewImportedKeys = false;

            try {
                for (let index = 0; index < importedTransactions.length; index++) {
                    const trans = importedTransactions[index];
                    if (!trans || trans.action === 'ignore') continue;
                    const bankKey = normalizeBankKey(trans.banco || importBankHint || '');
                    if (bankKey && !importRun.sources.includes(bankKey)) {
                        importRun.sources.push(bankKey);
                    }

                    if (trans.action === 'match') {
                        const nome = trans.matchName;
                        if (!nome) continue;
                        const targetMonth = trans.matchMonth || currentMonth;
                        const previousStatus = GestaoFinanceira.getStatus(targetMonth, 'receita', nome);
                        const partial = trans.partialReceive;
                        if (partial && partial.type === 'partial') {
                            const cliente = getClienteInfoByName(nome, getPendentesParaMes(targetMonth), targetMonth);
                            const totalValor = partial.total || cliente?.valorLiquido || cliente?.valor || 0;
                            const parcialValor = partial.value || 0;
                            if (parcialValor > 0 && parcialValor < totalValor) {
                                const dataParcial = partial.date || trans.date;
                                const remainingValor = totalValor - parcialValor;
                                const nextDate = partial.nextDate || '';
                                const nomeBase = (cliente?.nome || nome)
                                    .replace(/ \(Restante.*\)$/, '')
                                    .replace(/ \(Parcial\)$/, '')
                                    .replace(/ \(Recebido.*\)$/, '');
                                const nomeOriginal = cliente?.origemParcial || cliente?.nome || nome;
                                const empresa = cliente?.empresa || 'Starken';
                                const isCustom = cliente?.isCustom || false;

                                GestaoFinanceira.deleteReceita(targetMonth, cliente?.nome || nome, isCustom);

                                const nomeRecebido = nomeBase + ' (Recebido ' + formatMoney(parcialValor) + ')';
                                GestaoFinanceira.addReceita(targetMonth, {
                                    nome: nomeRecebido,
                                    valor: parcialValor,
                                    empresa,
                                    status: 'Recebido',
                                    origemParcial: nomeOriginal,
                                    valorOriginal: totalValor,
                                    isCustom: true,
                                    observacao: `Recebimento parcial de "${nomeOriginal}" - Original: ${formatMoney(totalValor)}`
                                });
                                GestaoFinanceira.updateStatus(targetMonth, 'receita', nomeRecebido, 'Recebido', dataParcial);

                                const nomeRestante = nomeBase + ' (Restante de ' + formatMoney(totalValor) + ')';
                                GestaoFinanceira.addReceita(targetMonth, {
                                    nome: nomeRestante,
                                    valor: remainingValor,
                                    empresa,
                                    status: 'A Receber',
                                    origemParcial: nomeOriginal,
                                    valorOriginal: totalValor,
                                    isCustom: true,
                                    dataVencimento: nextDate,
                                    observacao: `Saldo restante de "${nomeOriginal}" - JÃ¡ recebido: ${formatMoney(totalValor - remainingValor)}`
                                });

                                importRun.matchedItems.push({
                                    nome,
                                    previousStatus,
                                    month: targetMonth,
                                    partial: true,
                                    receivedValue: parcialValor,
                                    remainingValue: remainingValor,
                                    receivedDate: dataParcial,
                                    nextDate
                                });
                            } else {
                                GestaoFinanceira.updateStatus(targetMonth, 'receita', nome, 'Recebido', trans.receiveDate || trans.date);
                                importRun.matchedItems.push({ nome, previousStatus, month: targetMonth });
                            }
                        } else {
                            GestaoFinanceira.updateStatus(targetMonth, 'receita', nome, 'Recebido', trans.receiveDate || trans.date);
                            importRun.matchedItems.push({ nome, previousStatus, month: targetMonth });
                        }
                    } else if (trans.action === 'split') {
                        const selected = trans.splitClients || [];
                        if (!selected.length) continue;
                        selected.forEach(nome => {
                            const targetMonth = trans.matchMonth || currentMonth;
                            const previousStatus = GestaoFinanceira.getStatus(targetMonth, 'receita', nome);
                            GestaoFinanceira.updateStatus(targetMonth, 'receita', nome, 'Recebido', trans.date);
                            importRun.matchedItems.push({ nome, previousStatus, month: targetMonth });
                        });
                    } else if (trans.action === 'new') {
                        // Adicionar ao customItems
                        if (!GestaoFinanceira.customItems[currentMonth]) {
                            GestaoFinanceira.customItems[currentMonth] = { despesas: [], receitas: [] };
                        }
                        if (!GestaoFinanceira.customItems[currentMonth].receitas) {
                            GestaoFinanceira.customItems[currentMonth].receitas = [];
                        }
                        
                        const newItem = {
                            importBatchId: importRun.id,
                            nome: trans.memo || 'Receita Importada',
                            valor: parseFloat(trans.amount),
                            categoria: 'outros',
                            status: 'Recebido',
                            dataPagamento: trans.date,
                            isCustom: true,
                            gateway: trans.banco || 'asaas',
                            observacao: 'Importado via OFX/CSV',
                            dataCriacao: new Date().toISOString()
                        };
                        
                        GestaoFinanceira.customItems[currentMonth].receitas.push(newItem);
                        GestaoFinanceira.saveToStorage();
                        importRun.createdItems.push({
                            nome: newItem.nome,
                            valor: newItem.valor,
                            dataPagamento: newItem.dataPagamento,
                            gateway: newItem.gateway,
                            importBatchId: newItem.importBatchId
                        });
                    }
                    const transKey = createTransactionKey(trans.memo || trans.name || '', trans.amount, trans.date);
                    if (!importedKeySet.has(transKey)) {
                        importedKeySet.add(transKey);
                        importRun.importedKeys.push(transKey);
                        hasNewImportedKeys = true;
                    }
                    processed++;
                }

                if (hasNewImportedKeys) {
                    saveImportedKeys(Array.from(importedKeySet));
                }

                // Sync
                if (GestaoFinanceira.syncToServer) {
                    await GestaoFinanceira.syncToServer();
                }

                loadMonthData(currentMonth);
                closeModal('importModal');
                showToast(`${processed} transaÃ§Ãµes importadas!`);

                const history = loadImportHistory();
                history.push(importRun);
                saveImportHistory(history);
                if (processed > 0) {
                    const sources = Array.isArray(importRun.sources) && importRun.sources.length ? importRun.sources : ['asaas'];
                    sources.forEach(source => {
                        setImportMetaForMonthBank(currentMonth, source, {
                            lastImportAt: importRun.createdAt,
                            lastReconcileAt: importRun.createdAt
                        });
                    });
                }
            } catch (error) {
                console.error('Erro na importaÃ§Ã£o:', error);
                showToast('Erro ao processar importaÃ§Ã£o', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ========================================
        // MODAL DE RECEBIMENTO KANBAN
        // ========================================

        let kanbanSelectedItem = null;
        let kanbanTargetStatus = null;
        let kanbanItemsMap = {};

        function openKanbanReceiveModal(item, targetStatus = null) {
            kanbanSelectedItem = item;
            kanbanTargetStatus = targetStatus;

            document.getElementById('kanbanItemName').textContent = item.nome;
            document.getElementById('kanbanItemValue').textContent = formatMoney(item.valorLiquido || item.valor || 0);
            document.getElementById('kanbanItemEmpresa').textContent = item.empresa || 'Starken';

            const currentStatus = item.isRecebido ? 'recebido' : 'pendente';
            selectKanbanStatus(targetStatus || currentStatus);

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('kanbanReceiveDate').value = item.dataPagamento || today;
            document.getElementById('kanbanObservations').value = item.observacao || '';

            // Reset recebimento parcial
            document.querySelector('input[name="receiveType"][value="full"]').checked = true;
            document.getElementById('partialReceiveGroup').style.display = 'none';
            document.getElementById('partialReceiveValue').value = '';
            document.getElementById('remainingReceiveValue').textContent = 'R$ 0,00';

            document.getElementById('kanbanReceiveModal').classList.add('active');
        }

        function closeKanbanReceiveModal() {
            document.getElementById('kanbanReceiveModal').classList.remove('active');
            kanbanSelectedItem = null;
            kanbanTargetStatus = null;
        }

        function selectKanbanStatus(status) {
            document.querySelectorAll('.kanban-status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            const el = document.querySelector(`.kanban-status-option[data-status="${status}"]`);
            if (el) el.classList.add('selected');

            // Mostrar opÃ§Ãµes de tipo de recebimento apenas quando "recebido" for selecionado
            const receiveTypeGroup = document.getElementById('receiveTypeGroup');
            if (status === 'recebido') {
                receiveTypeGroup.style.display = 'block';
            } else {
                receiveTypeGroup.style.display = 'none';
                document.getElementById('partialReceiveGroup').style.display = 'none';
            }
        }

        function getSelectedKanbanStatus() {
            const selected = document.querySelector('.kanban-status-option.selected');
            return selected ? selected.dataset.status : 'pendente';
        }

        // Toggle recebimento parcial
        function togglePartialReceive() {
            const isPartial = document.querySelector('input[name="receiveType"]:checked')?.value === 'partial';
            const partialGroup = document.getElementById('partialReceiveGroup');
            partialGroup.style.display = isPartial ? 'block' : 'none';

            if (isPartial) {
                document.getElementById('partialReceiveValue').focus();
            }
        }

        // Atualizar valor restante do recebimento
        function updateRemainingReceive() {
            if (!kanbanSelectedItem) return;

            const totalValor = kanbanSelectedItem.valorLiquido || kanbanSelectedItem.valor || 0;
            const partialInput = document.getElementById('partialReceiveValue').value;
            const partialValor = parseMoney(partialInput);

            const remaining = totalValor - partialValor;
            document.getElementById('remainingReceiveValue').textContent = formatMoney(Math.max(0, remaining));
        }

        function maskDate(input) {
            let value = input.value.replace(/\D/g, '').slice(0, 8);
            if (value.length >= 5) {
                value = value.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{2})(\d{0,2})/, '$1/$2');
            }
            input.value = value;
        }

        // MÃ¡scara de dinheiro
        function maskMoney(input) {
            let value = input.value.replace(/\D/g, '');
            value = (parseInt(value) / 100).toFixed(2);
            value = value.replace('.', ',');
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            input.value = 'R$ ' + value;
        }

        // Parse de valor monetÃ¡rio
        function parseMoney(value) {
            if (!value) return 0;
            return parseFloat(value.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
        }

        function saveKanbanReceive() {
            if (!kanbanSelectedItem) return;

            const status = getSelectedKanbanStatus();
            const date = document.getElementById('kanbanReceiveDate').value;
            const observacao = document.getElementById('kanbanObservations').value;

            // Se nÃ£o for recebido, apenas atualizar status
            if (status !== 'recebido') {
                const newStatus = 'A Receber';
                GestaoFinanceira.updateStatus(currentMonth, 'receita', kanbanSelectedItem.nome, newStatus, date);
                closeKanbanReceiveModal();
                showToast('Status atualizado!', 'success');
                loadMonthData(currentMonth);
                return;
            }

            // Verificar se Ã© recebimento parcial
            const receiveType = document.querySelector('input[name="receiveType"]:checked')?.value || 'full';

            if (receiveType === 'full') {
                // Recebimento total
                GestaoFinanceira.updateStatus(currentMonth, 'receita', kanbanSelectedItem.nome, 'Recebido', date);

                if (observacao) {
                    // Atualizar observaÃ§Ã£o
                    const dados = GestaoFinanceira.getDadosMesComStatus(currentMonth);
                    const cliente = dados.receitas.clientes.find(c => c.nome === kanbanSelectedItem.nome);
                    if (cliente) {
                        cliente.observacao = observacao;
                        GestaoFinanceira.saveDados(currentMonth, dados);
                    }
                }

                closeKanbanReceiveModal();
                showToast('Recebimento total registrado!', 'success');
                loadMonthData(currentMonth);
            } else {
                // Recebimento parcial
                const partialInput = document.getElementById('partialReceiveValue').value;
                const partialValor = parseMoney(partialInput);
                const totalValor = kanbanSelectedItem.valorLiquido || kanbanSelectedItem.valor || 0;

                if (partialValor <= 0) {
                    showToast('Informe o valor do recebimento parcial', 'error');
                    return;
                }

                if (partialValor >= totalValor) {
                    showToast('Para recebimento total, selecione a opÃ§Ã£o "Recebimento Total"', 'error');
                    return;
                }

                const remainingValor = totalValor - partialValor;
                const nomeBase = kanbanSelectedItem.nome.replace(/ \(Restante.*\)$/, '').replace(/ \(Parcial\)$/, '').replace(/ \(Recebido.*\)$/, '');
                const nomeOriginal = kanbanSelectedItem.origemParcial || kanbanSelectedItem.nome;
                const valorOriginalTotal = kanbanSelectedItem.valorOriginal || totalValor;

                // 1. Deletar item original
                GestaoFinanceira.deleteReceita(currentMonth, kanbanSelectedItem.nome, kanbanSelectedItem.isCustom);

                // 2. Criar item RECEBIDO com valor parcial
                const nomeRecebido = nomeBase + ' (Recebido ' + formatMoney(partialValor) + ')';
                GestaoFinanceira.addReceita(currentMonth, {
                    nome: nomeRecebido,
                    valor: partialValor,
                    empresa: kanbanSelectedItem.empresa || 'Starken',
                    status: 'Recebido',
                    origemParcial: nomeOriginal,
                    valorOriginal: valorOriginalTotal,
                    isCustom: true,
                    observacao: `Recebimento parcial de "${nomeOriginal}" - Original: ${formatMoney(valorOriginalTotal)}`
                });
                GestaoFinanceira.updateStatus(currentMonth, 'receita', nomeRecebido, 'Recebido', date);

                // 3. Criar item PENDENTE com valor restante
                const nomeRestante = nomeBase + ' (Restante de ' + formatMoney(valorOriginalTotal) + ')';
                GestaoFinanceira.addReceita(currentMonth, {
                    nome: nomeRestante,
                    valor: remainingValor,
                    empresa: kanbanSelectedItem.empresa || 'Starken',
                    status: 'A Receber',
                    origemParcial: nomeOriginal,
                    valorOriginal: valorOriginalTotal,
                    isCustom: true,
                    observacao: `Saldo restante de "${nomeOriginal}" - JÃ¡ recebido: ${formatMoney(valorOriginalTotal - remainingValor)}`
                });

                closeKanbanReceiveModal();
                showToast(`Recebimento parcial registrado! Restante: ${formatMoney(remainingValor)}`, 'success');
                loadMonthData(currentMonth);
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeKanbanReceiveModal();
                closeNovaReceitaModal();
            }
        });

        // ==========================================
        // NOVA RECEITA MODAL - Com cÃ¡lculo Alpha
        // ==========================================

        let contratoClientesMap = new Map();

        function populateContratoClientesSelect() {
            const select = document.getElementById('receitaContratoSelect');
            if (!select) return;
            const mes = currentMonth || new Date().toISOString().slice(0, 7);
            const clientes = getClientesContratoAtivos(mes);
            const items = clientes.map((cliente, index) => ({
                key: cliente.id ? String(cliente.id) : `${cliente.nome}-${index}`,
                cliente
            }));

            items.sort((a, b) => (a.cliente.nome || '').localeCompare(b.cliente.nome || '', 'pt-BR'));
            contratoClientesMap = new Map(items.map(item => [item.key, item.cliente]));

            const options = items.map(item => {
                const c = item.cliente;
                const empresaLabel = c.empresa === 'alpha' ? 'Alpha' : 'Starken';
                const tipoLabel = c.tipoValor ? c.tipoValor.toUpperCase() : '';
                const valorBase = c.tipoValor === 'tcv' ? (c.tcvTotal || c.valor || 0) : (c.valor || 0);
                const valorLabel = valorBase ? formatMoney(valorBase) : '';
                const label = [c.nome, empresaLabel, tipoLabel, valorLabel].filter(Boolean).join(' â€¢ ');
                return `<option value="${escapeAttr(item.key)}">${escapeAttr(label)}</option>`;
            }).join('');

            select.innerHTML = `<option value="">Selecionar cliente do contrato...</option>${options}`;
        }

        function applyContratoClienteSelection(value) {
            const cliente = contratoClientesMap.get(value);
            if (!cliente) return;

            document.getElementById('receitaNome').value = cliente.nome || '';
            document.getElementById('receitaCategoria').value = cliente.categoria || '';

            const empresaValue = cliente.empresa === 'alpha' ? 'Alpha' : 'Starken';
            const empresaSelect = document.getElementById('receitaEmpresa');
            if (empresaSelect) {
                empresaSelect.value = empresaValue;
            }

            const origemSelect = document.getElementById('receitaOrigem');
            if (origemSelect && cliente.origem && Array.from(origemSelect.options).some(opt => opt.value === cliente.origem)) {
                origemSelect.value = cliente.origem;
            }

            toggleAlphaFields();

            if (empresaValue === 'Alpha') {
                const tipoValor = (cliente.tipoValor || '').toLowerCase();
                if (tipoValor === 'mrr') {
                    setTipoContrato('mrr');
                    document.getElementById('receitaMRR').value = cliente.valor || 0;
                } else {
                    setTipoContrato('tcv');
                    document.getElementById('receitaTCV').value = cliente.tcvTotal || cliente.valor || 0;
                    if (cliente.parcelas) {
                        const parcelasSelect = document.getElementById('receitaParcelas');
                        if (parcelasSelect) {
                            parcelasSelect.value = String(cliente.parcelas);
                        }
                    }
                }
                calcularRepasseAlpha();
            } else {
                document.getElementById('receitaValorSimples').value = cliente.valor || 0;
            }
        }

        function openNovaReceitaModal() {
            document.getElementById('novaReceitaModal').classList.add('active');
            document.getElementById('receitaForm').reset();
            populateContratoClientesSelect();
            const contratoSelect = document.getElementById('receitaContratoSelect');
            if (contratoSelect) {
                contratoSelect.value = '';
            }
            // Resetar tipo de contrato para TCV
            tipoContratoSelecionado = 'tcv';
            setTipoContrato('tcv');
            toggleAlphaFields();
        }

        function closeNovaReceitaModal() {
            document.getElementById('novaReceitaModal').classList.remove('active');
        }

        function toggleAlphaFields() {
            const empresa = document.getElementById('receitaEmpresa').value;
            const alphaFields = document.getElementById('alphaFields');
            const starkenFields = document.getElementById('starkenFields');

            if (empresa === 'Alpha') {
                alphaFields.classList.add('visible');
                starkenFields.style.display = 'none';
                // Recalcular ao trocar para Alpha
                calcularRepasseAlpha();
            } else {
                alphaFields.classList.remove('visible');
                starkenFields.style.display = 'block';
            }
        }

        // Tipo de contrato selecionado (tcv ou mrr)
        let tipoContratoSelecionado = 'tcv';

        function setTipoContrato(tipo) {
            tipoContratoSelecionado = tipo;

            const camposTCV = document.getElementById('camposTCV');
            const camposMRR = document.getElementById('camposMRR');
            const labelTCV = document.getElementById('labelTCV');
            const labelMRR = document.getElementById('labelMRR');
            const labelValorBruto = document.getElementById('labelValorBruto');
            const labelValorLiquido = document.getElementById('labelValorLiquido');
            const rowTaxaCartao = document.getElementById('rowTaxaCartao');

            if (tipo === 'tcv') {
                camposTCV.style.display = 'block';
                camposMRR.style.display = 'none';
                labelTCV.style.borderColor = 'var(--primary-green)';
                labelTCV.style.background = 'rgba(74, 107, 84, 0.05)';
                labelMRR.style.borderColor = 'var(--border-color)';
                labelMRR.style.background = 'transparent';
                labelValorBruto.textContent = 'TCV Total:';
                labelValorLiquido.textContent = 'Valor LÃ­quido a Receber';
                rowTaxaCartao.style.display = 'flex';
            } else {
                camposTCV.style.display = 'none';
                camposMRR.style.display = 'block';
                labelMRR.style.borderColor = 'var(--primary-green)';
                labelMRR.style.background = 'rgba(74, 107, 84, 0.05)';
                labelTCV.style.borderColor = 'var(--border-color)';
                labelTCV.style.background = 'transparent';
                labelValorBruto.textContent = 'MRR Bruto (Mensal):';
                labelValorLiquido.textContent = 'Valor LÃ­quido Mensal';
                rowTaxaCartao.style.display = 'none';
            }

            // Recalcular com o novo tipo
            calcularRepasseAlpha();
        }

        function calcularRepasseAlpha() {
            let valorBruto = 0;
            let royaltiesPct = 15;
            let taxaCartaoPct = 0;

            if (tipoContratoSelecionado === 'tcv') {
                valorBruto = parseFloat(document.getElementById('receitaTCV').value) || 0;
                royaltiesPct = parseFloat(document.getElementById('receitaRoyaltiesTCV').value) || 15;
                taxaCartaoPct = parseFloat(document.getElementById('receitaTaxaCartao').value) || 0;
            } else {
                valorBruto = parseFloat(document.getElementById('receitaMRR').value) || 0;
                royaltiesPct = parseFloat(document.getElementById('receitaRoyaltiesMRR').value) || 15;
                taxaCartaoPct = 0; // MRR nÃ£o tem taxa de cartÃ£o
            }

            // Calcular valores
            const royaltiesValor = valorBruto * (royaltiesPct / 100);
            const taxaCartaoValor = valorBruto * (taxaCartaoPct / 100);
            const valorLiquido = valorBruto - royaltiesValor - taxaCartaoValor;

            // Atualizar resumo
            document.getElementById('summaryTCV').textContent = formatMoney(valorBruto);
            document.getElementById('summaryRoyaltiesPct').textContent = royaltiesPct;
            document.getElementById('summaryRoyalties').textContent = '- ' + formatMoney(royaltiesValor);
            document.getElementById('summaryTaxaPct').textContent = taxaCartaoPct;
            document.getElementById('summaryTaxa').textContent = '- ' + formatMoney(taxaCartaoValor);
            document.getElementById('summaryLiquido').textContent = formatMoney(valorLiquido);
        }

        function saveNovaReceita(event) {
            event.preventDefault();

            const nome = document.getElementById('receitaNome').value.trim();
            const empresa = document.getElementById('receitaEmpresa').value;
            const origem = document.getElementById('receitaOrigem').value;
            const categoria = document.getElementById('receitaCategoria').value.trim();
            const isNovo = document.getElementById('receitaNovo').checked;
            const isRenovacao = document.getElementById('receitaRenovacao').checked;

            let valor = 0;
            let contratoInfo = null;

            if (empresa === 'Alpha') {
                if (tipoContratoSelecionado === 'tcv') {
                    // Contrato TCV (Projeto Ãºnico)
                    const tcv = parseFloat(document.getElementById('receitaTCV').value) || 0;
                    const royaltiesPct = parseFloat(document.getElementById('receitaRoyaltiesTCV').value) || 15;
                    const taxaCartaoPct = parseFloat(document.getElementById('receitaTaxaCartao').value) || 0;
                    const meses = parseInt(document.getElementById('receitaMeses').value) || 1;
                    const parcelas = parseInt(document.getElementById('receitaParcelas').value) || 1;

                    const royaltiesValor = tcv * (royaltiesPct / 100);
                    const taxaCartaoValor = tcv * (taxaCartaoPct / 100);
                    valor = tcv - royaltiesValor - taxaCartaoValor;

                    contratoInfo = {
                        tipo: 'TCV',
                        valorBruto: tcv,
                        royaltiesPct: royaltiesPct,
                        royaltiesValor: royaltiesValor,
                        taxaCartaoPct: taxaCartaoPct,
                        taxaCartaoValor: taxaCartaoValor,
                        meses: meses,
                        parcelas: parcelas,
                        valorLiquido: valor
                    };
                } else {
                    // Contrato MRR (Mensalidade recorrente)
                    const mrr = parseFloat(document.getElementById('receitaMRR').value) || 0;
                    const royaltiesPct = parseFloat(document.getElementById('receitaRoyaltiesMRR').value) || 15;

                    const royaltiesValor = mrr * (royaltiesPct / 100);
                    valor = mrr - royaltiesValor;

                    contratoInfo = {
                        tipo: 'MRR',
                        valorBruto: mrr,
                        royaltiesPct: royaltiesPct,
                        royaltiesValor: royaltiesValor,
                        valorLiquido: valor,
                        recorrente: true
                    };
                }
            } else {
                valor = parseFloat(document.getElementById('receitaValorSimples').value) || 0;
            }

            if (!nome || valor <= 0) {
                showToast('Preencha o nome e um valor vÃ¡lido', 'error');
                return;
            }

            // Criar item de receita
            const novaReceita = {
                nome: nome,
                valor: valor,
                empresa: empresa,
                origem: origem,
                categoria: categoria,
                novo: isNovo,
                renovacao: isRenovacao,
                status: 'A Receber',
                isCustom: true,
                contratoInfo: contratoInfo // Guardar info do contrato se for Alpha
            };

            // Adicionar ao GestaoFinanceira
            if (!GestaoFinanceira.customItems[currentMonth]) {
                GestaoFinanceira.customItems[currentMonth] = { despesas: [], receitas: [] };
            }
            if (!GestaoFinanceira.customItems[currentMonth].receitas) {
                GestaoFinanceira.customItems[currentMonth].receitas = [];
            }

            GestaoFinanceira.customItems[currentMonth].receitas.push(novaReceita);
            GestaoFinanceira.saveToStorage();

            closeNovaReceitaModal();

            // Mensagem de sucesso com detalhes
            if (empresa === 'Alpha' && contratoInfo) {
                const tipoLabel = contratoInfo.tipo === 'MRR' ? 'MRR' : 'TCV';
                showToast(`Receita Alpha (${tipoLabel}) adicionada: ${formatMoney(valor)} (Bruto: ${formatMoney(contratoInfo.valorBruto)})`, 'success');
            } else {
                showToast(`Receita adicionada: ${formatMoney(valor)}`, 'success');
            }

            loadMonthData(currentMonth);
        }
    </script>

    <!-- Modal de Recebimento Kanban -->
    <div id="kanbanReceiveModal" class="kanban-modal-overlay" onclick="if(event.target===this) closeKanbanReceiveModal()">
        <div class="kanban-modal">
            <div class="kanban-modal-header">
                <h3>ðŸ’° Registrar Recebimento</h3>
                <button class="kanban-modal-close" onclick="closeKanbanReceiveModal()">âœ•</button>
            </div>
            <div class="kanban-modal-body">
                <div class="kanban-modal-item-info">
                    <div class="kanban-modal-item-name" id="kanbanItemName">-</div>
                    <div class="kanban-modal-item-value" id="kanbanItemValue">R$ 0,00</div>
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;" id="kanbanItemEmpresa">-</div>
                </div>

                <label style="font-size: 13px; font-weight: 600; margin-bottom: 12px; display: block;">Status</label>
                <div class="kanban-status-options">
                    <div class="kanban-status-option" data-status="pendente" onclick="selectKanbanStatus('pendente')">
                        <div class="status-icon">ðŸŸ¡</div>
                        <div class="status-label">Pendente</div>
                    </div>
                    <div class="kanban-status-option" data-status="recebido" onclick="selectKanbanStatus('recebido')">
                        <div class="status-icon">ðŸŸ¢</div>
                        <div class="status-label">Recebido</div>
                    </div>
                </div>

                <div class="kanban-form-group" id="receiveTypeGroup" style="display: none;">
                    <label style="font-size: 13px; font-weight: 600; margin-bottom: 12px; display: block;">Tipo de Recebimento</label>
                    <div style="display: flex; gap: 12px;">
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #27ae60; border-radius: 8px; cursor: pointer; background: #d4edda;">
                            <input type="radio" name="receiveType" value="full" checked onchange="togglePartialReceive()">
                            <span style="font-weight: 500;">Recebimento Total</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="receiveType" value="partial" onchange="togglePartialReceive()">
                            <span style="font-weight: 500;">Recebimento Parcial</span>
                        </label>
                    </div>
                </div>

                <div class="kanban-form-group" id="partialReceiveGroup" style="display: none;">
                    <label for="partialReceiveValue">Valor a Receber Agora <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="partialReceiveValue" placeholder="R$ 0,00" oninput="maskMoney(this); updateRemainingReceive()">
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                        <span style="color: #7f8c8d;">Valor restante:</span>
                        <span style="color: #e74c3c; font-weight: 600;" id="remainingReceiveValue">R$ 0,00</span>
                    </div>
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-top: 12px; font-size: 12px; color: #856404; border-radius: 4px;" id="partialReceiveNote">
                        <strong>AtenÃ§Ã£o:</strong> SerÃ¡ criada uma nova conta com o valor restante marcada como "A Receber".
                    </div>
                </div>

                <div class="kanban-form-group">
                    <label for="kanbanReceiveDate">Data do Recebimento</label>
                    <input type="date" id="kanbanReceiveDate">
                </div>

                <div class="kanban-form-group">
                    <label for="kanbanObservations">ObservaÃ§Ãµes</label>
                    <textarea id="kanbanObservations" rows="3" placeholder="Adicione notas..."></textarea>
                </div>
            </div>
            <div class="kanban-modal-footer">
                <button class="kanban-modal-btn cancel" onclick="closeKanbanReceiveModal()">Cancelar</button>
                <button class="kanban-modal-btn save" onclick="saveKanbanReceive()">ðŸ’¾ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nova Receita Alpha -->
    <div id="novaReceitaModal" class="receita-modal-overlay" onclick="if(event.target===this) closeNovaReceitaModal()">
        <div class="receita-modal">
            <div class="modal-header">
                <h3>ðŸ’° Nova Receita</h3>
                <button class="modal-close" onclick="closeNovaReceitaModal()">âœ•</button>
            </div>
            <form id="receitaForm" onsubmit="saveNovaReceita(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Cliente do Dashboard</label>
                        <select class="form-select" id="receitaContratoSelect" onchange="applyContratoClienteSelection(this.value)">
                            <option value="">Selecionar cliente do contrato...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome do Cliente *</label>
                        <input type="text" class="form-input" id="receitaNome" placeholder="Ex: Restaurante Exemplo" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Empresa *</label>
                            <select class="form-select" id="receitaEmpresa" onchange="toggleAlphaFields()">
                                <option value="Starken">ðŸš€ Starken</option>
                                <option value="Alpha">â­ Alpha (Franquia)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Origem</label>
                            <select class="form-select" id="receitaOrigem">
                                <option value="ProspecÃ§Ã£o">ProspecÃ§Ã£o</option>
                                <option value="IndicaÃ§Ã£o">IndicaÃ§Ã£o</option>
                                <option value="Inbound">Inbound</option>
                                <option value="Outbound">Outbound</option>
                                <option value="Matriz">Matriz</option>
                                <option value="RenovaÃ§Ã£o">RenovaÃ§Ã£o</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campos Starken (simples) -->
                    <div id="starkenFields">
                        <div class="form-group">
                            <label class="form-label">Valor (R$) *</label>
                            <input type="number" class="form-input" id="receitaValorSimples" placeholder="2000" min="0" step="0.01">
                        </div>
                    </div>

                    <!-- Campos Alpha (com cÃ¡lculo de repasse) -->
                    <div id="alphaFields" class="alpha-fields">
                        <div class="alpha-fields-title">
                            â­ CÃ¡lculo do Repasse Alpha
                        </div>

                        <!-- Tipo de Contrato -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Tipo de Contrato *</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;" id="labelTCV" onclick="setTipoContrato('tcv')">
                                    <input type="radio" name="tipoContrato" value="tcv" checked style="width: 16px; height: 16px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">ðŸ“‹ TCV</div>
                                        <div style="font-size: 10px; color: var(--text-light);">Projeto Ãºnico</div>
                                    </div>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;" id="labelMRR" onclick="setTipoContrato('mrr')">
                                    <input type="radio" name="tipoContrato" value="mrr" style="width: 16px; height: 16px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">ðŸ”„ MRR</div>
                                        <div style="font-size: 10px; color: var(--text-light);">Recorrente</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Grid: Campos Ã  esquerda, Resumo Ã  direita -->
                        <div class="alpha-content-grid">
                            <div class="alpha-inputs-section">
                                <!-- Campos TCV -->
                                <div id="camposTCV">
                                    <div class="form-row">
                                        <div class="form-group" style="margin-bottom: 10px;">
                                            <label class="form-label">TCV Total (Valor Bruto) *</label>
                                            <input type="number" class="form-input" id="receitaTCV" placeholder="7500" min="0" step="0.01" oninput="calcularRepasseAlpha()">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 10px;">
                                            <label class="form-label">Meses de Trabalho</label>
                                            <select class="form-select" id="receitaMeses" onchange="calcularRepasseAlpha()">
                                                <option value="1">1 (Mensal)</option>
                                                <option value="3">3 (Trimestral)</option>
                                                <option value="6">6 (Semestral)</option>
                                                <option value="12">12 (Anual)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-row-3">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Parcelas</label>
                                            <select class="form-select" id="receitaParcelas" onchange="calcularRepasseAlpha()">
                                                <option value="1">1x</option>
                                                <option value="2">2x</option>
                                                <option value="3">3x</option>
                                                <option value="4">4x</option>
                                                <option value="5">5x</option>
                                                <option value="6">6x</option>
                                                <option value="10">10x</option>
                                                <option value="12">12x</option>
                                            </select>
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">% Royalties</label>
                                            <input type="number" class="form-input" id="receitaRoyaltiesTCV" value="15" min="0" max="100" step="0.01" oninput="calcularRepasseAlpha()">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">% Taxa CartÃ£o</label>
                                            <input type="number" class="form-input" id="receitaTaxaCartao" value="0" min="0" max="100" step="0.01" oninput="calcularRepasseAlpha()">
                                        </div>
                                    </div>
                                </div>

                                <!-- Campos MRR -->
                                <div id="camposMRR" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Valor Mensal (MRR Bruto) *</label>
                                            <input type="number" class="form-input" id="receitaMRR" placeholder="2000" min="0" step="0.01" oninput="calcularRepasseAlpha()">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">% Royalties</label>
                                            <input type="number" class="form-input" id="receitaRoyaltiesMRR" value="15" min="0" max="100" step="0.01" oninput="calcularRepasseAlpha()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumo do Repasse -->
                            <div id="repasseSummary" class="repasse-summary" style="display: block; margin-top: 0;">
                                <div class="repasse-summary-title">ðŸ“Š Resumo do Repasse</div>
                                <div class="repasse-row" id="rowValorBruto">
                                    <span class="label" id="labelValorBruto">TCV Total:</span>
                                    <span class="value" id="summaryTCV">R$ 0,00</span>
                                </div>
                                <div class="repasse-row">
                                    <span class="label">Royalties (<span id="summaryRoyaltiesPct">15</span>%):</span>
                                    <span class="value negative" id="summaryRoyalties">- R$ 0,00</span>
                                </div>
                                <div class="repasse-row" id="rowTaxaCartao">
                                    <span class="label">Taxa CartÃ£o (<span id="summaryTaxaPct">0</span>%):</span>
                                    <span class="value negative" id="summaryTaxa">- R$ 0,00</span>
                                </div>
                                <div class="repasse-row total">
                                    <span class="label">ðŸ’° <span id="labelValorLiquido">Valor LÃ­quido</span>:</span>
                                    <span class="value positive" id="summaryLiquido">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="receitaNovo">
                            <span>âœ¨ Novo Cliente</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="receitaRenovacao">
                            <span>ðŸ”„ RenovaÃ§Ã£o</span>
                        </label>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">Categoria</label>
                        <input type="text" class="form-input" id="receitaCategoria" placeholder="Ex: Gastronomia, Automotivo...">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeNovaReceitaModal()">Cancelar</button>
                    <button type="submit" class="btn-save">ðŸ’¾ Salvar Receita</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de EdiÃ§Ã£o de Receita (Completo) -->
    <div id="editReceitaModal" class="receita-modal-overlay" onclick="if(event.target===this) closeEditReceitaModal()">
        <div class="receita-modal">
            <div class="modal-header">
                <h3>âœï¸ Editar Receita</h3>
                <button class="modal-close" onclick="closeEditReceitaModal()">âœ•</button>
            </div>
            <form id="editReceitaForm" onsubmit="saveEditReceita(event)">
                <input type="hidden" id="editReceitaNomeOriginal">
                <input type="hidden" id="editReceitaIsCustom">
                <input type="hidden" id="editReceitaTipoOriginal">

                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nome do Cliente *</label>
                        <input type="text" class="form-input" id="editReceitaNome" placeholder="Ex: Restaurante Exemplo" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Empresa *</label>
                            <select class="form-select" id="editReceitaEmpresa" onchange="toggleEditAlphaFields()">
                                <option value="Starken">ðŸš€ Starken</option>
                                <option value="Alpha">â­ Alpha (Franquia)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Origem</label>
                            <select class="form-select" id="editReceitaOrigem">
                                <option value="ProspecÃ§Ã£o">ProspecÃ§Ã£o</option>
                                <option value="IndicaÃ§Ã£o">IndicaÃ§Ã£o</option>
                                <option value="Inbound">Inbound</option>
                                <option value="Outbound">Outbound</option>
                                <option value="Matriz">Matriz</option>
                                <option value="RenovaÃ§Ã£o">RenovaÃ§Ã£o</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campos Starken (simples) -->
                    <div id="editStarkenFields">
                        <div class="form-group">
                            <label class="form-label">Valor (R$) *</label>
                            <input type="number" class="form-input" id="editReceitaValorSimples" placeholder="2000" min="0" step="0.01">
                        </div>
                    </div>

                    <!-- Campos Alpha (com cÃ¡lculo de repasse) -->
                    <div id="editAlphaFields" class="alpha-fields" style="display: none;">
                        <div class="alpha-fields-title">
                            â­ CÃ¡lculo do Repasse Alpha
                        </div>

                        <!-- Tipo de Contrato -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Tipo de Contrato *</label>
                            <div style="display: flex; gap: 10px;">
                                <label style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;" id="editLabelTCV" onclick="setEditTipoContrato('tcv')">
                                    <input type="radio" name="editTipoContrato" value="tcv" checked style="width: 16px; height: 16px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">ðŸ“‹ TCV</div>
                                        <div style="font-size: 10px; color: var(--text-light);">Projeto Ãºnico</div>
                                    </div>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;" id="editLabelMRR" onclick="setEditTipoContrato('mrr')">
                                    <input type="radio" name="editTipoContrato" value="mrr" style="width: 16px; height: 16px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 13px;">ðŸ”„ MRR</div>
                                        <div style="font-size: 10px; color: var(--text-light);">Recorrente</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Grid: Campos Ã  esquerda, Resumo Ã  direita -->
                        <div class="alpha-content-grid">
                            <div class="alpha-inputs-section">
                                <!-- Campos TCV -->
                                <div id="editCamposTCV">
                                    <div class="form-row">
                                        <div class="form-group" style="margin-bottom: 10px;">
                                            <label class="form-label">TCV Total (Valor Bruto) *</label>
                                            <input type="number" class="form-input" id="editReceitaTCV" placeholder="7500" min="0" step="0.01" oninput="calcularEditRepasseAlpha()">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 10px;">
                                            <label class="form-label">Meses de Trabalho</label>
                                            <select class="form-select" id="editReceitaMeses" onchange="calcularEditRepasseAlpha()">
                                                <option value="1">1 (Mensal)</option>
                                                <option value="3">3 (Trimestral)</option>
                                                <option value="6">6 (Semestral)</option>
                                                <option value="12">12 (Anual)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-row-3">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Parcelas</label>
                                            <select class="form-select" id="editReceitaParcelas" onchange="calcularEditRepasseAlpha()">
                                                <option value="1">1x</option>
                                                <option value="2">2x</option>
                                                <option value="3">3x</option>
                                                <option value="4">4x</option>
                                                <option value="5">5x</option>
                                                <option value="6">6x</option>
                                                <option value="10">10x</option>
                                                <option value="12">12x</option>
                                            </select>
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">% Royalties</label>
                                            <input type="number" class="form-input" id="editReceitaRoyaltiesTCV" value="15" min="0" max="100" step="0.01" oninput="calcularEditRepasseAlpha()">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">% Taxa CartÃ£o</label>
                                            <input type="number" class="form-input" id="editReceitaTaxaCartao" value="0" min="0" max="100" step="0.01" oninput="calcularEditRepasseAlpha()">
                                        </div>
                                    </div>
                                </div>

                                <!-- Campos MRR -->
                                <div id="editCamposMRR" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Valor Mensal (MRR Bruto) *</label>
                                            <input type="number" class="form-input" id="editReceitaMRR" placeholder="2000" min="0" step="0.01" oninput="calcularEditRepasseAlpha()">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">% Royalties</label>
                                            <input type="number" class="form-input" id="editReceitaRoyaltiesMRR" value="15" min="0" max="100" step="0.01" oninput="calcularEditRepasseAlpha()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumo do Repasse -->
                            <div id="editRepasseSummary" class="repasse-summary" style="display: block; margin-top: 0;">
                                <div class="repasse-summary-title">ðŸ“Š Resumo do Repasse</div>
                                <div class="repasse-row" id="editRowValorBruto">
                                    <span class="label" id="editLabelValorBruto">TCV Total:</span>
                                    <span class="value" id="editSummaryTCV">R$ 0,00</span>
                                </div>
                                <div class="repasse-row">
                                    <span class="label">Royalties (<span id="editSummaryRoyaltiesPct">15</span>%):</span>
                                    <span class="value negative" id="editSummaryRoyalties">- R$ 0,00</span>
                                </div>
                                <div class="repasse-row" id="editRowTaxaCartao">
                                    <span class="label">Taxa CartÃ£o (<span id="editSummaryTaxaPct">0</span>%):</span>
                                    <span class="value negative" id="editSummaryTaxa">- R$ 0,00</span>
                                </div>
                                <div class="repasse-row total">
                                    <span class="label">ðŸ’° <span id="editLabelValorLiquido">Valor LÃ­quido</span>:</span>
                                    <span class="value positive" id="editSummaryLiquido">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Separador: Status e Datas -->
                    <div style="border-top: 2px solid var(--border-color); margin: 20px 0; padding-top: 20px;">
                        <div style="font-size: 15px; font-weight: 600; color: var(--text-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            ðŸ“… Status e Datas
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Valor LÃ­quido Manual (R$)</label>
                                <input type="number" class="form-input" id="editReceitaValorLiquidoManual" placeholder="Opcional" min="0" step="0.01" oninput="calcularEditRepasseAlpha()">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editReceitaStatus">
                                    <option value="A Receber">ðŸ“‹ A Receber</option>
                                    <option value="Recebido">âœ… Recebido</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data de Recebimento</label>
                                <input type="date" class="form-input" id="editReceitaData" placeholder="dd/mm/aaaa">
                                <div style="font-size: 11px; color: var(--text-light); margin-top: 4px;">
                                    ðŸ’¡ Data em que o pagamento foi/serÃ¡ recebido
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Data de Vencimento</label>
                                <input type="date" class="form-input" id="editReceitaDataVencimento" placeholder="dd/mm/aaaa">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Forma de Pagamento</label>
                                <select class="form-select" id="editReceitaFormaPagamento">
                                    <option value="">Selecione...</option>
                                    <option value="PIX">ðŸ’¸ PIX</option>
                                    <option value="CartÃ£o">ðŸ’³ CartÃ£o de CrÃ©dito</option>
                                    <option value="Boleto">ðŸ“„ Boleto</option>
                                    <option value="TransferÃªncia">ðŸ¦ TransferÃªncia</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row" id="editReceitaGatewayRow" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Gateway</label>
                                <select class="form-select" id="editReceitaGateway">
                                    <option value="">Selecione...</option>
                                    <option value="Asaas">Asaas</option>
                                    <option value="Infinity Pay">Infinity Pay</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Parcelamento</label>
                                <input type="text" class="form-input" id="editReceitaParcelamento" placeholder="Ex: 3x, 1+2">
                            </div>
                        </div>
                    </div>

                    <!-- Separador: InformaÃ§Ãµes Adicionais -->
                    <div style="border-top: 2px solid var(--border-color); margin: 20px 0; padding-top: 20px;">
                        <div style="font-size: 15px; font-weight: 600; color: var(--text-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            ðŸ“ InformaÃ§Ãµes Adicionais
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="editReceitaNovo">
                                <span>âœ¨ Novo Cliente</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editReceitaRenovacao">
                                <span>ðŸ”„ RenovaÃ§Ã£o</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-input" id="editReceitaCategoria" placeholder="Ex: Gastronomia, Automotivo...">
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">ObservaÃ§Ãµes</label>
                            <textarea class="form-input" id="editReceitaObservacao" rows="3" placeholder="Adicione notas, observaÃ§Ãµes ou informaÃ§Ãµes importantes..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeEditReceitaModal()">Cancelar</button>
                    <button type="button" class="btn-delete" onclick="excluirReceitaDoModal()" style="background: #e74c3c; color: white;">ðŸ—‘ï¸ Excluir</button>
                    <button type="submit" class="btn-save">ðŸ’¾ Salvar AlteraÃ§Ãµes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // FUNÃ‡Ã•ES DE EDIÃ‡ÃƒO DE RECEITA (COMPLETO)
        // ========================================

        let editTipoContrato = 'tcv';

        function openEditReceitaModal(nome, empresa, valor, status, isCustom, tipo, origem, novo, renovacao, categoria, dataPagamento, observacao, dataVencimento, formaPagamento, gateway, parcelasCartao, valorLiquidoManual) {
            document.getElementById('editReceitaNomeOriginal').value = nome;
            document.getElementById('editReceitaIsCustom').value = isCustom;
            document.getElementById('editReceitaTipoOriginal').value = tipo || 'TCV';
            document.getElementById('editReceitaNome').value = nome;
            document.getElementById('editReceitaEmpresa').value = empresa;
            document.getElementById('editReceitaOrigem').value = origem || 'ProspecÃ§Ã£o';
            document.getElementById('editReceitaStatus').value = status;
            document.getElementById('editReceitaNovo').checked = novo || false;
            document.getElementById('editReceitaRenovacao').checked = renovacao || false;
            document.getElementById('editReceitaCategoria').value = categoria || '';
            document.getElementById('editReceitaData').value = dataPagamento || '';
            document.getElementById('editReceitaObservacao').value = observacao || '';
            document.getElementById('editReceitaValorLiquidoManual').value = valorLiquidoManual || '';

            // Preencher campos adicionais
            if (dataVencimento) document.getElementById('editReceitaDataVencimento').value = dataVencimento;
            if (formaPagamento) document.getElementById('editReceitaFormaPagamento').value = formaPagamento;
            if (gateway) document.getElementById('editReceitaGateway').value = gateway;
            if (parcelasCartao) document.getElementById('editReceitaParcelas').value = parcelasCartao;

            // Configurar campos baseado na empresa
            toggleEditAlphaFields();

            // Configurar valor
            if (empresa === 'Alpha') {
                const tipoContrato = (tipo === 'MRR' || tipo === 'mrr') ? 'mrr' : 'tcv';
                setEditTipoContrato(tipoContrato);
                if (tipoContrato === 'mrr') {
                    document.getElementById('editReceitaMRR').value = valor;
                } else {
                    document.getElementById('editReceitaTCV').value = valor;
                }
                calcularEditRepasseAlpha();
            } else {
                document.getElementById('editReceitaValorSimples').value = valor;
            }

            document.getElementById('editReceitaModal').classList.add('active');
        }

        function closeEditReceitaModal() {
            document.getElementById('editReceitaModal').classList.remove('active');
        }

        function toggleEditAlphaFields() {
            const empresa = document.getElementById('editReceitaEmpresa').value;
            const starkenFields = document.getElementById('editStarkenFields');
            const alphaFields = document.getElementById('editAlphaFields');

            if (empresa === 'Alpha') {
                starkenFields.style.display = 'none';
                alphaFields.style.display = 'block';
            } else {
                starkenFields.style.display = 'block';
                alphaFields.style.display = 'none';
            }
        }

        // Removida toggleEditDataRecebimento - campo de data sempre visÃ­vel

        function setEditTipoContrato(tipo) {
            editTipoContrato = tipo;
            const camposTCV = document.getElementById('editCamposTCV');
            const camposMRR = document.getElementById('editCamposMRR');
            const labelTCV = document.getElementById('editLabelTCV');
            const labelMRR = document.getElementById('editLabelMRR');
            const labelValorBruto = document.getElementById('editLabelValorBruto');
            const rowTaxaCartao = document.getElementById('editRowTaxaCartao');

            if (tipo === 'tcv') {
                camposTCV.style.display = 'block';
                camposMRR.style.display = 'none';
                labelTCV.style.borderColor = 'var(--primary-green)';
                labelTCV.style.background = 'rgba(74, 107, 84, 0.05)';
                labelMRR.style.borderColor = 'var(--border-color)';
                labelMRR.style.background = 'transparent';
                labelValorBruto.textContent = 'TCV Total:';
                rowTaxaCartao.style.display = 'flex';
                document.querySelector('input[name="editTipoContrato"][value="tcv"]').checked = true;
            } else {
                camposTCV.style.display = 'none';
                camposMRR.style.display = 'block';
                labelMRR.style.borderColor = 'var(--primary-green)';
                labelMRR.style.background = 'rgba(74, 107, 84, 0.05)';
                labelTCV.style.borderColor = 'var(--border-color)';
                labelTCV.style.background = 'transparent';
                labelValorBruto.textContent = 'MRR Bruto (Mensal):';
                rowTaxaCartao.style.display = 'none';
                document.querySelector('input[name="editTipoContrato"][value="mrr"]').checked = true;
            }
            calcularEditRepasseAlpha();
        }

        function calcularEditRepasseAlpha() {
            let valorBruto = 0;
            let royaltiesPct = 15;
            let taxaPct = 0;
            const valorLiquidoManualInput = document.getElementById('editReceitaValorLiquidoManual').value;
            const valorLiquidoManual = valorLiquidoManualInput === '' ? null : Number(valorLiquidoManualInput);

            if (editTipoContrato === 'tcv') {
                valorBruto = parseFloat(document.getElementById('editReceitaTCV').value) || 0;
                royaltiesPct = parseFloat(document.getElementById('editReceitaRoyaltiesTCV').value) || 15;
                taxaPct = parseFloat(document.getElementById('editReceitaTaxaCartao').value) || 0;
            } else {
                valorBruto = parseFloat(document.getElementById('editReceitaMRR').value) || 0;
                royaltiesPct = parseFloat(document.getElementById('editReceitaRoyaltiesMRR').value) || 15;
            }

            const royaltiesValor = valorBruto * (royaltiesPct / 100);
            const taxaValor = valorBruto * (taxaPct / 100);
            const valorLiquido = valorBruto - royaltiesValor - taxaValor;
            const valorLiquidoFinal = valorLiquidoManual !== null && !Number.isNaN(valorLiquidoManual) ? valorLiquidoManual : valorLiquido;

            document.getElementById('editSummaryTCV').textContent = formatMoney(valorBruto);
            document.getElementById('editSummaryRoyaltiesPct').textContent = royaltiesPct;
            document.getElementById('editSummaryRoyalties').textContent = '- ' + formatMoney(royaltiesValor);
            document.getElementById('editSummaryTaxaPct').textContent = taxaPct;
            document.getElementById('editSummaryTaxa').textContent = '- ' + formatMoney(taxaValor);
            document.getElementById('editSummaryLiquido').textContent = formatMoney(valorLiquidoFinal);
        }

        async function saveEditReceita(event) {
            event.preventDefault();

            const nomeOriginal = document.getElementById('editReceitaNomeOriginal').value;
            const isCustom = document.getElementById('editReceitaIsCustom').value === 'true';
            const novoNome = document.getElementById('editReceitaNome').value;
            const empresa = document.getElementById('editReceitaEmpresa').value;
            const origem = document.getElementById('editReceitaOrigem').value;
            const status = document.getElementById('editReceitaStatus').value;
            const dataRecebimento = document.getElementById('editReceitaData').value;
            const novo = document.getElementById('editReceitaNovo').checked;
            const renovacao = document.getElementById('editReceitaRenovacao').checked;
            const categoria = document.getElementById('editReceitaCategoria').value;
            const observacao = document.getElementById('editReceitaObservacao').value;
            const dataVencimento = document.getElementById('editReceitaDataVencimento').value;
            const formaPagamento = document.getElementById('editReceitaFormaPagamento').value;
            const gateway = document.getElementById('editReceitaGateway').value;
            const parcelamento = document.getElementById('editReceitaParcelamento').value;
            const valorLiquidoManualInput = document.getElementById('editReceitaValorLiquidoManual').value;
            const valorLiquidoManual = valorLiquidoManualInput === '' ? null : Number(valorLiquidoManualInput);

            // Determinar valor baseado na empresa
            let valor = 0;
            let tipo = 'TCV';
            if (empresa === 'Alpha') {
                tipo = editTipoContrato.toUpperCase();
                if (editTipoContrato === 'tcv') {
                    valor = parseFloat(document.getElementById('editReceitaTCV').value) || 0;
                } else {
                    valor = parseFloat(document.getElementById('editReceitaMRR').value) || 0;
                }
            } else {
                valor = parseFloat(document.getElementById('editReceitaValorSimples').value) || 0;
            }

            console.log('ðŸ’¾ Salvando receita:', { nomeOriginal, novoNome, valor, isCustom, empresa, tipo });

            try {
                // Se for customItem (receita manual ou parcial), atualizar via GestaoFinanceira
                if (isCustom) {
                    console.log('ðŸ“¦ Atualizando customItem via GestaoFinanceira');
                    GestaoFinanceira.editReceita(currentMonth, nomeOriginal, {
                        nome: novoNome,
                        valor: valor,
                        valorLiquidoManual: valorLiquidoManual,
                        empresa: empresa,
                        origem: origem,
                        tipo: tipo,
                        novo: novo,
                        renovacao: renovacao,
                        categoria: categoria,
                        observacao: observacao,
                        dataVencimento: dataVencimento,
                        formaPagamento: formaPagamento,
                        gateway: gateway,
                        parcelamento: parcelamento
                    });
                } else {
                    // Cliente do localStorage - atualizar diretamente
                    console.log('ðŸ—‚ï¸ Atualizando cliente do localStorage');
                    const todosClientes = JSON.parse(localStorage.getItem('starken_manual_clients') || '[]');
                    const clienteIndex = todosClientes.findIndex(c => c.nome === nomeOriginal);

                    if (clienteIndex !== -1) {
                        const cliente = todosClientes[clienteIndex];
                        console.log('âœï¸ Cliente encontrado:', cliente);

                        // Atualizar dados do cliente
                        cliente.nome = novoNome;
                        cliente.valor = valor;
                        if (valorLiquidoManual !== null && !Number.isNaN(valorLiquidoManual)) {
                            cliente.valorLiquidoManual = valorLiquidoManual;
                        } else {
                            delete cliente.valorLiquidoManual;
                        }
                        cliente.categoria = categoria;
                        cliente.origem = origem;
                        cliente.observacao = observacao;
                        cliente.dataVencimento = dataVencimento;
                        cliente.formaPagamento = formaPagamento;
                        cliente.gateway = gateway;
                        cliente.parcelasCartao = parcelamento;

                        // Salvar no localStorage
                        localStorage.setItem('starken_manual_clients', JSON.stringify(todosClientes));
                        console.log('âœ… Cliente atualizado no localStorage');
                    } else {
                        console.warn('âš ï¸ Cliente nÃ£o encontrado no localStorage, tentando GestaoFinanceira');
                        // Fallback: tentar via GestaoFinanceira
                        GestaoFinanceira.editReceita(currentMonth, nomeOriginal, {
                            nome: novoNome,
                            valor: valor,
                            valorLiquidoManual: valorLiquidoManual,
                            empresa: empresa,
                            origem: origem,
                            tipo: tipo,
                            novo: novo,
                            renovacao: renovacao,
                            categoria: categoria,
                            observacao: observacao,
                            dataVencimento: dataVencimento,
                            formaPagamento: formaPagamento,
                            gateway: gateway,
                            parcelamento: parcelamento
                        });
                    }
                }

                // Atualizar status (com data de recebimento)
                await GestaoFinanceira.updateStatus(currentMonth, 'receita', novoNome || nomeOriginal, status, dataRecebimento || null);

                // Sincronizar
                await GestaoFinanceira.syncToServer();

                closeEditReceitaModal();
                loadMonthData(currentMonth);
                showToast('Receita atualizada com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar receita:', error);
                showToast('Erro ao salvar receita', 'error');
            }
        }

        async function excluirReceita(nome, isCustom = false) {
            if (!confirm(`Tem certeza que deseja excluir "${nome}"?`)) {
                return;
            }

            try {
                GestaoFinanceira.deleteReceita(currentMonth, nome, isCustom);
                await GestaoFinanceira.syncToServer();
                loadMonthData(currentMonth);
                showToast('Receita excluÃ­da com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir receita:', error);
                showToast('Erro ao excluir receita', 'error');
            }
        }

        async function excluirReceitaDoModal() {
            const nome = document.getElementById('editReceitaNomeOriginal').value;
            const isCustom = document.getElementById('editReceitaIsCustom').value === 'true';
            if (!confirm(`Tem certeza que deseja excluir "${nome}"?`)) {
                return;
            }

            try {
                GestaoFinanceira.deleteReceita(currentMonth, nome, isCustom);
                await GestaoFinanceira.syncToServer();
                closeEditReceitaModal();
                loadMonthData(currentMonth);
                showToast('Receita excluÃ­da com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir receita:', error);
                showToast('Erro ao excluir receita', 'error');
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('sidebarToggle');
            if (!toggleButton) return;

            const applySidebarState = (collapsed) => {
                document.body.classList.toggle('sidebar-collapsed', collapsed);
                toggleButton.textContent = collapsed ? 'âŸ©' : 'âŸ¨';
            };

            const saved = localStorage.getItem('starken_sidebar_collapsed') === 'true';
            applySidebarState(saved);

            toggleButton.addEventListener('click', () => {
                const next = !document.body.classList.contains('sidebar-collapsed');
                applySidebarState(next);
                localStorage.setItem('starken_sidebar_collapsed', String(next));
            });
        });
    </script>
</body>
</html>
